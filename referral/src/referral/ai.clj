(ns referral.ai
  "AI-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ ‚Äî Claude Haiku —á–µ—Ä–µ–∑ API"
  (:require [clj-http.client :as http]
            [cheshire.core :as json]
            [referral.models :as models]
            [referral.config :as config]
            [clojure.string :as str]))

;; ‚îÄ‚îÄ Conversation memory (per chat, last N messages) ‚îÄ‚îÄ‚îÄ‚îÄ

(defonce ^:private conversations (atom {}))
(def ^:private MAX_HISTORY 10)
(def ^:private MAX_CONVERSATIONS 500)

(defn- add-message! [chat-id role text]
  (swap! conversations
    (fn [convs]
      (let [msgs  (get convs chat-id [])
            msgs' (conj msgs {:role role :content text :ts (System/currentTimeMillis)})
            msgs' (if (> (count msgs') MAX_HISTORY)
                    (vec (take-last MAX_HISTORY msgs'))
                    msgs')
            convs' (assoc convs chat-id msgs')]
        ;; Evict oldest conversations when over limit
        (if (> (count convs') MAX_CONVERSATIONS)
          (let [oldest-key (->> (dissoc convs' chat-id)
                                (sort-by (fn [[_ ms]] (or (:ts (last ms)) 0)))
                                first
                                first)]
            (dissoc convs' oldest-key))
          convs')))))

(defn clear-conversation! [chat-id]
  (swap! conversations dissoc chat-id))

;; ‚îÄ‚îÄ Build catalog context from DB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

(defn- build-catalog []
  "–§–æ—Ä–º–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–π –∫–∞—Ç–∞–ª–æ–≥ –∏–∑ –ë–î –¥–ª—è system prompt"
  (let [bikes (models/list-bikes "available")]
    (if (empty? bikes)
      "–ö–∞—Ç–∞–ª–æ–≥ –ø—É—Å—Ç ‚Äî –≤—Å–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ –∑–∞–Ω—è—Ç—ã."
      (str/join "\n"
        (map (fn [b]
               (str "‚Ä¢ " (:name b)
                    " | " (or (:daily_rate b) "?") "k/–¥–µ–Ω—å"
                    (when (:monthly_rate b)
                      (str " | " (:monthly_rate b) "k/–º–µ—Å"))
                    " | " (:category b)
                    (when (:notes b) (str " | " (:notes b)))))
             bikes)))))

;; ‚îÄ‚îÄ System prompt ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

(defn- system-prompt []
  (str
    "–¢—ã ‚Äî AI-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –∞—Ä–µ–Ω–¥—ã —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ Karma Rent –≤ –ù—è—á–∞–Ω–≥–µ, –í—å–µ—Ç–Ω–∞–º.\n"
    "–ü—Ä–∞–≤–∏–ª–∞:\n"
    "- –û—Ç–≤–µ—á–∞–π –∫–æ—Ä–æ—Ç–∫–æ (2-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è), –¥—Ä—É–∂–µ–ª—é–±–Ω–æ, –ø–æ-—Ä—É—Å—Å–∫–∏\n"
    "- –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø–∏—à–µ—Ç –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º ‚Äî –æ—Ç–≤–µ—á–∞–π –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º\n"
    "- –¶–µ–Ω—ã –≤ —Ç—ã—Å—è—á–∞—Ö VND (k = —Ç—ã—Å—è—á–∞). 250k = 250,000 VND ‚âà $10\n"
    "- –†–µ–∫–æ–º–µ–Ω–¥—É–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –º–æ–¥–µ–ª–∏ –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞ –ø–æ–¥ –∑–∞–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞\n"
    "- –î–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è ‚Äî –ø—Ä–µ–¥–ª–æ–∂–∏ –Ω–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É ¬´üìã –ö–∞—Ç–∞–ª–æ–≥¬ª –∏–ª–∏ /catalog\n"
    "- –ù–ï –ø—Ä–∏–¥—É–º—ã–≤–∞–π –¥–∞–Ω–Ω—ã–µ ‚Äî —Ç–æ–ª—å–∫–æ –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞ –∏ —Å–ø—Ä–∞–≤–∫–∏ –Ω–∏–∂–µ\n"
    "\n=== –£–°–õ–û–í–ò–Ø –ê–†–ï–ù–î–´ ===\n"
    "- –ó–∞–ª–æ–≥: $100 (—Å–∫—É—Ç–µ—Ä—ã/–±–∞–π–∫–∏), $200 (–ø—Ä–µ–º–∏—É–º –º–æ—Ç–æ—Ü–∏–∫–ª—ã), $300 (–∞–≤—Ç–æ)\n"
    "- –î–æ—Å—Ç–∞–≤–∫–∞ –ø–æ –ù—è—á–∞–Ω–≥—É –±–µ—Å–ø–ª–∞—Ç–Ω–æ, –∫ –æ—Ç–µ–ª—é –∏–ª–∏ –ª—é–±–æ–π —Ç–æ—á–∫–µ\n"
    "- –®–ª–µ–º—ã –≤–∫–ª—é—á–µ–Ω—ã (1-2 —à—Ç)\n"
    "- –î–ª—è —Å–∫—É—Ç–µ—Ä–æ–≤ –¥–æ 125—Å—Å –ø—Ä–∞–≤–∞ –Ω–µ —Ç—Ä–µ–±—É—é—Ç—Å—è\n"
    "- –î–ª—è –º–æ—Ç–æ—Ü–∏–∫–ª–æ–≤ –æ—Ç 150—Å—Å —Ä–µ–∫–æ–º–µ–Ω–¥—É—é—Ç—Å—è –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ –ø—Ä–∞–≤–∞ –∫–∞—Ç. A\n"
    "- –ü—Ä–∏ –∞—Ä–µ–Ω–¥–µ –æ—Ç –º–µ—Å—è—Ü–∞ ‚Äî —Å–∫–∏–¥–∫–∞ (–ø–æ–º–µ—Å—è—á–Ω—ã–π —Ç–∞—Ä–∏—Ñ)\n"
    "- –ë–µ–Ω–∑–∏–Ω: –∫–ª–∏–µ–Ω—Ç –∑–∞–ø—Ä–∞–≤–ª—è–µ—Ç —Å–∞–º (–∑–∞–ø—Ä–∞–≤–∫–∏ –≤–µ–∑–¥–µ, 25-30k/–ª–∏—Ç—Ä)\n"
    "- –í–æ–∑–≤—Ä–∞—Ç: –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è, –∑–∞–ª–æ–≥ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–∏ –∏—Å–ø—Ä–∞–≤–Ω–æ–º –¢–°\n"
    "\n=== –°–ü–†–ê–í–ö–ê –ü–û –ú–û–î–ï–õ–Ø–ú ===\n"
    "Honda AirBlade 125: –∞–≤—Ç–æ–º–∞—Ç, 125—Å—Å, —Ä–∞—Å—Ö–æ–¥ ~2–ª/100–∫–º, –ª–µ–≥–∫–∏–π, –¥–ª—è –≥–æ—Ä–æ–¥–∞\n"
    "Honda Vision 110: –∞–≤—Ç–æ–º–∞—Ç, 110—Å—Å, —Å–∞–º—ã–π —ç–∫–æ–Ω–æ–º–∏—á–Ω—ã–π, –¥–ª—è –æ–¥–Ω–æ–≥–æ\n"
    "Honda Lead 125: –∞–≤—Ç–æ–º–∞—Ç, 125—Å—Å, –±–æ–ª—å—à–æ–π –±–∞–≥–∞–∂–Ω–∏–∫, –¥–ª—è –¥–≤–æ–∏—Ö\n"
    "Honda SH 125/150: –∞–≤—Ç–æ–º–∞—Ç, –ø—Ä–µ–º–∏—É–º —Å–∫—É—Ç–µ—Ä, –æ—á–µ–Ω—å –∫–æ–º—Ñ–æ—Ä—Ç–Ω—ã–π\n"
    "Honda Click 125/150: –∞–≤—Ç–æ–º–∞—Ç, —Å–ø–æ—Ä—Ç–∏–≤–Ω—ã–π —Å–∫—É—Ç–µ—Ä, –º–æ—â–Ω—ã–π\n"
    "Honda PCX 125/150: –∞–≤—Ç–æ–º–∞—Ç, –ø—Ä–µ–º–∏—É–º, —Ç–∏—Ö–∏–π, —ç–∫–æ–Ω–æ–º–∏—á–Ω—ã–π\n"
    "Yamaha NVX 125/155: –∞–≤—Ç–æ–º–∞—Ç, —Å–ø–æ—Ä—Ç–∏–≤–Ω—ã–π, –º–æ–ª–æ–¥—ë–∂–Ω—ã–π –¥–∏–∑–∞–π–Ω\n"
    "Yamaha Nouvo: –∞–≤—Ç–æ–º–∞—Ç, –∫–ª–∞—Å—Å–∏–∫–∞, –Ω–∞–¥—ë–∂–Ω—ã–π, –¥–ª—è –≥–æ—Ä–æ–¥–∞\n"
    "Yamaha Exciter 150: –ø–æ–ª—É–∞–≤—Ç–æ–º–∞—Ç, 150—Å—Å, —Å–ø–æ—Ä—Ç–∏–≤–Ω—ã–π, –º–æ—â–Ω—ã–π\n"
    "Honda Winner/Yamaha Exciter: –º–æ—Ç–æ, 150—Å—Å, –¥–ª—è –æ–ø—ã—Ç–Ω—ã—Ö, –±—ã—Å—Ç—Ä—ã–π\n"
    "Honda CB/Yamaha FZ: –Ω–µ–π–∫–µ–¥ –º–æ—Ç–æ, –æ—Ç 150—Å—Å, –¥–ª—è –∑–∞–≥–æ—Ä–æ–¥–Ω—ã—Ö –ø–æ–µ–∑–¥–æ–∫\n"
    "\n=== FAQ ===\n"
    "- –î–ª—è –≥–æ—Ä–æ–¥–∞ –∏ –ø–ª—è–∂–∞: —Å–∫—É—Ç–µ—Ä 110-125—Å—Å (—Å–∞–º—ã–π –ø–æ–ø—É–ª—è—Ä–Ω—ã–π –≤—ã–±–æ—Ä)\n"
    "- –î–ª—è –¥–≤–æ–∏—Ö: –æ—Ç 125—Å—Å (AirBlade, Lead, NVX)\n"
    "- –î–ª—è –ø–æ–µ–∑–¥–æ–∫ –∑–∞ –≥–æ—Ä–æ–¥: –º–æ—Ç–æ—Ü–∏–∫–ª –æ—Ç 150—Å—Å –∏–ª–∏ –∞–≤—Ç–æ\n"
    "- –î–ª—è —ç–∫–æ–Ω–æ–º–∏–∏: –ø–æ—Å—É—Ç–æ—á–Ω–∞—è –∞—Ä–µ–Ω–¥–∞ –ø—Ä–∏ –∫–æ—Ä–æ—Ç–∫–æ–º —Å—Ä–æ–∫–µ, –ø–æ–º–µ—Å—è—á–Ω–∞—è –ø—Ä–∏ –¥–ª–∏–Ω–Ω–æ–º\n"
    "- –¢–æ–ø–ª–∏–≤–æ: –ø–æ–ª–Ω—ã–π –±–∞–∫ –Ω–∞ —Å–∫—É—Ç–µ—Ä–µ = 4-5–ª = ~120-150k VND, —Ö–≤–∞—Ç–∞–µ—Ç –Ω–∞ 150-200–∫–º\n"
    "\n=== –ö–ê–¢–ê–õ–û–ì (—Å–≤–æ–±–æ–¥–Ω—ã–µ) ===\n"
    (build-catalog)))

;; ‚îÄ‚îÄ Demo mode (–±–µ–∑ API –∫–ª—é—á–∞) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

(defn- fmt-bike
  "–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –±–∞–π–∫ –¥–ª—è –≤—ã–≤–æ–¥–∞"
  [b]
  (str "‚Ä¢ " (:name b) " ‚Äî " (or (:daily_rate b) "?") "k/–¥–µ–Ω—å"
       (when (:monthly_rate b) (str " (" (:monthly_rate b) "k/–º–µ—Å)"))))

(defn- min-price
  "–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"
  [bikes]
  (when (seq bikes)
    (apply min (keep :daily_rate bikes))))

(defn- match-any?
  "–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è –ª–∏ —Ö–æ—Ç—å –æ–¥–Ω–æ –∏–∑ —Å–ª–æ–≤ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏"
  [msg words]
  (some #(str/includes? msg %) words))

(defn- demo-response [user-message]
  "–£–º–Ω—ã–π –º–æ–∫-–æ—Ç–≤–µ—Ç –±–µ–∑ AI ‚Äî –ø–æ–¥–±–∏—Ä–∞–µ—Ç –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º –∏–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ë–î"
  (let [msg       (str/lower-case user-message)
        bikes     (models/list-bikes "available")
        scooters  (filter #(= "scooter" (:category %)) bikes)
        motos     (filter #(= "bike" (:category %)) bikes)
        cars      (filter #(= "car" (:category %)) bikes)
        bicycles  (filter #(= "bicycle" (:category %)) bikes)
        cheap     (filter #(and (:daily_rate %) (<= (:daily_rate %) 250)) bikes)
        mid-range (filter #(and (:daily_rate %) (> (:daily_rate %) 250) (<= (:daily_rate %) 500)) bikes)
        expensive (filter #(and (:daily_rate %) (> (:daily_rate %) 500)) bikes)]
    (cond
      ;; ‚îÄ‚îÄ –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è ‚îÄ‚îÄ
      (match-any? msg ["–ø—Ä–∏–≤–µ—Ç" "hello" "hi " "–∑–¥—Ä–∞–≤—Å—Ç–≤" "–¥–æ–±—Ä—ã–π" "—Ö–∞–π" "hey"])
      (str "–ü—Ä–∏–≤–µ—Ç! üëã –Ø –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç Karma Rent –≤ –ù—è—á–∞–Ω–≥–µ.\n"
           "–£ –Ω–∞—Å " (count bikes) " —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤: "
           (count scooters) " —Å–∫—É—Ç–µ—Ä–æ–≤, " (count motos) " –º–æ—Ç–æ—Ü–∏–∫–ª–æ–≤"
           (when (pos? (count cars)) (str ", " (count cars) " –∞–≤—Ç–æ"))
           (when (pos? (count bicycles)) (str ", " (count bicycles) " –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤"))
           ".\n\n–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ —á—Ç–æ –∏—â–µ—Ç–µ ‚Äî –ø–æ–¥–±–µ—Ä—É –ª—É—á—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç!")

      ;; ‚îÄ‚îÄ –ë—é–¥–∂–µ—Ç–Ω—ã–µ ‚îÄ‚îÄ
      (match-any? msg ["–¥–µ—à–µ–≤" "–±—é–¥–∂–µ—Ç" "cheap" "–Ω–µ–¥–æ—Ä–æ–≥" "—ç–∫–æ–Ω–æ–º" "budget" "–ø–æ–¥–µ—à–µ–≤–ª"])
      (if (seq cheap)
        (str "–ë—é–¥–∂–µ—Ç–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã (–¥–æ 250k/–¥–µ–Ω—å):\n"
             (str/join "\n" (map fmt-bike (take 4 (sort-by :daily_rate cheap))))
             "\n\n–û—Ç–ª–∏—á–Ω—ã–π –≤—ã–±–æ—Ä –¥–ª—è –≥–æ—Ä–æ–¥–∞! –ó–∞–ª–æ–≥ ‚Äî $100. –î–æ—Å—Ç–∞–≤–∫–∞ –±–µ—Å–ø–ª–∞—Ç–Ω–æ üõµ")
        "–°–µ–π—á–∞—Å –≤—Å–µ –±—é–¥–∂–µ—Ç–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∑–∞–Ω—è—Ç—ã, –Ω–æ —Å–∫–æ—Ä–æ –æ—Å–≤–æ–±–æ–¥—è—Ç—Å—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ!")

      ;; ‚îÄ‚îÄ –ì–æ—Ä–æ–¥ / –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –ø–æ–µ–∑–¥–∫–∏ ‚îÄ‚îÄ
      (match-any? msg ["–≥–æ—Ä–æ–¥" "daily" "–µ–∂–µ–¥–Ω" "–ø–æ –≥–æ—Ä–æ–¥" "–≤ –≥–æ—Ä–æ–¥" "–ø–æ–∫–∞—Ç–∞—Ç—å" "city"])
      (let [city-bikes (or (seq (concat (take 2 (sort-by :daily_rate scooters))
                                        (take 1 (sort-by :daily_rate motos))))
                           (take 3 (sort-by :daily_rate bikes)))]
        (str "–î–ª—è –≥–æ—Ä–æ–¥–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É—é:\n"
             (str/join "\n" (map fmt-bike city-bikes))
             "\n\n–°–∫—É—Ç–µ—Ä—ã ‚Äî –∏–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –ù—è—á–∞–Ω–≥–∞: –ª–µ–≥–∫–æ –ø–∞—Ä–∫–æ–≤–∞—Ç—å—Å—è, —ç–∫–æ–Ω–æ–º–∏—á–Ω—ã–µ. –ó–∞–ª–æ–≥ $100."))

      ;; ‚îÄ‚îÄ –î–≤–æ–µ / –ø–∞—Ä–∞ ‚îÄ‚îÄ
      (match-any? msg ["–¥–≤–æ–∏—Ö" "–¥–≤–æ–µ–º" "–ø–∞—Ä–∞" "–≤–¥–≤–æ" "couple" "two people" "2 —á–µ–ª–æ–≤"])
      (let [for-two (or (seq (filter #(and (:daily_rate %) (>= (:daily_rate %) 200))
                                     (concat scooters motos)))
                        (take 3 bikes))]
        (str "–î–ª—è –¥–≤–æ–∏—Ö –ø–æ–¥–æ–π–¥—É—Ç:\n"
             (str/join "\n" (map fmt-bike (take 4 (sort-by :daily_rate for-two))))
             "\n\n–î–ª—è –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ–π –µ–∑–¥—ã –≤–¥–≤–æ—ë–º –ª—É—á—à–µ –æ—Ç 125—Å—Å. –®–ª–µ–º—ã –≤ –∫–æ–º–ø–ª–µ–∫—Ç–µ! üèç"))

      ;; ‚îÄ‚îÄ –°–∫—É—Ç–µ—Ä—ã ‚îÄ‚îÄ
      (match-any? msg ["—Å–∫—É—Ç–µ—Ä" "scooter" "–º–æ–ø–µ–¥"])
      (if (seq scooters)
        (str "–°–∫—É—Ç–µ—Ä—ã –≤ –Ω–∞–ª–∏—á–∏–∏:\n"
             (str/join "\n" (map fmt-bike (sort-by :daily_rate scooters)))
             "\n\n–°–∞–º—ã–π –ø–æ–ø—É–ª—è—Ä–Ω—ã–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –≤ –ù—è—á–∞–Ω–≥–µ! –ó–∞–ª–æ–≥ $100, –¥–æ—Å—Ç–∞–≤–∫–∞ –±–µ—Å–ø–ª–∞—Ç–Ω–æ.")
        "–°–µ–π—á–∞—Å –≤—Å–µ —Å–∫—É—Ç–µ—Ä—ã –∑–∞–Ω—è—Ç—ã. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –º–æ—Ç–æ—Ü–∏–∫–ª—ã ‚Äî –µ—Å—Ç—å –ª—ë–≥–∫–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã!")

      ;; ‚îÄ‚îÄ –ú–æ—Ç–æ—Ü–∏–∫–ª—ã / –º–æ—â–Ω—ã–µ ‚îÄ‚îÄ
      (match-any? msg ["–º–æ—Ç–æ" "–º–æ—â–Ω" "–ø—Ä–µ–º–∏—É–º" "big" "–±–æ–ª—å—à–æ–π" "motorcycle" "—Å–ø–æ—Ä—Ç" "sport"])
      (if (seq motos)
        (str "–ú–æ—Ç–æ—Ü–∏–∫–ª—ã:\n"
             (str/join "\n" (map fmt-bike (sort-by :daily_rate motos)))
             "\n\n–ó–∞–ª–æ–≥ –Ω–∞ –ø—Ä–µ–º–∏—É–º –º–æ—Ç–æ—Ü–∏–∫–ª—ã ‚Äî $200. –î–æ—Å—Ç–∞–≤–∫–∞ –±–µ—Å–ø–ª–∞—Ç–Ω–æ –ø–æ –ù—è—á–∞–Ω–≥—É!")
        "–°–µ–π—á–∞—Å –º–æ—Ç–æ—Ü–∏–∫–ª—ã –∑–∞–Ω—è—Ç—ã. –ó–∞–≥–ª—è–Ω–∏—Ç–µ –ø–æ–∑–∂–µ!")

      ;; ‚îÄ‚îÄ –ê–≤—Ç–æ–º–æ–±–∏–ª–∏ ‚îÄ‚îÄ
      (match-any? msg ["–º–∞—à–∏–Ω" "–∞–≤—Ç–æ" "car" "–∞–≤—Ç–æ–º–æ–±–∏–ª" "–∫—Ä–æ—Å—Å–æ–≤–µ—Ä" "–¥–∂–∏–ø" "suv"])
      (if (seq cars)
        (str "–ê–≤—Ç–æ–º–æ–±–∏–ª–∏ –≤ –Ω–∞–ª–∏—á–∏–∏:\n"
             (str/join "\n" (map fmt-bike (sort-by :daily_rate cars)))
             "\n\n–ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –ø–æ–µ–∑–¥–æ–∫ –∑–∞ –≥–æ—Ä–æ–¥ –∏–ª–∏ —Å–µ–º–µ–π–Ω—ã—Ö –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–π!")
        "–°–µ–π—á–∞—Å –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –∑–∞–Ω—è—Ç—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ!")

      ;; ‚îÄ‚îÄ –í–µ–ª–æ—Å–∏–ø–µ–¥—ã ‚îÄ‚îÄ
      (match-any? msg ["–≤–µ–ª–æ—Å–∏–ø–µ–¥" "bicycle" "–≤–µ–ª–∏–∫" "bike" "–ø–µ–¥–∞–ª"])
      (if (seq bicycles)
        (str "–í–µ–ª–æ—Å–∏–ø–µ–¥—ã:\n"
             (str/join "\n" (map fmt-bike (sort-by :daily_rate bicycles)))
             "\n\n–ü—Ä–µ–∫—Ä–∞—Å–Ω—ã–π –≤—ã–±–æ—Ä –¥–ª—è –ø—Ä–æ–≥—É–ª–æ–∫ –ø–æ –Ω–∞–±–µ—Ä–µ–∂–Ω–æ–π!")
        "–°–µ–π—á–∞—Å –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤ –Ω–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏.")

      ;; ‚îÄ‚îÄ –¶–µ–Ω—ã ‚îÄ‚îÄ
      (match-any? msg ["—Ü–µ–Ω" "price" "—Å—Ç–æ–∏" "—Å–∫–æ–ª—å–∫" "–ø—Ä–∞–π—Å" "cost" "how much" "tarif" "—Ç–∞—Ä–∏—Ñ"])
      (str "–ù–∞—à–∏ —Ü–µ–Ω—ã (–≤ –¥–µ–Ω—å):\n"
           (when (seq scooters)  (str "üõµ –°–∫—É—Ç–µ—Ä—ã: –æ—Ç " (min-price scooters) "k\n"))
           (when (seq motos)     (str "üèç –ú–æ—Ç–æ—Ü–∏–∫–ª—ã: –æ—Ç " (min-price motos) "k\n"))
           (when (seq cars)      (str "üöó –ê–≤—Ç–æ: –æ—Ç " (min-price cars) "k\n"))
           (when (seq bicycles)  (str "üö≤ –í–µ–ª–æ—Å–∏–ø–µ–¥—ã: –æ—Ç " (min-price bicycles) "k\n"))
           "\n–°–∫–∏–¥–∫–∏ –ø—Ä–∏ –∞—Ä–µ–Ω–¥–µ –æ—Ç –º–µ—Å—è—Ü–∞! –ù–∞–∂–º–∏—Ç–µ ¬´üìã –ö–∞—Ç–∞–ª–æ–≥¬ª –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞.")

      ;; ‚îÄ‚îÄ –î–æ–ª–≥–æ—Å—Ä–æ–∫ / –º–µ—Å—è—Ü ‚îÄ‚îÄ
      (match-any? msg ["–º–µ—Å—è—Ü" "month" "–¥–æ–ª–≥–æ—Å—Ä–æ–∫" "–Ω–∞–¥–æ–ª–≥–æ" "long" "–¥–ª–∏—Ç–µ–ª—å–Ω"])
      (let [monthly (filter :monthly_rate bikes)]
        (if (seq monthly)
          (str "–í–∞—Ä–∏–∞–Ω—Ç—ã —Å –ø–æ–º–µ—Å—è—á–Ω–æ–π —Ü–µ–Ω–æ–π:\n"
               (str/join "\n" (map #(str "‚Ä¢ " (:name %) " ‚Äî " (:monthly_rate %) "k/–º–µ—Å") (take 5 (sort-by :monthly_rate monthly))))
               "\n\n–ü–æ–º–µ—Å—è—á–Ω–∞—è –∞—Ä–µ–Ω–¥–∞ –≤—ã–≥–æ–¥–Ω–µ–µ! –ó–∞–ª–æ–≥ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π.")
          "–ü–æ–º–µ—Å—è—á–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã –¥–æ—Å—Ç—É–ø–Ω—ã ‚Äî –Ω–∞–∂–º–∏—Ç–µ ¬´üìã –ö–∞—Ç–∞–ª–æ–≥¬ª –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç."))

      ;; ‚îÄ‚îÄ –ù–µ–¥–µ–ª—è ‚îÄ‚îÄ
      (match-any? msg ["–Ω–µ–¥–µ–ª" "week" "7 –¥–Ω–µ–π" "—Å–µ–º—å –¥–Ω–µ–π"])
      (let [good (take 4 (sort-by :daily_rate bikes))]
        (str "–ù–∞ –Ω–µ–¥–µ–ª—é —Ä–µ–∫–æ–º–µ–Ω–¥—É—é:\n"
             (str/join "\n" (map fmt-bike good))
             "\n\n–ù–∞ –Ω–µ–¥–µ–ª—é –¥–µ–π—Å—Ç–≤—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ç–∞—Ä–∏—Ñ. –ü—Ä–∏ –∞—Ä–µ–Ω–¥–µ –æ—Ç –º–µ—Å—è—Ü–∞ ‚Äî —Å–∫–∏–¥–∫–∞!"))

      ;; ‚îÄ‚îÄ –ó–∞–ª–æ–≥ / –¥–µ–ø–æ–∑–∏—Ç ‚îÄ‚îÄ
      (match-any? msg ["–∑–∞–ª–æ–≥" "deposit" "–¥–µ–ø–æ–∑–∏—Ç" "–≥–∞—Ä–∞–Ω—Ç"])
      "–ó–∞–ª–æ–≥: $100 –Ω–∞ —Å–∫—É—Ç–µ—Ä—ã –∏ –±–∞–π–∫–∏, $200 –Ω–∞ –ø—Ä–µ–º–∏—É–º –º–æ—Ç–æ—Ü–∏–∫–ª—ã. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ –≤ –∏—Å–ø—Ä–∞–≤–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏."

      ;; ‚îÄ‚îÄ –î–æ—Å—Ç–∞–≤–∫–∞ ‚îÄ‚îÄ
      (match-any? msg ["–¥–æ—Å—Ç–∞–≤–∫" "delivery" "–ø—Ä–∏–≤–µ–∑" "–ø—Ä–∏–≤–æ–∑"])
      "–î–æ—Å—Ç–∞–≤–∫–∞ –ø–æ –ù—è—á–∞–Ω–≥—É –±–µ—Å–ø–ª–∞—Ç–Ω–æ! üõµ –ü—Ä–∏–≤–µ–∑—ë–º –∫ –≤–∞—à–µ–º—É –æ—Ç–µ–ª—é –∏–ª–∏ –ª—é–±–æ–π —Ç–æ—á–∫–µ –≤ –≥–æ—Ä–æ–¥–µ."

      ;; ‚îÄ‚îÄ –î–æ–∫—É–º–µ–Ω—Ç—ã / –ø—Ä–∞–≤–∞ ‚îÄ‚îÄ
      (match-any? msg ["–ø—Ä–∞–≤" "–¥–æ–∫—É–º–µ–Ω—Ç" "license" "–≤–æ–¥–∏—Ç–µ–ª" "–∫–∞—Ç–µ–≥–æ—Ä–∏"])
      "–î–ª—è —Å–∫—É—Ç–µ—Ä–æ–≤ –¥–æ 125—Å—Å ‚Äî –ø—Ä–∞–≤–∞ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã (–ø–æ —Ñ–∞–∫—Ç—É –≤ –ù—è—á–∞–Ω–≥–µ). –î–ª—è –º–æ—Ç–æ—Ü–∏–∫–ª–æ–≤ –æ—Ç 150—Å—Å —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ –ø—Ä–∞–≤–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ A."

      ;; ‚îÄ‚îÄ –®–ª–µ–º / –∑–∞—â–∏—Ç–∞ ‚îÄ‚îÄ
      (match-any? msg ["—à–ª–µ–º" "helmet" "–∑–∞—â–∏—Ç" "–±–µ–∑–æ–ø–∞—Å–Ω"])
      "–®–ª–µ–º—ã –≤–∫–ª—é—á–µ–Ω—ã –≤ —Å—Ç–æ–∏–º–æ—Å—Ç—å –∞—Ä–µ–Ω–¥—ã ‚Äî 1-2 —à–ª–µ–º–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –≤—Å–µ–≥–¥–∞ –Ω–∞–¥–µ–≤–∞—Ç—å! üèç"

      ;; ‚îÄ‚îÄ –ë–µ–Ω–∑–∏–Ω / –∑–∞–ø—Ä–∞–≤–∫–∞ ‚îÄ‚îÄ
      (match-any? msg ["–±–µ–Ω–∑–∏–Ω" "–∑–∞–ø—Ä–∞–≤" "fuel" "gasoline" "—Ç–æ–ø–ª–∏–≤" "petrol"])
      "–ë–µ–Ω–∑–∏–Ω –∫–ª–∏–µ–Ω—Ç –∑–∞–ø—Ä–∞–≤–ª—è–µ—Ç —Å–∞–º. –ó–∞–ø—Ä–∞–≤–∫–∏ –≤–µ–∑–¥–µ –≤ –≥–æ—Ä–æ–¥–µ, 25-30k VND/–ª–∏—Ç—Ä. –ü–æ–ª–Ω—ã–π –±–∞–∫ —Å–∫—É—Ç–µ—Ä–∞ (4-5–ª) = ~120-150k, —Ö–≤–∞—Ç–∞–µ—Ç –Ω–∞ 150-200–∫–º. –í–æ–∑–≤—Ä–∞—â–∞—Ç—å —Å —Ç–µ–º –∂–µ —É—Ä–æ–≤–Ω–µ–º —Ç–æ–ø–ª–∏–≤–∞."

      ;; ‚îÄ‚îÄ –ü–ª—è–∂ / –º–æ—Ä–µ / –ø—Ä–æ–≥—É–ª–∫–∞ ‚îÄ‚îÄ
      (match-any? msg ["–ø–ª—è–∂" "beach" "–º–æ—Ä–µ" "sea" "–Ω–∞–±–µ—Ä–µ–∂–Ω" "–ø—Ä–æ–≥—É–ª" "–ø–æ–∫–∞—Ç–∞—Ç"])
      (let [easy (take 3 (sort-by :daily_rate (concat scooters bicycles)))]
        (str "–î–ª—è –ø–ª—è–∂–∞ –∏ –Ω–∞–±–µ—Ä–µ–∂–Ω–æ–π:\n"
             (str/join "\n" (map fmt-bike easy))
             "\n\n–°–∫—É—Ç–µ—Ä ‚Äî –∏–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π –º–µ–∂–¥—É –ø–ª—è–∂–∞–º–∏. –í–µ–ª–æ—Å–∏–ø–µ–¥ ‚Äî –¥–ª—è –Ω–µ—Å–ø–µ—à–Ω—ã—Ö –ø—Ä–æ–≥—É–ª–æ–∫ –ø–æ –Ω–∞–±–µ—Ä–µ–∂–Ω–æ–π!"))

      ;; ‚îÄ‚îÄ –°–µ–º—å—è / –¥–µ—Ç–∏ ‚îÄ‚îÄ
      (match-any? msg ["—Å–µ–º—å" "famil" "–¥–µ—Ç" "child" "—Ä–µ–±—ë–Ω" "kids"])
      (if (seq cars)
        (str "–î–ª—è —Å–µ–º—å–∏ —Å –¥–µ—Ç—å–º–∏ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º –∞–≤—Ç–æ–º–æ–±–∏–ª—å:\n"
             (str/join "\n" (map fmt-bike (sort-by :daily_rate cars)))
             "\n\n–ë–µ–∑–æ–ø–∞—Å–Ω–æ –∏ –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ –¥–ª—è –ø–æ–µ–∑–¥–æ–∫ —Å –¥–µ—Ç—å–º–∏!")
        "–î–ª—è —Å–µ–º—å–∏ —Å –¥–µ—Ç—å–º–∏ –ª—É—á—à–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—å, –Ω–æ —Å–µ–π—á–∞—Å –≤—Å–µ –∑–∞–Ω—è—Ç—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ ‚Äî –ø–æ–¥–±–µ—Ä—ë–º –≤–∞—Ä–∏–∞–Ω—Ç!")

      ;; ‚îÄ‚îÄ –°–ø–∞—Å–∏–±–æ / –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å ‚îÄ‚îÄ
      (match-any? msg ["—Å–ø–∞—Å–∏–±" "thank" "–±–ª–∞–≥–æ–¥–∞—Ä" "thanks"])
      "–†–∞–¥ –ø–æ–º–æ—á—å! üòä –ï—Å–ª–∏ –Ω—É–∂–Ω–æ —á—Ç–æ-—Ç–æ –µ—â—ë ‚Äî –ø–∏—à–∏—Ç–µ. –•–æ—Ä–æ—à–µ–≥–æ –¥–Ω—è –≤ –ù—è—á–∞–Ω–≥–µ!"

      ;; ‚îÄ‚îÄ English greetings ‚îÄ‚îÄ
      (match-any? msg ["want to rent" "looking for" "need a" "i want" "can i"])
      (str "Welcome to Karma Rent! üõµ\n"
           "We have " (count bikes) " vehicles available in Nha Trang.\n"
           "Scooters from " (or (min-price scooters) "?") "k/day, motorbikes from " (or (min-price motos) "?") "k/day.\n"
           "Tell me what you need ‚Äî I'll find the best option! Or tap ¬´üìã –ö–∞—Ç–∞–ª–æ–≥¬ª.")

      ;; ‚îÄ‚îÄ Default ‚îÄ‚îÄ
      :else
      (str "–£ –Ω–∞—Å " (count bikes) " —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤:\n"
           (when (seq scooters) (str "üõµ " (count scooters) " —Å–∫—É—Ç–µ—Ä–æ–≤ (–æ—Ç " (min-price scooters) "k/–¥–µ–Ω—å)\n"))
           (when (seq motos)    (str "üèç " (count motos) " –º–æ—Ç–æ—Ü–∏–∫–ª–æ–≤ (–æ—Ç " (min-price motos) "k/–¥–µ–Ω—å)\n"))
           (when (seq cars)     (str "üöó " (count cars) " –∞–≤—Ç–æ (–æ—Ç " (min-price cars) "k/–¥–µ–Ω—å)\n"))
           (when (seq bicycles) (str "üö≤ " (count bicycles) " –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤ (–æ—Ç " (min-price bicycles) "k/–¥–µ–Ω—å)\n"))
           "\n–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ —á—Ç–æ –∏—â–µ—Ç–µ ‚Äî –ø–æ–¥–±–µ—Ä—É –ª—É—á—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç! –ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ ¬´üìã –ö–∞—Ç–∞–ª–æ–≥¬ª."))))

;; ‚îÄ‚îÄ Claude API call ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

(defn- call-claude [chat-id user-message]
  "–í—ã–∑–æ–≤ Claude API. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç –∏–ª–∏ nil."
  (let [api-key (config/anthropic-api-key)]
    (when (and api-key (not (str/blank? api-key)))
      (add-message! chat-id "user" user-message)
      (try
        (let [history (get @conversations chat-id [])
              resp (http/post "https://api.anthropic.com/v1/messages"
                     {:headers {"x-api-key"         api-key
                                "anthropic-version"  "2023-06-01"
                                "content-type"       "application/json"}
                      :body (json/generate-string
                              {:model      "claude-haiku-4-5-20251001"
                               :max_tokens 400
                               :system     (system-prompt)
                               :messages   history})
                      :throw-exceptions false
                      :socket-timeout    10000
                      :connection-timeout 5000})]
          (if (= 200 (:status resp))
            (let [body (json/parse-string (:body resp) true)
                  text (get-in body [:content 0 :text])]
              (add-message! chat-id "assistant" text)
              text)
            (do
              (println "AI API error:" (:status resp) (:body resp))
              nil)))
        (catch Exception e
          (println "AI consult exception:" (.getMessage e))
          nil)))))

;; ‚îÄ‚îÄ Public API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

(defn consult
  "–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞. –ü—Ä–æ–±—É–µ—Ç Claude API, fallback –Ω–∞ demo mode.
   –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –∏–ª–∏ nil (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–æ–≤—Å–µ–º –Ω–∏—á–µ–≥–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)."
  [chat-id user-message]
  (or (call-claude chat-id user-message)
      (demo-response user-message)))

(defn enabled?
  "–ï—Å—Ç—å –ª–∏ API –∫–ª—é—á (true = –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π AI, false = demo —Ä–µ–∂–∏–º)"
  []
  (let [k (config/anthropic-api-key)]
    (and k (not (str/blank? k)))))
