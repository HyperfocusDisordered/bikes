{
  "updatedAt": "2026-02-28T18:59:53.489Z",
  "createdAt": "2026-02-20T13:11:32.879Z",
  "id": "rC30SNQvTZG9Zhza",
  "name": "Karma_Rent_Workers",
  "description": null,
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "tableId": "Message_Buffer",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "user_id",
              "fieldValue": "={{ $json.sender }}"
            },
            {
              "fieldId": "message",
              "fieldValue": "={{ $json.message }}"
            },
            {
              "fieldId": "message_id",
              "fieldValue": "={{ $('Webhook').item.json.body.metadata.messageId }}"
            },
            {
              "fieldId": "timestamp",
              "fieldValue": "={{ $('Webhook').item.json.body.metadata.timestamp }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        1168,
        -304
      ],
      "id": "e56ae42c-9d2b-49f8-9e59-2353f6f874a6",
      "name": "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π",
      "credentials": {
        "supabaseApi": {
          "id": "u1mkv2sS5oh337qr",
          "name": "Supabase Karma_Worker"
        }
      }
    },
    {
      "parameters": {
        "content": "–°–±–æ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞\n\n*¬†–ó–∞–ø–æ–º–∏–Ω–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è. –≤ —Ç–µ—á–µ–Ω–∏–∏ 10 —Å–µ–∫, –∏ –æ—Ç–≤–µ—á–∞–µ—Ç. –Ω–∞ –≤—Å–µ, –∞ –Ω–µ –ø–æ –æ–¥–Ω–æ–º—É",
        "height": 500,
        "width": 1896,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1120,
        -400
      ],
      "typeVersion": 1,
      "id": "50e9a8b6-46c8-4d74-babe-d3fe334e6ef6",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "sortFieldsUi": {
          "sortField": [
            {
              "fieldName": "timestamp",
              "order": "=ascending"
            }
          ]
        },
        "options": {}
      },
      "id": "3d1be0b3-5910-43eb-93df-57777209f978",
      "name": "Sort by Message ID",
      "type": "n8n-nodes-base.sort",
      "position": [
        1904,
        -176
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "Message_Buffer",
        "filters": {
          "conditions": [
            {
              "keyName": "user_id",
              "condition": "eq",
              "keyValue": "={{ $('Webhook').item.json.body.metadata.remoteJid }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        1648,
        -304
      ],
      "id": "5639a0b2-3528-445d-a6b2-04bdcc0196f6",
      "name": "–ë–µ—Ä–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è",
      "credentials": {
        "supabaseApi": {
          "id": "u1mkv2sS5oh337qr",
          "name": "Supabase Karma_Worker"
        }
      }
    },
    {
      "parameters": {
        "amount": 3
      },
      "id": "b7b93f28-25b0-4a6c-88dd-65462f02d4a3",
      "name": "Wait 10 Seconds",
      "type": "n8n-nodes-base.wait",
      "position": [
        1408,
        -144
      ],
      "webhookId": "87994c9a-fd20-48b6-8dbe-9af36dc40b2f",
      "typeVersion": 1.1
    },
    {
      "parameters": {},
      "id": "7ca8e5ed-45ee-4e10-9fc9-621725de64c3",
      "name": "No Operation, do nothing",
      "type": "n8n-nodes-base.noOp",
      "position": [
        2480,
        -112
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "–°–±–æ—Ä –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π\n* –°–≤–≤–µ—Ä–∫–∞ —Å CRM\n* —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ ",
        "height": 632,
        "width": 1016,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1472,
        160
      ],
      "typeVersion": 1,
      "id": "9bd44ad0-6c47-40fe-b3ec-e6c8e6caa529",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Inject State').first().json.message + '\\n\\n–î–ê–ù–ù–´–ï –¢–†–ê–ù–°–ü–û–†–¢–ê (–∞–∫—Ç—É–∞–ª—å–Ω—ã–µ):\\n\\n–ë–ê–ô–ö–ò:\\n' + (($json.bikes && $json.bikes.length > 0 && $json.bikes[0]['–ë–∞–π–∫']) ? $json.bikes.map((b, i) => (i+1) + '. ' + b['–ë–∞–π–∫'] + ' ‚Äî ' + b['–ö–ª–∞—Å—Å'] + ', ' + b['–¶–µ–Ω–∞/—Å—É—Ç–∫–∏'] + ' VND/—Å—É—Ç–∫–∏, —Å—Å—ã–ª–∫–∞: ' + b['–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ç–∞–ª–æ–≥']).join('\\n') + '\\n–ò–¢–û–ì–û –ë–ê–ô–ö–û–í: ' + $json.bikes.length : '–í—Å–µ –±–∞–π–∫–∏ –∑–∞–Ω—è—Ç—ã. –ù–∞ –¥–Ω—è—Ö –±—É–¥—É—Ç!') + '\\n\\n–ê–í–¢–û:\\n' + (($json.cars && $json.cars.length > 0 && $json.cars[0]['–ù–∞–∑–≤–∞–Ω–∏–µ']) ? $json.cars.map((c, i) => (i+1) + '. ' + c['–ù–∞–∑–≤–∞–Ω–∏–µ'] + ' ‚Äî ' + c['–ö–ª–∞—Å—Å'] + ', ' + c['–¶–µ–Ω–∞/—Å—É—Ç–∫–∏'] + ' VND/—Å—É—Ç–∫–∏, —Å—Å—ã–ª–∫–∞: ' + c['–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ç–∞–ª–æ–≥']).join('\\n') + '\\n–ò–¢–û–ì–û –ê–í–¢–û: ' + $json.cars.length : '–í—Å–µ –∞–≤—Ç–æ –∑–∞–Ω—è—Ç—ã.') + '\\n\\n–í–ï–õ–û–°–ò–ü–ï–î–´:\\n' + (($json.bicycles && $json.bicycles.length > 0 && $json.bicycles[0]['–ù–∞–∑–≤–∞–Ω–∏–µ']) ? $json.bicycles.map((v, i) => (i+1) + '. ' + v['–ù–∞–∑–≤–∞–Ω–∏–µ'] + ' ‚Äî ' + v['–ö–ª–∞—Å—Å'] + ', ' + v['–¶–µ–Ω–∞/—Å—É—Ç–∫–∏'] + ' VND/—Å—É—Ç–∫–∏, —Å—Å—ã–ª–∫–∞: ' + v['–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ç–∞–ª–æ–≥']).join('\\n') + '\\n–ò–¢–û–ì–û –í–ï–õ–û: ' + $json.bicycles.length : '–í—Å–µ –≤–µ–ª–æ—Å–∏–ø–µ–¥—ã –∑–∞–Ω—è—Ç—ã.') + '\\n\\nüî¥ –ü–û–ö–ê–ñ–ò –í–°–ï –µ–¥–∏–Ω–∏—Ü—ã –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ! –ï—Å–ª–∏ –ò–¢–û–ì–û=9, –ø–æ–∫–∞–∂–∏ 9. –ù–µ –ø—Ä–æ–ø—É—Å–∫–∞–π!\\nüî¥ –Ø–ó–´–ö: –æ—Ç–≤–µ—á–∞–π –Ω–∞ —è–∑—ã–∫–µ –∫–ª–∏–µ–Ω—Ç–∞! English ‚Üí English.\\nüî¥ –ù–ï –ø–µ—Ä–µ—á–∏—Å–ª—è–π –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ —Å–ø–∏—Å–∫–æ–º.\\nüî¥ –í–´–ë–û–†: –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –≥–æ–≤–æ—Ä–∏—Ç \"–±–µ—Ä—É X\" ‚Äî –∑–∞–ø–∏—à–∏ \"–±–∞–π–∫\"=–Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ –≤ STATE! –ù–µ –æ—Å—Ç–∞–≤–ª—è–π \"?\".\\nüî¥ –ü–†–ò–í–ï–¢–°–¢–í–ò–ï: –µ—Å–ª–∏ [—ç—Ç–∞–ø: –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ] –ò –∫–ª–∏–µ–Ω—Ç –ù–ï —É–∫–∞–∑–∞–ª —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç ‚Üí —Å–ø—Ä–æ—Å–∏ \"–±–∞–π–∫, –∞–≤—Ç–æ –∏–ª–∏ –≤–µ–ª–æ—Å–∏–ø–µ–¥?\" –ë–ï–ó –∫–∞—Ç–∞–ª–æ–≥–∞. –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –£–ñ–ï —Å–∫–∞–∑–∞–ª —á—Ç–æ —Ö–æ—á–µ—Ç (–∞–≤—Ç–æ/–±–∞–π–∫/–≤–µ–ª–æ) ‚Üí –ù–ï –ø–µ—Ä–µ—Å–ø—Ä–∞—à–∏–≤–∞–π, –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ —É—Ç–æ—á–Ω–µ–Ω–∏—é.\\n\\nüéÅüéÅüéÅ –ë–û–ù–£–°–´ ‚Äî –ü–û–°–õ–ï –ö–ê–¢–ê–õ–û–ì–ê –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –î–û–ë–ê–í–¨:\\n\"üéÅ –ë–æ–Ω—É—Å: –æ—Ç 3 –¥–Ω–µ–π ‚Äî –∫–∞—Ä—Ç–∞ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö –º–µ—Å—Ç –ù—è—á–∞–Ω–≥–∞ –∏ –î–∞–ª–∞—Ç–∞! –û—Ç 7 –¥–Ω–µ–π ‚Äî –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ üöö\"\\n–ë–µ–∑ —ç—Ç–æ–π —Å—Ç—Ä–æ–∫–∏ –æ—Ç–≤–µ—Ç –ù–ï–ü–û–õ–ù–´–ô!\\nüî¥ –ê–í–¢–û: –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –∞–≤—Ç–æ –ø—Ä–æ—Å–∏ –¢–û–õ–¨–ö–û —Ñ–æ—Ç–æ –í–£ (–≤–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–µ —É–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏–µ)! –ù–ï –ø–∞—Å–ø–æ—Ä—Ç!\\n\\n‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –≤ –∫–æ–Ω—Ü–µ –ö–ê–ñ–î–û–ì–û –æ—Ç–≤–µ—Ç–∞ –¥–æ–±–∞–≤—å STATE –±–ª–æ–∫:\\nSTATE: {\"—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç\": \"?\", \"–¥–Ω–µ–π\": \"?\", \"–ø–æ–µ–∑–¥–∫–∏\": \"?\", \"–æ–ø—ã—Ç\": \"?\", \"–±–∞–π–∫\": \"?\", \"–±–∞–π–∫_—Å—Å—ã–ª–∫–∞\": \"?\", \"—ç—Ç–∞–ø\": \"–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ\"}\\n–ó–∞–º–µ–Ω–∏ ? –Ω–∞ –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞. –ë–ï–ó –≠–¢–û–ì–û –ë–õ–û–ö–ê –û–¢–í–ï–¢ –û–¢–ö–õ–û–ù–Å–ù.' }}",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "–¢—ã –º–µ–Ω–µ–¥–∂–µ—Ä –ø–æ –∞—Ä–µ–Ω–¥–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ KarmaRent –≤ –ù—è—á–∞–Ω–≥–µ.\n–û—à–∏–±—Å—è –≥–æ—Ä–æ–¥–æ–º ‚Üí \"–ú—ã —Ä–∞–±–æ—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ –≤ –ù—è—á–∞–Ω–≥–µ.\" –ò–Ω–∞—á–µ ‚Äî –Ω–µ –Ω–∞–ø–æ–º–∏–Ω–∞–π.\n\n–°–¢–ò–õ–¨: –∂–∏–≤–æ –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ, –∫–∞–∫ —á–µ–ª–æ–≤–µ–∫ –≤ —á–∞—Ç–µ. –®—É—Ç–∫–∏, —Å–º–∞–π–ª–∏–∫–∏, —ç–º–æ—Ü–∏–∏. –ù–µ –±—É–¥—å —Ä–æ–±–æ—Ç–æ–º.\n\n–Ø–ó–´–ö: {{ $('Inject State').first().json.clientLang }}. –û–¢–í–ï–ß–ê–ô –°–¢–†–û–ì–û –ù–ê –≠–¢–û–ú –Ø–ó–´–ö–ï! –ï—Å–ª–∏ —è–∑—ã–∫ ‚â† –†—É—Å—Å–∫–∏–π ‚Äî –ø–µ—Ä–µ–≤–µ–¥–∏ –í–°–Å: –æ–ø–∏—Å–∞–Ω–∏—è, –±–æ–Ω—É—Å—ã, –≤–æ–ø—Ä–æ—Å—ã. –ù–∏ –æ–¥–Ω–æ–≥–æ —Ä—É—Å—Å–∫–æ–≥–æ —Å–ª–æ–≤–∞!\n\n\n–†–ê–°–ü–û–ó–ù–ê–í–ê–ù–ò–ï –û–ü–´–¢–ê:\n–û–ø—ã—Ç –ï–°–¢–¨: \"–¥–∞/—É–≥—É/–∞–≥–∞/–µ—Å—Ç—å/–∫–æ–Ω–µ—á–Ω–æ/yes/years/c√≥/–ø—Ä–∞–≤–∞ –µ—Å—Ç—å/–∑–∞ —Ä—É–ª–µ–º/b·∫±ng l√°i/driving for/have a license/have license\"\n–û–ø—ã—Ç –ù–ï–¢: \"–Ω–µ—Ç/–Ω–µ—Ç—É/–ø–µ—Ä–≤—ã–π —Ä–∞–∑/no/kh√¥ng/never\"\n–ù–µ –ø–µ—Ä–µ—Å–ø—Ä–∞—à–∏–≤–∞–π. \"–∑–∞ —Ä—É–ª–µ–º –¥–∞–≤–Ω–æ\" = –µ—Å—Ç—å. \"–ø—Ä–∞–≤–∞ –µ—Å—Ç—å\" = –µ—Å—Ç—å. \"been driving\" = –µ—Å—Ç—å.\n\n–†–ê–°–ü–û–ó–ù–ê–í–ê–ù–ò–ï –ü–û–ï–ó–î–û–ö:\n–≥–æ—Ä–æ–¥: \"–ø–æ –≥–æ—Ä–æ–¥—É/in the city/city driving/trong th√†nh ph·ªë/around town/–≤ –≥–æ—Ä–æ–¥–µ\"\n–¥–∞–ª—å–Ω–∏–µ: \"–∑–∞ –≥–æ—Ä–æ–¥/–¥–∞–ª—å–Ω–∏–µ/long distance/highway/ngo·∫°i th√†nh/long trips\"\n–ù–µ –ø—É—Ç–∞–π —Å –ù–ê–ó–í–ê–ù–ò–ï–ú –≥–æ—Ä–æ–¥–∞. \"–ø–æ –≥–æ—Ä–æ–¥—É\" = —Ç–∏–ø –ø–æ–µ–∑–¥–æ–∫, –ù–ï –∏–º—è –≥–æ—Ä–æ–¥–∞.\n\n–¢–†–ê–ù–°–ü–û–†–¢:\n- –¢–æ–ª—å–∫–æ —Å–≤–æ–±–æ–¥–Ω—ã–µ –∏–∑ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–∏–¥—É–º—ã–≤–∞—Ç—å –∑–∞–ø—Ä–µ—â–µ–Ω–æ.\n- –§–æ—Ä–º–∞—Ç: –º–æ–¥–µ–ª—å, –∫–ª–∞—Å—Å, —Ü–µ–Ω–∞/—Å—É—Ç–∫–∏, —Å—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ç–∞–ª–æ–≥.\n- üî¥ –ü–û–ö–ê–ñ–ò –í–°–ï –µ–¥–∏–Ω–∏—Ü—ã –∏–∑ –¥–∞–Ω–Ω—ã—Ö! –°–º–æ—Ç—Ä–∏ –ò–¢–û–ì–û –≤ –¥–∞–Ω–Ω—ã—Ö ‚Äî –µ—Å–ª–∏ –ò–¢–û–ì–û=9, –≤ –æ—Ç–≤–µ—Ç–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 9. –ù–µ –æ–±—Ä–µ–∑–∞–π —Å–ø–∏—Å–æ–∫!\n- –ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö –Ω—É–∂–Ω–æ–≥–æ —Ç–∏–ø–∞ ‚Üí \"–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —Å–µ–π—á–∞—Å –≤—Å–µ [—Ç–∏–ø] –∑–∞–Ω—è—Ç—ã. –ö–∞–∫ –ø–æ—è–≤—è—Ç—Å—è ‚Äî —Å–≤—è–∂–µ–º—Å—è!\"\n- –ï—Å—Ç—å –¥—Ä—É–≥–æ–π —Ç–∏–ø ‚Üí –ø—Ä–µ–¥–ª–æ–∂–∏ –∫–∞–∫ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—É.\n\n–¶–ï–ù–´: ‚ö†Ô∏è –°–¢–†–û–ì–û –∏–∑ –¥–∞–Ω–Ω—ã—Ö. –ù–ò–ö–û–ì–î–ê –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π!\n–ó–ê–ü–†–ï–©–ï–ù–û: –ø—Ä–∏–¥—É–º—ã–≤–∞—Ç—å —É—Å–ª–æ–≤–∏—è (—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞, –∑–∞–ª–æ–≥, —Ç–æ–ø–ª–∏–≤–æ). –ù–µ –∑–Ω–∞–µ—à—å ‚Üí \"–£—Ç–æ—á–Ω—é —É –º–µ–Ω–µ–¥–∂–µ—Ä–∞.\"\n\n–î–ê–ù–ù–´–ï –ö–õ–ò–ï–ù–¢–ê = –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –∏–Ω—Ñ–æ. –ù–ï –ø–µ—Ä–µ—á–∏—Å–ª—è–π –∏—Ö —Å–ø–∏—Å–∫–æ–º (\"—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç: –∞–≤—Ç–æ, –¥–Ω–µ–π: 5...\"). –ü—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–π.\n\n–ì–õ–ê–í–ù–û–ï: –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–π —Å–∫–∞–∑–∞–Ω–Ω–æ–µ. –ö–ª–∏–µ–Ω—Ç –ø–æ–º–Ω–∏—Ç, —Ç—ã –≤–∏–¥–∏—à—å –∏—Å—Ç–æ—Ä–∏—é.\n\n–ñ–Å–°–¢–ö–ò–ï –ü–†–ê–í–ò–õ–ê:\n- üî¥ –°–¢–û–ü-–ü–†–û–í–ï–†–ö–ê –ø–µ—Ä–µ–¥ –∫–∞—Ç–∞–ª–æ–≥–æ–º: —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç ‚â† \"?\", –¥–Ω–µ–π ‚â† \"?\", –ø–æ–µ–∑–¥–∫–∏ ‚â† \"?\", –æ–ø—ã—Ç ‚â† \"?\". –ï—Å–ª–∏ –õ–Æ–ë–û–ï = \"?\" ‚Üí –ó–ê–ü–†–ï–©–ï–ù–û –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫–∞—Ç–∞–ª–æ–≥. –°–ø—Ä–æ—Å–∏ –Ω–µ–¥–æ—Å—Ç–∞—é—â–µ–µ.\n- \"–ø—Ä–∞–≤–∞ –µ—Å—Ç—å\" / \"–∑–∞ —Ä—É–ª–µ–º\" / \"been driving\" / \"c√≥ b·∫±ng l√°i\" = –æ–ø—ã—Ç –ï–°–¢–¨. –ó–∞–ø–∏—à–∏ —Å—Ä–∞–∑—É, –Ω–µ —Å—Ç–∞–≤—å \"?\".\n- –ö–ª–∏–µ–Ω—Ç –¥–∞–ª –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ—Ç–≤–µ—Ç–æ–≤ —Å—Ä–∞–∑—É ‚Üí –∑–∞–ø–∏—à–∏ –≤—Å—ë, —Å–ø—Ä–æ—Å–∏ —Ç–æ–ª—å–∫–æ –Ω–µ–¥–æ—Å—Ç–∞—é—â–µ–µ.\n- –ú–∏–Ω–∏–º—É–º –∞—Ä–µ–Ω–¥—ã = 2 –¥–Ω—è. 1 –¥–µ–Ω—å ‚Üí \"–ú–∏–Ω–∏–º—É–º 2 –¥–Ω—è, –ø–æ–¥–æ–π–¥—ë—Ç?\"\n\n–≠–¢–ê–ü–´ (–æ–ø—Ä–µ–¥–µ–ª—è–π –ø–æ [—ç—Ç–∞–ø:] –≤ –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞):\n\n1. –ü–†–ò–í–ï–¢–°–¢–í–ò–ï (—ç—Ç–∞–ø = \"–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ\")\n   ‚Üí –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–∫–∞–∑–∞–ª –¢–û–õ–¨–ö–û \"–ø—Ä–∏–≤–µ—Ç/hi/hello\" ‚Äî –ø–æ–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–π –∏ –∑–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å—ã —Å–ø–∏—Å–∫–æ–º:\n     –ü—Ä–∏–º–µ—Ä: \"–ü—Ä–∏–≤–µ—Ç! üòä –î–∞–≤–∞–π—Ç–µ –ø–æ–¥–±–µ—Ä—ë–º –≤–∞–º —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç. –û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –ø–∞—Ä—É –≤–æ–ø—Ä–æ—Å–æ–≤:\n     ‚Äì –ß—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç ‚Äî –±–∞–π–∫, –∞–≤—Ç–æ –∏–ª–∏ –≤–µ–ª–æ—Å–∏–ø–µ–¥?\n     ‚Äì –ù–∞ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –∞—Ä–µ–Ω–¥—É?\n     ‚Äì –ü–æ –≥–æ—Ä–æ–¥—É –∏–ª–∏ –¥–∞–ª—å–Ω–∏–µ –ø–æ–µ–∑–¥–∫–∏?\"\n   ‚Üí –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –°–†–ê–ó–£ –Ω–∞–∑–≤–∞–ª —Ç–∏–ø —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ (\"—Ö–æ—á—É –±–∞–π–∫\", \"–∞–≤—Ç–æ\") ‚Äî –∑–∞–ø–∏—à–∏ –∏ –ø–µ—Ä–µ–π–¥–∏ –∫ —ç—Ç–∞–ø—É \"–≤—ã—è—Å–Ω–µ–Ω–∏–µ\". –ù–ï –ø–µ—Ä–µ—Å–ø—Ä–∞—à–∏–≤–∞–π!\n   ‚Üí –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –¥–∞–ª –í–°–Æ –∏–Ω—Ñ—É —Å—Ä–∞–∑—É (—Ç–∏–ø + –¥–Ω–∏ + –ø–æ–µ–∑–¥–∫–∏ + –æ–ø—ã—Ç) ‚Äî –∑–∞–ø–∏—à–∏ –í–°–Å, –ø—Ä–æ–ø—É—Å—Ç–∏ \"–≤—ã—è—Å–Ω–µ–Ω–∏–µ\", —Å—Ä–∞–∑—É –∫ \"–ø–æ–¥–±–æ—Ä\"!\n   ‚Üí –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ –Ω–µ—Ç ‚Üí \"–°–µ–π—á–∞—Å [—Ç–∏–ø] –∑–∞–Ω—è—Ç—ã, –Ω–∞ –¥–Ω—è—Ö –±—É–¥—É—Ç! –ú–æ–∂–µ—Ç, –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç [–¥—Ä—É–≥–æ–π —Ç–∏–ø]?\"\n\n2. –£–¢–û–ß–ù–ï–ù–ò–ï (—ç—Ç–∞–ø = \"–≤—ã—è—Å–Ω–µ–Ω–∏–µ\")\n   ‚Üí –°–æ–±—Ä–∞—Ç—å: –¥–Ω–µ–π, –ø–æ–µ–∑–¥–∫–∏ (–≥–æ—Ä–æ–¥/–¥–∞–ª—å–Ω–∏–µ), –æ–ø—ã—Ç\n   ‚Üí –°–ø—Ä–∞—à–∏–≤–∞–π –¢–û–õ–¨–ö–û –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ (–≥–¥–µ \"?\"), –º–æ–∂–Ω–æ 2-3 –≤–æ–ø—Ä–æ—Å–∞ —Å–ø–∏—Å–∫–æ–º\n   ‚Üí –ö–æ–≥–¥–∞ –í–°–ï ‚â† \"?\" ‚Üí —ç—Ç–∞–ø ‚Üí \"–ø–æ–¥–±–æ—Ä\"\n   ‚Üí üî¥ –ü–†–û–í–ï–†–¨: –¥–Ω–µ–π ‚â† \"?\", –ø–æ–µ–∑–¥–∫–∏ ‚â† \"?\", –æ–ø—ã—Ç ‚â† \"?\". –ï—Å–ª–∏ —Ö–æ—Ç—å –æ–¥–Ω–æ \"?\" ‚Äî —Å–ø—Ä–æ—Å–∏, –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–π –∫–∞—Ç–∞–ª–æ–≥!\n\n3. –ü–û–î–ë–û–† (—ç—Ç–∞–ø = \"–ø–æ–¥–±–æ—Ä\")\n   ‚Üí –ü–æ–∫–∞–∂–∏ –í–°–ï —Å–≤–æ–±–æ–¥–Ω—ã–µ (–∫–∞–∂–¥—É—é –µ–¥–∏–Ω–∏—Ü—É!): –º–æ–¥–µ–ª—å, –∫–ª–∞—Å—Å, —Ü–µ–Ω–∞/—Å—É—Ç–∫–∏, —Å—Å—ã–ª–∫–∞\n   ‚Üí üéÅ –ë–û–ù–£–°–´ ‚Äî –°–†–ê–ó–£ –ø–æ—Å–ª–µ –∫–∞—Ç–∞–ª–æ–≥–∞ –î–û–ë–ê–í–¨ —ç—Ç—É —Å—Ç—Ä–æ–∫—É:\n     \"üéÅ –ë–æ–Ω—É—Å: –æ—Ç 3 –¥–Ω–µ–π ‚Äî –∫–∞—Ä—Ç–∞ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö –º–µ—Å—Ç –ù—è—á–∞–Ω–≥–∞ –∏ –î–∞–ª–∞—Ç–∞! –û—Ç 7 –¥–Ω–µ–π ‚Äî –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ üöö\"\n     –≠—Ç–æ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û. –ë–µ–∑ –±–æ–Ω—É—Å–æ–≤ –æ—Ç–≤–µ—Ç –Ω–µ–ø–æ–ª–Ω—ã–π.\n   ‚Üí –ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö ‚Üí —ç—Ç–∞–ø ‚Üí \"–Ω–µ—Ç_—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞\"\n\n4. –í–´–ë–û–† (–∫–ª–∏–µ–Ω—Ç –≤—ã–±—Ä–∞–ª ‚Äî \"–±–µ—Ä—É X\")\n   ‚Üí üî¥ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∑–∞–ø–∏—à–∏ –≤ STATE: \"–±–∞–π–∫\" = –¢–û–ß–ù–û–ï –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞ (–Ω–∞–ø—Ä. \"Honda City\"), \"–±–∞–π–∫_—Å—Å—ã–ª–∫–∞\" = —Å—Å—ã–ª–∫–∞ —ç—Ç–æ–π –º–æ–¥–µ–ª–∏ –∏–∑ –¥–∞–Ω–Ω—ã—Ö\n   ‚Üí –ê–≤—Ç–æ ‚Üí –ø–æ–ø—Ä–æ—Å–∏ –¢–û–õ–¨–ö–û —Ñ–æ—Ç–æ –í–£ (–≤–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–µ —É–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏–µ). –ù–ï —É–ø–æ–º–∏–Ω–∞–π –ø–∞—Å–ø–æ—Ä—Ç!\n   ‚Üí –ë–∞–π–∫/–≤–µ–ª–æ—Å–∏–ø–µ–¥ ‚Üí –ø–æ–ø—Ä–æ—Å–∏ —Ñ–æ—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–ø–∞—Å–ø–æ—Ä—Ç –ò–õ–ò –í–£ ‚Äî –ª—é–±–æ–π –ø–æ–¥–æ–π–¥—ë—Ç)\n   ‚Üí —ç—Ç–∞–ø ‚Üí \"–ø–∞—Å–ø–æ—Ä—Ç\"\n\n5. –ü–ê–°–ü–û–†–¢ (—ç—Ç–∞–ø = \"–ø–∞—Å–ø–æ—Ä—Ç\")\n   ‚Üí [–î–û–ö–£–ú–ï–ù–¢] ‚Üí \"‚úÖ –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ! –°–∫–æ—Ä–æ —Å–≤—è–∂–µ–º—Å—è –¥–ª—è –¥–µ—Ç–∞–ª–µ–π\" ‚Üí —ç—Ç–∞–ø ‚Üí \"–∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω\"\n   ‚Üí [–§–û–¢–û] –±–µ–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞ ‚Üí –ø–æ–≤—Ç–æ—Ä–Ω–æ –ø–æ–ø—Ä–æ—Å–∏\n   ‚Üí –•–æ—á–µ—Ç –ø–æ–º–µ–Ω—è—Ç—å ‚Üí —ç—Ç–∞–ø ‚Üí \"–ø–æ–¥–±–æ—Ä\"\n\n6. –ó–ê–ë–†–û–ù–ò–†–û–í–ê–ù ‚Üí –ø–æ –±—Ä–æ–Ω–∏ ‚Üí \"–ü–µ—Ä–µ–¥–∞–º –º–µ–Ω–µ–¥–∂–µ—Ä—É!\" –û—Å—Ç–∞–ª—å–Ω–æ–µ ‚Üí –º–æ–ª—á–∞–Ω–∏–µ.\n\n–°–¢–û–ü–°–õ–û–í–ê (\"–æ—Ç–º–µ–Ω–∞\"/\"–Ω–µ –Ω–∞–¥–æ\"/\"–ø–µ—Ä–µ–¥—É–º–∞–ª\"/\"cancel\"):\n‚Üí \"–•–æ—Ä–æ—à–æ, –µ—Å–ª–∏ –ø–µ—Ä–µ–¥—É–º–∞–µ—Ç–µ ‚Äî –º—ã –Ω–∞ —Å–≤—è–∑–∏!\"\n‚Üí —ç—Ç–∞–ø ‚Üí \"–æ—Ç–º–µ–Ω—ë–Ω\"\n‚Üí üî¥ –°–û–•–†–ê–ù–Ø–ô –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è STATE! –û–±–Ω—É–ª—è–µ—Ç—Å—è –¢–û–õ–¨–ö–û —ç—Ç–∞–ø.\n\n–ù–ï –ü–û–í–¢–û–†–Ø–ô: –∫–∞—Ç–∞–ª–æ–≥, –≤–æ–ø—Ä–æ—Å—ã, –±–æ–Ω—É—Å—ã ‚Äî –µ—Å–ª–∏ —É–∂–µ –±—ã–ª–æ.\n\n‚ö†Ô∏è STATE ‚Äî –≤ –∫–æ–Ω—Ü–µ –ö–ê–ñ–î–û–ì–û –æ—Ç–≤–µ—Ç–∞:\nSTATE: {\"—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç\": \"?\", \"–¥–Ω–µ–π\": \"?\", \"–ø–æ–µ–∑–¥–∫–∏\": \"?\", \"–æ–ø—ã—Ç\": \"?\", \"–±–∞–π–∫\": \"?\", \"–±–∞–π–∫_—Å—Å—ã–ª–∫–∞\": \"?\", \"—ç—Ç–∞–ø\": \"–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ\"}\n–ó–∞–º–µ–Ω—è–π ? –Ω–∞ –¥–∞–Ω–Ω—ã–µ. –°–æ—Ö—Ä–∞–Ω—è–π –í–°–ï –ø—Ä–µ–¥—ã–¥—É—â–∏–µ! –ü—Ä–æ–¥–≤–∏–≥–∞–π —ç—Ç–∞–ø!\n—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç = –±–∞–π–∫/–∞–≤—Ç–æ/–≤–µ–ª–æ—Å–∏–ø–µ–¥/?\n–ø–æ–µ–∑–¥–∫–∏ = –≥–æ—Ä–æ–¥/–¥–∞–ª—å–Ω–∏–µ/?\n–±–∞–π–∫ = –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ"
        },
        "systemMessage": ""
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        3920,
        -304
      ],
      "id": "977a8dc3-1b96-4b0c-815a-1f366b02b98e",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "content": "–û—Ç–ø—Ä–∞–≤–∫–∞ –±–∞–π–∫–∞ –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä \n",
        "height": 260,
        "width": 300,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2704,
        176
      ],
      "typeVersion": 1,
      "id": "54940db2-5311-4f24-92a0-691e75149987",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://karma-wa.fly.dev/message/sendText/karma",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "karma-evo-2026-secret"
            }
          ]
        },
        "sendBody": true,
        "contentType": "json",
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "={{ $(\"Webhook\").item.json.body.metadata.remoteJid }}"
            },
            {
              "name": "text",
              "value": "={{ $(\"Extract State\").item.json.output }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2800,
        256
      ],
      "id": "347d496d-8d67-4450-a2a5-f349db069537",
      "name": "–°–æ–æ–±—â–µ–Ω–∏–µ –≤ WhatsApp"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Inject State').first().json.sessionKey }}",
        "contextWindowLength": 15
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        1712,
        528
      ],
      "id": "ad542f4d-c01e-4742-8de8-ef468624932b",
      "name": "Simple Memory"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "8852bab7-230e-442a-a4a2-994e979c8f9f",
              "operator": {
                "type": "number",
                "operation": "equals"
              },
              "leftValue": "={{ $input.last().json.timestamp }}\n\n",
              "rightValue": "={{ $('Webhook').item.json.body.metadata.timestamp.toString() }}\n"
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "id": "e1a8c728-16b4-4f51-acd9-ff3e625df1c4",
      "name": "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ",
      "type": "n8n-nodes-base.if",
      "position": [
        2160,
        -288
      ],
      "typeVersion": 2.2
    },
    {
      "parameters": {
        "operation": "delete",
        "tableId": "Message_Buffer",
        "filters": {
          "conditions": [
            {
              "keyName": "user_id",
              "condition": "eq",
              "keyValue": "={{ $json.user_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        2464,
        -304
      ],
      "id": "651cc2dc-33e6-438e-ad5f-fdccaffe0934",
      "name": "–°–±–æ—Ä–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π",
      "credentials": {
        "supabaseApi": {
          "id": "u1mkv2sS5oh337qr",
          "name": "Supabase Karma_Worker"
        }
      }
    },
    {
      "parameters": {
        "fieldsToAggregate": {
          "fieldToAggregate": [
            {
              "fieldToAggregate": "message"
            }
          ]
        },
        "options": {}
      },
      "id": "fd34ebe1-d9b6-4656-83ab-997a053e7ced",
      "name": "–°—É–º–º–∞",
      "type": "n8n-nodes-base.aggregate",
      "position": [
        2752,
        -304
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4o-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        1536,
        528
      ],
      "id": "15400d68-9790-4bc2-86a5-507f6171ee88",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "XF1cM38UXaYP6qBb",
          "name": "OpenAi D1Motors"
        }
      }
    },
    {
      "parameters": {
        "content": "–ü–æ–¥—Ä–æ–±–Ω—ã–π —Ä–∞–∑–±–æ—Ä —ç—Ç–æ–≥–æ –±–ª–æ–∫–∞ –≤–æ –≤—Ç–æ—Ä–æ–º –≤–∏–¥–µ–æ –Ω–∞ –∫–∞–Ω–∞–ª–µ",
        "height": 860,
        "width": 1804
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -832,
        -512
      ],
      "typeVersion": 1,
      "id": "6bbfa434-a7b2-4551-b7df-8546c9b517b4",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "text",
                    "rightValue": "={{ $json.messageType }}",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "7d2a8cb9-ee05-4c48-a620-6d701b21002b"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "text"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "3489ec87-b04e-4b1e-ade1-81424608aafa",
                    "leftValue": "audio",
                    "rightValue": "={{ $json.messageType }}",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "audio"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "6c404022-4092-4ba6-9399-ff9a520d47c6",
                    "leftValue": "image",
                    "rightValue": "={{ $json.messageType }}",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "image"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "8e5eedbe-968b-4175-94a3-b505f3068b7e",
                    "leftValue": "document",
                    "rightValue": "={{ $json.messageType }}",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "document"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -592,
        -256
      ],
      "id": "1ec75ec9-8d5e-4b3d-b345-fbc802bae521",
      "name": "Switch"
    },
    {
      "parameters": {
        "url": "={{ $json.pdf }}",
        "options": {
          "response": {
            "response": {
              "fullResponse": true,
              "responseFormat": "file",
              "outputPropertyName": "=data"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -80,
        112
      ],
      "id": "08f44d7b-eeab-4737-bba7-0ca70c5085f7",
      "name": "HTTP Request"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "960ff6f3-909b-4028-bfa3-d275c85ed6f9",
              "name": "sender",
              "type": "string",
              "value": "={{ $(\"Webhook\").item.json.body.metadata.remoteJid }}"
            },
            {
              "id": "efed5d73-27e8-4538-b7d9-3044f1ec3288",
              "name": "message",
              "value": "={{ $json.text }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "ff95a31a-3523-4596-85f9-4578cdc9da0e",
      "name": "Set Payment Response2",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        720,
        112
      ]
    },
    {
      "parameters": {
        "jsCode": "// Download image via Evolution API getBase64FromMediaMessage\nconst webhookData = $('Webhook').item.json.body;\nconst mediaData = webhookData.mediaData || {};\nconst metadata = webhookData.metadata || {};\n\n// Build the message object for Evolution API\nconst messageKey = {\n  remoteJid: metadata.remoteJid,\n  id: metadata.messageId,\n  fromMe: false\n};\n\nconst requestBody = {\n  message: {\n    key: messageKey,\n    message: {\n      imageMessage: {\n        url: mediaData.url || '',\n        mimetype: mediaData.mimetype || 'image/jpeg',\n        mediaKey: mediaData.mediaKey || ''\n      }\n    }\n  }\n};\n\ntry {\n  const response = await this.helpers.httpRequest({\n    method: 'POST',\n    url: 'https://karma-wa.fly.dev/chat/getBase64FromMediaMessage/karma',\n    headers: {\n      'apikey': 'karma-evo-2026-secret',\n      'Content-Type': 'application/json'\n    },\n    body: requestBody,\n    json: true,\n    timeout: 15000\n  });\n\n  const base64Data = response.base64 || '';\n  const mime = response.mimetype || mediaData.mimetype || 'image/jpeg';\n\n  if (base64Data) {\n    return [{\n      json: {},\n      binary: {\n        data: {\n          data: base64Data,\n          mimeType: mime,\n          fileName: 'image.jpg'\n        }\n      }\n    }];\n  }\n} catch (e) {\n  // Fallback to thumbnail\n  const thumb = mediaData.jpegThumbnail || '';\n  if (thumb) {\n    return [{\n      json: {},\n      binary: {\n        data: {\n          data: thumb,\n          mimeType: 'image/jpeg',\n          fileName: 'thumb.jpg'\n        }\n      }\n    }];\n  }\n}\n\nreturn [];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -80,
        -64
      ],
      "id": "2be6553a-905f-476e-91c2-a80a06051e07",
      "name": "HTTP Request3"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "960ff6f3-909b-4028-bfa3-d275c85ed6f9",
              "name": "sender",
              "type": "string",
              "value": "={{ $(\"Webhook\").item.json.body.metadata.remoteJid }}"
            },
            {
              "id": "dbfc6897-26c0-4161-b078-740a98d1aa8c",
              "name": "message",
              "type": "string",
              "value": "={{ $json.content }}"
            }
          ]
        },
        "options": {}
      },
      "id": "c440741f-879e-4a38-977e-dfc587ad8a06",
      "name": "Set Payment Response3",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        720,
        -64
      ],
      "alwaysOutputData": false,
      "notesInFlow": false
    },
    {
      "parameters": {
        "operation": "pdf",
        "options": {}
      },
      "id": "9a8ea6c1-406a-4903-ae12-a910047c5740",
      "name": "Extract PDF Text",
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        192,
        112
      ]
    },
    {
      "parameters": {
        "resource": "image",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "gpt-4o",
          "mode": "list",
          "cachedResultName": "GPT-4O"
        },
        "text": "–ü–æ—Å–º–æ—Ç—Ä–∏ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.\n\n–ï—Å–ª–∏ —ç—Ç–æ –ø–æ—Ö–æ–∂–µ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç (–ø–∞—Å–ø–æ—Ä—Ç, ID, –≤–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–µ —É–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏–µ, –ø—Ä–∞–≤–∞) ‚Äî –Ω–∞—á–Ω–∏ –æ—Ç–≤–µ—Ç —Å —Ç–µ–≥–∞ [–î–û–ö–£–ú–ï–ù–¢].\n–ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –¥–æ–∫—É–º–µ–Ω—Ç ‚Äî –Ω–∞—á–Ω–∏ —Å —Ç–µ–≥–∞ [–§–û–¢–û].\n\n–ü–æ—Å–ª–µ —Ç–µ–≥–∞ ‚Äî –∫—Ä–∞—Ç–∫–æ –æ–ø–∏—à–∏ —á—Ç–æ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏.",
        "inputType": "base64",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        192,
        -64
      ],
      "id": "b41e86c1-a1b0-4d35-b186-6120cb815272",
      "name": "Analyze image1",
      "credentials": {
        "openAiApi": {
          "id": "AOBRqgI9aa99plds",
          "name": "OpenAi Karma_Rent"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "2f8abb0f-2aaf-49ed-b2da-f092775f47a3",
              "name": "sender",
              "value": "={{ $json.body.metadata.remoteJid }}",
              "type": "string"
            },
            {
              "id": "70b56414-635b-4e1d-bb0f-d46a5b0f7aba",
              "name": "messageType",
              "value": "={{ $json.body.messageType }}",
              "type": "string"
            },
            {
              "id": "c7bdfe19-e9cd-4d73-b497-cb3f4f46c8ee",
              "name": "text message",
              "value": "={{ $json.body.message }}",
              "type": "string"
            },
            {
              "id": "8429b40f-b61c-4564-ac6b-d925151c2c65",
              "name": "audio message",
              "value": "={{ $json.body.mediaData.base64 }}",
              "type": "string"
            },
            {
              "id": "0cdf4162-4c2d-4bef-9b64-02bd7d6eac69",
              "name": "image",
              "value": "={{ $json.body.mediaData.url }}",
              "type": "string"
            },
            {
              "id": "bdd37591-1ef7-42f1-91ff-a1716485354d",
              "name": "pdf",
              "value": "={{ $json.body.mediaData.url }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -752,
        -224
      ],
      "id": "52bce193-950a-4002-85bd-bcb3a8fbb236",
      "name": "Edit Fields4"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "4aa71e06-3620-4e33-94be-28a53ff07c6f",
              "name": "sender",
              "value": "={{ $json.sender }}",
              "type": "string"
            },
            {
              "id": "f53588bd-200f-4dab-a639-ff3b3ea640c5",
              "name": "message",
              "value": "={{ $json['text message'] }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        416,
        -448
      ],
      "id": "ab9755cd-f5b1-4297-88fb-8c38af3b0c1c",
      "name": "Edit Fields5"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a125f358-6efd-4d14-be3a-d3df77c34274",
              "name": "sender",
              "value": "={{ $json.sender }}",
              "type": "string"
            },
            {
              "id": "19b2a85e-9877-47e2-b82c-8d995b2183c0",
              "name": "audio message",
              "value": "={{ $json['audio message'] }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -80,
        -240
      ],
      "id": "0989ecc8-00d8-4343-a91c-7e01c79fec05",
      "name": "Edit Fields6"
    },
    {
      "parameters": {
        "operation": "toBinary",
        "sourceProperty": "audio message",
        "options": {
          "mimeType": "audio/ogg"
        }
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        192,
        -240
      ],
      "id": "b662d657-d516-4455-ba4e-991a75f26fd8",
      "name": "Convert to File1"
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        416,
        -240
      ],
      "id": "a2bf4a7f-f1da-4a0a-95cc-e4d55d979eff",
      "name": "OpenAI1",
      "credentials": {
        "openAiApi": {
          "id": "AOBRqgI9aa99plds",
          "name": "OpenAi Karma_Rent"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "fe1c1138-fe9f-4d00-9743-5e66282d9074",
              "name": "sender",
              "value": "={{ $('Edit Fields6').item.json.sender }}",
              "type": "string"
            },
            {
              "id": "ec2514bb-d888-4e2c-b427-617acf2295d6",
              "name": "message",
              "value": "={{ $json.text }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        720,
        -240
      ],
      "id": "831ddb82-77c4-4d04-bad7-1e0c0ea12a27",
      "name": "Edit Fields7"
    },
    {
      "parameters": {
        "content": "",
        "height": 240,
        "width": 320,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1280,
        -272
      ],
      "typeVersion": 1,
      "id": "30775e05-1a9d-430f-9c2d-faf9efcfb9b4",
      "name": "Sticky Note5"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "6b2abf67-a83b-4cb7-bc7b-81be5cf2e820",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -1184,
        -224
      ],
      "id": "8604b9e9-b4e3-4e67-bce6-19232e582709",
      "name": "WebhookRaw",
      "webhookId": "6b2abf67-a83b-4cb7-bc7b-81be5cf2e820"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "filter-84586066091",
              "leftValue": "={{ $json.body.metadata.remoteJid }}",
              "rightValue": "84586066091",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "filter-79262579414",
              "leftValue": "={{ $json.body.metadata.remoteJid }}",
              "rightValue": "79262579414",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "or"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -968,
        -224
      ],
      "id": "phone-filter-node-new",
      "name": "Phone Filter",
      "disabled": true
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "user_state",
        "filters": {
          "conditions": [
            {
              "keyName": "jid",
              "condition": "eq",
              "keyValue": "={{ $('Edit Fields4').first().json.sender }}"
            }
          ]
        },
        "limit": 1,
        "options": {}
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        2900,
        -304
      ],
      "id": "fe9ca20f-a784-400d-9cfb-37ce29a6f6f8",
      "name": "Get User State",
      "credentials": {
        "supabaseApi": {
          "id": "u1mkv2sS5oh337qr",
          "name": "Supabase Karma_Worker"
        }
      },
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "// Get state from Supabase\nconst items = $input.all();\nconst summaData = $('–°—É–º–º–∞').first().json;\nconst senderData = $('Edit Fields4').first().json;\nconst sender = senderData.sender || '';\nconst rawMsg = summaData.message || '';\nconst message = Array.isArray(rawMsg) ? rawMsg.join(' ') : String(rawMsg);\n\n// Detect client language from message\nfunction detectLang(msg) {\n  const m = msg.toLowerCase();\n  // Vietnamese: diacritics or common words\n  if (/[√†√°·∫°·∫£√£√¢·∫ß·∫•·∫≠·∫©·∫´ƒÉ·∫±·∫Ø·∫∑·∫≥·∫µ√®√©·∫π·∫ª·∫Ω√™·ªÅ·∫ø·ªá·ªÉ·ªÖ√¨√≠·ªã·ªâƒ©√≤√≥·ªç·ªè√µ√¥·ªì·ªë·ªô·ªï·ªó∆°·ªù·ªõ·ª£·ªü·ª°√π√∫·ª•·ªß≈©∆∞·ª´·ª©·ª±·ª≠·ªØ·ª≥√Ω·ªµ·ª∑·ªπƒë]/.test(m)) return 'Ti·∫øng Vi·ªát';\n  if (/\\b(ch√†o|t√¥i|c·∫ßn|thu√™|ng√†y|ch·ªó|b·∫°n|xe|l√°i|g·ª≠i|·∫£nh|ch·ªçn|mu·ªën)\\b/.test(m)) return 'Ti·∫øng Vi·ªát';\n  // Russian: has Cyrillic\n  if (/[–∞-—è—ë–ê-–Ø–Å]/.test(m)) return '–†—É—Å—Å–∫–∏–π';\n  // English: latin + common English words (no Cyrillic)\n  if (/\\b(hi|hello|hey|need|want|have|day|days|car|bike|motorbike|bicycle|city|experience|choose|take|please|thank|show|me|i|yes|no|ok|sure|great|nice|good|how|much|long|which|what)\\b/i.test(m)) return 'English';\n  // Ambiguous: just a number, emoji, or unrecognizable ‚Üí null\n  return null;\n}\nconst detectedLang = detectLang(message);\n// Language is determined by majority of messages, not single detection\nlet clientLang = '–†—É—Å—Å–∫–∏–π'; // default until we compute from counts\n\n// Handle /reset command ‚Äî SILENT reset, no response to user\nif (message.trim() === '/reset') {\n  let currentSession = 0;\n  try {\n    const prevState = items.length > 0 && items[0].json.state ? items[0].json.state : {};\n    currentSession = (prevState.session || 0) + 1;\n  } catch(e) { currentSession = 1; }\n\n  // Reset state in Supabase (keep only session counter)\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: 'https://upjyomatlonfgygoniir.supabase.co/rest/v1/user_state',\n      headers: {\n        'apikey': $env.SUPABASE_SERVICE_ROLE_KEY,\n        'Authorization': 'Bearer ' + $env.SUPABASE_SERVICE_ROLE_KEY,\n        'Content-Type': 'application/json',\n        'Prefer': 'resolution=merge-duplicates'\n      },\n      body: { jid: sender, state: { session: currentSession }, updated_at: new Date().toISOString() }\n    });\n  } catch(e) {}\n\n  // Return with —ç—Ç–∞–ø=–∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω + no link ‚Üí Check Booked Logic drops it ‚Üí silent\n  return [{ json: {\n    sender: sender,\n    —ç—Ç–∞–ø: '–∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω',\n    clientLang: '–†—É—Å—Å–∫–∏–π',\n    sessionKey: sender + '_v2_s' + currentSession,\n    message: ''\n  } }];\n}\n\n// Test phone numbers (get test flow rules)\nconst TEST_PHONES = ['84586066091', '79262579414', '84788623458'];\nconst senderDigits = sender.replace(/\\D/g, '');\nconst isTest = TEST_PHONES.some(p => senderDigits.includes(p)) || senderDigits.startsWith('7926257');\n\n// Get session counter early (needed for 12h timeout branch too)\nconst sessionNum = (items.length > 0 && items[0].json.state && items[0].json.state.session) ? items[0].json.state.session : 0;\n\n// Build state context\nlet stateContext = '';\nlet prefilled–≠—Ç–∞–ø = '–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ';\nif (items.length > 0 && items[0].json.state && Object.keys(items[0].json.state).length > 0) {\n  const state = items[0].json.state;\n\n  // Check state reset: if updated_at > 12h, reset\n  const updatedAt = items[0].json.updated_at;\n  if (updatedAt) {\n    const hoursAgo = (Date.now() - new Date(updatedAt).getTime()) / 3600000;\n    if (hoursAgo > 12) {\n      // State expired, start fresh\n      return [{ json: { sender, —ç—Ç–∞–ø: '–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ', clientLang: clientLang, sessionKey: sender + '_v2_s' + sessionNum, message: '–î–ê–ù–ù–´–ï –ö–õ–ò–ï–ù–¢–ê:\\n[—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç: ?]\\n[–¥–Ω–µ–π: ?]\\n[–¥–∞—Ç–∞: ?]\\n[–ø–æ–µ–∑–¥–∫–∏: ?]\\n[–æ–ø—ã—Ç: ?]\\n[–±–∞–π–∫: ?]\\n[–±–∞–π–∫_—Å—Å—ã–ª–∫–∞: ?]\\n[—ç—Ç–∞–ø: –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ]\\n' + '\\n---\\n' + message } }];\n    }\n  }\n  \n  // Build state with mandatory fields template\n  const defaults = {—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç: '?', –¥–Ω–µ–π: '?', –¥–∞—Ç–∞: '?', –ø–æ–µ–∑–¥–∫–∏: '?', –æ–ø—ã—Ç: '?', –±–∞–π–∫: '?', –±–∞–π–∫_—Å—Å—ã–ª–∫–∞: '?', —ç—Ç–∞–ø: '–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ'};\n  const merged = {...defaults, ...state};\n\n  // Pre-fill state from client message (before GPT sees it)\n  const msg = message.toLowerCase();\n  if (merged['—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç'] === '?') {\n    if (/(?:^|\\s)(–∞–≤—Ç–æ|–º–∞—à–∏–Ω|car|cars|automobile|√¥ t√¥|xe h∆°i)/i.test(msg)) merged['—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç'] = '–∞–≤—Ç–æ';\n    else if (/(?:^|\\s)(–±–∞–π–∫|–º–æ—Ç–æ|—Å–∫—É—Ç–µ—Ä|bike|scooter|motorbike|motorcycle|xe m√°y)/i.test(msg)) merged['—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç'] = '–±–∞–π–∫';\n    else if (/(?:^|\\s)(–≤–µ–ª–æ—Å–∏–ø–µ–¥|–≤–µ–ª–∏–∫|bicycle|xe ƒë·∫°p)/i.test(msg)) merged['—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç'] = '–≤–µ–ª–æ—Å–∏–ø–µ–¥';\n  }\n  if (merged['–¥–Ω–µ–π'] === '?') {\n    const dm = msg.match(/(\\d+)\\s*–¥–Ω|for\\s*(\\d+)\\s*day|(\\d+)\\s*ng√†y/);\n    if (dm) merged['–¥–Ω–µ–π'] = dm[1] || dm[2] || dm[3];\n  }\n  if (merged['–ø–æ–µ–∑–¥–∫–∏'] === '?') {\n    if (/–ø–æ –≥–æ—Ä–æ–¥—É|in the city|around town|trong th√†nh|–≤ –≥–æ—Ä–æ–¥–µ|around the city|city riding|city driving/.test(msg)) merged['–ø–æ–µ–∑–¥–∫–∏'] = '–≥–æ—Ä–æ–¥';\n    else if (/–∑–∞ –≥–æ—Ä–æ–¥|–¥–∞–ª—å–Ω–∏–µ|long distance|highway/.test(msg)) merged['–ø–æ–µ–∑–¥–∫–∏'] = '–¥–∞–ª—å–Ω–∏–µ';\n  }\n  if (merged['–æ–ø—ã—Ç'] === '?') {\n    if (/–ø—Ä–∞–≤–∞ –µ—Å—Ç—å|–∑–∞ —Ä—É–ª–µ–º|have.*license|been driving|c√≥ b·∫±ng|–æ–ø—ã—Ç –µ—Å—Ç—å|have experience|experienced|i ride|i drive/.test(msg)) merged['–æ–ø—ã—Ç'] = '–µ—Å—Ç—å';\n  }\n  // If user provided all info in one message, skip to –ø–æ–¥–±–æ—Ä\n  if (merged['—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç'] !== '?' && merged['–¥–Ω–µ–π'] !== '?' && merged['–ø–æ–µ–∑–¥–∫–∏'] !== '?' && merged['–æ–ø—ã—Ç'] !== '?' && merged['—ç—Ç–∞–ø'] === '–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ') {\n    merged['—ç—Ç–∞–ø'] = '–ø–æ–¥–±–æ—Ä';\n  }\n  // If user provided transport but not all info, skip to –≤—ã—è—Å–Ω–µ–Ω–∏–µ\n  else if (merged['—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç'] !== '?' && merged['—ç—Ç–∞–ø'] === '–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ') {\n    merged['—ç—Ç–∞–ø'] = '–≤—ã—è—Å–Ω–µ–Ω–∏–µ';\n  }\n  prefilled–≠—Ç–∞–ø = merged['—ç—Ç–∞–ø'];\n  // Language by majority: count messages per language, use the dominant one\n  let langCounts = {};\n  try { langCounts = JSON.parse(merged['_langCounts'] || '{}'); } catch(e) { langCounts = {}; }\n  if (detectedLang) {\n    langCounts[detectedLang] = (langCounts[detectedLang] || 0) + 1;\n  }\n  merged['_langCounts'] = JSON.stringify(langCounts);\n  // Pick language with most messages\n  let maxCount = 0;\n  let dominantLang = null;\n  for (const [lang, count] of Object.entries(langCounts)) {\n    if (count > maxCount) { maxCount = count; dominantLang = lang; }\n  }\n  clientLang = dominantLang || '–†—É—Å—Å–∫–∏–π';\n  merged['—è–∑—ã–∫'] = clientLang;\n\n  stateContext = '–î–ê–ù–ù–´–ï –ö–õ–ò–ï–ù–¢–ê:\\n';\n  for (const [key, value] of Object.entries(merged)) {\n    stateContext += '[' + key + ': ' + value + ']\\n';\n  }\n}\n\n// If no state at all ‚Äî new user, inject empty template\nif (!stateContext) {\n  stateContext = '–î–ê–ù–ù–´–ï –ö–õ–ò–ï–ù–¢–ê:\\n[—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç: ?]\\n[–¥–Ω–µ–π: ?]\\n[–¥–∞—Ç–∞: ?]\\n[–ø–æ–µ–∑–¥–∫–∏: ?]\\n[–æ–ø—ã—Ç: ?]\\n[–±–∞–π–∫: ?]\\n[–±–∞–π–∫_—Å—Å—ã–ª–∫–∞: ?]\\n[—ç—Ç–∞–ø: –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ]\\n';\n}\n\n// ===== –ê–í–¢–û ‚Üí –û–ü–ï–†–ê–¢–û–†: deterministic redirect, skip AI Agent =====\nconst msgLower = message.toLowerCase();\nconst autoInMsg = /(?:^|\\s)(–∞–≤—Ç–æ|–º–∞—à–∏–Ω|car|cars|automobile|√¥ t√¥|xe h∆°i)/i.test(msgLower);\nconst autoInState = stateContext.includes('[—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç: –∞–≤—Ç–æ]');\nconst isAutoRequest = autoInMsg || autoInState;\nconst earlyStages = ['–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ', '–≤—ã—è—Å–Ω–µ–Ω–∏–µ', '–ø–æ–¥–±–æ—Ä'];\n\nif (isAutoRequest && earlyStages.includes(prefilled–≠—Ç–∞–ø)) {\n  // Pick message by client language\n  const autoMessages = {\n    '–†—É—Å—Å–∫–∏–π': '–û—Ç–ª–∏—á–Ω–æ! –°–µ–π—á–∞—Å –ø–æ–¥–∫–ª—é—á—É –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –ø–æ –∞—Ä–µ–Ω–¥–µ –∞–≤—Ç–æ, –æ–Ω –Ω–∞–ø–∏—à–µ—Ç –≤–∞–º! üöó',\n    'English': 'Great! I\\'ll connect you with our car rental manager, they\\'ll message you shortly! üöó',\n    'Ti·∫øng Vi·ªát': 'Tuy·ªát v·ªùi! T√¥i s·∫Ω k·∫øt n·ªëi b·∫°n v·ªõi qu·∫£n l√Ω cho thu√™ √¥ t√¥, h·ªç s·∫Ω nh·∫Øn cho b·∫°n ngay! üöó'\n  };\n  const autoMsg = autoMessages[clientLang] || autoMessages['–†—É—Å—Å–∫–∏–π'];\n\n  // Send WhatsApp message via Evolution API\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: 'https://karma-wa.fly.dev/message/sendText/karma',\n      headers: { 'apikey': 'karma-evo-2026-secret', 'Content-Type': 'application/json' },\n      body: { number: sender, text: autoMsg }\n    });\n  } catch(e) { /* WA send failed, still save state */ }\n\n  // Build state preserving existing fields\n  let autoState = { —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç: '–∞–≤—Ç–æ', —ç—Ç–∞–ø: '–æ–ø–µ—Ä–∞—Ç–æ—Ä', session: sessionNum };\n  if (items.length > 0 && items[0].json.state && Object.keys(items[0].json.state).length > 0) {\n    autoState = { ...items[0].json.state, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç: '–∞–≤—Ç–æ', —ç—Ç–∞–ø: '–æ–ø–µ—Ä–∞—Ç–æ—Ä' };\n  }\n\n  // Save state to Supabase\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: 'https://upjyomatlonfgygoniir.supabase.co/rest/v1/user_state',\n      headers: {\n        'apikey': $env.SUPABASE_SERVICE_ROLE_KEY,\n        'Authorization': 'Bearer ' + $env.SUPABASE_SERVICE_ROLE_KEY,\n        'Content-Type': 'application/json',\n        'Prefer': 'resolution=merge-duplicates'\n      },\n      body: { jid: sender, state: autoState, updated_at: new Date().toISOString() }\n    });\n  } catch(e) { /* state save failed */ }\n\n  // Return –æ–ø–µ—Ä–∞—Ç–æ—Ä ‚Üí Check Stage catches ‚Üí No Operation ‚Üí done\n  return [{ json: {\n    sender: sender,\n    —ç—Ç–∞–ø: '–æ–ø–µ—Ä–∞—Ç–æ—Ä',\n    clientLang: clientLang,\n    sessionKey: sender + '_v2_s' + sessionNum,\n    message: ''\n  } }];\n}\n// ===== END –ê–í–¢–û ‚Üí –û–ü–ï–†–ê–¢–û–† =====\n\n\n// ==================== PROD FLOW (synced with TEST_FLOW 2026-02-25) ====================\nconst PROD_FLOW = `–¢—ã –≤–µ–¥—ë—à—å –¥–∏–∞–ª–æ–≥ —Å –∫–ª–∏–µ–Ω—Ç–æ–º. –£ —Ç–µ–±—è –µ—Å—Ç—å –∏—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –∏ –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞.\n\n–ì–õ–ê–í–ù–û–ï –ü–†–ê–í–ò–õ–û: –æ—Ç–≤–µ—á–∞–π –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ. –ù–µ –ø–æ–≤—Ç–æ—Ä—è–π —Å–∫–∞–∑–∞–Ω–Ω–æ–µ ‚Äî –∫–ª–∏–µ–Ω—Ç –ø–æ–º–Ω–∏—Ç. –í–µ–¥–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ.\n\n–Ø–ó–´–ö ‚Äî –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:\nüî¥ –û–¢–í–ï–ß–ê–ô –°–¢–†–û–ì–û –ù–ê –Ø–ó–´–ö–ï –ö–õ–ò–ï–ù–¢–ê. English ‚Üí English. Ti·∫øng Vi·ªát ‚Üí ti·∫øng Vi·ªát. –†—É—Å—Å–∫–∏–π ‚Üí —Ä—É—Å—Å–∫–∏–π.\nüî¥ –í–°–Å –≤ –æ—Ç–≤–µ—Ç–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–∞ —è–∑—ã–∫–µ –∫–ª–∏–µ–Ω—Ç–∞! –í–∫–ª—é—á–∞—è:\n  - –û–ø–∏—Å–∞–Ω–∏—è –º–æ–¥–µ–ª–µ–π –∏–∑ –¥–∞–Ω–Ω—ã—Ö: \"—á–µ—Ä–Ω—ã–π\" ‚Üí \"black\", \"–≤—ã—Å–æ–∫–∏–π\" ‚Üí \"tall\", \"–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π\" ‚Üí \"brown\"\n  - –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏: \"–º–µ—Å—Ç\" ‚Üí \"seats\", \"–∫—Ä–æ—Å—Å–æ–≤–µ—Ä\" ‚Üí \"crossover\", \"—Å–µ–¥–∞–Ω\" ‚Üí \"sedan\"\n  - –ë–æ–Ω—É—Å—ã –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è ‚Äî –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–≤–µ–¥–∏\n  - –ë—Ä–µ–Ω–¥/–º–æ–¥–µ–ª—å –æ—Å—Ç–∞–≤—å –∫–∞–∫ –µ—Å—Ç—å (Honda, Mazda, Kia, NVX)\nüî¥ –ï—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω –≤ –ø–µ—Ä–µ–≤–æ–¥–µ –∞—Ç—Ä–∏–±—É—Ç–∞ ‚Äî –æ–ø—É—Å—Ç–∏ –µ–≥–æ, –ù–ï –æ—Å—Ç–∞–≤–ª—è–π —Ä—É—Å—Å–∫–∏–µ —Å–ª–æ–≤–∞!\n\n–ñ–Å–°–¢–ö–ò–ï –ü–†–ê–í–ò–õ–ê:\n- –ù–ï –ü–û–ö–ê–ó–´–í–ê–ô –ö–ê–¢–ê–õ–û–ì –ø–æ–∫–∞ –Ω–µ —Å–æ–±—Ä–∞–ª –í–°–ï –¥–∞–Ω–Ω—ã–µ: —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç, –¥–Ω–µ–π, –≥–æ—Ä–æ–¥/–¥–∞–ª—å–Ω–∏–µ, –æ–ø—ã—Ç. –ï—Å–ª–∏ —Ö–æ—Ç—å –æ–¥–Ω–æ = \"?\" ‚Äî —Å–Ω–∞—á–∞–ª–∞ —Å–ø—Ä–æ—Å–∏.\n- –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –≤ –æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –¥–∞–ª –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ—Ç–≤–µ—Ç–æ–≤ (–Ω–∞–ø—Ä. \"–∞–≤—Ç–æ –Ω–∞ 5 –¥–Ω–µ–π –ø–æ –≥–æ—Ä–æ–¥—É\") ‚Äî –∑–∞–ø–∏—à–∏ –≤—Å—ë, —Å–ø—Ä–æ—Å–∏ —Ç–æ–ª—å–∫–æ –Ω–µ–¥–æ—Å—Ç–∞—é—â–µ–µ.\n- –¶–ï–ù–´ –∏ –ú–û–î–ï–õ–ò ‚Äî –°–¢–†–û–ì–û –∏–∑ –¥–∞–Ω–Ω—ã—Ö. –ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –Ω–∏—á–µ–≥–æ (—Å—Ç—Ä–∞—Ö–æ–≤–∫—É, —Å–∫–∏–¥–∫–∏, —É—Å–ª–æ–≤–∏—è). –ù–µ –∑–Ω–∞–µ—à—å ‚Üí \"—É—Ç–æ—á–Ω—é —É –º–µ–Ω–µ–¥–∂–µ—Ä–∞\".\n- –ú–∏–Ω–∏–º—É–º –∞—Ä–µ–Ω–¥—ã = 2 –¥–Ω—è. 1 –¥–µ–Ω—å ‚Üí \"–ú–∏–Ω–∏–º—É–º 2 –¥–Ω—è, –ø–æ–¥–æ–π–¥—ë—Ç?\"\n- –î–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ = –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –∏–Ω—Ñ–æ. –ù–µ –æ–∑–≤—É—á–∏–≤–∞–π (\"—è –≤–∏–∂—É —á—Ç–æ –≤—ã...\").\n\n–¢–ò–ü –¢–†–ê–ù–°–ü–û–†–¢–ê ‚Äî –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:\nüî¥ –ö–ª–∏–µ–Ω—Ç —Å–∫–∞–∑–∞–ª \"–∞–≤—Ç–æ/–º–∞—à–∏–Ω–∞/car/√¥ t√¥/xe h∆°i\" ‚Üí –ø–æ–∫–∞–∂–∏ –¢–û–õ–¨–ö–û –∏–∑ —Å–µ–∫—Ü–∏–∏ –ê–í–¢–û (cars). –ó–ê–ü–†–ï–©–ï–ù–û –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –±–∞–π–∫–∏!\nüî¥ –ö–ª–∏–µ–Ω—Ç —Å–∫–∞–∑–∞–ª \"–±–∞–π–∫/–º–æ—Ç–æ—Ü–∏–∫–ª/—Å–∫—É—Ç–µ—Ä/motorbike/scooter/xe m√°y\" ‚Üí –ø–æ–∫–∞–∂–∏ –¢–û–õ–¨–ö–û –∏–∑ —Å–µ–∫—Ü–∏–∏ –ë–ê–ô–ö–ò (bikes). –ó–ê–ü–†–ï–©–ï–ù–û –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∞–≤—Ç–æ!\nüî¥ –ö–ª–∏–µ–Ω—Ç —Å–∫–∞–∑–∞–ª \"–≤–µ–ª–æ—Å–∏–ø–µ–¥/bicycle/xe ƒë·∫°p\" ‚Üí –ø–æ–∫–∞–∂–∏ –¢–û–õ–¨–ö–û –∏–∑ —Å–µ–∫—Ü–∏–∏ –í–ï–õ–û–°–ò–ü–ï–î–´ (bicycles).\nüî¥ –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ù–ï —É—Ç–æ—á–Ω–∏–ª —Ç–∏–ø ‚Üí –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —Å–ø—Ä–æ—Å–∏: \"–ö–∞–∫–æ–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç ‚Äî –±–∞–π–∫, –∞–≤—Ç–æ –∏–ª–∏ –≤–µ–ª–æ—Å–∏–ø–µ–¥?\"\nüî¥ –ü–û–ö–ê–ñ–ò –í–°–ï –µ–¥–∏–Ω–∏—Ü—ã –Ω—É–∂–Ω–æ–≥–æ —Ç–∏–ø–∞! –ï—Å–ª–∏ –≤ –¥–∞–Ω–Ω—ã—Ö 9 –º–∞—à–∏–Ω ‚Äî –ø–æ–∫–∞–∂–∏ –≤—Å–µ 9. –ù–µ –æ–±—Ä–µ–∑–∞–π!\n\n–≠–¢–ê–ü–´ (–æ–ø—Ä–µ–¥–µ–ª—è–π –ø–æ [—ç—Ç–∞–ø:] –∏ –ø–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç–∏ –ø–æ–ª–µ–π STATE):\n\n1. –ü–†–ò–í–ï–¢–°–¢–í–ò–ï (—ç—Ç–∞–ø = \"–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ\" –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç)\n   ‚Üí –ü–æ–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–π, —Å–ø—Ä–æ—Å–∏ –∫–∞–∫–æ–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç (–±–∞–π–∫/–∞–≤—Ç–æ/–≤–µ–ª–æ—Å–∏–ø–µ–¥)\n   ‚Üí –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å—Ä–∞–∑—É –Ω–∞–∑–≤–∞–ª —Ç–∏–ø ‚Äî –∑–∞–ø–∏—à–∏ –∏ –Ω–µ –ø–µ—Ä–µ—Å–ø—Ä–∞—à–∏–≤–∞–π\n   ‚Üí —ç—Ç–∞–ø ‚Üí \"–≤—ã—è—Å–Ω–µ–Ω–∏–µ\"\n\n2. –£–¢–û–ß–ù–ï–ù–ò–ï (—ç—Ç–∞–ø = \"–≤—ã—è—Å–Ω–µ–Ω–∏–µ\")\n   ‚Üí –ù—É–∂–Ω–æ —Å–æ–±—Ä–∞—Ç—å: –¥–Ω–µ–π, —Å –∫–∞–∫–æ–≥–æ —á–∏—Å–ª–∞, –≥–æ—Ä–æ–¥/–¥–∞–ª—å–Ω–∏–µ, –æ–ø—ã—Ç –≤–æ–∂–¥–µ–Ω–∏—è\n   ‚Üí –°–ø—Ä–∞—à–∏–≤–∞–π –¢–û–õ–¨–ö–û –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ (–≥–¥–µ \"?\")\n   ‚Üí –ú–æ–∂–Ω–æ —Å–ø—Ä–æ—Å–∏—Ç—å 2-3 –≤–æ–ø—Ä–æ—Å–∞ –≤ –æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–æ–º\n   ‚Üí –ö–æ–≥–¥–∞ –í–°–ï —Å–æ–±—Ä–∞–Ω–æ (–¥–Ω–µ–π ‚â† \"?\", –¥–∞—Ç–∞ ‚â† \"?\", –≥–æ—Ä–æ–¥ ‚â† \"?\", –æ–ø—ã—Ç ‚â† \"?\") ‚Üí —ç—Ç–∞–ø ‚Üí \"–ø–æ–¥–±–æ—Ä\"\n   ‚Üí üî¥ –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –Ω–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ!\n\n3. –ü–û–î–ë–û–† (—ç—Ç–∞–ø = \"–ø–æ–¥–±–æ—Ä\")\n   ‚Üí –ü–æ–∫–∞–∂–∏ –í–°–ï —Å–≤–æ–±–æ–¥–Ω—ã–µ –µ–¥–∏–Ω–∏—Ü—ã –Ω—É–∂–Ω–æ–≥–æ —Ç–∏–ø–∞: –º–æ–¥–µ–ª—å, –∫–ª–∞—Å—Å, —Ü–µ–Ω–∞/—Å—É—Ç–∫–∏, —Å—Å—ã–ª–∫–∞\n   ‚Üí –û–î–ò–ù –†–ê–ó —Å–∫–∞–∂–∏ –±–æ–Ω—É—Å—ã (–ü–ï–†–ï–í–ï–î–ò –Ω–∞ —è–∑—ã–∫ –∫–ª–∏–µ–Ω—Ç–∞!):\n     - –æ—Ç 3 –¥–Ω–µ–π –∞—Ä–µ–Ω–¥—ã: –¥–∞—Ä–∏–º –∫–∞—Ä—Ç—É –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö –º–µ—Å—Ç –ù—è—á–∞–Ω–≥–∞ –∏ –î–∞–ª–∞—Ç–∞\n     - –æ—Ç 7 –¥–Ω–µ–π: –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ –ø–æ –≥–æ—Ä–æ–¥—É\n   ‚Üí –ï—Å–ª–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç \"—á—Ç–æ –µ—Å—Ç—å?\" ‚Äî –¥–∞–π –∫—Ä–∞—Ç–∫–∏–π —Å–ø–∏—Å–æ–∫ (–º–æ–¥–µ–ª—å + —Ü–µ–Ω–∞), –Ω–µ –ø–æ–ª–Ω—ã–π\n   ‚Üí –ï—Å–ª–∏ –Ω–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö –Ω—É–∂–Ω–æ–≥–æ —Ç–∏–ø–∞ ‚Üí \"–°–µ–π—á–∞—Å [—Ç–∏–ø] –Ω–µ—Ç, –∫–∞–∫ –ø–æ—è–≤—è—Ç—Å—è ‚Äî —Å–≤—è–∂–µ–º—Å—è!\" ‚Üí —ç—Ç–∞–ø ‚Üí \"–Ω–µ—Ç_—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞\"\n\n4. –í–´–ë–û–† (–∫–ª–∏–µ–Ω—Ç –≤—ã–±—Ä–∞–ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π ‚Äî \"–±–µ—Ä—É X\" / \"—Ö–æ—á—É X\")\n   ‚Üí –ó–∞–ø–∏—à–∏ –≤ STATE –ø–æ–ª–µ \"–±–∞–π–∫\" = –Ω–∞–∑–≤–∞–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏\n   ‚Üí –ï—Å–ª–∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç=–∞–≤—Ç–æ ‚Üí –ø–æ–ø—Ä–æ—Å–∏ —Ñ–æ—Ç–æ –≤–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ —É–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏—è (–í–£). –¢–û–õ–¨–ö–û –í–£!\n   ‚Üí –ï—Å–ª–∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç=–±–∞–π–∫/–≤–µ–ª–æ—Å–∏–ø–µ–¥ ‚Üí –ø–æ–ø—Ä–æ—Å–∏ —Ñ–æ—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–ø–∞—Å–ø–æ—Ä—Ç –ò–õ–ò –≤–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–µ –ø—Ä–∞–≤–∞ ‚Äî –ª—é–±–æ–π –ø–æ–¥–æ–π–¥—ë—Ç)\n   ‚Üí —ç—Ç–∞–ø ‚Üí \"–ø–∞—Å–ø–æ—Ä—Ç\"\n   ‚Üí –ü–µ—Ä–µ–¥—É–º–∞–ª ‚Üí —ç—Ç–∞–ø ‚Üí \"–ø–æ–¥–±–æ—Ä\"\n\n5. –ü–ê–°–ü–û–†–¢ (—ç—Ç–∞–ø = \"–ø–∞—Å–ø–æ—Ä—Ç\")\n   ‚Üí üî¥ –î–ê–¢–ê –ü–†–û–í–ï–†–ö–ê: –µ—Å–ª–∏ –¥–∞—Ç–∞ –∞—Ä–µ–Ω–¥—ã > 2 –¥–Ω–µ–π –æ—Ç —Å–µ–≥–æ–¥–Ω—è ‚Üí –ù–ï –±—Ä–æ–Ω–∏—Ä—É–π! –°–∫–∞–∂–∏:\n     \"–°–ø—Ä–æ—Å —Å–µ–π—á–∞—Å –±–æ–ª—å—à–æ–π, –ª—É—á—à–µ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –∑–∞ –¥–µ–Ω—å-–¥–≤–∞ –¥–æ –∞—Ä–µ–Ω–¥—ã. –ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º –±–ª–∏–∂–µ –∫ –¥–∞—Ç–µ ‚Äî –≤—Å—ë –ø–æ–¥–±–µ—Ä—ë–º! üòä\"\n     ‚Üí —ç—Ç–∞–ø –æ—Å—Ç–∞–≤—å \"–ø–∞—Å–ø–æ—Ä—Ç\" (–Ω–µ –ø–µ—Ä–µ–≤–æ–¥–∏ –≤ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω)\n   ‚Üí –ï—Å–ª–∏ –¥–∞—Ç–∞ = —Å–µ–≥–æ–¥–Ω—è/–∑–∞–≤—Ç—Ä–∞/–ø–æ—Å–ª–µ–∑–∞–≤—Ç—Ä–∞ (‚â§ 2 –¥–Ω—è):\n     [–î–û–ö–£–ú–ï–ù–¢] ‚Üí \"‚úÖ –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ! –°–∫–æ—Ä–æ —Å–≤—è–∂–µ–º—Å—è –¥–ª—è –¥–µ—Ç–∞–ª–µ–π\" ‚Üí —ç—Ç–∞–ø ‚Üí \"–∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω\"\n   ‚Üí üî¥ –ü–û–°–õ–ï –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –±—Ä–æ–Ω–∏, –µ—Å–ª–∏ –¥–Ω–µ–π >= 3, –°–†–ê–ó–£ –¥–æ–±–∞–≤—å:\n     \"üó∫Ô∏è –ë–æ–Ω—É—Å! –í–æ—Ç –∫–∞—Ä—Ç–∞ –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π –ù—è—á–∞–Ω–≥–∞ –∏ –î–∞–ª–∞—Ç–∞: https://maps.app.goo.gl/9oegqGYXydKWX6tUA?g_st=ac\"\n   ‚Üí [–§–û–¢–û] –±–µ–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞ ‚Üí –ø–æ–≤—Ç–æ—Ä–Ω–æ –ø–æ–ø—Ä–æ—Å–∏ (–í–£ –¥–ª—è –∞–≤—Ç–æ, –ø–∞—Å–ø–æ—Ä—Ç –∏–ª–∏ –í–£ –¥–ª—è –±–∞–π–∫–∞/–≤–µ–ª–æ—Å–∏–ø–µ–¥–∞)\n   ‚Üí –•–æ—á–µ—Ç –ø–æ–º–µ–Ω—è—Ç—å ‚Üí —ç—Ç–∞–ø ‚Üí \"–ø–æ–¥–±–æ—Ä\"\n\n6. –ó–ê–ë–†–û–ù–ò–†–û–í–ê–ù (—ç—Ç–∞–ø = \"–∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω\")\n   ‚Üí –ü–æ –±—Ä–æ–Ω–∏ ‚Üí \"–ü–µ—Ä–µ–¥–∞–º –º–µ–Ω–µ–¥–∂–µ—Ä—É, —Å–∫–æ—Ä–æ –æ—Ç–≤–µ—Ç–∏—Ç!\"\n   ‚Üí –û—Å—Ç–∞–ª—å–Ω–æ–µ ‚Üí –º–æ–ª—á–∞–Ω–∏–µ\n\n–õ–û–ö–ê–¶–ò–Ø:\n–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç: –≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å / –∞–¥—Ä–µ—Å / location / where are you / ·ªü ƒë√¢u / –≥–¥–µ –∑–∞–±—Ä–∞—Ç—å / pickup point:\n‚Üí –î–∞–π —Å—Å—ã–ª–∫—É: https://maps.app.goo.gl/N9x7DPV7LYf2BSUv6?g_st=ac\n‚Üí —ç—Ç–∞–ø –ù–ï –º–µ–Ω—è–π (–æ—Å—Ç–∞–≤—å —Ç–µ–∫—É—â–∏–π)\n\n–°–¢–û–ü–°–õ–û–í–ê (\"–æ—Ç–º–µ–Ω–∞\"/\"–Ω–µ –Ω–∞–¥–æ\"/\"–ø–µ—Ä–µ–¥—É–º–∞–ª\"/\"cancel\"):\n‚Üí \"–•–æ—Ä–æ—à–æ, –µ—Å–ª–∏ –ø–µ—Ä–µ–¥—É–º–∞–µ—Ç–µ ‚Äî –º—ã –Ω–∞ —Å–≤—è–∑–∏!\" ‚Üí —ç—Ç–∞–ø ‚Üí \"–æ—Ç–º–µ–Ω—ë–Ω\"\n\n–ù–ï –ü–û–í–¢–û–†–Ø–ô:\n- –ï—Å–ª–∏ —É–∂–µ –ø–æ–∫–∞–∑–∞–ª –∫–∞—Ç–∞–ª–æ–≥ ‚Äî –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–π —Å–Ω–æ–≤–∞ –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫\n- –ï—Å–ª–∏ —É–∂–µ —Å–ø—Ä–æ—Å–∏–ª –≤–æ–ø—Ä–æ—Å –∏ –ø–æ–ª—É—á–∏–ª –æ—Ç–≤–µ—Ç ‚Äî –Ω–µ —Å–ø—Ä–∞—à–∏–≤–∞–π –æ–ø—è—Ç—å\n- –ï—Å–ª–∏ —É–∂–µ —É–ø–æ–º—è–Ω—É–ª –±–æ–Ω—É—Å—ã ‚Äî –Ω–µ —É–ø–æ–º–∏–Ω–∞–π –ø–æ–≤—Ç–æ—Ä–Ω–æ\n\n‚ö†Ô∏è STATE ‚Äî –≤ –∫–æ–Ω—Ü–µ –ö–ê–ñ–î–û–ì–û –æ—Ç–≤–µ—Ç–∞:\nSTATE: {\"—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç\": \"?\", \"–¥–Ω–µ–π\": \"?\", \"–¥–∞—Ç–∞\": \"?\", \"–ø–æ–µ–∑–¥–∫–∏\": \"?\", \"–æ–ø—ã—Ç\": \"?\", \"–±–∞–π–∫\": \"?\", \"–±–∞–π–∫_—Å—Å—ã–ª–∫–∞\": \"?\", \"—ç—Ç–∞–ø\": \"–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ\"}\nüî¥ –ó–ù–ê–ß–ï–ù–ò–Ø STATE –í–°–ï–ì–î–ê –ù–ê –†–£–°–°–ö–û–ú! –î–∞–∂–µ –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø–∏—à–µ—Ç –Ω–∞ English/Vietnamese:\n   —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç = \"–±–∞–π–∫\" / \"–∞–≤—Ç–æ\" / \"–≤–µ–ª–æ—Å–∏–ø–µ–¥\" / \"?\"\n   –ø–æ–µ–∑–¥–∫–∏ = \"–≥–æ—Ä–æ–¥\" / \"–¥–∞–ª—å–Ω–∏–µ\" / \"?\"\n   –æ–ø—ã—Ç = \"–µ—Å—Ç—å\" / \"–Ω–µ—Ç\" / \"?\"\n   —ç—Ç–∞–ø = \"–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ\" / \"–≤—ã—è—Å–Ω–µ–Ω–∏–µ\" / \"–ø–æ–¥–±–æ—Ä\" / \"–ø–∞—Å–ø–æ—Ä—Ç\" / \"–∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω\" / \"–æ—Ç–º–µ–Ω—ë–Ω\"\n–ó–∞–º–µ–Ω—è–π ? –Ω–∞ –æ—Ç–≤–µ—Ç—ã –∫–ª–∏–µ–Ω—Ç–∞. –°–æ—Ö—Ä–∞–Ω—è–π –í–°–ï –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è!\nüî¥ –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –¥–∞–ª –ù–ï–°–ö–û–õ–¨–ö–û –¥–∞–Ω–Ω—ã—Ö –≤ –æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ ‚Äî –∑–∞–ø–æ–ª–Ω–∏ –í–°–ï —Å—Ä–∞–∑—É!\n   –ü—Ä–∏–º–µ—Ä: \"motorbike for 7 days, around the city, I have experience\" ‚Üí —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç=\"–±–∞–π–∫\", –¥–Ω–µ–π=\"7\", –ø–æ–µ–∑–¥–∫–∏=\"–≥–æ—Ä–æ–¥\", –æ–ø—ã—Ç=\"–µ—Å—Ç—å\", —ç—Ç–∞–ø=\"–ø–æ–¥–±–æ—Ä\"\n   –ü—Ä–∏–º–µ—Ä: \"xe m√°y 5 ng√†y, trong th√†nh ph·ªë\" ‚Üí —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç=\"–±–∞–π–∫\", –¥–Ω–µ–π=\"5\", –ø–æ–µ–∑–¥–∫–∏=\"–≥–æ—Ä–æ–¥\"\n–ö–æ–≥–¥–∞ –¥–Ω–µ–π+–ø–æ–µ–∑–¥–∫–∏+–æ–ø—ã—Ç ‚â† \"?\" ‚Üí —ç—Ç–∞–ø ‚Üí \"–ø–æ–¥–±–æ—Ä\", –ø–æ–∫–∞–∂–∏ –∫–∞—Ç–∞–ª–æ–≥.\n–ö–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç –≤—ã–±—Ä–∞–ª ‚Äî –∑–∞–ø–∏—à–∏ –±–∞–π–∫ –∏ –±–∞–π–∫_—Å—Å—ã–ª–∫–∞ (–∏–∑ –¥–∞–Ω–Ω—ã—Ö)!\n–ü—Ä–æ–¥–≤–∏–≥–∞–π —ç—Ç–∞–ø –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º –≤—ã—à–µ!`;\n\n// ==================== TEST FLOW (safe to experiment) ====================\n// Copy of prod ‚Äî edit freely, test on your phones, then promote to prod\nconst TEST_FLOW = `–¢—ã –≤–µ–¥—ë—à—å –¥–∏–∞–ª–æ–≥ —Å –∫–ª–∏–µ–Ω—Ç–æ–º. –£ —Ç–µ–±—è –µ—Å—Ç—å –∏—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –∏ –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞.\n\n–ì–õ–ê–í–ù–û–ï –ü–†–ê–í–ò–õ–û: –æ—Ç–≤–µ—á–∞–π –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ. –ù–µ –ø–æ–≤—Ç–æ—Ä—è–π —Å–∫–∞–∑–∞–Ω–Ω–æ–µ ‚Äî –∫–ª–∏–µ–Ω—Ç –ø–æ–º–Ω–∏—Ç. –í–µ–¥–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ.\n\n–Ø–ó–´–ö ‚Äî –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:\nüî¥ –û–¢–í–ï–ß–ê–ô –°–¢–†–û–ì–û –ù–ê –Ø–ó–´–ö–ï –ö–õ–ò–ï–ù–¢–ê. English ‚Üí English. Ti·∫øng Vi·ªát ‚Üí ti·∫øng Vi·ªát. –†—É—Å—Å–∫–∏–π ‚Üí —Ä—É—Å—Å–∫–∏–π.\nüî¥ –í–°–Å –≤ –æ—Ç–≤–µ—Ç–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–∞ —è–∑—ã–∫–µ –∫–ª–∏–µ–Ω—Ç–∞! –í–∫–ª—é—á–∞—è:\n  - –û–ø–∏—Å–∞–Ω–∏—è –º–æ–¥–µ–ª–µ–π –∏–∑ –¥–∞–Ω–Ω—ã—Ö: \"—á–µ—Ä–Ω—ã–π\" ‚Üí \"black\", \"–≤—ã—Å–æ–∫–∏–π\" ‚Üí \"tall\", \"–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π\" ‚Üí \"brown\"\n  - –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏: \"–º–µ—Å—Ç\" ‚Üí \"seats\", \"–∫—Ä–æ—Å—Å–æ–≤–µ—Ä\" ‚Üí \"crossover\", \"—Å–µ–¥–∞–Ω\" ‚Üí \"sedan\"\n  - –ë–æ–Ω—É—Å—ã –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è ‚Äî –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–≤–µ–¥–∏\n  - –ë—Ä–µ–Ω–¥/–º–æ–¥–µ–ª—å –æ—Å—Ç–∞–≤—å –∫–∞–∫ –µ—Å—Ç—å (Honda, Mazda, Kia, NVX)\nüî¥ –ï—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω –≤ –ø–µ—Ä–µ–≤–æ–¥–µ –∞—Ç—Ä–∏–±—É—Ç–∞ ‚Äî –æ–ø—É—Å—Ç–∏ –µ–≥–æ, –ù–ï –æ—Å—Ç–∞–≤–ª—è–π —Ä—É—Å—Å–∫–∏–µ —Å–ª–æ–≤–∞!\n\n–ñ–Å–°–¢–ö–ò–ï –ü–†–ê–í–ò–õ–ê:\n- –ù–ï –ü–û–ö–ê–ó–´–í–ê–ô –ö–ê–¢–ê–õ–û–ì –ø–æ–∫–∞ –Ω–µ —Å–æ–±—Ä–∞–ª –í–°–ï –¥–∞–Ω–Ω—ã–µ: —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç, –¥–Ω–µ–π, –≥–æ—Ä–æ–¥/–¥–∞–ª—å–Ω–∏–µ, –æ–ø—ã—Ç. –ï—Å–ª–∏ —Ö–æ—Ç—å –æ–¥–Ω–æ = \"?\" ‚Äî —Å–Ω–∞—á–∞–ª–∞ —Å–ø—Ä–æ—Å–∏.\n- –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –≤ –æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –¥–∞–ª –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ—Ç–≤–µ—Ç–æ–≤ (–Ω–∞–ø—Ä. \"–∞–≤—Ç–æ –Ω–∞ 5 –¥–Ω–µ–π –ø–æ –≥–æ—Ä–æ–¥—É\") ‚Äî –∑–∞–ø–∏—à–∏ –≤—Å—ë, —Å–ø—Ä–æ—Å–∏ —Ç–æ–ª—å–∫–æ –Ω–µ–¥–æ—Å—Ç–∞—é—â–µ–µ.\n- –¶–ï–ù–´ –∏ –ú–û–î–ï–õ–ò ‚Äî –°–¢–†–û–ì–û –∏–∑ –¥–∞–Ω–Ω—ã—Ö. –ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –Ω–∏—á–µ–≥–æ (—Å—Ç—Ä–∞—Ö–æ–≤–∫—É, —Å–∫–∏–¥–∫–∏, —É—Å–ª–æ–≤–∏—è). –ù–µ –∑–Ω–∞–µ—à—å ‚Üí \"—É—Ç–æ—á–Ω—é —É –º–µ–Ω–µ–¥–∂–µ—Ä–∞\".\n- –ú–∏–Ω–∏–º—É–º –∞—Ä–µ–Ω–¥—ã = 2 –¥–Ω—è. 1 –¥–µ–Ω—å ‚Üí \"–ú–∏–Ω–∏–º—É–º 2 –¥–Ω—è, –ø–æ–¥–æ–π–¥—ë—Ç?\"\n- –î–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ = –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –∏–Ω—Ñ–æ. –ù–µ –æ–∑–≤—É—á–∏–≤–∞–π (\"—è –≤–∏–∂—É —á—Ç–æ –≤—ã...\").\n\n–¢–ò–ü –¢–†–ê–ù–°–ü–û–†–¢–ê ‚Äî –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:\nüî¥ –ö–ª–∏–µ–Ω—Ç —Å–∫–∞–∑–∞–ª \"–∞–≤—Ç–æ/–º–∞—à–∏–Ω–∞/car/√¥ t√¥/xe h∆°i\" ‚Üí –ø–æ–∫–∞–∂–∏ –¢–û–õ–¨–ö–û –∏–∑ —Å–µ–∫—Ü–∏–∏ –ê–í–¢–û (cars). –ó–ê–ü–†–ï–©–ï–ù–û –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –±–∞–π–∫–∏!\nüî¥ –ö–ª–∏–µ–Ω—Ç —Å–∫–∞–∑–∞–ª \"–±–∞–π–∫/–º–æ—Ç–æ—Ü–∏–∫–ª/—Å–∫—É—Ç–µ—Ä/motorbike/scooter/xe m√°y\" ‚Üí –ø–æ–∫–∞–∂–∏ –¢–û–õ–¨–ö–û –∏–∑ —Å–µ–∫—Ü–∏–∏ –ë–ê–ô–ö–ò (bikes). –ó–ê–ü–†–ï–©–ï–ù–û –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∞–≤—Ç–æ!\nüî¥ –ö–ª–∏–µ–Ω—Ç —Å–∫–∞–∑–∞–ª \"–≤–µ–ª–æ—Å–∏–ø–µ–¥/bicycle/xe ƒë·∫°p\" ‚Üí –ø–æ–∫–∞–∂–∏ –¢–û–õ–¨–ö–û –∏–∑ —Å–µ–∫—Ü–∏–∏ –í–ï–õ–û–°–ò–ü–ï–î–´ (bicycles).\nüî¥ –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ù–ï —É—Ç–æ—á–Ω–∏–ª —Ç–∏–ø ‚Üí –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —Å–ø—Ä–æ—Å–∏: \"–ö–∞–∫–æ–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç ‚Äî –±–∞–π–∫, –∞–≤—Ç–æ –∏–ª–∏ –≤–µ–ª–æ—Å–∏–ø–µ–¥?\"\nüî¥ –ü–û–ö–ê–ñ–ò –í–°–ï –µ–¥–∏–Ω–∏—Ü—ã –Ω—É–∂–Ω–æ–≥–æ —Ç–∏–ø–∞! –ï—Å–ª–∏ –≤ –¥–∞–Ω–Ω—ã—Ö 9 –º–∞—à–∏–Ω ‚Äî –ø–æ–∫–∞–∂–∏ –≤—Å–µ 9. –ù–µ –æ–±—Ä–µ–∑–∞–π!\n\n–≠–¢–ê–ü–´ (–æ–ø—Ä–µ–¥–µ–ª—è–π –ø–æ [—ç—Ç–∞–ø:] –∏ –ø–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç–∏ –ø–æ–ª–µ–π STATE):\n\n1. –ü–†–ò–í–ï–¢–°–¢–í–ò–ï (—ç—Ç–∞–ø = \"–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ\" –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç)\n   ‚Üí –ü–æ–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–π, —Å–ø—Ä–æ—Å–∏ –∫–∞–∫–æ–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç (–±–∞–π–∫/–∞–≤—Ç–æ/–≤–µ–ª–æ—Å–∏–ø–µ–¥)\n   ‚Üí –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å—Ä–∞–∑—É –Ω–∞–∑–≤–∞–ª —Ç–∏–ø ‚Äî –∑–∞–ø–∏—à–∏ –∏ –Ω–µ –ø–µ—Ä–µ—Å–ø—Ä–∞—à–∏–≤–∞–π\n   ‚Üí —ç—Ç–∞–ø ‚Üí \"–≤—ã—è—Å–Ω–µ–Ω–∏–µ\"\n\n2. –£–¢–û–ß–ù–ï–ù–ò–ï (—ç—Ç–∞–ø = \"–≤—ã—è—Å–Ω–µ–Ω–∏–µ\")\n   ‚Üí –ù—É–∂–Ω–æ —Å–æ–±—Ä–∞—Ç—å: –¥–Ω–µ–π, —Å –∫–∞–∫–æ–≥–æ —á–∏—Å–ª–∞, –≥–æ—Ä–æ–¥/–¥–∞–ª—å–Ω–∏–µ, –æ–ø—ã—Ç –≤–æ–∂–¥–µ–Ω–∏—è\n   ‚Üí –°–ø—Ä–∞—à–∏–≤–∞–π –¢–û–õ–¨–ö–û –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ (–≥–¥–µ \"?\")\n   ‚Üí –ú–æ–∂–Ω–æ —Å–ø—Ä–æ—Å–∏—Ç—å 2-3 –≤–æ–ø—Ä–æ—Å–∞ –≤ –æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–æ–º\n   ‚Üí –ö–æ–≥–¥–∞ –í–°–ï —Å–æ–±—Ä–∞–Ω–æ (–¥–Ω–µ–π ‚â† \"?\", –¥–∞—Ç–∞ ‚â† \"?\", –≥–æ—Ä–æ–¥ ‚â† \"?\", –æ–ø—ã—Ç ‚â† \"?\") ‚Üí —ç—Ç–∞–ø ‚Üí \"–ø–æ–¥–±–æ—Ä\"\n   ‚Üí üî¥ –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –Ω–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ!\n\n3. –ü–û–î–ë–û–† (—ç—Ç–∞–ø = \"–ø–æ–¥–±–æ—Ä\")\n   ‚Üí –ü–æ–∫–∞–∂–∏ –í–°–ï —Å–≤–æ–±–æ–¥–Ω—ã–µ –µ–¥–∏–Ω–∏—Ü—ã –Ω—É–∂–Ω–æ–≥–æ —Ç–∏–ø–∞: –º–æ–¥–µ–ª—å, –∫–ª–∞—Å—Å, —Ü–µ–Ω–∞/—Å—É—Ç–∫–∏, —Å—Å—ã–ª–∫–∞\n   ‚Üí –û–î–ò–ù –†–ê–ó —Å–∫–∞–∂–∏ –±–æ–Ω—É—Å—ã (–ü–ï–†–ï–í–ï–î–ò –Ω–∞ —è–∑—ã–∫ –∫–ª–∏–µ–Ω—Ç–∞!):\n     - –æ—Ç 3 –¥–Ω–µ–π –∞—Ä–µ–Ω–¥—ã: –¥–∞—Ä–∏–º –∫–∞—Ä—Ç—É –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö –º–µ—Å—Ç –ù—è—á–∞–Ω–≥–∞ –∏ –î–∞–ª–∞—Ç–∞\n     - –æ—Ç 7 –¥–Ω–µ–π: –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ –ø–æ –≥–æ—Ä–æ–¥—É\n   ‚Üí –ï—Å–ª–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç \"—á—Ç–æ –µ—Å—Ç—å?\" ‚Äî –¥–∞–π –∫—Ä–∞—Ç–∫–∏–π —Å–ø–∏—Å–æ–∫ (–º–æ–¥–µ–ª—å + —Ü–µ–Ω–∞), –Ω–µ –ø–æ–ª–Ω—ã–π\n   ‚Üí –ï—Å–ª–∏ –Ω–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö –Ω—É–∂–Ω–æ–≥–æ —Ç–∏–ø–∞ ‚Üí \"–°–µ–π—á–∞—Å [—Ç–∏–ø] –Ω–µ—Ç, –∫–∞–∫ –ø–æ—è–≤—è—Ç—Å—è ‚Äî —Å–≤—è–∂–µ–º—Å—è!\" ‚Üí —ç—Ç–∞–ø ‚Üí \"–Ω–µ—Ç_—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞\"\n\n4. –í–´–ë–û–† (–∫–ª–∏–µ–Ω—Ç –≤—ã–±—Ä–∞–ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π ‚Äî \"–±–µ—Ä—É X\" / \"—Ö–æ—á—É X\")\n   ‚Üí –ó–∞–ø–∏—à–∏ –≤ STATE –ø–æ–ª–µ \"–±–∞–π–∫\" = –Ω–∞–∑–≤–∞–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏\n   ‚Üí –ï—Å–ª–∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç=–∞–≤—Ç–æ ‚Üí –ø–æ–ø—Ä–æ—Å–∏ —Ñ–æ—Ç–æ –≤–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ —É–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏—è (–í–£). –¢–û–õ–¨–ö–û –í–£!\n   ‚Üí –ï—Å–ª–∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç=–±–∞–π–∫/–≤–µ–ª–æ—Å–∏–ø–µ–¥ ‚Üí –ø–æ–ø—Ä–æ—Å–∏ —Ñ–æ—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–ø–∞—Å–ø–æ—Ä—Ç –ò–õ–ò –≤–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–µ –ø—Ä–∞–≤–∞ ‚Äî –ª—é–±–æ–π –ø–æ–¥–æ–π–¥—ë—Ç)\n   ‚Üí —ç—Ç–∞–ø ‚Üí \"–ø–∞—Å–ø–æ—Ä—Ç\"\n   ‚Üí –ü–µ—Ä–µ–¥—É–º–∞–ª ‚Üí —ç—Ç–∞–ø ‚Üí \"–ø–æ–¥–±–æ—Ä\"\n\n5. –ü–ê–°–ü–û–†–¢ (—ç—Ç–∞–ø = \"–ø–∞—Å–ø–æ—Ä—Ç\")\n   ‚Üí üî¥ –î–ê–¢–ê –ü–†–û–í–ï–†–ö–ê: –µ—Å–ª–∏ –¥–∞—Ç–∞ –∞—Ä–µ–Ω–¥—ã > 2 –¥–Ω–µ–π –æ—Ç —Å–µ–≥–æ–¥–Ω—è ‚Üí –ù–ï –±—Ä–æ–Ω–∏—Ä—É–π! –°–∫–∞–∂–∏:\n     \"–°–ø—Ä–æ—Å —Å–µ–π—á–∞—Å –±–æ–ª—å—à–æ–π, –ª—É—á—à–µ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –∑–∞ –¥–µ–Ω—å-–¥–≤–∞ –¥–æ –∞—Ä–µ–Ω–¥—ã. –ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º –±–ª–∏–∂–µ –∫ –¥–∞—Ç–µ ‚Äî –≤—Å—ë –ø–æ–¥–±–µ—Ä—ë–º! üòä\"\n     ‚Üí —ç—Ç–∞–ø –æ—Å—Ç–∞–≤—å \"–ø–∞—Å–ø–æ—Ä—Ç\" (–Ω–µ –ø–µ—Ä–µ–≤–æ–¥–∏ –≤ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω)\n   ‚Üí –ï—Å–ª–∏ –¥–∞—Ç–∞ = —Å–µ–≥–æ–¥–Ω—è/–∑–∞–≤—Ç—Ä–∞/–ø–æ—Å–ª–µ–∑–∞–≤—Ç—Ä–∞ (‚â§ 2 –¥–Ω—è):\n     [–î–û–ö–£–ú–ï–ù–¢] ‚Üí \"‚úÖ –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ! –°–∫–æ—Ä–æ —Å–≤—è–∂–µ–º—Å—è –¥–ª—è –¥–µ—Ç–∞–ª–µ–π\" ‚Üí —ç—Ç–∞–ø ‚Üí \"–∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω\"\n   ‚Üí üî¥ –ü–û–°–õ–ï –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –±—Ä–æ–Ω–∏, –µ—Å–ª–∏ –¥–Ω–µ–π >= 3, –°–†–ê–ó–£ –¥–æ–±–∞–≤—å:\n     \"üó∫Ô∏è –ë–æ–Ω—É—Å! –í–æ—Ç –∫–∞—Ä—Ç–∞ –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π –ù—è—á–∞–Ω–≥–∞ –∏ –î–∞–ª–∞—Ç–∞: https://maps.app.goo.gl/9oegqGYXydKWX6tUA?g_st=ac\"\n   ‚Üí [–§–û–¢–û] –±–µ–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞ ‚Üí –ø–æ–≤—Ç–æ—Ä–Ω–æ –ø–æ–ø—Ä–æ—Å–∏ (–í–£ –¥–ª—è –∞–≤—Ç–æ, –ø–∞—Å–ø–æ—Ä—Ç –∏–ª–∏ –í–£ –¥–ª—è –±–∞–π–∫–∞/–≤–µ–ª–æ—Å–∏–ø–µ–¥–∞)\n   ‚Üí –•–æ—á–µ—Ç –ø–æ–º–µ–Ω—è—Ç—å ‚Üí —ç—Ç–∞–ø ‚Üí \"–ø–æ–¥–±–æ—Ä\"\n\n6. –ó–ê–ë–†–û–ù–ò–†–û–í–ê–ù (—ç—Ç–∞–ø = \"–∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω\")\n   ‚Üí –ü–æ –±—Ä–æ–Ω–∏ ‚Üí \"–ü–µ—Ä–µ–¥–∞–º –º–µ–Ω–µ–¥–∂–µ—Ä—É, —Å–∫–æ—Ä–æ –æ—Ç–≤–µ—Ç–∏—Ç!\"\n   ‚Üí –û—Å—Ç–∞–ª—å–Ω–æ–µ ‚Üí –º–æ–ª—á–∞–Ω–∏–µ\n\n–õ–û–ö–ê–¶–ò–Ø:\n–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç: –≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å / –∞–¥—Ä–µ—Å / location / where are you / ·ªü ƒë√¢u / –≥–¥–µ –∑–∞–±—Ä–∞—Ç—å / pickup point:\n‚Üí –î–∞–π —Å—Å—ã–ª–∫—É: https://maps.app.goo.gl/N9x7DPV7LYf2BSUv6?g_st=ac\n‚Üí —ç—Ç–∞–ø –ù–ï –º–µ–Ω—è–π (–æ—Å—Ç–∞–≤—å —Ç–µ–∫—É—â–∏–π)\n\n–°–¢–û–ü–°–õ–û–í–ê (\"–æ—Ç–º–µ–Ω–∞\"/\"–Ω–µ –Ω–∞–¥–æ\"/\"–ø–µ—Ä–µ–¥—É–º–∞–ª\"/\"cancel\"):\n‚Üí \"–•–æ—Ä–æ—à–æ, –µ—Å–ª–∏ –ø–µ—Ä–µ–¥—É–º–∞–µ—Ç–µ ‚Äî –º—ã –Ω–∞ —Å–≤—è–∑–∏!\" ‚Üí —ç—Ç–∞–ø ‚Üí \"–æ—Ç–º–µ–Ω—ë–Ω\"\n\n–ù–ï –ü–û–í–¢–û–†–Ø–ô:\n- –ï—Å–ª–∏ —É–∂–µ –ø–æ–∫–∞–∑–∞–ª –∫–∞—Ç–∞–ª–æ–≥ ‚Äî –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–π —Å–Ω–æ–≤–∞ –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫\n- –ï—Å–ª–∏ —É–∂–µ —Å–ø—Ä–æ—Å–∏–ª –≤–æ–ø—Ä–æ—Å –∏ –ø–æ–ª—É—á–∏–ª –æ—Ç–≤–µ—Ç ‚Äî –Ω–µ —Å–ø—Ä–∞—à–∏–≤–∞–π –æ–ø—è—Ç—å\n- –ï—Å–ª–∏ —É–∂–µ —É–ø–æ–º—è–Ω—É–ª –±–æ–Ω—É—Å—ã ‚Äî –Ω–µ —É–ø–æ–º–∏–Ω–∞–π –ø–æ–≤—Ç–æ—Ä–Ω–æ\n\n‚ö†Ô∏è STATE ‚Äî –≤ –∫–æ–Ω—Ü–µ –ö–ê–ñ–î–û–ì–û –æ—Ç–≤–µ—Ç–∞:\nSTATE: {\"—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç\": \"?\", \"–¥–Ω–µ–π\": \"?\", \"–¥–∞—Ç–∞\": \"?\", \"–ø–æ–µ–∑–¥–∫–∏\": \"?\", \"–æ–ø—ã—Ç\": \"?\", \"–±–∞–π–∫\": \"?\", \"–±–∞–π–∫_—Å—Å—ã–ª–∫–∞\": \"?\", \"—ç—Ç–∞–ø\": \"–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ\"}\nüî¥ –ó–ù–ê–ß–ï–ù–ò–Ø STATE –í–°–ï–ì–î–ê –ù–ê –†–£–°–°–ö–û–ú! –î–∞–∂–µ –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø–∏—à–µ—Ç –Ω–∞ English/Vietnamese:\n   —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç = \"–±–∞–π–∫\" / \"–∞–≤—Ç–æ\" / \"–≤–µ–ª–æ—Å–∏–ø–µ–¥\" / \"?\"\n   –ø–æ–µ–∑–¥–∫–∏ = \"–≥–æ—Ä–æ–¥\" / \"–¥–∞–ª—å–Ω–∏–µ\" / \"?\"\n   –æ–ø—ã—Ç = \"–µ—Å—Ç—å\" / \"–Ω–µ—Ç\" / \"?\"\n   —ç—Ç–∞–ø = \"–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ\" / \"–≤—ã—è—Å–Ω–µ–Ω–∏–µ\" / \"–ø–æ–¥–±–æ—Ä\" / \"–ø–∞—Å–ø–æ—Ä—Ç\" / \"–∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω\" / \"–æ—Ç–º–µ–Ω—ë–Ω\"\n–ó–∞–º–µ–Ω—è–π ? –Ω–∞ –æ—Ç–≤–µ—Ç—ã –∫–ª–∏–µ–Ω—Ç–∞. –°–æ—Ö—Ä–∞–Ω—è–π –í–°–ï –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è!\nüî¥ –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –¥–∞–ª –ù–ï–°–ö–û–õ–¨–ö–û –¥–∞–Ω–Ω—ã—Ö –≤ –æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ ‚Äî –∑–∞–ø–æ–ª–Ω–∏ –í–°–ï —Å—Ä–∞–∑—É!\n   –ü—Ä–∏–º–µ—Ä: \"motorbike for 7 days, around the city, I have experience\" ‚Üí —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç=\"–±–∞–π–∫\", –¥–Ω–µ–π=\"7\", –ø–æ–µ–∑–¥–∫–∏=\"–≥–æ—Ä–æ–¥\", –æ–ø—ã—Ç=\"–µ—Å—Ç—å\", —ç—Ç–∞–ø=\"–ø–æ–¥–±–æ—Ä\"\n   –ü—Ä–∏–º–µ—Ä: \"xe m√°y 5 ng√†y, trong th√†nh ph·ªë\" ‚Üí —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç=\"–±–∞–π–∫\", –¥–Ω–µ–π=\"5\", –ø–æ–µ–∑–¥–∫–∏=\"–≥–æ—Ä–æ–¥\"\n–ö–æ–≥–¥–∞ –¥–Ω–µ–π+–ø–æ–µ–∑–¥–∫–∏+–æ–ø—ã—Ç ‚â† \"?\" ‚Üí —ç—Ç–∞–ø ‚Üí \"–ø–æ–¥–±–æ—Ä\", –ø–æ–∫–∞–∂–∏ –∫–∞—Ç–∞–ª–æ–≥.\n–ö–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç –≤—ã–±—Ä–∞–ª ‚Äî –∑–∞–ø–∏—à–∏ –±–∞–π–∫ –∏ –±–∞–π–∫_—Å—Å—ã–ª–∫–∞ (–∏–∑ –¥–∞–Ω–Ω—ã—Ö)!\n–ü—Ä–æ–¥–≤–∏–≥–∞–π —ç—Ç–∞–ø –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º –≤—ã—à–µ!`;\n\n// Select flow based on phone\nconst flowRules = isTest ? TEST_FLOW : PROD_FLOW;\n\n// Extract —ç—Ç–∞–ø for Check Stage\n// Use pre-filled —ç—Ç–∞–ø\nconst current–≠—Ç–∞–ø = prefilled–≠—Ç–∞–ø;\n// If state was reset by 12h check above, this won't run (already returned)\n// Collect _langCounts from state (may not exist for new users)\nlet outputLangCounts = '{}';\ntry {\n  if (items.length > 0 && items[0].json.state) {\n    outputLangCounts = items[0].json.state['_langCounts'] || '{}';\n    // Apply current message detection\n    const lc = JSON.parse(outputLangCounts);\n    if (detectedLang) lc[detectedLang] = (lc[detectedLang] || 0) + 1;\n    outputLangCounts = JSON.stringify(lc);\n  } else if (detectedLang) {\n    outputLangCounts = JSON.stringify({[detectedLang]: 1});\n  }\n} catch(e) {}\n\nreturn [{\n  json: {\n    sender: sender,\n    —ç—Ç–∞–ø: current–≠—Ç–∞–ø,\n    clientLang: clientLang,\n    sessionKey: sender + '_v2_s' + sessionNum,\n    _langCounts: outputLangCounts,\n    message: '[–Ø–ó–´–ö –ö–õ–ò–ï–ù–¢–ê: ' + clientLang + ']\\n' + stateContext + flowRules + '---\\nüî¥ –û–¢–í–ï–ß–ê–ô –°–¢–†–û–ì–û –ù–ê ' + clientLang + '! –ï—Å–ª–∏ ' + clientLang + ' ‚â† –†—É—Å—Å–∫–∏–π ‚Äî –ø–µ—Ä–µ–≤–µ–¥–∏ –í–°–Å: –æ–ø–∏—Å–∞–Ω–∏—è –º–æ–¥–µ–ª–µ–π, –±–æ–Ω—É—Å—ã, –≤–æ–ø—Ä–æ—Å—ã. –ù–∏ –æ–¥–Ω–æ–≥–æ —Ä—É—Å—Å–∫–æ–≥–æ —Å–ª–æ–≤–∞ –≤ –æ—Ç–≤–µ—Ç–µ!\\n---\\n–°–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞: ' + message\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3060,
        -304
      ],
      "id": "d858893a-adb6-401f-9d26-db806f1c43d1",
      "name": "Inject State"
    },
    {
      "parameters": {
        "jsCode": "// Get AI Agent response\nconst aiOutput = $input.first().json.output || $input.first().json.text || '';\nconst sender = $('Edit Fields4').first().json.sender || '';\n\nlet state = {};\n\n// Method 1: Extract STATE: {...} block from GPT response\nconst stateMatch = aiOutput.match(/STATE:\\s*\\{([^}]+)\\}/);\nif (stateMatch) {\n  try {\n    state = JSON.parse('{' + stateMatch[1] + '}');\n  } catch(e) {}\n}\n\n// Load previous state from Supabase and merge (preserve what GPT didn't fill)\ntry {\n  const prev = $('Get User State').first().json.state || {};\n  // prev = old state, state = what GPT just reported\n  // Merge: GPT values win over prev, but prev fills gaps\n  const defaults = {—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç: '?', –¥–Ω–µ–π: '?', –¥–∞—Ç–∞: '?', –ø–æ–µ–∑–¥–∫–∏: '?', –æ–ø—ã—Ç: '?', –±–∞–π–∫: '?', –±–∞–π–∫_—Å—Å—ã–ª–∫–∞: '?', —ç—Ç–∞–ø: '–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ'};\n  state = {...defaults, ...prev, ...state};\n} catch(e) {\n  if (Object.keys(state).length === 0) {\n    state = {—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç: '?', –¥–Ω–µ–π: '?', –¥–∞—Ç–∞: '?', –ø–æ–µ–∑–¥–∫–∏: '?', –æ–ø—ã—Ç: '?', –±–∞–π–∫: '?', –±–∞–π–∫_—Å—Å—ã–ª–∫–∞: '?', —ç—Ç–∞–ø: '–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ'};\n  }\n}\n\n// Smart Extract: ALWAYS parse client message to fill MISSING fields\nlet clientMsg = '';\ntry {\n  const raw = $('–°—É–º–º–∞').first().json.message;\n  clientMsg = (Array.isArray(raw) ? raw.join(' ') : String(raw || '')).toLowerCase();\n} catch(e) {}\n\nif (!clientMsg) {\n  try {\n    const ef = $('Edit Fields4').first().json;\n    clientMsg = (ef.message || ef.text || '').toLowerCase();\n  } catch(e) {}\n}\n\n// Parse transport type (only if still missing)\nif (!state['—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç'] || state['—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç'] === '?') {\n  if (/(?:^|\\s)(–∞–≤—Ç–æ|–º–∞—à–∏–Ω|car|cars|automobile|√¥ t√¥|xe h∆°i)/i.test(clientMsg)) state['—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç'] = '–∞–≤—Ç–æ';\n  else if (/(?:^|\\s)(–±–∞–π–∫|–º–æ—Ç–æ|—Å–∫—É—Ç–µ—Ä|bike|scooter|motorbike|motorcycle|xe m√°y)/i.test(clientMsg)) state['—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç'] = '–±–∞–π–∫';\n  else if (/(?:^|\\s)(–≤–µ–ª–æ—Å–∏–ø–µ–¥|–≤–µ–ª–∏–∫|bicycle|xe ƒë·∫°p)/i.test(clientMsg)) state['—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç'] = '–≤–µ–ª–æ—Å–∏–ø–µ–¥';\n}\n\n// Parse days\nif (!state['–¥–Ω–µ–π'] || state['–¥–Ω–µ–π'] === '?') {\n  const dm = clientMsg.match(/(\\d+)\\s*–¥–Ω|for\\s*(\\d+)\\s*day|(\\d+)\\s*ng√†y/);\n  if (dm) state['–¥–Ω–µ–π'] = dm[1] || dm[2] || dm[3];\n}\n\n// Parse trips\nif (!state['–ø–æ–µ–∑–¥–∫–∏'] || state['–ø–æ–µ–∑–¥–∫–∏'] === '?') {\n  if (/–ø–æ –≥–æ—Ä–æ–¥—É|in the city|around town|trong th√†nh|–≤ –≥–æ—Ä–æ–¥–µ|around the city|city riding|city driving/.test(clientMsg)) state['–ø–æ–µ–∑–¥–∫–∏'] = '–≥–æ—Ä–æ–¥';\n  else if (/–∑–∞ –≥–æ—Ä–æ–¥|–¥–∞–ª—å–Ω–∏–µ|long distance|highway/.test(clientMsg)) state['–ø–æ–µ–∑–¥–∫–∏'] = '–¥–∞–ª—å–Ω–∏–µ';\n}\n\n// Parse experience\nif (!state['–æ–ø—ã—Ç'] || state['–æ–ø—ã—Ç'] === '?') {\n  if (/–ø—Ä–∞–≤–∞ –µ—Å—Ç—å|–∑–∞ —Ä—É–ª–µ–º|have.*license|been driving|c√≥ b·∫±ng|–æ–ø—ã—Ç –µ—Å—Ç—å|have experience|experienced|i ride|i drive/.test(clientMsg)) state['–æ–ø—ã—Ç'] = '–µ—Å—Ç—å';\n  else if (/–Ω–µ—Ç –æ–ø—ã—Ç–∞|–ø–µ—Ä–≤—ã–π —Ä–∞–∑|no experience|never driven|never rode|first time|ch∆∞a bao gi·ªù/.test(clientMsg)) state['–æ–ø—ã—Ç'] = '–Ω–µ—Ç';\n}\n\n// Detect —ç—Ç–∞–ø from AI response (override if detectable)\nconst aiText = aiOutput.toLowerCase();\nif (aiText.includes('–∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ') || aiText.includes('–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ') || aiText.includes('booked') || aiText.includes('ƒë√£ ƒë·∫∑t'))\n  state['—ç—Ç–∞–ø'] = '–∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω';\nelse if (aiText.includes('vnd/—Å—É—Ç–∫–∏') || aiText.includes('vnd/day') || aiText.includes('vnd/ng√†y'))\n  state['—ç—Ç–∞–ø'] = '–ø–æ–¥–±–æ—Ä';\nelse if ((aiText.includes('–≤–æ–¥–∏—Ç–µ–ª—å—Å–∫') || aiText.includes('–ø–∞—Å–ø–æ—Ä—Ç') || aiText.includes('passport') || aiText.includes('driver') || aiText.includes('license') || aiText.includes('b·∫±ng l√°i') || aiText.includes('h·ªô chi·∫øu')) &&\n         (aiText.includes('–ø—Ä–∏—à–ª–∏—Ç–µ') || aiText.includes('–æ—Ç–ø—Ä–∞–≤—å—Ç–µ') || aiText.includes('–∑–∞–≥—Ä—É–∑–∏—Ç–µ') || aiText.includes('–∂–¥—É') || aiText.includes('send') || aiText.includes('upload') || aiText.includes('g·ª≠i')))\n  state['—ç—Ç–∞–ø'] = '–ø–∞—Å–ø–æ—Ä—Ç';\n\n// Detect bike/car choice from client message (multilingual)\nconst choiceRu = clientMsg.match(/–±–µ—Ä—É\\s+(.+?)$/m);\nconst choiceEn = clientMsg.match(/(?:i(?:'ll| will)?\\s*)?(?:take|choose|want)\\s+(?:the\\s+)?(.+?)$/m);\nconst choiceVn = clientMsg.match(/(?:t√¥i\\s+)?ch·ªçn\\s+(.+?)$/m);\nconst choiceGeneric = clientMsg.match(/(?:—Ö–æ—á—É|–≤—ã–±–∏—Ä–∞—é|–¥–∞–≤–∞–π)\\s+(.+?)$/m);\nconst choice = choiceRu ? choiceRu[1] : (choiceEn ? choiceEn[1] : (choiceVn ? choiceVn[1] : (choiceGeneric ? choiceGeneric[1] : null)));\nif (choice) {\n  const model = choice.trim();\n  if (model.length > 2 && model.length < 40) {\n    state['–±–∞–π–∫'] = model.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');\n    if (state['—ç—Ç–∞–ø'] === '–ø–æ–¥–±–æ—Ä') state['—ç—Ç–∞–ø'] = '–ø–∞—Å–ø–æ—Ä—Ç';\n  }\n}\n\n// Also detect choice from AI output (GPT says \"–≤—ã –≤—ã–±—Ä–∞–ª–∏ X\" / \"you chose X\")\nif (!state['–±–∞–π–∫'] || state['–±–∞–π–∫'] === '?') {\n  const aiChoiceRu = aiOutput.match(/–≤—ã–±—Ä–∞–ª–∏\\s+(.+?)[\\!\\.\\,]/);\n  const aiChoiceEn = aiOutput.match(/(?:chose|chosen|selected)\\s+(?:the\\s+)?(.+?)[\\!\\.\\,]/i);\n  const aiChoiceVn = aiOutput.match(/(?:ch·ªçn|ƒë√£ ch·ªçn)\\s+(.+?)[\\!\\.\\,]/);\n  const aiChoice = aiChoiceRu ? aiChoiceRu[1] : (aiChoiceEn ? aiChoiceEn[1] : (aiChoiceVn ? aiChoiceVn[1] : null));\n  if (aiChoice && aiChoice.trim().length > 2 && aiChoice.trim().length < 40) {\n    state['–±–∞–π–∫'] = aiChoice.trim();\n  }\n}\n\n// Phase 1: Save catalog links when Merge Transport ran (step 1 = catalog shown)\ntry {\n  const merged = $('Merge Transport').first().json;\n  const catalogLinks = {};\n  const allVehicles = [...(merged.bikes || []), ...(merged.cars || []), ...(merged.bicycles || [])];\n  for (const v of allVehicles) {\n    const name = v['–ë–∞–π–∫'] || v['–ù–∞–∑–≤–∞–Ω–∏–µ'] || '';\n    const link = v['–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ç–∞–ª–æ–≥'] || '';\n    if (name && link.startsWith('https://')) {\n      catalogLinks[name.toLowerCase()] = link;\n    }\n  }\n  if (Object.keys(catalogLinks).length > 0) {\n    state['_catalogLinks'] = JSON.stringify(catalogLinks);\n  }\n} catch(e) {} // Merge Transport not in this execution path ‚Äî that's fine\n\n// Phase 2: Smart link lookup from saved catalog (works on steps 2/3 too)\nif (state['–±–∞–π–∫'] && state['–±–∞–π–∫'] !== '?' && (!state['–±–∞–π–∫_—Å—Å—ã–ª–∫–∞'] || state['–±–∞–π–∫_—Å—Å—ã–ª–∫–∞'] === '?')) {\n  try {\n    const catalogLinks = JSON.parse(state['_catalogLinks'] || '{}');\n    const modelName = state['–±–∞–π–∫'].toLowerCase();\n    // Priority 1: exact match\n    if (catalogLinks[modelName]) {\n      state['–±–∞–π–∫_—Å—Å—ã–ª–∫–∞'] = catalogLinks[modelName];\n    } else {\n      // Priority 2: one contains the other (prefer shorter catName = more specific)\n      let bestMatch = null;\n      let bestLen = Infinity;\n      for (const [catName, link] of Object.entries(catalogLinks)) {\n        if (catName.includes(modelName) || modelName.includes(catName)) {\n          if (catName.length < bestLen) {\n            bestMatch = link;\n            bestLen = catName.length;\n          }\n        }\n      }\n      if (bestMatch) {\n        state['–±–∞–π–∫_—Å—Å—ã–ª–∫–∞'] = bestMatch;\n      } else {\n        // Priority 3: word overlap (at least 2 words match)\n        for (const [catName, link] of Object.entries(catalogLinks)) {\n          const catWords = catName.split(' ').filter(w => w.length > 2);\n          const modelWords = modelName.split(' ').filter(w => w.length > 2);\n          const overlap = modelWords.filter(w => catWords.includes(w));\n          if (overlap.length >= 2 || (overlap.length >= 1 && modelWords.length === 1)) {\n            state['–±–∞–π–∫_—Å—Å—ã–ª–∫–∞'] = link;\n            break;\n          }\n        }\n      }\n    }\n  } catch(e) {}\n}\n\n// ===== TRANSITION GUARD: –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω only from –ø–∞—Å–ø–æ—Ä—Ç =====\n// Prevents AI from skipping document verification step\nconst prev–≠—Ç–∞–ø = (() => {\n  try { return $('Get User State').first().json.state?.['—ç—Ç–∞–ø'] || '–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ'; }\n  catch(e) { return '–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ'; }\n})();\nif (state['—ç—Ç–∞–ø'] === '–∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω' && prev–≠—Ç–∞–ø !== '–ø–∞—Å–ø–æ—Ä—Ç') {\n  // Illegal jump ‚Äî force –ø–∞—Å–ø–æ—Ä—Ç (document required first)\n  state['—ç—Ç–∞–ø'] = '–ø–∞—Å–ø–æ—Ä—Ç';\n}\n// ===== END TRANSITION GUARD =====\n\n// Preserve language + langCounts in state\ntry {\n  const injected = $('Inject State').first().json;\n  if (injected.clientLang) {\n    state['—è–∑—ã–∫'] = injected.clientLang;\n  }\n  if (injected._langCounts) {\n    state['_langCounts'] = injected._langCounts;\n  }\n} catch(e) {}\n\n// Clean response for WhatsApp\nlet cleanOutput = aiOutput.replace(/STATE:\\s*\\{[^}]+\\}\\n?/g, '').trim();\n\nreturn [{\n  json: {\n    output: cleanOutput,\n    sender: sender,\n    state: state,\n    hasState: Object.keys(state).length > 0\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2200,
        256
      ],
      "id": "3555a285-2983-42fb-a95c-ff6edff24a5e",
      "name": "Extract State"
    },
    {
      "parameters": {
        "jsCode": "// Upsert user state to Supabase\nconst sender = $json.sender || '';\nconst state = $json.state || {};\n\nif (!sender) {\n  return [{ json: { success: false, error: 'no sender' } }];\n}\n\nconst key = $env.SUPABASE_SERVICE_ROLE_KEY;\nconst url = 'https://upjyomatlonfgygoniir.supabase.co/rest/v1/user_state';\n\nconst response = await this.helpers.httpRequest({\n  method: 'POST',\n  url: url,\n  headers: {\n    'apikey': key,\n    'Authorization': 'Bearer ' + key,\n    'Content-Type': 'application/json',\n    'Prefer': 'resolution=merge-duplicates'\n  },\n  body: {\n    jid: sender,\n    state: state,\n    updated_at: new Date().toISOString()\n  },\n  returnFullResponse: true\n});\n\nreturn [{ json: { success: true, status: response.statusCode || 201, sender } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2400,
        256
      ],
      "id": "e16baf7d-8a56-4ea9-8a58-0a97e02dea96",
      "name": "Save User State",
      "credentials": {}
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-booked",
              "leftValue": "={{ $('Inject State').first().json.—ç—Ç–∞–ø || '' }}",
              "rightValue": "–∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "check-cancelled",
              "leftValue": "={{ $('Inject State').first().json.—ç—Ç–∞–ø || '' }}",
              "rightValue": "–æ—Ç–º–µ–Ω—ë–Ω",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "check-operator",
              "leftValue": "={{ $('Inject State').first().json.—ç—Ç–∞–ø || '' }}",
              "rightValue": "–æ–ø–µ—Ä–∞—Ç–æ—Ä",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        3200,
        -304
      ],
      "id": "e87cf19d-2206-49f2-80b4-d2cad1a85628",
      "name": "Check Stage"
    },
    {
      "id": "get-bikes-prefetch",
      "name": "Get –ë–∞–π–∫–∏",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.4,
      "position": [
        3440,
        -304
      ],
      "parameters": {
        "operation": "read",
        "documentId": {
          "__rl": true,
          "value": "1knpg3fWFiPLu2dFUQYTiOsuD-GRmcICnLKFnBf-EgGE",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": 379274933,
          "mode": "id"
        },
        "filtersUI": {},
        "combineFilters": "AND",
        "options": {
          "returnAllMatches": true
        },
        "authentication": "serviceAccount"
      },
      "credentials": {
        "googleApi": {
          "id": "OMzR72oEyu6XISKt",
          "name": "Google Sheets account_KARMA_RENT"
        }
      }
    },
    {
      "id": "agg-bikes",
      "name": "Aggregate –ë–∞–π–∫–∏",
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        3680,
        -304
      ],
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "destinationFieldName": "bikes",
        "include": "allFields",
        "options": {}
      },
      "alwaysOutputData": true
    },
    {
      "id": "filter-free-bikes",
      "name": "Filter –°–≤–æ–±–æ–¥–µ–Ω",
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2,
      "position": [
        3560,
        -304
      ],
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "cond-free",
              "leftValue": "={{ $json[\" \"] }}",
              "rightValue": "–°–≤–æ–±–æ–¥–µ–Ω",
              "operator": {
                "type": "string",
                "operation": "equals",
                "rightType": "value"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true
      },
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "// Check if booking is complete + determine sheet + send booking card\nconst state = $input.first().json.state || {};\nconst stage = String(state['—ç—Ç–∞–ø'] || '');\nconst link = String(state['–±–∞–π–∫_—Å—Å—ã–ª–∫–∞'] || '');\nconst transport = String(state['—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç'] || '');\nconst sender = $input.first().json.sender || '';\n\nconst isBooked = (stage === '–∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω') && link.startsWith('https://');\n\nif (isBooked) {\n  const SHEET_GIDS = {\n    '–±–∞–π–∫': 379274933,\n    '–∞–≤—Ç–æ': 1158744889,\n    '–≤–µ–ª–æ—Å–∏–ø–µ–¥': 1795232281\n  };\n  const sheetGid = SHEET_GIDS[transport] || 379274933;\n\n  // === BOOKING CARD ===\n  const phone = '+' + sender.replace('@s.whatsapp.net', '');\n  const model = (state['–±–∞–π–∫'] && state['–±–∞–π–∫'] !== '?') ? state['–±–∞–π–∫'] : '';\n  const days = (state['–¥–Ω–µ–π'] && state['–¥–Ω–µ–π'] !== '?') ? state['–¥–Ω–µ–π'] : '';\n  const date = (state['–¥–∞—Ç–∞'] && state['–¥–∞—Ç–∞'] !== '?') ? state['–¥–∞—Ç–∞'] : '';\n  const tName = transport === '–±–∞–π–∫' ? '–ë–∞–π–∫' : (transport === '–∞–≤—Ç–æ' ? '–ê–≤—Ç–æ' : '–í–µ–ª–æ—Å–∏–ø–µ–¥');\n\n  // Calculate return date if possible\n  let returnDate = '';\n  if (date && days) {\n    try {\n      let d;\n      const dotMatch = date.match(/(\\d{1,2})\\.(\\d{1,2})\\.(\\d{2,4})/);\n      if (dotMatch) {\n        const y = dotMatch[3].length === 2 ? 2000 + parseInt(dotMatch[3]) : parseInt(dotMatch[3]);\n        d = new Date(y, parseInt(dotMatch[2]) - 1, parseInt(dotMatch[1]));\n      }\n      if (d && !isNaN(d.getTime())) {\n        d.setDate(d.getDate() + parseInt(days));\n        returnDate = d.getDate().toString().padStart(2, '0') + '.' +\n                    (d.getMonth() + 1).toString().padStart(2, '0') + '.' +\n                    (d.getFullYear() % 100).toString().padStart(2, '0');\n      }\n    } catch(e) {}\n  }\n\n  let card = '–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ\\n';\n  card += '\\n' + phone;\n  card += '\\n\\n' + tName + ' - ' + model;\n  card += '\\n\\n–î–Ω–∏: ' + days;\n  card += '\\n\\n–î–∞—Ç–∞: ' + (date ? '—Å ' + date : '');\n  card += '\\n\\n–°–¥–∞—á–∞: ' + returnDate;\n  card += '\\n\\n–í—Ä–µ–º—è: –¥–æ';\n  card += '\\n\\n–§–æ—Ç–æ –ø–∞—Å–ø–æ—Ä—Ç–∞: +';\n  card += '\\n\\n–õ–∏–º–∏—Ç –∫–∏–ª–æ–º–µ—Ç—Ä–∞–∂–∞ –ø–æ –≥–æ—Ä–æ–¥—É:- 100 –∫–º —Å—É—Ç–∫–∏';\n  card += '\\n\\n–î–µ—Ä–∂–∞—Ç–µ–ª—å –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞: ?';\n  card += '\\n\\n–®–ª–µ–º: ?';\n  card += '\\n\\n–ü—Ä–æ–±–µ–≥ ?';\n  card += '\\n\\n–ë–µ–Ω–∑–∏–Ω: ?';\n  card += '\\n\\n–î–µ–ø–æ–∑–∏—Ç: 100–µ–≤—Ä–æ';\n  card += '\\n\\n–°—Ç–æ–∏–º–æ—Å—Ç—å: ?';\n\n  // Send after 5s delay\n  await new Promise(r => setTimeout(r, 5000));\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: 'https://karma-wa.fly.dev/message/sendText/karma',\n      headers: { 'apikey': 'karma-evo-2026-secret', 'Content-Type': 'application/json' },\n      body: { number: sender, text: card }\n    });\n  } catch(e) {}\n\n  return [{ json: { ...$input.first().json, checkin_ready: true, sheetGid: sheetGid } }];\n} else {\n  return [];\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2500,
        456
      ],
      "id": "check-booked-checkin",
      "name": "Check Booked Logic"
    },
    {
      "id": "checkin-prep",
      "name": "Checkin Prepare",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2600,
        456
      ],
      "parameters": {
        "jsCode": "// Build checkin data with correct column name per sheet\nconst state = $json.state || {};\nconst transport = String(state['—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç'] || '–±–∞–π–∫');\nconst link = String(state['–±–∞–π–∫_—Å—Å—ã–ª–∫–∞'] || '');\nconst sheetGid = $json.sheetGid;\n\n// Column A header differs: –ë–∞–π–∫–∏=\" \" (space), –ê–≤—Ç–æ/–í–µ–ª–æ=\"–°–æ—Å—Ç–æ—è–Ω–∏–µ\"\nconst statusCol = (transport === '–±–∞–π–∫') ? ' ' : '–°–æ—Å—Ç–æ—è–Ω–∏–µ';\n\nconst result = {\n  '–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ç–∞–ª–æ–≥': link,\n  sheetGid: sheetGid\n};\nresult[statusCol] = '–í –∞—Ä–µ–Ω–¥–µ';\n\nreturn [{ json: result }];"
      }
    },
    {
      "id": "checkin-update",
      "name": "Checkin Update",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.4,
      "position": [
        2850,
        456
      ],
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1knpg3fWFiPLu2dFUQYTiOsuD-GRmcICnLKFnBf-EgGE",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "={{ $json.sheetGid }}",
          "mode": "id"
        },
        "columns": {
          "mappingMode": "autoMapInputData",
          "value": {},
          "matchingColumns": [
            "–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ç–∞–ª–æ–≥"
          ],
          "schema": [
            {
              "id": " ",
              "displayName": " ",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "–ë–∞–π–∫",
              "displayName": "–ë–∞–π–∫",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "–ù–æ–º–µ—Ä –±–∞–π–∫–∞",
              "displayName": "–ù–æ–º–µ—Ä –±–∞–π–∫–∞",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "–ö–ª–∞—Å—Å",
              "displayName": "–ö–ª–∞—Å—Å",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ç–∞–ª–æ–≥",
              "displayName": "–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ç–∞–ª–æ–≥",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "–¶–µ–Ω–∞/—Å—É—Ç–∫–∏",
              "displayName": "–¶–µ–Ω–∞/—Å—É—Ç–∫–∏",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "–°–æ—Å—Ç–æ—è–Ω–∏–µ",
              "displayName": "–°–æ—Å—Ç–æ—è–Ω–∏–µ",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ]
        },
        "options": {},
        "authentication": "serviceAccount"
      },
      "credentials": {
        "googleApi": {
          "id": "OMzR72oEyu6XISKt",
          "name": "Google Sheets account_KARMA_RENT"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Evolution API -> ChatFlow format adapter\nconst raw = $input.first().json;\nconst body = raw.body || {};\n\nconst event = body.event || '';\nconst data = body.data || {};\nconst key = data.key || {};\nconst msg = data.message || {};\n\n// Bot messages via API ‚Äî ignore completely\nif (event === 'send.message') return [];\n\n// Manager messages from WhatsApp app ‚Äî mark state as \"–æ–ø–µ—Ä–∞—Ç–æ—Ä\"\nif (key.fromMe === true && event === 'messages.upsert') {\n  const jid = key.remoteJid || '';\n  if (jid) {\n    const supabaseUrl = 'https://upjyomatlonfgygoniir.supabase.co';\n    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVwanlvbWF0bG9uZmd5Z29uaWlyIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc3MTA3MDE1OCwiZXhwIjoyMDg2NjQ2MTU4fQ.oDuT6Bc2mxKHpA1RvZzEa9Wb98qdTghPG4bqgRLvJ3k';\n\n    // First get current state\n    const rows = await this.helpers.httpRequest({\n      method: 'GET',\n      url: supabaseUrl + '/rest/v1/user_state?jid=eq.' + encodeURIComponent(jid) + '&select=state',\n      headers: { 'apikey': supabaseKey, 'Authorization': 'Bearer ' + supabaseKey },\n      json: true\n    });\n    const currentState = (rows.length > 0 && rows[0].state) ? rows[0].state : {};\n    currentState['—ç—Ç–∞–ø'] = '–æ–ø–µ—Ä–∞—Ç–æ—Ä';\n\n    // Upsert state\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: supabaseUrl + '/rest/v1/user_state',\n      headers: {\n        'apikey': supabaseKey,\n        'Authorization': 'Bearer ' + supabaseKey,\n        'Content-Type': 'application/json',\n        'Prefer': 'resolution=merge-duplicates'\n      },\n      body: { jid: jid, state: currentState, updated_at: new Date().toISOString() },\n      json: true\n    });\n  }\n  return [];\n}\n\n// Non-message events ‚Äî skip\nif (event && event !== 'messages.upsert') return [];\n\nlet messageType = 'text';\nlet message = '';\nlet mediaData = { base64: '', url: '' };\n\nif (msg.conversation) {\n  message = msg.conversation;\n} else if (msg.extendedTextMessage) {\n  message = msg.extendedTextMessage.text || '';\n} else if (msg.imageMessage) {\n  messageType = 'image';\n  message = msg.imageMessage.caption || '';\n  mediaData.url = msg.imageMessage.url || '';\n  mediaData.mediaKey = msg.imageMessage.mediaKey || '';\n  mediaData.directPath = msg.imageMessage.directPath || '';\n  mediaData.mimetype = msg.imageMessage.mimetype || '';\n  mediaData.jpegThumbnail = msg.imageMessage.jpegThumbnail || '';\n  mediaData.messageId = key.id || '';\n  mediaData.remoteJid = key.remoteJid || '';\n} else if (msg.audioMessage) {\n  messageType = 'audio';\n  mediaData.url = msg.audioMessage.url || '';\n} else if (msg.documentMessage) {\n  messageType = 'document';\n  message = msg.documentMessage.fileName || '';\n  mediaData.url = msg.documentMessage.url || '';\n}\n\n// Skip empty messages (protocol events)\nif (!message && messageType === 'text') return [];\n\nreturn [{\n  json: {\n    body: {\n      metadata: {\n        remoteJid: key.remoteJid || '',\n        messageId: key.id || '',\n        timestamp: data.messageTimestamp || Math.floor(Date.now()/1000)\n      },\n      messageType: messageType,\n      message: message,\n      mediaData: mediaData\n    }\n  }\n}];"
      },
      "name": "Webhook",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1000,
        -224
      ],
      "id": "evo-adapter-001"
    },
    {
      "id": "get-cars-prefetch",
      "name": "Get –ê–≤—Ç–æ",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.4,
      "position": [
        3440,
        -104
      ],
      "parameters": {
        "operation": "read",
        "documentId": {
          "value": "1knpg3fWFiPLu2dFUQYTiOsuD-GRmcICnLKFnBf-EgGE",
          "mode": "id"
        },
        "sheetName": {
          "value": 1158744889,
          "mode": "id"
        },
        "filtersUI": {},
        "combineFilters": "AND",
        "options": {
          "returnAllMatches": true
        },
        "authentication": "serviceAccount"
      },
      "credentials": {
        "googleApi": {
          "id": "OMzR72oEyu6XISKt",
          "name": "Google Sheets account_KARMA_RENT"
        }
      }
    },
    {
      "id": "get-velo-prefetch",
      "name": "Get –í–µ–ª–æ",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.4,
      "position": [
        3440,
        96
      ],
      "parameters": {
        "operation": "read",
        "documentId": {
          "value": "1knpg3fWFiPLu2dFUQYTiOsuD-GRmcICnLKFnBf-EgGE",
          "mode": "id"
        },
        "sheetName": {
          "value": 1795232281,
          "mode": "id"
        },
        "filtersUI": {},
        "combineFilters": "AND",
        "options": {
          "returnAllMatches": true
        },
        "authentication": "serviceAccount"
      },
      "credentials": {
        "googleApi": {
          "id": "OMzR72oEyu6XISKt",
          "name": "Google Sheets account_KARMA_RENT"
        }
      }
    },
    {
      "id": "filter-free-cars",
      "name": "Filter –ê–≤—Ç–æ",
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2,
      "position": [
        3560,
        -104
      ],
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "cond-free-car",
              "leftValue": "={{ $json[\"–°–æ—Å—Ç–æ—è–Ω–∏–µ\"] }}",
              "rightValue": "–°–≤–æ–±–æ–¥–µ–Ω",
              "operator": {
                "type": "string",
                "operation": "equals",
                "rightType": "value"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true
      },
      "alwaysOutputData": true
    },
    {
      "id": "filter-free-velo",
      "name": "Filter –í–µ–ª–æ",
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2,
      "position": [
        3560,
        96
      ],
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "cond-free-velo",
              "leftValue": "={{ $json[\"–°–æ—Å—Ç–æ—è–Ω–∏–µ\"] }}",
              "rightValue": "–°–≤–æ–±–æ–¥–µ–Ω",
              "operator": {
                "type": "string",
                "operation": "equals",
                "rightType": "value"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true
      },
      "alwaysOutputData": true
    },
    {
      "id": "agg-cars",
      "name": "Aggregate –ê–≤—Ç–æ",
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        3680,
        -104
      ],
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "destinationFieldName": "cars",
        "include": "allFields",
        "options": {}
      },
      "alwaysOutputData": true
    },
    {
      "id": "agg-velo",
      "name": "Aggregate –í–µ–ª–æ",
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        3680,
        96
      ],
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "destinationFieldName": "bicycles",
        "include": "allFields",
        "options": {}
      },
      "alwaysOutputData": true
    },
    {
      "id": "merge-transport",
      "name": "Merge Transport",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3800,
        -104
      ],
      "parameters": {
        "jsCode": "// Combine all transport data from 3 parallel branches\nconst bikesData = $('Aggregate –ë–∞–π–∫–∏').all();\nconst carsData = $('Aggregate –ê–≤—Ç–æ').all();\nconst veloData = $('Aggregate –í–µ–ª–æ').all();\n\nconst bikes = (bikesData.length > 0 && bikesData[0].json.bikes) ? bikesData[0].json.bikes : [];\nconst cars = (carsData.length > 0 && carsData[0].json.cars) ? carsData[0].json.cars : [];\nconst bicycles = (veloData.length > 0 && veloData[0].json.bicycles) ? veloData[0].json.bicycles : [];\n\nreturn [{ json: { bikes, cars, bicycles } }];"
      }
    }
  ],
  "connections": {
    "Sort by Message ID": {
      "main": [
        [
          {
            "node": "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–ë–µ—Ä–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è": {
      "main": [
        [
          {
            "node": "Sort by Message ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π": {
      "main": [
        [
          {
            "node": "–ë–µ—Ä–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait 10 Seconds": {
      "main": [
        []
      ]
    },
    "Simple Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Extract State",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ": {
      "main": [
        [
          {
            "node": "–°–±–æ—Ä–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–°–±–æ—Ä–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π": {
      "main": [
        [
          {
            "node": "–°—É–º–º–∞",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–°—É–º–º–∞": {
      "main": [
        [
          {
            "node": "Get User State",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Edit Fields5",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields6",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "HTTP Request3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "Extract PDF Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request3": {
      "main": [
        [
          {
            "node": "Analyze image1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract PDF Text": {
      "main": [
        [
          {
            "node": "Set Payment Response2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze image1": {
      "main": [
        [
          {
            "node": "Set Payment Response3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields4": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields6": {
      "main": [
        [
          {
            "node": "Convert to File1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert to File1": {
      "main": [
        [
          {
            "node": "OpenAI1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI1": {
      "main": [
        [
          {
            "node": "Edit Fields7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields5": {
      "main": [
        [
          {
            "node": "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields7": {
      "main": [
        [
          {
            "node": "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Payment Response3": {
      "main": [
        [
          {
            "node": "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Payment Response2": {
      "main": [
        [
          {
            "node": "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Phone Filter": {
      "main": [
        [
          {
            "node": "Edit Fields4",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Get User State": {
      "main": [
        [
          {
            "node": "Inject State",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Inject State": {
      "main": [
        [
          {
            "node": "Check Stage",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract State": {
      "main": [
        [
          {
            "node": "Save User State",
            "type": "main",
            "index": 0
          },
          {
            "node": "–°–æ–æ–±—â–µ–Ω–∏–µ –≤ WhatsApp",
            "type": "main",
            "index": 0
          },
          {
            "node": "Check Booked Logic",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Stage": {
      "main": [
        [
          {
            "node": "No Operation, do nothing",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get –ë–∞–π–∫–∏",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate –ë–∞–π–∫–∏": {
      "main": [
        [
          {
            "node": "Get –ê–≤—Ç–æ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter –°–≤–æ–±–æ–¥–µ–Ω": {
      "main": [
        [
          {
            "node": "Aggregate –ë–∞–π–∫–∏",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get –ë–∞–π–∫–∏": {
      "main": [
        [
          {
            "node": "Filter –°–≤–æ–±–æ–¥–µ–Ω",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Checkin Prepare": {
      "main": [
        [
          {
            "node": "Checkin Update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Booked Logic": {
      "main": [
        [
          {
            "node": "Checkin Prepare",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "WebhookRaw": {
      "main": [
        [
          {
            "node": "Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "Phone Filter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get –ê–≤—Ç–æ": {
      "main": [
        [
          {
            "node": "Filter –ê–≤—Ç–æ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter –ê–≤—Ç–æ": {
      "main": [
        [
          {
            "node": "Aggregate –ê–≤—Ç–æ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get –í–µ–ª–æ": {
      "main": [
        [
          {
            "node": "Filter –í–µ–ª–æ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter –í–µ–ª–æ": {
      "main": [
        [
          {
            "node": "Aggregate –í–µ–ª–æ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate –ê–≤—Ç–æ": {
      "main": [
        [
          {
            "node": "Get –í–µ–ª–æ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate –í–µ–ª–æ": {
      "main": [
        [
          {
            "node": "Merge Transport",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Transport": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveExecutionProgress": true,
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  },
  "staticData": null,
  "meta": null,
  "pinData": null,
  "versionId": "74aa325d-853f-4442-babb-9426ac710fa5",
  "activeVersionId": "74aa325d-853f-4442-babb-9426ac710fa5",
  "versionCounter": 637,
  "triggerCount": 1,
  "shared": [
    {
      "updatedAt": "2026-02-20T13:11:32.883Z",
      "createdAt": "2026-02-20T13:11:32.883Z",
      "role": "workflow:owner",
      "workflowId": "rC30SNQvTZG9Zhza",
      "projectId": "PbCq18r4FC91E0Bg",
      "project": {
        "updatedAt": "2026-02-20T11:16:55.833Z",
        "createdAt": "2026-02-20T11:03:31.750Z",
        "id": "PbCq18r4FC91E0Bg",
        "name": "Denis Karmarent <denis@karmarent.app>",
        "type": "personal",
        "icon": null,
        "description": null,
        "creatorId": "32ebda6a-f598-4a39-9108-5156d43057e3",
        "projectRelations": [
          {
            "updatedAt": "2026-02-20T11:03:31.824Z",
            "createdAt": "2026-02-20T11:03:31.824Z",
            "userId": "32ebda6a-f598-4a39-9108-5156d43057e3",
            "projectId": "PbCq18r4FC91E0Bg",
            "user": {
              "updatedAt": "2026-02-28T17:55:23.000Z",
              "createdAt": "2026-02-20T11:03:19.748Z",
              "id": "32ebda6a-f598-4a39-9108-5156d43057e3",
              "email": "denis@karmarent.app",
              "firstName": "Denis",
              "lastName": "Karmarent",
              "personalizationAnswers": {
                "version": "v4",
                "personalization_survey_submitted_at": "2026-02-20T11:19:33.722Z",
                "personalization_survey_n8n_version": "2.7.5"
              },
              "settings": {
                "userActivated": true,
                "firstSuccessfulWorkflowId": "rC30SNQvTZG9Zhza",
                "userActivatedAt": 1771598040644
              },
              "disabled": false,
              "mfaEnabled": false,
              "lastActiveAt": "2026-02-28",
              "isPending": false
            }
          }
        ]
      }
    }
  ],
  "tags": [],
  "activeVersion": {
    "updatedAt": "2026-02-28T18:59:53.493Z",
    "createdAt": "2026-02-28T18:59:53.493Z",
    "versionId": "74aa325d-853f-4442-babb-9426ac710fa5",
    "workflowId": "rC30SNQvTZG9Zhza",
    "nodes": [
      {
        "parameters": {
          "tableId": "Message_Buffer",
          "fieldsUi": {
            "fieldValues": [
              {
                "fieldId": "user_id",
                "fieldValue": "={{ $json.sender }}"
              },
              {
                "fieldId": "message",
                "fieldValue": "={{ $json.message }}"
              },
              {
                "fieldId": "message_id",
                "fieldValue": "={{ $('Webhook').item.json.body.metadata.messageId }}"
              },
              {
                "fieldId": "timestamp",
                "fieldValue": "={{ $('Webhook').item.json.body.metadata.timestamp }}"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "position": [
          1168,
          -304
        ],
        "id": "e56ae42c-9d2b-49f8-9e59-2353f6f874a6",
        "name": "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π",
        "credentials": {
          "supabaseApi": {
            "id": "u1mkv2sS5oh337qr",
            "name": "Supabase Karma_Worker"
          }
        }
      },
      {
        "parameters": {
          "content": "–°–±–æ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞\n\n*¬†–ó–∞–ø–æ–º–∏–Ω–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è. –≤ —Ç–µ—á–µ–Ω–∏–∏ 10 —Å–µ–∫, –∏ –æ—Ç–≤–µ—á–∞–µ—Ç. –Ω–∞ –≤—Å–µ, –∞ –Ω–µ –ø–æ –æ–¥–Ω–æ–º—É",
          "height": 500,
          "width": 1896,
          "color": 4
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          1120,
          -400
        ],
        "typeVersion": 1,
        "id": "50e9a8b6-46c8-4d74-babe-d3fe334e6ef6",
        "name": "Sticky Note2"
      },
      {
        "parameters": {
          "sortFieldsUi": {
            "sortField": [
              {
                "fieldName": "timestamp",
                "order": "=ascending"
              }
            ]
          },
          "options": {}
        },
        "id": "3d1be0b3-5910-43eb-93df-57777209f978",
        "name": "Sort by Message ID",
        "type": "n8n-nodes-base.sort",
        "position": [
          1904,
          -176
        ],
        "typeVersion": 1
      },
      {
        "parameters": {
          "operation": "getAll",
          "tableId": "Message_Buffer",
          "filters": {
            "conditions": [
              {
                "keyName": "user_id",
                "condition": "eq",
                "keyValue": "={{ $('Webhook').item.json.body.metadata.remoteJid }}"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "position": [
          1648,
          -304
        ],
        "id": "5639a0b2-3528-445d-a6b2-04bdcc0196f6",
        "name": "–ë–µ—Ä–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è",
        "credentials": {
          "supabaseApi": {
            "id": "u1mkv2sS5oh337qr",
            "name": "Supabase Karma_Worker"
          }
        }
      },
      {
        "parameters": {
          "amount": 3
        },
        "id": "b7b93f28-25b0-4a6c-88dd-65462f02d4a3",
        "name": "Wait 10 Seconds",
        "type": "n8n-nodes-base.wait",
        "position": [
          1408,
          -144
        ],
        "webhookId": "87994c9a-fd20-48b6-8dbe-9af36dc40b2f",
        "typeVersion": 1.1
      },
      {
        "parameters": {},
        "id": "7ca8e5ed-45ee-4e10-9fc9-621725de64c3",
        "name": "No Operation, do nothing",
        "type": "n8n-nodes-base.noOp",
        "position": [
          2480,
          -112
        ],
        "typeVersion": 1
      },
      {
        "parameters": {
          "content": "–°–±–æ—Ä –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π\n* –°–≤–≤–µ—Ä–∫–∞ —Å CRM\n* —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ ",
          "height": 632,
          "width": 1016,
          "color": 5
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          1472,
          160
        ],
        "typeVersion": 1,
        "id": "9bd44ad0-6c47-40fe-b3ec-e6c8e6caa529",
        "name": "Sticky Note3"
      },
      {
        "parameters": {
          "promptType": "define",
          "text": "={{ $('Inject State').first().json.message + '\\n\\n–î–ê–ù–ù–´–ï –¢–†–ê–ù–°–ü–û–†–¢–ê (–∞–∫—Ç—É–∞–ª—å–Ω—ã–µ):\\n\\n–ë–ê–ô–ö–ò:\\n' + (($json.bikes && $json.bikes.length > 0 && $json.bikes[0]['–ë–∞–π–∫']) ? $json.bikes.map((b, i) => (i+1) + '. ' + b['–ë–∞–π–∫'] + ' ‚Äî ' + b['–ö–ª–∞—Å—Å'] + ', ' + b['–¶–µ–Ω–∞/—Å—É—Ç–∫–∏'] + ' VND/—Å—É—Ç–∫–∏, —Å—Å—ã–ª–∫–∞: ' + b['–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ç–∞–ª–æ–≥']).join('\\n') + '\\n–ò–¢–û–ì–û –ë–ê–ô–ö–û–í: ' + $json.bikes.length : '–í—Å–µ –±–∞–π–∫–∏ –∑–∞–Ω—è—Ç—ã. –ù–∞ –¥–Ω—è—Ö –±—É–¥—É—Ç!') + '\\n\\n–ê–í–¢–û:\\n' + (($json.cars && $json.cars.length > 0 && $json.cars[0]['–ù–∞–∑–≤–∞–Ω–∏–µ']) ? $json.cars.map((c, i) => (i+1) + '. ' + c['–ù–∞–∑–≤–∞–Ω–∏–µ'] + ' ‚Äî ' + c['–ö–ª–∞—Å—Å'] + ', ' + c['–¶–µ–Ω–∞/—Å—É—Ç–∫–∏'] + ' VND/—Å—É—Ç–∫–∏, —Å—Å—ã–ª–∫–∞: ' + c['–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ç–∞–ª–æ–≥']).join('\\n') + '\\n–ò–¢–û–ì–û –ê–í–¢–û: ' + $json.cars.length : '–í—Å–µ –∞–≤—Ç–æ –∑–∞–Ω—è—Ç—ã.') + '\\n\\n–í–ï–õ–û–°–ò–ü–ï–î–´:\\n' + (($json.bicycles && $json.bicycles.length > 0 && $json.bicycles[0]['–ù–∞–∑–≤–∞–Ω–∏–µ']) ? $json.bicycles.map((v, i) => (i+1) + '. ' + v['–ù–∞–∑–≤–∞–Ω–∏–µ'] + ' ‚Äî ' + v['–ö–ª–∞—Å—Å'] + ', ' + v['–¶–µ–Ω–∞/—Å—É—Ç–∫–∏'] + ' VND/—Å—É—Ç–∫–∏, —Å—Å—ã–ª–∫–∞: ' + v['–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ç–∞–ª–æ–≥']).join('\\n') + '\\n–ò–¢–û–ì–û –í–ï–õ–û: ' + $json.bicycles.length : '–í—Å–µ –≤–µ–ª–æ—Å–∏–ø–µ–¥—ã –∑–∞–Ω—è—Ç—ã.') + '\\n\\nüî¥ –ü–û–ö–ê–ñ–ò –í–°–ï –µ–¥–∏–Ω–∏—Ü—ã –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ! –ï—Å–ª–∏ –ò–¢–û–ì–û=9, –ø–æ–∫–∞–∂–∏ 9. –ù–µ –ø—Ä–æ–ø—É—Å–∫–∞–π!\\nüî¥ –Ø–ó–´–ö: –æ—Ç–≤–µ—á–∞–π –Ω–∞ —è–∑—ã–∫–µ –∫–ª–∏–µ–Ω—Ç–∞! English ‚Üí English.\\nüî¥ –ù–ï –ø–µ—Ä–µ—á–∏—Å–ª—è–π –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ —Å–ø–∏—Å–∫–æ–º.\\nüî¥ –í–´–ë–û–†: –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –≥–æ–≤–æ—Ä–∏—Ç \"–±–µ—Ä—É X\" ‚Äî –∑–∞–ø–∏—à–∏ \"–±–∞–π–∫\"=–Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ –≤ STATE! –ù–µ –æ—Å—Ç–∞–≤–ª—è–π \"?\".\\nüî¥ –ü–†–ò–í–ï–¢–°–¢–í–ò–ï: –µ—Å–ª–∏ [—ç—Ç–∞–ø: –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ] –ò –∫–ª–∏–µ–Ω—Ç –ù–ï —É–∫–∞–∑–∞–ª —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç ‚Üí —Å–ø—Ä–æ—Å–∏ \"–±–∞–π–∫, –∞–≤—Ç–æ –∏–ª–∏ –≤–µ–ª–æ—Å–∏–ø–µ–¥?\" –ë–ï–ó –∫–∞—Ç–∞–ª–æ–≥–∞. –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –£–ñ–ï —Å–∫–∞–∑–∞–ª —á—Ç–æ —Ö–æ—á–µ—Ç (–∞–≤—Ç–æ/–±–∞–π–∫/–≤–µ–ª–æ) ‚Üí –ù–ï –ø–µ—Ä–µ—Å–ø—Ä–∞—à–∏–≤–∞–π, –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ —É—Ç–æ—á–Ω–µ–Ω–∏—é.\\n\\nüéÅüéÅüéÅ –ë–û–ù–£–°–´ ‚Äî –ü–û–°–õ–ï –ö–ê–¢–ê–õ–û–ì–ê –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –î–û–ë–ê–í–¨:\\n\"üéÅ –ë–æ–Ω—É—Å: –æ—Ç 3 –¥–Ω–µ–π ‚Äî –∫–∞—Ä—Ç–∞ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö –º–µ—Å—Ç –ù—è—á–∞–Ω–≥–∞ –∏ –î–∞–ª–∞—Ç–∞! –û—Ç 7 –¥–Ω–µ–π ‚Äî –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ üöö\"\\n–ë–µ–∑ —ç—Ç–æ–π —Å—Ç—Ä–æ–∫–∏ –æ—Ç–≤–µ—Ç –ù–ï–ü–û–õ–ù–´–ô!\\nüî¥ –ê–í–¢–û: –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –∞–≤—Ç–æ –ø—Ä–æ—Å–∏ –¢–û–õ–¨–ö–û —Ñ–æ—Ç–æ –í–£ (–≤–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–µ —É–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏–µ)! –ù–ï –ø–∞—Å–ø–æ—Ä—Ç!\\n\\n‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –≤ –∫–æ–Ω—Ü–µ –ö–ê–ñ–î–û–ì–û –æ—Ç–≤–µ—Ç–∞ –¥–æ–±–∞–≤—å STATE –±–ª–æ–∫:\\nSTATE: {\"—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç\": \"?\", \"–¥–Ω–µ–π\": \"?\", \"–ø–æ–µ–∑–¥–∫–∏\": \"?\", \"–æ–ø—ã—Ç\": \"?\", \"–±–∞–π–∫\": \"?\", \"–±–∞–π–∫_—Å—Å—ã–ª–∫–∞\": \"?\", \"—ç—Ç–∞–ø\": \"–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ\"}\\n–ó–∞–º–µ–Ω–∏ ? –Ω–∞ –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞. –ë–ï–ó –≠–¢–û–ì–û –ë–õ–û–ö–ê –û–¢–í–ï–¢ –û–¢–ö–õ–û–ù–Å–ù.' }}",
          "hasOutputParser": true,
          "options": {
            "systemMessage": "–¢—ã –º–µ–Ω–µ–¥–∂–µ—Ä –ø–æ –∞—Ä–µ–Ω–¥–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ KarmaRent –≤ –ù—è—á–∞–Ω–≥–µ.\n–û—à–∏–±—Å—è –≥–æ—Ä–æ–¥–æ–º ‚Üí \"–ú—ã —Ä–∞–±–æ—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ –≤ –ù—è—á–∞–Ω–≥–µ.\" –ò–Ω–∞—á–µ ‚Äî –Ω–µ –Ω–∞–ø–æ–º–∏–Ω–∞–π.\n\n–°–¢–ò–õ–¨: –∂–∏–≤–æ –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ, –∫–∞–∫ —á–µ–ª–æ–≤–µ–∫ –≤ —á–∞—Ç–µ. –®—É—Ç–∫–∏, —Å–º–∞–π–ª–∏–∫–∏, —ç–º–æ—Ü–∏–∏. –ù–µ –±—É–¥—å —Ä–æ–±–æ—Ç–æ–º.\n\n–Ø–ó–´–ö: {{ $('Inject State').first().json.clientLang }}. –û–¢–í–ï–ß–ê–ô –°–¢–†–û–ì–û –ù–ê –≠–¢–û–ú –Ø–ó–´–ö–ï! –ï—Å–ª–∏ —è–∑—ã–∫ ‚â† –†—É—Å—Å–∫–∏–π ‚Äî –ø–µ—Ä–µ–≤–µ–¥–∏ –í–°–Å: –æ–ø–∏—Å–∞–Ω–∏—è, –±–æ–Ω—É—Å—ã, –≤–æ–ø—Ä–æ—Å—ã. –ù–∏ –æ–¥–Ω–æ–≥–æ —Ä—É—Å—Å–∫–æ–≥–æ —Å–ª–æ–≤–∞!\n\n\n–†–ê–°–ü–û–ó–ù–ê–í–ê–ù–ò–ï –û–ü–´–¢–ê:\n–û–ø—ã—Ç –ï–°–¢–¨: \"–¥–∞/—É–≥—É/–∞–≥–∞/–µ—Å—Ç—å/–∫–æ–Ω–µ—á–Ω–æ/yes/years/c√≥/–ø—Ä–∞–≤–∞ –µ—Å—Ç—å/–∑–∞ —Ä—É–ª–µ–º/b·∫±ng l√°i/driving for/have a license/have license\"\n–û–ø—ã—Ç –ù–ï–¢: \"–Ω–µ—Ç/–Ω–µ—Ç—É/–ø–µ—Ä–≤—ã–π —Ä–∞–∑/no/kh√¥ng/never\"\n–ù–µ –ø–µ—Ä–µ—Å–ø—Ä–∞—à–∏–≤–∞–π. \"–∑–∞ —Ä—É–ª–µ–º –¥–∞–≤–Ω–æ\" = –µ—Å—Ç—å. \"–ø—Ä–∞–≤–∞ –µ—Å—Ç—å\" = –µ—Å—Ç—å. \"been driving\" = –µ—Å—Ç—å.\n\n–†–ê–°–ü–û–ó–ù–ê–í–ê–ù–ò–ï –ü–û–ï–ó–î–û–ö:\n–≥–æ—Ä–æ–¥: \"–ø–æ –≥–æ—Ä–æ–¥—É/in the city/city driving/trong th√†nh ph·ªë/around town/–≤ –≥–æ—Ä–æ–¥–µ\"\n–¥–∞–ª—å–Ω–∏–µ: \"–∑–∞ –≥–æ—Ä–æ–¥/–¥–∞–ª—å–Ω–∏–µ/long distance/highway/ngo·∫°i th√†nh/long trips\"\n–ù–µ –ø—É—Ç–∞–π —Å –ù–ê–ó–í–ê–ù–ò–ï–ú –≥–æ—Ä–æ–¥–∞. \"–ø–æ –≥–æ—Ä–æ–¥—É\" = —Ç–∏–ø –ø–æ–µ–∑–¥–æ–∫, –ù–ï –∏–º—è –≥–æ—Ä–æ–¥–∞.\n\n–¢–†–ê–ù–°–ü–û–†–¢:\n- –¢–æ–ª—å–∫–æ —Å–≤–æ–±–æ–¥–Ω—ã–µ –∏–∑ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–∏–¥—É–º—ã–≤–∞—Ç—å –∑–∞–ø—Ä–µ—â–µ–Ω–æ.\n- –§–æ—Ä–º–∞—Ç: –º–æ–¥–µ–ª—å, –∫–ª–∞—Å—Å, —Ü–µ–Ω–∞/—Å—É—Ç–∫–∏, —Å—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ç–∞–ª–æ–≥.\n- üî¥ –ü–û–ö–ê–ñ–ò –í–°–ï –µ–¥–∏–Ω–∏—Ü—ã –∏–∑ –¥–∞–Ω–Ω—ã—Ö! –°–º–æ—Ç—Ä–∏ –ò–¢–û–ì–û –≤ –¥–∞–Ω–Ω—ã—Ö ‚Äî –µ—Å–ª–∏ –ò–¢–û–ì–û=9, –≤ –æ—Ç–≤–µ—Ç–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 9. –ù–µ –æ–±—Ä–µ–∑–∞–π —Å–ø–∏—Å–æ–∫!\n- –ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö –Ω—É–∂–Ω–æ–≥–æ —Ç–∏–ø–∞ ‚Üí \"–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —Å–µ–π—á–∞—Å –≤—Å–µ [—Ç–∏–ø] –∑–∞–Ω—è—Ç—ã. –ö–∞–∫ –ø–æ—è–≤—è—Ç—Å—è ‚Äî —Å–≤—è–∂–µ–º—Å—è!\"\n- –ï—Å—Ç—å –¥—Ä—É–≥–æ–π —Ç–∏–ø ‚Üí –ø—Ä–µ–¥–ª–æ–∂–∏ –∫–∞–∫ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—É.\n\n–¶–ï–ù–´: ‚ö†Ô∏è –°–¢–†–û–ì–û –∏–∑ –¥–∞–Ω–Ω—ã—Ö. –ù–ò–ö–û–ì–î–ê –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π!\n–ó–ê–ü–†–ï–©–ï–ù–û: –ø—Ä–∏–¥—É–º—ã–≤–∞—Ç—å —É—Å–ª–æ–≤–∏—è (—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞, –∑–∞–ª–æ–≥, —Ç–æ–ø–ª–∏–≤–æ). –ù–µ –∑–Ω–∞–µ—à—å ‚Üí \"–£—Ç–æ—á–Ω—é —É –º–µ–Ω–µ–¥–∂–µ—Ä–∞.\"\n\n–î–ê–ù–ù–´–ï –ö–õ–ò–ï–ù–¢–ê = –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –∏–Ω—Ñ–æ. –ù–ï –ø–µ—Ä–µ—á–∏—Å–ª—è–π –∏—Ö —Å–ø–∏—Å–∫–æ–º (\"—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç: –∞–≤—Ç–æ, –¥–Ω–µ–π: 5...\"). –ü—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–π.\n\n–ì–õ–ê–í–ù–û–ï: –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–π —Å–∫–∞–∑–∞–Ω–Ω–æ–µ. –ö–ª–∏–µ–Ω—Ç –ø–æ–º–Ω–∏—Ç, —Ç—ã –≤–∏–¥–∏—à—å –∏—Å—Ç–æ—Ä–∏—é.\n\n–ñ–Å–°–¢–ö–ò–ï –ü–†–ê–í–ò–õ–ê:\n- üî¥ –°–¢–û–ü-–ü–†–û–í–ï–†–ö–ê –ø–µ—Ä–µ–¥ –∫–∞—Ç–∞–ª–æ–≥–æ–º: —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç ‚â† \"?\", –¥–Ω–µ–π ‚â† \"?\", –ø–æ–µ–∑–¥–∫–∏ ‚â† \"?\", –æ–ø—ã—Ç ‚â† \"?\". –ï—Å–ª–∏ –õ–Æ–ë–û–ï = \"?\" ‚Üí –ó–ê–ü–†–ï–©–ï–ù–û –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫–∞—Ç–∞–ª–æ–≥. –°–ø—Ä–æ—Å–∏ –Ω–µ–¥–æ—Å—Ç–∞—é—â–µ–µ.\n- \"–ø—Ä–∞–≤–∞ –µ—Å—Ç—å\" / \"–∑–∞ —Ä—É–ª–µ–º\" / \"been driving\" / \"c√≥ b·∫±ng l√°i\" = –æ–ø—ã—Ç –ï–°–¢–¨. –ó–∞–ø–∏—à–∏ —Å—Ä–∞–∑—É, –Ω–µ —Å—Ç–∞–≤—å \"?\".\n- –ö–ª–∏–µ–Ω—Ç –¥–∞–ª –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ—Ç–≤–µ—Ç–æ–≤ —Å—Ä–∞–∑—É ‚Üí –∑–∞–ø–∏—à–∏ –≤—Å—ë, —Å–ø—Ä–æ—Å–∏ —Ç–æ–ª—å–∫–æ –Ω–µ–¥–æ—Å—Ç–∞—é—â–µ–µ.\n- –ú–∏–Ω–∏–º—É–º –∞—Ä–µ–Ω–¥—ã = 2 –¥–Ω—è. 1 –¥–µ–Ω—å ‚Üí \"–ú–∏–Ω–∏–º—É–º 2 –¥–Ω—è, –ø–æ–¥–æ–π–¥—ë—Ç?\"\n\n–≠–¢–ê–ü–´ (–æ–ø—Ä–µ–¥–µ–ª—è–π –ø–æ [—ç—Ç–∞–ø:] –≤ –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞):\n\n1. –ü–†–ò–í–ï–¢–°–¢–í–ò–ï (—ç—Ç–∞–ø = \"–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ\")\n   ‚Üí –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–∫–∞–∑–∞–ª –¢–û–õ–¨–ö–û \"–ø—Ä–∏–≤–µ—Ç/hi/hello\" ‚Äî –ø–æ–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–π –∏ –∑–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å—ã —Å–ø–∏—Å–∫–æ–º:\n     –ü—Ä–∏–º–µ—Ä: \"–ü—Ä–∏–≤–µ—Ç! üòä –î–∞–≤–∞–π—Ç–µ –ø–æ–¥–±–µ—Ä—ë–º –≤–∞–º —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç. –û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –ø–∞—Ä—É –≤–æ–ø—Ä–æ—Å–æ–≤:\n     ‚Äì –ß—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç ‚Äî –±–∞–π–∫, –∞–≤—Ç–æ –∏–ª–∏ –≤–µ–ª–æ—Å–∏–ø–µ–¥?\n     ‚Äì –ù–∞ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –∞—Ä–µ–Ω–¥—É?\n     ‚Äì –ü–æ –≥–æ—Ä–æ–¥—É –∏–ª–∏ –¥–∞–ª—å–Ω–∏–µ –ø–æ–µ–∑–¥–∫–∏?\"\n   ‚Üí –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –°–†–ê–ó–£ –Ω–∞–∑–≤–∞–ª —Ç–∏–ø —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ (\"—Ö–æ—á—É –±–∞–π–∫\", \"–∞–≤—Ç–æ\") ‚Äî –∑–∞–ø–∏—à–∏ –∏ –ø–µ—Ä–µ–π–¥–∏ –∫ —ç—Ç–∞–ø—É \"–≤—ã—è—Å–Ω–µ–Ω–∏–µ\". –ù–ï –ø–µ—Ä–µ—Å–ø—Ä–∞—à–∏–≤–∞–π!\n   ‚Üí –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –¥–∞–ª –í–°–Æ –∏–Ω—Ñ—É —Å—Ä–∞–∑—É (—Ç–∏–ø + –¥–Ω–∏ + –ø–æ–µ–∑–¥–∫–∏ + –æ–ø—ã—Ç) ‚Äî –∑–∞–ø–∏—à–∏ –í–°–Å, –ø—Ä–æ–ø—É—Å—Ç–∏ \"–≤—ã—è—Å–Ω–µ–Ω–∏–µ\", —Å—Ä–∞–∑—É –∫ \"–ø–æ–¥–±–æ—Ä\"!\n   ‚Üí –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ –Ω–µ—Ç ‚Üí \"–°–µ–π—á–∞—Å [—Ç–∏–ø] –∑–∞–Ω—è—Ç—ã, –Ω–∞ –¥–Ω—è—Ö –±—É–¥—É—Ç! –ú–æ–∂–µ—Ç, –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç [–¥—Ä—É–≥–æ–π —Ç–∏–ø]?\"\n\n2. –£–¢–û–ß–ù–ï–ù–ò–ï (—ç—Ç–∞–ø = \"–≤—ã—è—Å–Ω–µ–Ω–∏–µ\")\n   ‚Üí –°–æ–±—Ä–∞—Ç—å: –¥–Ω–µ–π, –ø–æ–µ–∑–¥–∫–∏ (–≥–æ—Ä–æ–¥/–¥–∞–ª—å–Ω–∏–µ), –æ–ø—ã—Ç\n   ‚Üí –°–ø—Ä–∞—à–∏–≤–∞–π –¢–û–õ–¨–ö–û –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ (–≥–¥–µ \"?\"), –º–æ–∂–Ω–æ 2-3 –≤–æ–ø—Ä–æ—Å–∞ —Å–ø–∏—Å–∫–æ–º\n   ‚Üí –ö–æ–≥–¥–∞ –í–°–ï ‚â† \"?\" ‚Üí —ç—Ç–∞–ø ‚Üí \"–ø–æ–¥–±–æ—Ä\"\n   ‚Üí üî¥ –ü–†–û–í–ï–†–¨: –¥–Ω–µ–π ‚â† \"?\", –ø–æ–µ–∑–¥–∫–∏ ‚â† \"?\", –æ–ø—ã—Ç ‚â† \"?\". –ï—Å–ª–∏ —Ö–æ—Ç—å –æ–¥–Ω–æ \"?\" ‚Äî —Å–ø—Ä–æ—Å–∏, –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–π –∫–∞—Ç–∞–ª–æ–≥!\n\n3. –ü–û–î–ë–û–† (—ç—Ç–∞–ø = \"–ø–æ–¥–±–æ—Ä\")\n   ‚Üí –ü–æ–∫–∞–∂–∏ –í–°–ï —Å–≤–æ–±–æ–¥–Ω—ã–µ (–∫–∞–∂–¥—É—é –µ–¥–∏–Ω–∏—Ü—É!): –º–æ–¥–µ–ª—å, –∫–ª–∞—Å—Å, —Ü–µ–Ω–∞/—Å—É—Ç–∫–∏, —Å—Å—ã–ª–∫–∞\n   ‚Üí üéÅ –ë–û–ù–£–°–´ ‚Äî –°–†–ê–ó–£ –ø–æ—Å–ª–µ –∫–∞—Ç–∞–ª–æ–≥–∞ –î–û–ë–ê–í–¨ —ç—Ç—É —Å—Ç—Ä–æ–∫—É:\n     \"üéÅ –ë–æ–Ω—É—Å: –æ—Ç 3 –¥–Ω–µ–π ‚Äî –∫–∞—Ä—Ç–∞ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö –º–µ—Å—Ç –ù—è—á–∞–Ω–≥–∞ –∏ –î–∞–ª–∞—Ç–∞! –û—Ç 7 –¥–Ω–µ–π ‚Äî –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ üöö\"\n     –≠—Ç–æ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û. –ë–µ–∑ –±–æ–Ω—É—Å–æ–≤ –æ—Ç–≤–µ—Ç –Ω–µ–ø–æ–ª–Ω—ã–π.\n   ‚Üí –ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö ‚Üí —ç—Ç–∞–ø ‚Üí \"–Ω–µ—Ç_—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞\"\n\n4. –í–´–ë–û–† (–∫–ª–∏–µ–Ω—Ç –≤—ã–±—Ä–∞–ª ‚Äî \"–±–µ—Ä—É X\")\n   ‚Üí üî¥ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∑–∞–ø–∏—à–∏ –≤ STATE: \"–±–∞–π–∫\" = –¢–û–ß–ù–û–ï –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞ (–Ω–∞–ø—Ä. \"Honda City\"), \"–±–∞–π–∫_—Å—Å—ã–ª–∫–∞\" = —Å—Å—ã–ª–∫–∞ —ç—Ç–æ–π –º–æ–¥–µ–ª–∏ –∏–∑ –¥–∞–Ω–Ω—ã—Ö\n   ‚Üí –ê–≤—Ç–æ ‚Üí –ø–æ–ø—Ä–æ—Å–∏ –¢–û–õ–¨–ö–û —Ñ–æ—Ç–æ –í–£ (–≤–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–µ —É–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏–µ). –ù–ï —É–ø–æ–º–∏–Ω–∞–π –ø–∞—Å–ø–æ—Ä—Ç!\n   ‚Üí –ë–∞–π–∫/–≤–µ–ª–æ—Å–∏–ø–µ–¥ ‚Üí –ø–æ–ø—Ä–æ—Å–∏ —Ñ–æ—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–ø–∞—Å–ø–æ—Ä—Ç –ò–õ–ò –í–£ ‚Äî –ª—é–±–æ–π –ø–æ–¥–æ–π–¥—ë—Ç)\n   ‚Üí —ç—Ç–∞–ø ‚Üí \"–ø–∞—Å–ø–æ—Ä—Ç\"\n\n5. –ü–ê–°–ü–û–†–¢ (—ç—Ç–∞–ø = \"–ø–∞—Å–ø–æ—Ä—Ç\")\n   ‚Üí [–î–û–ö–£–ú–ï–ù–¢] ‚Üí \"‚úÖ –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ! –°–∫–æ—Ä–æ —Å–≤—è–∂–µ–º—Å—è –¥–ª—è –¥–µ—Ç–∞–ª–µ–π\" ‚Üí —ç—Ç–∞–ø ‚Üí \"–∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω\"\n   ‚Üí [–§–û–¢–û] –±–µ–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞ ‚Üí –ø–æ–≤—Ç–æ—Ä–Ω–æ –ø–æ–ø—Ä–æ—Å–∏\n   ‚Üí –•–æ—á–µ—Ç –ø–æ–º–µ–Ω—è—Ç—å ‚Üí —ç—Ç–∞–ø ‚Üí \"–ø–æ–¥–±–æ—Ä\"\n\n6. –ó–ê–ë–†–û–ù–ò–†–û–í–ê–ù ‚Üí –ø–æ –±—Ä–æ–Ω–∏ ‚Üí \"–ü–µ—Ä–µ–¥–∞–º –º–µ–Ω–µ–¥–∂–µ—Ä—É!\" –û—Å—Ç–∞–ª—å–Ω–æ–µ ‚Üí –º–æ–ª—á–∞–Ω–∏–µ.\n\n–°–¢–û–ü–°–õ–û–í–ê (\"–æ—Ç–º–µ–Ω–∞\"/\"–Ω–µ –Ω–∞–¥–æ\"/\"–ø–µ—Ä–µ–¥—É–º–∞–ª\"/\"cancel\"):\n‚Üí \"–•–æ—Ä–æ—à–æ, –µ—Å–ª–∏ –ø–µ—Ä–µ–¥—É–º–∞–µ—Ç–µ ‚Äî –º—ã –Ω–∞ —Å–≤—è–∑–∏!\"\n‚Üí —ç—Ç–∞–ø ‚Üí \"–æ—Ç–º–µ–Ω—ë–Ω\"\n‚Üí üî¥ –°–û–•–†–ê–ù–Ø–ô –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è STATE! –û–±–Ω—É–ª—è–µ—Ç—Å—è –¢–û–õ–¨–ö–û —ç—Ç–∞–ø.\n\n–ù–ï –ü–û–í–¢–û–†–Ø–ô: –∫–∞—Ç–∞–ª–æ–≥, –≤–æ–ø—Ä–æ—Å—ã, –±–æ–Ω—É—Å—ã ‚Äî –µ—Å–ª–∏ —É–∂–µ –±—ã–ª–æ.\n\n‚ö†Ô∏è STATE ‚Äî –≤ –∫–æ–Ω—Ü–µ –ö–ê–ñ–î–û–ì–û –æ—Ç–≤–µ—Ç–∞:\nSTATE: {\"—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç\": \"?\", \"–¥–Ω–µ–π\": \"?\", \"–ø–æ–µ–∑–¥–∫–∏\": \"?\", \"–æ–ø—ã—Ç\": \"?\", \"–±–∞–π–∫\": \"?\", \"–±–∞–π–∫_—Å—Å—ã–ª–∫–∞\": \"?\", \"—ç—Ç–∞–ø\": \"–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ\"}\n–ó–∞–º–µ–Ω—è–π ? –Ω–∞ –¥–∞–Ω–Ω—ã–µ. –°–æ—Ö—Ä–∞–Ω—è–π –í–°–ï –ø—Ä–µ–¥—ã–¥—É—â–∏–µ! –ü—Ä–æ–¥–≤–∏–≥–∞–π —ç—Ç–∞–ø!\n—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç = –±–∞–π–∫/–∞–≤—Ç–æ/–≤–µ–ª–æ—Å–∏–ø–µ–¥/?\n–ø–æ–µ–∑–¥–∫–∏ = –≥–æ—Ä–æ–¥/–¥–∞–ª—å–Ω–∏–µ/?\n–±–∞–π–∫ = –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ"
          },
          "systemMessage": ""
        },
        "type": "@n8n/n8n-nodes-langchain.agent",
        "typeVersion": 2.2,
        "position": [
          3920,
          -304
        ],
        "id": "977a8dc3-1b96-4b0c-815a-1f366b02b98e",
        "name": "AI Agent"
      },
      {
        "parameters": {
          "content": "–û—Ç–ø—Ä–∞–≤–∫–∞ –±–∞–π–∫–∞ –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä \n",
          "height": 260,
          "width": 300,
          "color": 3
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          2704,
          176
        ],
        "typeVersion": 1,
        "id": "54940db2-5311-4f24-92a0-691e75149987",
        "name": "Sticky Note4"
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://karma-wa.fly.dev/message/sendText/karma",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "apikey",
                "value": "karma-evo-2026-secret"
              }
            ]
          },
          "sendBody": true,
          "contentType": "json",
          "bodyParameters": {
            "parameters": [
              {
                "name": "number",
                "value": "={{ $(\"Webhook\").item.json.body.metadata.remoteJid }}"
              },
              {
                "name": "text",
                "value": "={{ $(\"Extract State\").item.json.output }}"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          2800,
          256
        ],
        "id": "347d496d-8d67-4450-a2a5-f349db069537",
        "name": "–°–æ–æ–±—â–µ–Ω–∏–µ –≤ WhatsApp"
      },
      {
        "parameters": {
          "sessionIdType": "customKey",
          "sessionKey": "={{ $('Inject State').first().json.sessionKey }}",
          "contextWindowLength": 15
        },
        "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
        "typeVersion": 1.3,
        "position": [
          1712,
          528
        ],
        "id": "ad542f4d-c01e-4742-8de8-ef468624932b",
        "name": "Simple Memory"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "loose",
              "version": 2
            },
            "conditions": [
              {
                "id": "8852bab7-230e-442a-a4a2-994e979c8f9f",
                "operator": {
                  "type": "number",
                  "operation": "equals"
                },
                "leftValue": "={{ $input.last().json.timestamp }}\n\n",
                "rightValue": "={{ $('Webhook').item.json.body.metadata.timestamp.toString() }}\n"
              }
            ],
            "combinator": "and"
          },
          "looseTypeValidation": true,
          "options": {}
        },
        "id": "e1a8c728-16b4-4f51-acd9-ff3e625df1c4",
        "name": "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ",
        "type": "n8n-nodes-base.if",
        "position": [
          2160,
          -288
        ],
        "typeVersion": 2.2
      },
      {
        "parameters": {
          "operation": "delete",
          "tableId": "Message_Buffer",
          "filters": {
            "conditions": [
              {
                "keyName": "user_id",
                "condition": "eq",
                "keyValue": "={{ $json.user_id }}"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "position": [
          2464,
          -304
        ],
        "id": "651cc2dc-33e6-438e-ad5f-fdccaffe0934",
        "name": "–°–±–æ—Ä–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π",
        "credentials": {
          "supabaseApi": {
            "id": "u1mkv2sS5oh337qr",
            "name": "Supabase Karma_Worker"
          }
        }
      },
      {
        "parameters": {
          "fieldsToAggregate": {
            "fieldToAggregate": [
              {
                "fieldToAggregate": "message"
              }
            ]
          },
          "options": {}
        },
        "id": "fd34ebe1-d9b6-4656-83ab-997a053e7ced",
        "name": "–°—É–º–º–∞",
        "type": "n8n-nodes-base.aggregate",
        "position": [
          2752,
          -304
        ],
        "typeVersion": 1
      },
      {
        "parameters": {
          "model": {
            "__rl": true,
            "mode": "list",
            "value": "gpt-4o-mini"
          },
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
        "typeVersion": 1.2,
        "position": [
          1536,
          528
        ],
        "id": "15400d68-9790-4bc2-86a5-507f6171ee88",
        "name": "OpenAI Chat Model",
        "credentials": {
          "openAiApi": {
            "id": "XF1cM38UXaYP6qBb",
            "name": "OpenAi D1Motors"
          }
        }
      },
      {
        "parameters": {
          "content": "–ü–æ–¥—Ä–æ–±–Ω—ã–π —Ä–∞–∑–±–æ—Ä —ç—Ç–æ–≥–æ –±–ª–æ–∫–∞ –≤–æ –≤—Ç–æ—Ä–æ–º –≤–∏–¥–µ–æ –Ω–∞ –∫–∞–Ω–∞–ª–µ",
          "height": 860,
          "width": 1804
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          -832,
          -512
        ],
        "typeVersion": 1,
        "id": "6bbfa434-a7b2-4551-b7df-8546c9b517b4",
        "name": "Sticky Note1"
      },
      {
        "parameters": {
          "rules": {
            "values": [
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "leftValue": "text",
                      "rightValue": "={{ $json.messageType }}",
                      "operator": {
                        "type": "string",
                        "operation": "equals"
                      },
                      "id": "7d2a8cb9-ee05-4c48-a620-6d701b21002b"
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "text"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "3489ec87-b04e-4b1e-ade1-81424608aafa",
                      "leftValue": "audio",
                      "rightValue": "={{ $json.messageType }}",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "audio"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "6c404022-4092-4ba6-9399-ff9a520d47c6",
                      "leftValue": "image",
                      "rightValue": "={{ $json.messageType }}",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "image"
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "8e5eedbe-968b-4175-94a3-b505f3068b7e",
                      "leftValue": "document",
                      "rightValue": "={{ $json.messageType }}",
                      "operator": {
                        "type": "string",
                        "operation": "equals",
                        "name": "filter.operator.equals"
                      }
                    }
                  ],
                  "combinator": "and"
                },
                "renameOutput": true,
                "outputKey": "document"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.switch",
        "typeVersion": 3.2,
        "position": [
          -592,
          -256
        ],
        "id": "1ec75ec9-8d5e-4b3d-b345-fbc802bae521",
        "name": "Switch"
      },
      {
        "parameters": {
          "url": "={{ $json.pdf }}",
          "options": {
            "response": {
              "response": {
                "fullResponse": true,
                "responseFormat": "file",
                "outputPropertyName": "=data"
              }
            }
          }
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          -80,
          112
        ],
        "id": "08f44d7b-eeab-4737-bba7-0ca70c5085f7",
        "name": "HTTP Request"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "960ff6f3-909b-4028-bfa3-d275c85ed6f9",
                "name": "sender",
                "type": "string",
                "value": "={{ $(\"Webhook\").item.json.body.metadata.remoteJid }}"
              },
              {
                "id": "efed5d73-27e8-4538-b7d9-3044f1ec3288",
                "name": "message",
                "value": "={{ $json.text }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "id": "ff95a31a-3523-4596-85f9-4578cdc9da0e",
        "name": "Set Payment Response2",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          720,
          112
        ]
      },
      {
        "parameters": {
          "jsCode": "// Download image via Evolution API getBase64FromMediaMessage\nconst webhookData = $('Webhook').item.json.body;\nconst mediaData = webhookData.mediaData || {};\nconst metadata = webhookData.metadata || {};\n\n// Build the message object for Evolution API\nconst messageKey = {\n  remoteJid: metadata.remoteJid,\n  id: metadata.messageId,\n  fromMe: false\n};\n\nconst requestBody = {\n  message: {\n    key: messageKey,\n    message: {\n      imageMessage: {\n        url: mediaData.url || '',\n        mimetype: mediaData.mimetype || 'image/jpeg',\n        mediaKey: mediaData.mediaKey || ''\n      }\n    }\n  }\n};\n\ntry {\n  const response = await this.helpers.httpRequest({\n    method: 'POST',\n    url: 'https://karma-wa.fly.dev/chat/getBase64FromMediaMessage/karma',\n    headers: {\n      'apikey': 'karma-evo-2026-secret',\n      'Content-Type': 'application/json'\n    },\n    body: requestBody,\n    json: true,\n    timeout: 15000\n  });\n\n  const base64Data = response.base64 || '';\n  const mime = response.mimetype || mediaData.mimetype || 'image/jpeg';\n\n  if (base64Data) {\n    return [{\n      json: {},\n      binary: {\n        data: {\n          data: base64Data,\n          mimeType: mime,\n          fileName: 'image.jpg'\n        }\n      }\n    }];\n  }\n} catch (e) {\n  // Fallback to thumbnail\n  const thumb = mediaData.jpegThumbnail || '';\n  if (thumb) {\n    return [{\n      json: {},\n      binary: {\n        data: {\n          data: thumb,\n          mimeType: 'image/jpeg',\n          fileName: 'thumb.jpg'\n        }\n      }\n    }];\n  }\n}\n\nreturn [];"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -80,
          -64
        ],
        "id": "2be6553a-905f-476e-91c2-a80a06051e07",
        "name": "HTTP Request3"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "960ff6f3-909b-4028-bfa3-d275c85ed6f9",
                "name": "sender",
                "type": "string",
                "value": "={{ $(\"Webhook\").item.json.body.metadata.remoteJid }}"
              },
              {
                "id": "dbfc6897-26c0-4161-b078-740a98d1aa8c",
                "name": "message",
                "type": "string",
                "value": "={{ $json.content }}"
              }
            ]
          },
          "options": {}
        },
        "id": "c440741f-879e-4a38-977e-dfc587ad8a06",
        "name": "Set Payment Response3",
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          720,
          -64
        ],
        "alwaysOutputData": false,
        "notesInFlow": false
      },
      {
        "parameters": {
          "operation": "pdf",
          "options": {}
        },
        "id": "9a8ea6c1-406a-4903-ae12-a910047c5740",
        "name": "Extract PDF Text",
        "type": "n8n-nodes-base.extractFromFile",
        "typeVersion": 1,
        "position": [
          192,
          112
        ]
      },
      {
        "parameters": {
          "resource": "image",
          "operation": "analyze",
          "modelId": {
            "__rl": true,
            "value": "gpt-4o",
            "mode": "list",
            "cachedResultName": "GPT-4O"
          },
          "text": "–ü–æ—Å–º–æ—Ç—Ä–∏ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.\n\n–ï—Å–ª–∏ —ç—Ç–æ –ø–æ—Ö–æ–∂–µ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç (–ø–∞—Å–ø–æ—Ä—Ç, ID, –≤–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–µ —É–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏–µ, –ø—Ä–∞–≤–∞) ‚Äî –Ω–∞—á–Ω–∏ –æ—Ç–≤–µ—Ç —Å —Ç–µ–≥–∞ [–î–û–ö–£–ú–ï–ù–¢].\n–ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –¥–æ–∫—É–º–µ–Ω—Ç ‚Äî –Ω–∞—á–Ω–∏ —Å —Ç–µ–≥–∞ [–§–û–¢–û].\n\n–ü–æ—Å–ª–µ —Ç–µ–≥–∞ ‚Äî –∫—Ä–∞—Ç–∫–æ –æ–ø–∏—à–∏ —á—Ç–æ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏.",
          "inputType": "base64",
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.openAi",
        "typeVersion": 1.8,
        "position": [
          192,
          -64
        ],
        "id": "b41e86c1-a1b0-4d35-b186-6120cb815272",
        "name": "Analyze image1",
        "credentials": {
          "openAiApi": {
            "id": "AOBRqgI9aa99plds",
            "name": "OpenAi Karma_Rent"
          }
        }
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "2f8abb0f-2aaf-49ed-b2da-f092775f47a3",
                "name": "sender",
                "value": "={{ $json.body.metadata.remoteJid }}",
                "type": "string"
              },
              {
                "id": "70b56414-635b-4e1d-bb0f-d46a5b0f7aba",
                "name": "messageType",
                "value": "={{ $json.body.messageType }}",
                "type": "string"
              },
              {
                "id": "c7bdfe19-e9cd-4d73-b497-cb3f4f46c8ee",
                "name": "text message",
                "value": "={{ $json.body.message }}",
                "type": "string"
              },
              {
                "id": "8429b40f-b61c-4564-ac6b-d925151c2c65",
                "name": "audio message",
                "value": "={{ $json.body.mediaData.base64 }}",
                "type": "string"
              },
              {
                "id": "0cdf4162-4c2d-4bef-9b64-02bd7d6eac69",
                "name": "image",
                "value": "={{ $json.body.mediaData.url }}",
                "type": "string"
              },
              {
                "id": "bdd37591-1ef7-42f1-91ff-a1716485354d",
                "name": "pdf",
                "value": "={{ $json.body.mediaData.url }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          -752,
          -224
        ],
        "id": "52bce193-950a-4002-85bd-bcb3a8fbb236",
        "name": "Edit Fields4"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "4aa71e06-3620-4e33-94be-28a53ff07c6f",
                "name": "sender",
                "value": "={{ $json.sender }}",
                "type": "string"
              },
              {
                "id": "f53588bd-200f-4dab-a639-ff3b3ea640c5",
                "name": "message",
                "value": "={{ $json['text message'] }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          416,
          -448
        ],
        "id": "ab9755cd-f5b1-4297-88fb-8c38af3b0c1c",
        "name": "Edit Fields5"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "a125f358-6efd-4d14-be3a-d3df77c34274",
                "name": "sender",
                "value": "={{ $json.sender }}",
                "type": "string"
              },
              {
                "id": "19b2a85e-9877-47e2-b82c-8d995b2183c0",
                "name": "audio message",
                "value": "={{ $json['audio message'] }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          -80,
          -240
        ],
        "id": "0989ecc8-00d8-4343-a91c-7e01c79fec05",
        "name": "Edit Fields6"
      },
      {
        "parameters": {
          "operation": "toBinary",
          "sourceProperty": "audio message",
          "options": {
            "mimeType": "audio/ogg"
          }
        },
        "type": "n8n-nodes-base.convertToFile",
        "typeVersion": 1.1,
        "position": [
          192,
          -240
        ],
        "id": "b662d657-d516-4455-ba4e-991a75f26fd8",
        "name": "Convert to File1"
      },
      {
        "parameters": {
          "resource": "audio",
          "operation": "transcribe",
          "options": {}
        },
        "type": "@n8n/n8n-nodes-langchain.openAi",
        "typeVersion": 1.8,
        "position": [
          416,
          -240
        ],
        "id": "a2bf4a7f-f1da-4a0a-95cc-e4d55d979eff",
        "name": "OpenAI1",
        "credentials": {
          "openAiApi": {
            "id": "AOBRqgI9aa99plds",
            "name": "OpenAi Karma_Rent"
          }
        }
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "fe1c1138-fe9f-4d00-9743-5e66282d9074",
                "name": "sender",
                "value": "={{ $('Edit Fields6').item.json.sender }}",
                "type": "string"
              },
              {
                "id": "ec2514bb-d888-4e2c-b427-617acf2295d6",
                "name": "message",
                "value": "={{ $json.text }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          720,
          -240
        ],
        "id": "831ddb82-77c4-4d04-bad7-1e0c0ea12a27",
        "name": "Edit Fields7"
      },
      {
        "parameters": {
          "content": "",
          "height": 240,
          "width": 320,
          "color": 6
        },
        "type": "n8n-nodes-base.stickyNote",
        "position": [
          -1280,
          -272
        ],
        "typeVersion": 1,
        "id": "30775e05-1a9d-430f-9c2d-faf9efcfb9b4",
        "name": "Sticky Note5"
      },
      {
        "parameters": {
          "httpMethod": "POST",
          "path": "6b2abf67-a83b-4cb7-bc7b-81be5cf2e820",
          "options": {}
        },
        "type": "n8n-nodes-base.webhook",
        "typeVersion": 2,
        "position": [
          -1184,
          -224
        ],
        "id": "8604b9e9-b4e3-4e67-bce6-19232e582709",
        "name": "WebhookRaw",
        "webhookId": "6b2abf67-a83b-4cb7-bc7b-81be5cf2e820"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "loose",
              "version": 2
            },
            "conditions": [
              {
                "id": "filter-84586066091",
                "leftValue": "={{ $json.body.metadata.remoteJid }}",
                "rightValue": "84586066091",
                "operator": {
                  "type": "string",
                  "operation": "contains"
                }
              },
              {
                "id": "filter-79262579414",
                "leftValue": "={{ $json.body.metadata.remoteJid }}",
                "rightValue": "79262579414",
                "operator": {
                  "type": "string",
                  "operation": "contains"
                }
              }
            ],
            "combinator": "or"
          },
          "looseTypeValidation": true,
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.2,
        "position": [
          -968,
          -224
        ],
        "id": "phone-filter-node-new",
        "name": "Phone Filter",
        "disabled": true
      },
      {
        "parameters": {
          "operation": "getAll",
          "tableId": "user_state",
          "filters": {
            "conditions": [
              {
                "keyName": "jid",
                "condition": "eq",
                "keyValue": "={{ $('Edit Fields4').first().json.sender }}"
              }
            ]
          },
          "limit": 1,
          "options": {}
        },
        "type": "n8n-nodes-base.supabase",
        "typeVersion": 1,
        "position": [
          2900,
          -304
        ],
        "id": "fe9ca20f-a784-400d-9cfb-37ce29a6f6f8",
        "name": "Get User State",
        "credentials": {
          "supabaseApi": {
            "id": "u1mkv2sS5oh337qr",
            "name": "Supabase Karma_Worker"
          }
        },
        "alwaysOutputData": true
      },
      {
        "parameters": {
          "jsCode": "// Get state from Supabase\nconst items = $input.all();\nconst summaData = $('–°—É–º–º–∞').first().json;\nconst senderData = $('Edit Fields4').first().json;\nconst sender = senderData.sender || '';\nconst rawMsg = summaData.message || '';\nconst message = Array.isArray(rawMsg) ? rawMsg.join(' ') : String(rawMsg);\n\n// Detect client language from message\nfunction detectLang(msg) {\n  const m = msg.toLowerCase();\n  // Vietnamese: diacritics or common words\n  if (/[√†√°·∫°·∫£√£√¢·∫ß·∫•·∫≠·∫©·∫´ƒÉ·∫±·∫Ø·∫∑·∫≥·∫µ√®√©·∫π·∫ª·∫Ω√™·ªÅ·∫ø·ªá·ªÉ·ªÖ√¨√≠·ªã·ªâƒ©√≤√≥·ªç·ªè√µ√¥·ªì·ªë·ªô·ªï·ªó∆°·ªù·ªõ·ª£·ªü·ª°√π√∫·ª•·ªß≈©∆∞·ª´·ª©·ª±·ª≠·ªØ·ª≥√Ω·ªµ·ª∑·ªπƒë]/.test(m)) return 'Ti·∫øng Vi·ªát';\n  if (/\\b(ch√†o|t√¥i|c·∫ßn|thu√™|ng√†y|ch·ªó|b·∫°n|xe|l√°i|g·ª≠i|·∫£nh|ch·ªçn|mu·ªën)\\b/.test(m)) return 'Ti·∫øng Vi·ªát';\n  // Russian: has Cyrillic\n  if (/[–∞-—è—ë–ê-–Ø–Å]/.test(m)) return '–†—É—Å—Å–∫–∏–π';\n  // English: latin + common English words (no Cyrillic)\n  if (/\\b(hi|hello|hey|need|want|have|day|days|car|bike|motorbike|bicycle|city|experience|choose|take|please|thank|show|me|i|yes|no|ok|sure|great|nice|good|how|much|long|which|what)\\b/i.test(m)) return 'English';\n  // Ambiguous: just a number, emoji, or unrecognizable ‚Üí null\n  return null;\n}\nconst detectedLang = detectLang(message);\n// Language is determined by majority of messages, not single detection\nlet clientLang = '–†—É—Å—Å–∫–∏–π'; // default until we compute from counts\n\n// Handle /reset command ‚Äî SILENT reset, no response to user\nif (message.trim() === '/reset') {\n  let currentSession = 0;\n  try {\n    const prevState = items.length > 0 && items[0].json.state ? items[0].json.state : {};\n    currentSession = (prevState.session || 0) + 1;\n  } catch(e) { currentSession = 1; }\n\n  // Reset state in Supabase (keep only session counter)\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: 'https://upjyomatlonfgygoniir.supabase.co/rest/v1/user_state',\n      headers: {\n        'apikey': $env.SUPABASE_SERVICE_ROLE_KEY,\n        'Authorization': 'Bearer ' + $env.SUPABASE_SERVICE_ROLE_KEY,\n        'Content-Type': 'application/json',\n        'Prefer': 'resolution=merge-duplicates'\n      },\n      body: { jid: sender, state: { session: currentSession }, updated_at: new Date().toISOString() }\n    });\n  } catch(e) {}\n\n  // Return with —ç—Ç–∞–ø=–∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω + no link ‚Üí Check Booked Logic drops it ‚Üí silent\n  return [{ json: {\n    sender: sender,\n    —ç—Ç–∞–ø: '–∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω',\n    clientLang: '–†—É—Å—Å–∫–∏–π',\n    sessionKey: sender + '_v2_s' + currentSession,\n    message: ''\n  } }];\n}\n\n// Test phone numbers (get test flow rules)\nconst TEST_PHONES = ['84586066091', '79262579414', '84788623458'];\nconst senderDigits = sender.replace(/\\D/g, '');\nconst isTest = TEST_PHONES.some(p => senderDigits.includes(p)) || senderDigits.startsWith('7926257');\n\n// Get session counter early (needed for 12h timeout branch too)\nconst sessionNum = (items.length > 0 && items[0].json.state && items[0].json.state.session) ? items[0].json.state.session : 0;\n\n// Build state context\nlet stateContext = '';\nlet prefilled–≠—Ç–∞–ø = '–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ';\nif (items.length > 0 && items[0].json.state && Object.keys(items[0].json.state).length > 0) {\n  const state = items[0].json.state;\n\n  // Check state reset: if updated_at > 12h, reset\n  const updatedAt = items[0].json.updated_at;\n  if (updatedAt) {\n    const hoursAgo = (Date.now() - new Date(updatedAt).getTime()) / 3600000;\n    if (hoursAgo > 12) {\n      // State expired, start fresh\n      return [{ json: { sender, —ç—Ç–∞–ø: '–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ', clientLang: clientLang, sessionKey: sender + '_v2_s' + sessionNum, message: '–î–ê–ù–ù–´–ï –ö–õ–ò–ï–ù–¢–ê:\\n[—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç: ?]\\n[–¥–Ω–µ–π: ?]\\n[–¥–∞—Ç–∞: ?]\\n[–ø–æ–µ–∑–¥–∫–∏: ?]\\n[–æ–ø—ã—Ç: ?]\\n[–±–∞–π–∫: ?]\\n[–±–∞–π–∫_—Å—Å—ã–ª–∫–∞: ?]\\n[—ç—Ç–∞–ø: –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ]\\n' + '\\n---\\n' + message } }];\n    }\n  }\n  \n  // Build state with mandatory fields template\n  const defaults = {—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç: '?', –¥–Ω–µ–π: '?', –¥–∞—Ç–∞: '?', –ø–æ–µ–∑–¥–∫–∏: '?', –æ–ø—ã—Ç: '?', –±–∞–π–∫: '?', –±–∞–π–∫_—Å—Å—ã–ª–∫–∞: '?', —ç—Ç–∞–ø: '–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ'};\n  const merged = {...defaults, ...state};\n\n  // Pre-fill state from client message (before GPT sees it)\n  const msg = message.toLowerCase();\n  if (merged['—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç'] === '?') {\n    if (/(?:^|\\s)(–∞–≤—Ç–æ|–º–∞—à–∏–Ω|car|cars|automobile|√¥ t√¥|xe h∆°i)/i.test(msg)) merged['—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç'] = '–∞–≤—Ç–æ';\n    else if (/(?:^|\\s)(–±–∞–π–∫|–º–æ—Ç–æ|—Å–∫—É—Ç–µ—Ä|bike|scooter|motorbike|motorcycle|xe m√°y)/i.test(msg)) merged['—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç'] = '–±–∞–π–∫';\n    else if (/(?:^|\\s)(–≤–µ–ª–æ—Å–∏–ø–µ–¥|–≤–µ–ª–∏–∫|bicycle|xe ƒë·∫°p)/i.test(msg)) merged['—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç'] = '–≤–µ–ª–æ—Å–∏–ø–µ–¥';\n  }\n  if (merged['–¥–Ω–µ–π'] === '?') {\n    const dm = msg.match(/(\\d+)\\s*–¥–Ω|for\\s*(\\d+)\\s*day|(\\d+)\\s*ng√†y/);\n    if (dm) merged['–¥–Ω–µ–π'] = dm[1] || dm[2] || dm[3];\n  }\n  if (merged['–ø–æ–µ–∑–¥–∫–∏'] === '?') {\n    if (/–ø–æ –≥–æ—Ä–æ–¥—É|in the city|around town|trong th√†nh|–≤ –≥–æ—Ä–æ–¥–µ|around the city|city riding|city driving/.test(msg)) merged['–ø–æ–µ–∑–¥–∫–∏'] = '–≥–æ—Ä–æ–¥';\n    else if (/–∑–∞ –≥–æ—Ä–æ–¥|–¥–∞–ª—å–Ω–∏–µ|long distance|highway/.test(msg)) merged['–ø–æ–µ–∑–¥–∫–∏'] = '–¥–∞–ª—å–Ω–∏–µ';\n  }\n  if (merged['–æ–ø—ã—Ç'] === '?') {\n    if (/–ø—Ä–∞–≤–∞ –µ—Å—Ç—å|–∑–∞ —Ä—É–ª–µ–º|have.*license|been driving|c√≥ b·∫±ng|–æ–ø—ã—Ç –µ—Å—Ç—å|have experience|experienced|i ride|i drive/.test(msg)) merged['–æ–ø—ã—Ç'] = '–µ—Å—Ç—å';\n  }\n  // If user provided all info in one message, skip to –ø–æ–¥–±–æ—Ä\n  if (merged['—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç'] !== '?' && merged['–¥–Ω–µ–π'] !== '?' && merged['–ø–æ–µ–∑–¥–∫–∏'] !== '?' && merged['–æ–ø—ã—Ç'] !== '?' && merged['—ç—Ç–∞–ø'] === '–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ') {\n    merged['—ç—Ç–∞–ø'] = '–ø–æ–¥–±–æ—Ä';\n  }\n  // If user provided transport but not all info, skip to –≤—ã—è—Å–Ω–µ–Ω–∏–µ\n  else if (merged['—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç'] !== '?' && merged['—ç—Ç–∞–ø'] === '–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ') {\n    merged['—ç—Ç–∞–ø'] = '–≤—ã—è—Å–Ω–µ–Ω–∏–µ';\n  }\n  prefilled–≠—Ç–∞–ø = merged['—ç—Ç–∞–ø'];\n  // Language by majority: count messages per language, use the dominant one\n  let langCounts = {};\n  try { langCounts = JSON.parse(merged['_langCounts'] || '{}'); } catch(e) { langCounts = {}; }\n  if (detectedLang) {\n    langCounts[detectedLang] = (langCounts[detectedLang] || 0) + 1;\n  }\n  merged['_langCounts'] = JSON.stringify(langCounts);\n  // Pick language with most messages\n  let maxCount = 0;\n  let dominantLang = null;\n  for (const [lang, count] of Object.entries(langCounts)) {\n    if (count > maxCount) { maxCount = count; dominantLang = lang; }\n  }\n  clientLang = dominantLang || '–†—É—Å—Å–∫–∏–π';\n  merged['—è–∑—ã–∫'] = clientLang;\n\n  stateContext = '–î–ê–ù–ù–´–ï –ö–õ–ò–ï–ù–¢–ê:\\n';\n  for (const [key, value] of Object.entries(merged)) {\n    stateContext += '[' + key + ': ' + value + ']\\n';\n  }\n}\n\n// If no state at all ‚Äî new user, inject empty template\nif (!stateContext) {\n  stateContext = '–î–ê–ù–ù–´–ï –ö–õ–ò–ï–ù–¢–ê:\\n[—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç: ?]\\n[–¥–Ω–µ–π: ?]\\n[–¥–∞—Ç–∞: ?]\\n[–ø–æ–µ–∑–¥–∫–∏: ?]\\n[–æ–ø—ã—Ç: ?]\\n[–±–∞–π–∫: ?]\\n[–±–∞–π–∫_—Å—Å—ã–ª–∫–∞: ?]\\n[—ç—Ç–∞–ø: –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ]\\n';\n}\n\n// ===== –ê–í–¢–û ‚Üí –û–ü–ï–†–ê–¢–û–†: deterministic redirect, skip AI Agent =====\nconst msgLower = message.toLowerCase();\nconst autoInMsg = /(?:^|\\s)(–∞–≤—Ç–æ|–º–∞—à–∏–Ω|car|cars|automobile|√¥ t√¥|xe h∆°i)/i.test(msgLower);\nconst autoInState = stateContext.includes('[—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç: –∞–≤—Ç–æ]');\nconst isAutoRequest = autoInMsg || autoInState;\nconst earlyStages = ['–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ', '–≤—ã—è—Å–Ω–µ–Ω–∏–µ', '–ø–æ–¥–±–æ—Ä'];\n\nif (isAutoRequest && earlyStages.includes(prefilled–≠—Ç–∞–ø)) {\n  // Pick message by client language\n  const autoMessages = {\n    '–†—É—Å—Å–∫–∏–π': '–û—Ç–ª–∏—á–Ω–æ! –°–µ–π—á–∞—Å –ø–æ–¥–∫–ª—é—á—É –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –ø–æ –∞—Ä–µ–Ω–¥–µ –∞–≤—Ç–æ, –æ–Ω –Ω–∞–ø–∏—à–µ—Ç –≤–∞–º! üöó',\n    'English': 'Great! I\\'ll connect you with our car rental manager, they\\'ll message you shortly! üöó',\n    'Ti·∫øng Vi·ªát': 'Tuy·ªát v·ªùi! T√¥i s·∫Ω k·∫øt n·ªëi b·∫°n v·ªõi qu·∫£n l√Ω cho thu√™ √¥ t√¥, h·ªç s·∫Ω nh·∫Øn cho b·∫°n ngay! üöó'\n  };\n  const autoMsg = autoMessages[clientLang] || autoMessages['–†—É—Å—Å–∫–∏–π'];\n\n  // Send WhatsApp message via Evolution API\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: 'https://karma-wa.fly.dev/message/sendText/karma',\n      headers: { 'apikey': 'karma-evo-2026-secret', 'Content-Type': 'application/json' },\n      body: { number: sender, text: autoMsg }\n    });\n  } catch(e) { /* WA send failed, still save state */ }\n\n  // Build state preserving existing fields\n  let autoState = { —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç: '–∞–≤—Ç–æ', —ç—Ç–∞–ø: '–æ–ø–µ—Ä–∞—Ç–æ—Ä', session: sessionNum };\n  if (items.length > 0 && items[0].json.state && Object.keys(items[0].json.state).length > 0) {\n    autoState = { ...items[0].json.state, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç: '–∞–≤—Ç–æ', —ç—Ç–∞–ø: '–æ–ø–µ—Ä–∞—Ç–æ—Ä' };\n  }\n\n  // Save state to Supabase\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: 'https://upjyomatlonfgygoniir.supabase.co/rest/v1/user_state',\n      headers: {\n        'apikey': $env.SUPABASE_SERVICE_ROLE_KEY,\n        'Authorization': 'Bearer ' + $env.SUPABASE_SERVICE_ROLE_KEY,\n        'Content-Type': 'application/json',\n        'Prefer': 'resolution=merge-duplicates'\n      },\n      body: { jid: sender, state: autoState, updated_at: new Date().toISOString() }\n    });\n  } catch(e) { /* state save failed */ }\n\n  // Return –æ–ø–µ—Ä–∞—Ç–æ—Ä ‚Üí Check Stage catches ‚Üí No Operation ‚Üí done\n  return [{ json: {\n    sender: sender,\n    —ç—Ç–∞–ø: '–æ–ø–µ—Ä–∞—Ç–æ—Ä',\n    clientLang: clientLang,\n    sessionKey: sender + '_v2_s' + sessionNum,\n    message: ''\n  } }];\n}\n// ===== END –ê–í–¢–û ‚Üí –û–ü–ï–†–ê–¢–û–† =====\n\n\n// ==================== PROD FLOW (synced with TEST_FLOW 2026-02-25) ====================\nconst PROD_FLOW = `–¢—ã –≤–µ–¥—ë—à—å –¥–∏–∞–ª–æ–≥ —Å –∫–ª–∏–µ–Ω—Ç–æ–º. –£ —Ç–µ–±—è –µ—Å—Ç—å –∏—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –∏ –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞.\n\n–ì–õ–ê–í–ù–û–ï –ü–†–ê–í–ò–õ–û: –æ—Ç–≤–µ—á–∞–π –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ. –ù–µ –ø–æ–≤—Ç–æ—Ä—è–π —Å–∫–∞–∑–∞–Ω–Ω–æ–µ ‚Äî –∫–ª–∏–µ–Ω—Ç –ø–æ–º–Ω–∏—Ç. –í–µ–¥–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ.\n\n–Ø–ó–´–ö ‚Äî –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:\nüî¥ –û–¢–í–ï–ß–ê–ô –°–¢–†–û–ì–û –ù–ê –Ø–ó–´–ö–ï –ö–õ–ò–ï–ù–¢–ê. English ‚Üí English. Ti·∫øng Vi·ªát ‚Üí ti·∫øng Vi·ªát. –†—É—Å—Å–∫–∏–π ‚Üí —Ä—É—Å—Å–∫–∏–π.\nüî¥ –í–°–Å –≤ –æ—Ç–≤–µ—Ç–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–∞ —è–∑—ã–∫–µ –∫–ª–∏–µ–Ω—Ç–∞! –í–∫–ª—é—á–∞—è:\n  - –û–ø–∏—Å–∞–Ω–∏—è –º–æ–¥–µ–ª–µ–π –∏–∑ –¥–∞–Ω–Ω—ã—Ö: \"—á–µ—Ä–Ω—ã–π\" ‚Üí \"black\", \"–≤—ã—Å–æ–∫–∏–π\" ‚Üí \"tall\", \"–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π\" ‚Üí \"brown\"\n  - –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏: \"–º–µ—Å—Ç\" ‚Üí \"seats\", \"–∫—Ä–æ—Å—Å–æ–≤–µ—Ä\" ‚Üí \"crossover\", \"—Å–µ–¥–∞–Ω\" ‚Üí \"sedan\"\n  - –ë–æ–Ω—É—Å—ã –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è ‚Äî –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–≤–µ–¥–∏\n  - –ë—Ä–µ–Ω–¥/–º–æ–¥–µ–ª—å –æ—Å—Ç–∞–≤—å –∫–∞–∫ –µ—Å—Ç—å (Honda, Mazda, Kia, NVX)\nüî¥ –ï—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω –≤ –ø–µ—Ä–µ–≤–æ–¥–µ –∞—Ç—Ä–∏–±—É—Ç–∞ ‚Äî –æ–ø—É—Å—Ç–∏ –µ–≥–æ, –ù–ï –æ—Å—Ç–∞–≤–ª—è–π —Ä—É—Å—Å–∫–∏–µ —Å–ª–æ–≤–∞!\n\n–ñ–Å–°–¢–ö–ò–ï –ü–†–ê–í–ò–õ–ê:\n- –ù–ï –ü–û–ö–ê–ó–´–í–ê–ô –ö–ê–¢–ê–õ–û–ì –ø–æ–∫–∞ –Ω–µ —Å–æ–±—Ä–∞–ª –í–°–ï –¥–∞–Ω–Ω—ã–µ: —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç, –¥–Ω–µ–π, –≥–æ—Ä–æ–¥/–¥–∞–ª—å–Ω–∏–µ, –æ–ø—ã—Ç. –ï—Å–ª–∏ —Ö–æ—Ç—å –æ–¥–Ω–æ = \"?\" ‚Äî —Å–Ω–∞—á–∞–ª–∞ —Å–ø—Ä–æ—Å–∏.\n- –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –≤ –æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –¥–∞–ª –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ—Ç–≤–µ—Ç–æ–≤ (–Ω–∞–ø—Ä. \"–∞–≤—Ç–æ –Ω–∞ 5 –¥–Ω–µ–π –ø–æ –≥–æ—Ä–æ–¥—É\") ‚Äî –∑–∞–ø–∏—à–∏ –≤—Å—ë, —Å–ø—Ä–æ—Å–∏ —Ç–æ–ª—å–∫–æ –Ω–µ–¥–æ—Å—Ç–∞—é—â–µ–µ.\n- –¶–ï–ù–´ –∏ –ú–û–î–ï–õ–ò ‚Äî –°–¢–†–û–ì–û –∏–∑ –¥–∞–Ω–Ω—ã—Ö. –ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –Ω–∏—á–µ–≥–æ (—Å—Ç—Ä–∞—Ö–æ–≤–∫—É, —Å–∫–∏–¥–∫–∏, —É—Å–ª–æ–≤–∏—è). –ù–µ –∑–Ω–∞–µ—à—å ‚Üí \"—É—Ç–æ—á–Ω—é —É –º–µ–Ω–µ–¥–∂–µ—Ä–∞\".\n- –ú–∏–Ω–∏–º—É–º –∞—Ä–µ–Ω–¥—ã = 2 –¥–Ω—è. 1 –¥–µ–Ω—å ‚Üí \"–ú–∏–Ω–∏–º—É–º 2 –¥–Ω—è, –ø–æ–¥–æ–π–¥—ë—Ç?\"\n- –î–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ = –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –∏–Ω—Ñ–æ. –ù–µ –æ–∑–≤—É—á–∏–≤–∞–π (\"—è –≤–∏–∂—É —á—Ç–æ –≤—ã...\").\n\n–¢–ò–ü –¢–†–ê–ù–°–ü–û–†–¢–ê ‚Äî –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:\nüî¥ –ö–ª–∏–µ–Ω—Ç —Å–∫–∞–∑–∞–ª \"–∞–≤—Ç–æ/–º–∞—à–∏–Ω–∞/car/√¥ t√¥/xe h∆°i\" ‚Üí –ø–æ–∫–∞–∂–∏ –¢–û–õ–¨–ö–û –∏–∑ —Å–µ–∫—Ü–∏–∏ –ê–í–¢–û (cars). –ó–ê–ü–†–ï–©–ï–ù–û –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –±–∞–π–∫–∏!\nüî¥ –ö–ª–∏–µ–Ω—Ç —Å–∫–∞–∑–∞–ª \"–±–∞–π–∫/–º–æ—Ç–æ—Ü–∏–∫–ª/—Å–∫—É—Ç–µ—Ä/motorbike/scooter/xe m√°y\" ‚Üí –ø–æ–∫–∞–∂–∏ –¢–û–õ–¨–ö–û –∏–∑ —Å–µ–∫—Ü–∏–∏ –ë–ê–ô–ö–ò (bikes). –ó–ê–ü–†–ï–©–ï–ù–û –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∞–≤—Ç–æ!\nüî¥ –ö–ª–∏–µ–Ω—Ç —Å–∫–∞–∑–∞–ª \"–≤–µ–ª–æ—Å–∏–ø–µ–¥/bicycle/xe ƒë·∫°p\" ‚Üí –ø–æ–∫–∞–∂–∏ –¢–û–õ–¨–ö–û –∏–∑ —Å–µ–∫—Ü–∏–∏ –í–ï–õ–û–°–ò–ü–ï–î–´ (bicycles).\nüî¥ –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ù–ï —É—Ç–æ—á–Ω–∏–ª —Ç–∏–ø ‚Üí –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —Å–ø—Ä–æ—Å–∏: \"–ö–∞–∫–æ–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç ‚Äî –±–∞–π–∫, –∞–≤—Ç–æ –∏–ª–∏ –≤–µ–ª–æ—Å–∏–ø–µ–¥?\"\nüî¥ –ü–û–ö–ê–ñ–ò –í–°–ï –µ–¥–∏–Ω–∏—Ü—ã –Ω—É–∂–Ω–æ–≥–æ —Ç–∏–ø–∞! –ï—Å–ª–∏ –≤ –¥–∞–Ω–Ω—ã—Ö 9 –º–∞—à–∏–Ω ‚Äî –ø–æ–∫–∞–∂–∏ –≤—Å–µ 9. –ù–µ –æ–±—Ä–µ–∑–∞–π!\n\n–≠–¢–ê–ü–´ (–æ–ø—Ä–µ–¥–µ–ª—è–π –ø–æ [—ç—Ç–∞–ø:] –∏ –ø–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç–∏ –ø–æ–ª–µ–π STATE):\n\n1. –ü–†–ò–í–ï–¢–°–¢–í–ò–ï (—ç—Ç–∞–ø = \"–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ\" –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç)\n   ‚Üí –ü–æ–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–π, —Å–ø—Ä–æ—Å–∏ –∫–∞–∫–æ–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç (–±–∞–π–∫/–∞–≤—Ç–æ/–≤–µ–ª–æ—Å–∏–ø–µ–¥)\n   ‚Üí –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å—Ä–∞–∑—É –Ω–∞–∑–≤–∞–ª —Ç–∏–ø ‚Äî –∑–∞–ø–∏—à–∏ –∏ –Ω–µ –ø–µ—Ä–µ—Å–ø—Ä–∞—à–∏–≤–∞–π\n   ‚Üí —ç—Ç–∞–ø ‚Üí \"–≤—ã—è—Å–Ω–µ–Ω–∏–µ\"\n\n2. –£–¢–û–ß–ù–ï–ù–ò–ï (—ç—Ç–∞–ø = \"–≤—ã—è—Å–Ω–µ–Ω–∏–µ\")\n   ‚Üí –ù—É–∂–Ω–æ —Å–æ–±—Ä–∞—Ç—å: –¥–Ω–µ–π, —Å –∫–∞–∫–æ–≥–æ —á–∏—Å–ª–∞, –≥–æ—Ä–æ–¥/–¥–∞–ª—å–Ω–∏–µ, –æ–ø—ã—Ç –≤–æ–∂–¥–µ–Ω–∏—è\n   ‚Üí –°–ø—Ä–∞—à–∏–≤–∞–π –¢–û–õ–¨–ö–û –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ (–≥–¥–µ \"?\")\n   ‚Üí –ú–æ–∂–Ω–æ —Å–ø—Ä–æ—Å–∏—Ç—å 2-3 –≤–æ–ø—Ä–æ—Å–∞ –≤ –æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–æ–º\n   ‚Üí –ö–æ–≥–¥–∞ –í–°–ï —Å–æ–±—Ä–∞–Ω–æ (–¥–Ω–µ–π ‚â† \"?\", –¥–∞—Ç–∞ ‚â† \"?\", –≥–æ—Ä–æ–¥ ‚â† \"?\", –æ–ø—ã—Ç ‚â† \"?\") ‚Üí —ç—Ç–∞–ø ‚Üí \"–ø–æ–¥–±–æ—Ä\"\n   ‚Üí üî¥ –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –Ω–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ!\n\n3. –ü–û–î–ë–û–† (—ç—Ç–∞–ø = \"–ø–æ–¥–±–æ—Ä\")\n   ‚Üí –ü–æ–∫–∞–∂–∏ –í–°–ï —Å–≤–æ–±–æ–¥–Ω—ã–µ –µ–¥–∏–Ω–∏—Ü—ã –Ω—É–∂–Ω–æ–≥–æ —Ç–∏–ø–∞: –º–æ–¥–µ–ª—å, –∫–ª–∞—Å—Å, —Ü–µ–Ω–∞/—Å—É—Ç–∫–∏, —Å—Å—ã–ª–∫–∞\n   ‚Üí –û–î–ò–ù –†–ê–ó —Å–∫–∞–∂–∏ –±–æ–Ω—É—Å—ã (–ü–ï–†–ï–í–ï–î–ò –Ω–∞ —è–∑—ã–∫ –∫–ª–∏–µ–Ω—Ç–∞!):\n     - –æ—Ç 3 –¥–Ω–µ–π –∞—Ä–µ–Ω–¥—ã: –¥–∞—Ä–∏–º –∫–∞—Ä—Ç—É –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö –º–µ—Å—Ç –ù—è—á–∞–Ω–≥–∞ –∏ –î–∞–ª–∞—Ç–∞\n     - –æ—Ç 7 –¥–Ω–µ–π: –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ –ø–æ –≥–æ—Ä–æ–¥—É\n   ‚Üí –ï—Å–ª–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç \"—á—Ç–æ –µ—Å—Ç—å?\" ‚Äî –¥–∞–π –∫—Ä–∞—Ç–∫–∏–π —Å–ø–∏—Å–æ–∫ (–º–æ–¥–µ–ª—å + —Ü–µ–Ω–∞), –Ω–µ –ø–æ–ª–Ω—ã–π\n   ‚Üí –ï—Å–ª–∏ –Ω–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö –Ω—É–∂–Ω–æ–≥–æ —Ç–∏–ø–∞ ‚Üí \"–°–µ–π—á–∞—Å [—Ç–∏–ø] –Ω–µ—Ç, –∫–∞–∫ –ø–æ—è–≤—è—Ç—Å—è ‚Äî —Å–≤—è–∂–µ–º—Å—è!\" ‚Üí —ç—Ç–∞–ø ‚Üí \"–Ω–µ—Ç_—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞\"\n\n4. –í–´–ë–û–† (–∫–ª–∏–µ–Ω—Ç –≤—ã–±—Ä–∞–ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π ‚Äî \"–±–µ—Ä—É X\" / \"—Ö–æ—á—É X\")\n   ‚Üí –ó–∞–ø–∏—à–∏ –≤ STATE –ø–æ–ª–µ \"–±–∞–π–∫\" = –Ω–∞–∑–≤–∞–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏\n   ‚Üí –ï—Å–ª–∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç=–∞–≤—Ç–æ ‚Üí –ø–æ–ø—Ä–æ—Å–∏ —Ñ–æ—Ç–æ –≤–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ —É–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏—è (–í–£). –¢–û–õ–¨–ö–û –í–£!\n   ‚Üí –ï—Å–ª–∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç=–±–∞–π–∫/–≤–µ–ª–æ—Å–∏–ø–µ–¥ ‚Üí –ø–æ–ø—Ä–æ—Å–∏ —Ñ–æ—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–ø–∞—Å–ø–æ—Ä—Ç –ò–õ–ò –≤–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–µ –ø—Ä–∞–≤–∞ ‚Äî –ª—é–±–æ–π –ø–æ–¥–æ–π–¥—ë—Ç)\n   ‚Üí —ç—Ç–∞–ø ‚Üí \"–ø–∞—Å–ø–æ—Ä—Ç\"\n   ‚Üí –ü–µ—Ä–µ–¥—É–º–∞–ª ‚Üí —ç—Ç–∞–ø ‚Üí \"–ø–æ–¥–±–æ—Ä\"\n\n5. –ü–ê–°–ü–û–†–¢ (—ç—Ç–∞–ø = \"–ø–∞—Å–ø–æ—Ä—Ç\")\n   ‚Üí üî¥ –î–ê–¢–ê –ü–†–û–í–ï–†–ö–ê: –µ—Å–ª–∏ –¥–∞—Ç–∞ –∞—Ä–µ–Ω–¥—ã > 2 –¥–Ω–µ–π –æ—Ç —Å–µ–≥–æ–¥–Ω—è ‚Üí –ù–ï –±—Ä–æ–Ω–∏—Ä—É–π! –°–∫–∞–∂–∏:\n     \"–°–ø—Ä–æ—Å —Å–µ–π—á–∞—Å –±–æ–ª—å—à–æ–π, –ª—É—á—à–µ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –∑–∞ –¥–µ–Ω—å-–¥–≤–∞ –¥–æ –∞—Ä–µ–Ω–¥—ã. –ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º –±–ª–∏–∂–µ –∫ –¥–∞—Ç–µ ‚Äî –≤—Å—ë –ø–æ–¥–±–µ—Ä—ë–º! üòä\"\n     ‚Üí —ç—Ç–∞–ø –æ—Å—Ç–∞–≤—å \"–ø–∞—Å–ø–æ—Ä—Ç\" (–Ω–µ –ø–µ—Ä–µ–≤–æ–¥–∏ –≤ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω)\n   ‚Üí –ï—Å–ª–∏ –¥–∞—Ç–∞ = —Å–µ–≥–æ–¥–Ω—è/–∑–∞–≤—Ç—Ä–∞/–ø–æ—Å–ª–µ–∑–∞–≤—Ç—Ä–∞ (‚â§ 2 –¥–Ω—è):\n     [–î–û–ö–£–ú–ï–ù–¢] ‚Üí \"‚úÖ –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ! –°–∫–æ—Ä–æ —Å–≤—è–∂–µ–º—Å—è –¥–ª—è –¥–µ—Ç–∞–ª–µ–π\" ‚Üí —ç—Ç–∞–ø ‚Üí \"–∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω\"\n   ‚Üí üî¥ –ü–û–°–õ–ï –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –±—Ä–æ–Ω–∏, –µ—Å–ª–∏ –¥–Ω–µ–π >= 3, –°–†–ê–ó–£ –¥–æ–±–∞–≤—å:\n     \"üó∫Ô∏è –ë–æ–Ω—É—Å! –í–æ—Ç –∫–∞—Ä—Ç–∞ –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π –ù—è—á–∞–Ω–≥–∞ –∏ –î–∞–ª–∞—Ç–∞: https://maps.app.goo.gl/9oegqGYXydKWX6tUA?g_st=ac\"\n   ‚Üí [–§–û–¢–û] –±–µ–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞ ‚Üí –ø–æ–≤—Ç–æ—Ä–Ω–æ –ø–æ–ø—Ä–æ—Å–∏ (–í–£ –¥–ª—è –∞–≤—Ç–æ, –ø–∞—Å–ø–æ—Ä—Ç –∏–ª–∏ –í–£ –¥–ª—è –±–∞–π–∫–∞/–≤–µ–ª–æ—Å–∏–ø–µ–¥–∞)\n   ‚Üí –•–æ—á–µ—Ç –ø–æ–º–µ–Ω—è—Ç—å ‚Üí —ç—Ç–∞–ø ‚Üí \"–ø–æ–¥–±–æ—Ä\"\n\n6. –ó–ê–ë–†–û–ù–ò–†–û–í–ê–ù (—ç—Ç–∞–ø = \"–∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω\")\n   ‚Üí –ü–æ –±—Ä–æ–Ω–∏ ‚Üí \"–ü–µ—Ä–µ–¥–∞–º –º–µ–Ω–µ–¥–∂–µ—Ä—É, —Å–∫–æ—Ä–æ –æ—Ç–≤–µ—Ç–∏—Ç!\"\n   ‚Üí –û—Å—Ç–∞–ª—å–Ω–æ–µ ‚Üí –º–æ–ª—á–∞–Ω–∏–µ\n\n–õ–û–ö–ê–¶–ò–Ø:\n–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç: –≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å / –∞–¥—Ä–µ—Å / location / where are you / ·ªü ƒë√¢u / –≥–¥–µ –∑–∞–±—Ä–∞—Ç—å / pickup point:\n‚Üí –î–∞–π —Å—Å—ã–ª–∫—É: https://maps.app.goo.gl/N9x7DPV7LYf2BSUv6?g_st=ac\n‚Üí —ç—Ç–∞–ø –ù–ï –º–µ–Ω—è–π (–æ—Å—Ç–∞–≤—å —Ç–µ–∫—É—â–∏–π)\n\n–°–¢–û–ü–°–õ–û–í–ê (\"–æ—Ç–º–µ–Ω–∞\"/\"–Ω–µ –Ω–∞–¥–æ\"/\"–ø–µ—Ä–µ–¥—É–º–∞–ª\"/\"cancel\"):\n‚Üí \"–•–æ—Ä–æ—à–æ, –µ—Å–ª–∏ –ø–µ—Ä–µ–¥—É–º–∞–µ—Ç–µ ‚Äî –º—ã –Ω–∞ —Å–≤—è–∑–∏!\" ‚Üí —ç—Ç–∞–ø ‚Üí \"–æ—Ç–º–µ–Ω—ë–Ω\"\n\n–ù–ï –ü–û–í–¢–û–†–Ø–ô:\n- –ï—Å–ª–∏ —É–∂–µ –ø–æ–∫–∞–∑–∞–ª –∫–∞—Ç–∞–ª–æ–≥ ‚Äî –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–π —Å–Ω–æ–≤–∞ –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫\n- –ï—Å–ª–∏ —É–∂–µ —Å–ø—Ä–æ—Å–∏–ª –≤–æ–ø—Ä–æ—Å –∏ –ø–æ–ª—É—á–∏–ª –æ—Ç–≤–µ—Ç ‚Äî –Ω–µ —Å–ø—Ä–∞—à–∏–≤–∞–π –æ–ø—è—Ç—å\n- –ï—Å–ª–∏ —É–∂–µ —É–ø–æ–º—è–Ω—É–ª –±–æ–Ω—É—Å—ã ‚Äî –Ω–µ —É–ø–æ–º–∏–Ω–∞–π –ø–æ–≤—Ç–æ—Ä–Ω–æ\n\n‚ö†Ô∏è STATE ‚Äî –≤ –∫–æ–Ω—Ü–µ –ö–ê–ñ–î–û–ì–û –æ—Ç–≤–µ—Ç–∞:\nSTATE: {\"—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç\": \"?\", \"–¥–Ω–µ–π\": \"?\", \"–¥–∞—Ç–∞\": \"?\", \"–ø–æ–µ–∑–¥–∫–∏\": \"?\", \"–æ–ø—ã—Ç\": \"?\", \"–±–∞–π–∫\": \"?\", \"–±–∞–π–∫_—Å—Å—ã–ª–∫–∞\": \"?\", \"—ç—Ç–∞–ø\": \"–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ\"}\nüî¥ –ó–ù–ê–ß–ï–ù–ò–Ø STATE –í–°–ï–ì–î–ê –ù–ê –†–£–°–°–ö–û–ú! –î–∞–∂–µ –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø–∏—à–µ—Ç –Ω–∞ English/Vietnamese:\n   —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç = \"–±–∞–π–∫\" / \"–∞–≤—Ç–æ\" / \"–≤–µ–ª–æ—Å–∏–ø–µ–¥\" / \"?\"\n   –ø–æ–µ–∑–¥–∫–∏ = \"–≥–æ—Ä–æ–¥\" / \"–¥–∞–ª—å–Ω–∏–µ\" / \"?\"\n   –æ–ø—ã—Ç = \"–µ—Å—Ç—å\" / \"–Ω–µ—Ç\" / \"?\"\n   —ç—Ç–∞–ø = \"–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ\" / \"–≤—ã—è—Å–Ω–µ–Ω–∏–µ\" / \"–ø–æ–¥–±–æ—Ä\" / \"–ø–∞—Å–ø–æ—Ä—Ç\" / \"–∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω\" / \"–æ—Ç–º–µ–Ω—ë–Ω\"\n–ó–∞–º–µ–Ω—è–π ? –Ω–∞ –æ—Ç–≤–µ—Ç—ã –∫–ª–∏–µ–Ω—Ç–∞. –°–æ—Ö—Ä–∞–Ω—è–π –í–°–ï –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è!\nüî¥ –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –¥–∞–ª –ù–ï–°–ö–û–õ–¨–ö–û –¥–∞–Ω–Ω—ã—Ö –≤ –æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ ‚Äî –∑–∞–ø–æ–ª–Ω–∏ –í–°–ï —Å—Ä–∞–∑—É!\n   –ü—Ä–∏–º–µ—Ä: \"motorbike for 7 days, around the city, I have experience\" ‚Üí —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç=\"–±–∞–π–∫\", –¥–Ω–µ–π=\"7\", –ø–æ–µ–∑–¥–∫–∏=\"–≥–æ—Ä–æ–¥\", –æ–ø—ã—Ç=\"–µ—Å—Ç—å\", —ç—Ç–∞–ø=\"–ø–æ–¥–±–æ—Ä\"\n   –ü—Ä–∏–º–µ—Ä: \"xe m√°y 5 ng√†y, trong th√†nh ph·ªë\" ‚Üí —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç=\"–±–∞–π–∫\", –¥–Ω–µ–π=\"5\", –ø–æ–µ–∑–¥–∫–∏=\"–≥–æ—Ä–æ–¥\"\n–ö–æ–≥–¥–∞ –¥–Ω–µ–π+–ø–æ–µ–∑–¥–∫–∏+–æ–ø—ã—Ç ‚â† \"?\" ‚Üí —ç—Ç–∞–ø ‚Üí \"–ø–æ–¥–±–æ—Ä\", –ø–æ–∫–∞–∂–∏ –∫–∞—Ç–∞–ª–æ–≥.\n–ö–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç –≤—ã–±—Ä–∞–ª ‚Äî –∑–∞–ø–∏—à–∏ –±–∞–π–∫ –∏ –±–∞–π–∫_—Å—Å—ã–ª–∫–∞ (–∏–∑ –¥–∞–Ω–Ω—ã—Ö)!\n–ü—Ä–æ–¥–≤–∏–≥–∞–π —ç—Ç–∞–ø –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º –≤—ã—à–µ!`;\n\n// ==================== TEST FLOW (safe to experiment) ====================\n// Copy of prod ‚Äî edit freely, test on your phones, then promote to prod\nconst TEST_FLOW = `–¢—ã –≤–µ–¥—ë—à—å –¥–∏–∞–ª–æ–≥ —Å –∫–ª–∏–µ–Ω—Ç–æ–º. –£ —Ç–µ–±—è –µ—Å—Ç—å –∏—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –∏ –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞.\n\n–ì–õ–ê–í–ù–û–ï –ü–†–ê–í–ò–õ–û: –æ—Ç–≤–µ—á–∞–π –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ. –ù–µ –ø–æ–≤—Ç–æ—Ä—è–π —Å–∫–∞–∑–∞–Ω–Ω–æ–µ ‚Äî –∫–ª–∏–µ–Ω—Ç –ø–æ–º–Ω–∏—Ç. –í–µ–¥–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ.\n\n–Ø–ó–´–ö ‚Äî –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:\nüî¥ –û–¢–í–ï–ß–ê–ô –°–¢–†–û–ì–û –ù–ê –Ø–ó–´–ö–ï –ö–õ–ò–ï–ù–¢–ê. English ‚Üí English. Ti·∫øng Vi·ªát ‚Üí ti·∫øng Vi·ªát. –†—É—Å—Å–∫–∏–π ‚Üí —Ä—É—Å—Å–∫–∏–π.\nüî¥ –í–°–Å –≤ –æ—Ç–≤–µ—Ç–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–∞ —è–∑—ã–∫–µ –∫–ª–∏–µ–Ω—Ç–∞! –í–∫–ª—é—á–∞—è:\n  - –û–ø–∏—Å–∞–Ω–∏—è –º–æ–¥–µ–ª–µ–π –∏–∑ –¥–∞–Ω–Ω—ã—Ö: \"—á–µ—Ä–Ω—ã–π\" ‚Üí \"black\", \"–≤—ã—Å–æ–∫–∏–π\" ‚Üí \"tall\", \"–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π\" ‚Üí \"brown\"\n  - –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏: \"–º–µ—Å—Ç\" ‚Üí \"seats\", \"–∫—Ä–æ—Å—Å–æ–≤–µ—Ä\" ‚Üí \"crossover\", \"—Å–µ–¥–∞–Ω\" ‚Üí \"sedan\"\n  - –ë–æ–Ω—É—Å—ã –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è ‚Äî –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–≤–µ–¥–∏\n  - –ë—Ä–µ–Ω–¥/–º–æ–¥–µ–ª—å –æ—Å—Ç–∞–≤—å –∫–∞–∫ –µ—Å—Ç—å (Honda, Mazda, Kia, NVX)\nüî¥ –ï—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω –≤ –ø–µ—Ä–µ–≤–æ–¥–µ –∞—Ç—Ä–∏–±—É—Ç–∞ ‚Äî –æ–ø—É—Å—Ç–∏ –µ–≥–æ, –ù–ï –æ—Å—Ç–∞–≤–ª—è–π —Ä—É—Å—Å–∫–∏–µ —Å–ª–æ–≤–∞!\n\n–ñ–Å–°–¢–ö–ò–ï –ü–†–ê–í–ò–õ–ê:\n- –ù–ï –ü–û–ö–ê–ó–´–í–ê–ô –ö–ê–¢–ê–õ–û–ì –ø–æ–∫–∞ –Ω–µ —Å–æ–±—Ä–∞–ª –í–°–ï –¥–∞–Ω–Ω—ã–µ: —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç, –¥–Ω–µ–π, –≥–æ—Ä–æ–¥/–¥–∞–ª—å–Ω–∏–µ, –æ–ø—ã—Ç. –ï—Å–ª–∏ —Ö–æ—Ç—å –æ–¥–Ω–æ = \"?\" ‚Äî —Å–Ω–∞—á–∞–ª–∞ —Å–ø—Ä–æ—Å–∏.\n- –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –≤ –æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –¥–∞–ª –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ—Ç–≤–µ—Ç–æ–≤ (–Ω–∞–ø—Ä. \"–∞–≤—Ç–æ –Ω–∞ 5 –¥–Ω–µ–π –ø–æ –≥–æ—Ä–æ–¥—É\") ‚Äî –∑–∞–ø–∏—à–∏ –≤—Å—ë, —Å–ø—Ä–æ—Å–∏ —Ç–æ–ª—å–∫–æ –Ω–µ–¥–æ—Å—Ç–∞—é—â–µ–µ.\n- –¶–ï–ù–´ –∏ –ú–û–î–ï–õ–ò ‚Äî –°–¢–†–û–ì–û –∏–∑ –¥–∞–Ω–Ω—ã—Ö. –ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –Ω–∏—á–µ–≥–æ (—Å—Ç—Ä–∞—Ö–æ–≤–∫—É, —Å–∫–∏–¥–∫–∏, —É—Å–ª–æ–≤–∏—è). –ù–µ –∑–Ω–∞–µ—à—å ‚Üí \"—É—Ç–æ—á–Ω—é —É –º–µ–Ω–µ–¥–∂–µ—Ä–∞\".\n- –ú–∏–Ω–∏–º—É–º –∞—Ä–µ–Ω–¥—ã = 2 –¥–Ω—è. 1 –¥–µ–Ω—å ‚Üí \"–ú–∏–Ω–∏–º—É–º 2 –¥–Ω—è, –ø–æ–¥–æ–π–¥—ë—Ç?\"\n- –î–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ = –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –∏–Ω—Ñ–æ. –ù–µ –æ–∑–≤—É—á–∏–≤–∞–π (\"—è –≤–∏–∂—É —á—Ç–æ –≤—ã...\").\n\n–¢–ò–ü –¢–†–ê–ù–°–ü–û–†–¢–ê ‚Äî –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:\nüî¥ –ö–ª–∏–µ–Ω—Ç —Å–∫–∞–∑–∞–ª \"–∞–≤—Ç–æ/–º–∞—à–∏–Ω–∞/car/√¥ t√¥/xe h∆°i\" ‚Üí –ø–æ–∫–∞–∂–∏ –¢–û–õ–¨–ö–û –∏–∑ —Å–µ–∫—Ü–∏–∏ –ê–í–¢–û (cars). –ó–ê–ü–†–ï–©–ï–ù–û –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –±–∞–π–∫–∏!\nüî¥ –ö–ª–∏–µ–Ω—Ç —Å–∫–∞–∑–∞–ª \"–±–∞–π–∫/–º–æ—Ç–æ—Ü–∏–∫–ª/—Å–∫—É—Ç–µ—Ä/motorbike/scooter/xe m√°y\" ‚Üí –ø–æ–∫–∞–∂–∏ –¢–û–õ–¨–ö–û –∏–∑ —Å–µ–∫—Ü–∏–∏ –ë–ê–ô–ö–ò (bikes). –ó–ê–ü–†–ï–©–ï–ù–û –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∞–≤—Ç–æ!\nüî¥ –ö–ª–∏–µ–Ω—Ç —Å–∫–∞–∑–∞–ª \"–≤–µ–ª–æ—Å–∏–ø–µ–¥/bicycle/xe ƒë·∫°p\" ‚Üí –ø–æ–∫–∞–∂–∏ –¢–û–õ–¨–ö–û –∏–∑ —Å–µ–∫—Ü–∏–∏ –í–ï–õ–û–°–ò–ü–ï–î–´ (bicycles).\nüî¥ –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ù–ï —É—Ç–æ—á–Ω–∏–ª —Ç–∏–ø ‚Üí –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —Å–ø—Ä–æ—Å–∏: \"–ö–∞–∫–æ–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç ‚Äî –±–∞–π–∫, –∞–≤—Ç–æ –∏–ª–∏ –≤–µ–ª–æ—Å–∏–ø–µ–¥?\"\nüî¥ –ü–û–ö–ê–ñ–ò –í–°–ï –µ–¥–∏–Ω–∏—Ü—ã –Ω—É–∂–Ω–æ–≥–æ —Ç–∏–ø–∞! –ï—Å–ª–∏ –≤ –¥–∞–Ω–Ω—ã—Ö 9 –º–∞—à–∏–Ω ‚Äî –ø–æ–∫–∞–∂–∏ –≤—Å–µ 9. –ù–µ –æ–±—Ä–µ–∑–∞–π!\n\n–≠–¢–ê–ü–´ (–æ–ø—Ä–µ–¥–µ–ª—è–π –ø–æ [—ç—Ç–∞–ø:] –∏ –ø–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç–∏ –ø–æ–ª–µ–π STATE):\n\n1. –ü–†–ò–í–ï–¢–°–¢–í–ò–ï (—ç—Ç–∞–ø = \"–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ\" –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç)\n   ‚Üí –ü–æ–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–π, —Å–ø—Ä–æ—Å–∏ –∫–∞–∫–æ–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç (–±–∞–π–∫/–∞–≤—Ç–æ/–≤–µ–ª–æ—Å–∏–ø–µ–¥)\n   ‚Üí –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å—Ä–∞–∑—É –Ω–∞–∑–≤–∞–ª —Ç–∏–ø ‚Äî –∑–∞–ø–∏—à–∏ –∏ –Ω–µ –ø–µ—Ä–µ—Å–ø—Ä–∞—à–∏–≤–∞–π\n   ‚Üí —ç—Ç–∞–ø ‚Üí \"–≤—ã—è—Å–Ω–µ–Ω–∏–µ\"\n\n2. –£–¢–û–ß–ù–ï–ù–ò–ï (—ç—Ç–∞–ø = \"–≤—ã—è—Å–Ω–µ–Ω–∏–µ\")\n   ‚Üí –ù—É–∂–Ω–æ —Å–æ–±—Ä–∞—Ç—å: –¥–Ω–µ–π, —Å –∫–∞–∫–æ–≥–æ —á–∏—Å–ª–∞, –≥–æ—Ä–æ–¥/–¥–∞–ª—å–Ω–∏–µ, –æ–ø—ã—Ç –≤–æ–∂–¥–µ–Ω–∏—è\n   ‚Üí –°–ø—Ä–∞—à–∏–≤–∞–π –¢–û–õ–¨–ö–û –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ (–≥–¥–µ \"?\")\n   ‚Üí –ú–æ–∂–Ω–æ —Å–ø—Ä–æ—Å–∏—Ç—å 2-3 –≤–æ–ø—Ä–æ—Å–∞ –≤ –æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–æ–º\n   ‚Üí –ö–æ–≥–¥–∞ –í–°–ï —Å–æ–±—Ä–∞–Ω–æ (–¥–Ω–µ–π ‚â† \"?\", –¥–∞—Ç–∞ ‚â† \"?\", –≥–æ—Ä–æ–¥ ‚â† \"?\", –æ–ø—ã—Ç ‚â† \"?\") ‚Üí —ç—Ç–∞–ø ‚Üí \"–ø–æ–¥–±–æ—Ä\"\n   ‚Üí üî¥ –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –Ω–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ!\n\n3. –ü–û–î–ë–û–† (—ç—Ç–∞–ø = \"–ø–æ–¥–±–æ—Ä\")\n   ‚Üí –ü–æ–∫–∞–∂–∏ –í–°–ï —Å–≤–æ–±–æ–¥–Ω—ã–µ –µ–¥–∏–Ω–∏—Ü—ã –Ω—É–∂–Ω–æ–≥–æ —Ç–∏–ø–∞: –º–æ–¥–µ–ª—å, –∫–ª–∞—Å—Å, —Ü–µ–Ω–∞/—Å—É—Ç–∫–∏, —Å—Å—ã–ª–∫–∞\n   ‚Üí –û–î–ò–ù –†–ê–ó —Å–∫–∞–∂–∏ –±–æ–Ω—É—Å—ã (–ü–ï–†–ï–í–ï–î–ò –Ω–∞ —è–∑—ã–∫ –∫–ª–∏–µ–Ω—Ç–∞!):\n     - –æ—Ç 3 –¥–Ω–µ–π –∞—Ä–µ–Ω–¥—ã: –¥–∞—Ä–∏–º –∫–∞—Ä—Ç—É –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö –º–µ—Å—Ç –ù—è—á–∞–Ω–≥–∞ –∏ –î–∞–ª–∞—Ç–∞\n     - –æ—Ç 7 –¥–Ω–µ–π: –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ –ø–æ –≥–æ—Ä–æ–¥—É\n   ‚Üí –ï—Å–ª–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç \"—á—Ç–æ –µ—Å—Ç—å?\" ‚Äî –¥–∞–π –∫—Ä–∞—Ç–∫–∏–π —Å–ø–∏—Å–æ–∫ (–º–æ–¥–µ–ª—å + —Ü–µ–Ω–∞), –Ω–µ –ø–æ–ª–Ω—ã–π\n   ‚Üí –ï—Å–ª–∏ –Ω–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö –Ω—É–∂–Ω–æ–≥–æ —Ç–∏–ø–∞ ‚Üí \"–°–µ–π—á–∞—Å [—Ç–∏–ø] –Ω–µ—Ç, –∫–∞–∫ –ø–æ—è–≤—è—Ç—Å—è ‚Äî —Å–≤—è–∂–µ–º—Å—è!\" ‚Üí —ç—Ç–∞–ø ‚Üí \"–Ω–µ—Ç_—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞\"\n\n4. –í–´–ë–û–† (–∫–ª–∏–µ–Ω—Ç –≤—ã–±—Ä–∞–ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π ‚Äî \"–±–µ—Ä—É X\" / \"—Ö–æ—á—É X\")\n   ‚Üí –ó–∞–ø–∏—à–∏ –≤ STATE –ø–æ–ª–µ \"–±–∞–π–∫\" = –Ω–∞–∑–≤–∞–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏\n   ‚Üí –ï—Å–ª–∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç=–∞–≤—Ç–æ ‚Üí –ø–æ–ø—Ä–æ—Å–∏ —Ñ–æ—Ç–æ –≤–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ —É–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏—è (–í–£). –¢–û–õ–¨–ö–û –í–£!\n   ‚Üí –ï—Å–ª–∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç=–±–∞–π–∫/–≤–µ–ª–æ—Å–∏–ø–µ–¥ ‚Üí –ø–æ–ø—Ä–æ—Å–∏ —Ñ–æ—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–ø–∞—Å–ø–æ—Ä—Ç –ò–õ–ò –≤–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–µ –ø—Ä–∞–≤–∞ ‚Äî –ª—é–±–æ–π –ø–æ–¥–æ–π–¥—ë—Ç)\n   ‚Üí —ç—Ç–∞–ø ‚Üí \"–ø–∞—Å–ø–æ—Ä—Ç\"\n   ‚Üí –ü–µ—Ä–µ–¥—É–º–∞–ª ‚Üí —ç—Ç–∞–ø ‚Üí \"–ø–æ–¥–±–æ—Ä\"\n\n5. –ü–ê–°–ü–û–†–¢ (—ç—Ç–∞–ø = \"–ø–∞—Å–ø–æ—Ä—Ç\")\n   ‚Üí üî¥ –î–ê–¢–ê –ü–†–û–í–ï–†–ö–ê: –µ—Å–ª–∏ –¥–∞—Ç–∞ –∞—Ä–µ–Ω–¥—ã > 2 –¥–Ω–µ–π –æ—Ç —Å–µ–≥–æ–¥–Ω—è ‚Üí –ù–ï –±—Ä–æ–Ω–∏—Ä—É–π! –°–∫–∞–∂–∏:\n     \"–°–ø—Ä–æ—Å —Å–µ–π—á–∞—Å –±–æ–ª—å—à–æ–π, –ª—É—á—à–µ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –∑–∞ –¥–µ–Ω—å-–¥–≤–∞ –¥–æ –∞—Ä–µ–Ω–¥—ã. –ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º –±–ª–∏–∂–µ –∫ –¥–∞—Ç–µ ‚Äî –≤—Å—ë –ø–æ–¥–±–µ—Ä—ë–º! üòä\"\n     ‚Üí —ç—Ç–∞–ø –æ—Å—Ç–∞–≤—å \"–ø–∞—Å–ø–æ—Ä—Ç\" (–Ω–µ –ø–µ—Ä–µ–≤–æ–¥–∏ –≤ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω)\n   ‚Üí –ï—Å–ª–∏ –¥–∞—Ç–∞ = —Å–µ–≥–æ–¥–Ω—è/–∑–∞–≤—Ç—Ä–∞/–ø–æ—Å–ª–µ–∑–∞–≤—Ç—Ä–∞ (‚â§ 2 –¥–Ω—è):\n     [–î–û–ö–£–ú–ï–ù–¢] ‚Üí \"‚úÖ –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ! –°–∫–æ—Ä–æ —Å–≤—è–∂–µ–º—Å—è –¥–ª—è –¥–µ—Ç–∞–ª–µ–π\" ‚Üí —ç—Ç–∞–ø ‚Üí \"–∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω\"\n   ‚Üí üî¥ –ü–û–°–õ–ï –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –±—Ä–æ–Ω–∏, –µ—Å–ª–∏ –¥–Ω–µ–π >= 3, –°–†–ê–ó–£ –¥–æ–±–∞–≤—å:\n     \"üó∫Ô∏è –ë–æ–Ω—É—Å! –í–æ—Ç –∫–∞—Ä—Ç–∞ –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π –ù—è—á–∞–Ω–≥–∞ –∏ –î–∞–ª–∞—Ç–∞: https://maps.app.goo.gl/9oegqGYXydKWX6tUA?g_st=ac\"\n   ‚Üí [–§–û–¢–û] –±–µ–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞ ‚Üí –ø–æ–≤—Ç–æ—Ä–Ω–æ –ø–æ–ø—Ä–æ—Å–∏ (–í–£ –¥–ª—è –∞–≤—Ç–æ, –ø–∞—Å–ø–æ—Ä—Ç –∏–ª–∏ –í–£ –¥–ª—è –±–∞–π–∫–∞/–≤–µ–ª–æ—Å–∏–ø–µ–¥–∞)\n   ‚Üí –•–æ—á–µ—Ç –ø–æ–º–µ–Ω—è—Ç—å ‚Üí —ç—Ç–∞–ø ‚Üí \"–ø–æ–¥–±–æ—Ä\"\n\n6. –ó–ê–ë–†–û–ù–ò–†–û–í–ê–ù (—ç—Ç–∞–ø = \"–∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω\")\n   ‚Üí –ü–æ –±—Ä–æ–Ω–∏ ‚Üí \"–ü–µ—Ä–µ–¥–∞–º –º–µ–Ω–µ–¥–∂–µ—Ä—É, —Å–∫–æ—Ä–æ –æ—Ç–≤–µ—Ç–∏—Ç!\"\n   ‚Üí –û—Å—Ç–∞–ª—å–Ω–æ–µ ‚Üí –º–æ–ª—á–∞–Ω–∏–µ\n\n–õ–û–ö–ê–¶–ò–Ø:\n–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç: –≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å / –∞–¥—Ä–µ—Å / location / where are you / ·ªü ƒë√¢u / –≥–¥–µ –∑–∞–±—Ä–∞—Ç—å / pickup point:\n‚Üí –î–∞–π —Å—Å—ã–ª–∫—É: https://maps.app.goo.gl/N9x7DPV7LYf2BSUv6?g_st=ac\n‚Üí —ç—Ç–∞–ø –ù–ï –º–µ–Ω—è–π (–æ—Å—Ç–∞–≤—å —Ç–µ–∫—É—â–∏–π)\n\n–°–¢–û–ü–°–õ–û–í–ê (\"–æ—Ç–º–µ–Ω–∞\"/\"–Ω–µ –Ω–∞–¥–æ\"/\"–ø–µ—Ä–µ–¥—É–º–∞–ª\"/\"cancel\"):\n‚Üí \"–•–æ—Ä–æ—à–æ, –µ—Å–ª–∏ –ø–µ—Ä–µ–¥—É–º–∞–µ—Ç–µ ‚Äî –º—ã –Ω–∞ —Å–≤—è–∑–∏!\" ‚Üí —ç—Ç–∞–ø ‚Üí \"–æ—Ç–º–µ–Ω—ë–Ω\"\n\n–ù–ï –ü–û–í–¢–û–†–Ø–ô:\n- –ï—Å–ª–∏ —É–∂–µ –ø–æ–∫–∞–∑–∞–ª –∫–∞—Ç–∞–ª–æ–≥ ‚Äî –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–π —Å–Ω–æ–≤–∞ –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫\n- –ï—Å–ª–∏ —É–∂–µ —Å–ø—Ä–æ—Å–∏–ª –≤–æ–ø—Ä–æ—Å –∏ –ø–æ–ª—É—á–∏–ª –æ—Ç–≤–µ—Ç ‚Äî –Ω–µ —Å–ø—Ä–∞—à–∏–≤–∞–π –æ–ø—è—Ç—å\n- –ï—Å–ª–∏ —É–∂–µ —É–ø–æ–º—è–Ω—É–ª –±–æ–Ω—É—Å—ã ‚Äî –Ω–µ —É–ø–æ–º–∏–Ω–∞–π –ø–æ–≤—Ç–æ—Ä–Ω–æ\n\n‚ö†Ô∏è STATE ‚Äî –≤ –∫–æ–Ω—Ü–µ –ö–ê–ñ–î–û–ì–û –æ—Ç–≤–µ—Ç–∞:\nSTATE: {\"—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç\": \"?\", \"–¥–Ω–µ–π\": \"?\", \"–¥–∞—Ç–∞\": \"?\", \"–ø–æ–µ–∑–¥–∫–∏\": \"?\", \"–æ–ø—ã—Ç\": \"?\", \"–±–∞–π–∫\": \"?\", \"–±–∞–π–∫_—Å—Å—ã–ª–∫–∞\": \"?\", \"—ç—Ç–∞–ø\": \"–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ\"}\nüî¥ –ó–ù–ê–ß–ï–ù–ò–Ø STATE –í–°–ï–ì–î–ê –ù–ê –†–£–°–°–ö–û–ú! –î–∞–∂–µ –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø–∏—à–µ—Ç –Ω–∞ English/Vietnamese:\n   —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç = \"–±–∞–π–∫\" / \"–∞–≤—Ç–æ\" / \"–≤–µ–ª–æ—Å–∏–ø–µ–¥\" / \"?\"\n   –ø–æ–µ–∑–¥–∫–∏ = \"–≥–æ—Ä–æ–¥\" / \"–¥–∞–ª—å–Ω–∏–µ\" / \"?\"\n   –æ–ø—ã—Ç = \"–µ—Å—Ç—å\" / \"–Ω–µ—Ç\" / \"?\"\n   —ç—Ç–∞–ø = \"–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ\" / \"–≤—ã—è—Å–Ω–µ–Ω–∏–µ\" / \"–ø–æ–¥–±–æ—Ä\" / \"–ø–∞—Å–ø–æ—Ä—Ç\" / \"–∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω\" / \"–æ—Ç–º–µ–Ω—ë–Ω\"\n–ó–∞–º–µ–Ω—è–π ? –Ω–∞ –æ—Ç–≤–µ—Ç—ã –∫–ª–∏–µ–Ω—Ç–∞. –°–æ—Ö—Ä–∞–Ω—è–π –í–°–ï –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è!\nüî¥ –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –¥–∞–ª –ù–ï–°–ö–û–õ–¨–ö–û –¥–∞–Ω–Ω—ã—Ö –≤ –æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ ‚Äî –∑–∞–ø–æ–ª–Ω–∏ –í–°–ï —Å—Ä–∞–∑—É!\n   –ü—Ä–∏–º–µ—Ä: \"motorbike for 7 days, around the city, I have experience\" ‚Üí —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç=\"–±–∞–π–∫\", –¥–Ω–µ–π=\"7\", –ø–æ–µ–∑–¥–∫–∏=\"–≥–æ—Ä–æ–¥\", –æ–ø—ã—Ç=\"–µ—Å—Ç—å\", —ç—Ç–∞–ø=\"–ø–æ–¥–±–æ—Ä\"\n   –ü—Ä–∏–º–µ—Ä: \"xe m√°y 5 ng√†y, trong th√†nh ph·ªë\" ‚Üí —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç=\"–±–∞–π–∫\", –¥–Ω–µ–π=\"5\", –ø–æ–µ–∑–¥–∫–∏=\"–≥–æ—Ä–æ–¥\"\n–ö–æ–≥–¥–∞ –¥–Ω–µ–π+–ø–æ–µ–∑–¥–∫–∏+–æ–ø—ã—Ç ‚â† \"?\" ‚Üí —ç—Ç–∞–ø ‚Üí \"–ø–æ–¥–±–æ—Ä\", –ø–æ–∫–∞–∂–∏ –∫–∞—Ç–∞–ª–æ–≥.\n–ö–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç –≤—ã–±—Ä–∞–ª ‚Äî –∑–∞–ø–∏—à–∏ –±–∞–π–∫ –∏ –±–∞–π–∫_—Å—Å—ã–ª–∫–∞ (–∏–∑ –¥–∞–Ω–Ω—ã—Ö)!\n–ü—Ä–æ–¥–≤–∏–≥–∞–π —ç—Ç–∞–ø –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º –≤—ã—à–µ!`;\n\n// Select flow based on phone\nconst flowRules = isTest ? TEST_FLOW : PROD_FLOW;\n\n// Extract —ç—Ç–∞–ø for Check Stage\n// Use pre-filled —ç—Ç–∞–ø\nconst current–≠—Ç–∞–ø = prefilled–≠—Ç–∞–ø;\n// If state was reset by 12h check above, this won't run (already returned)\n// Collect _langCounts from state (may not exist for new users)\nlet outputLangCounts = '{}';\ntry {\n  if (items.length > 0 && items[0].json.state) {\n    outputLangCounts = items[0].json.state['_langCounts'] || '{}';\n    // Apply current message detection\n    const lc = JSON.parse(outputLangCounts);\n    if (detectedLang) lc[detectedLang] = (lc[detectedLang] || 0) + 1;\n    outputLangCounts = JSON.stringify(lc);\n  } else if (detectedLang) {\n    outputLangCounts = JSON.stringify({[detectedLang]: 1});\n  }\n} catch(e) {}\n\nreturn [{\n  json: {\n    sender: sender,\n    —ç—Ç–∞–ø: current–≠—Ç–∞–ø,\n    clientLang: clientLang,\n    sessionKey: sender + '_v2_s' + sessionNum,\n    _langCounts: outputLangCounts,\n    message: '[–Ø–ó–´–ö –ö–õ–ò–ï–ù–¢–ê: ' + clientLang + ']\\n' + stateContext + flowRules + '---\\nüî¥ –û–¢–í–ï–ß–ê–ô –°–¢–†–û–ì–û –ù–ê ' + clientLang + '! –ï—Å–ª–∏ ' + clientLang + ' ‚â† –†—É—Å—Å–∫–∏–π ‚Äî –ø–µ—Ä–µ–≤–µ–¥–∏ –í–°–Å: –æ–ø–∏—Å–∞–Ω–∏—è –º–æ–¥–µ–ª–µ–π, –±–æ–Ω—É—Å—ã, –≤–æ–ø—Ä–æ—Å—ã. –ù–∏ –æ–¥–Ω–æ–≥–æ —Ä—É—Å—Å–∫–æ–≥–æ —Å–ª–æ–≤–∞ –≤ –æ—Ç–≤–µ—Ç–µ!\\n---\\n–°–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞: ' + message\n  }\n}];\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          3060,
          -304
        ],
        "id": "d858893a-adb6-401f-9d26-db806f1c43d1",
        "name": "Inject State"
      },
      {
        "parameters": {
          "jsCode": "// Get AI Agent response\nconst aiOutput = $input.first().json.output || $input.first().json.text || '';\nconst sender = $('Edit Fields4').first().json.sender || '';\n\nlet state = {};\n\n// Method 1: Extract STATE: {...} block from GPT response\nconst stateMatch = aiOutput.match(/STATE:\\s*\\{([^}]+)\\}/);\nif (stateMatch) {\n  try {\n    state = JSON.parse('{' + stateMatch[1] + '}');\n  } catch(e) {}\n}\n\n// Load previous state from Supabase and merge (preserve what GPT didn't fill)\ntry {\n  const prev = $('Get User State').first().json.state || {};\n  // prev = old state, state = what GPT just reported\n  // Merge: GPT values win over prev, but prev fills gaps\n  const defaults = {—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç: '?', –¥–Ω–µ–π: '?', –¥–∞—Ç–∞: '?', –ø–æ–µ–∑–¥–∫–∏: '?', –æ–ø—ã—Ç: '?', –±–∞–π–∫: '?', –±–∞–π–∫_—Å—Å—ã–ª–∫–∞: '?', —ç—Ç–∞–ø: '–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ'};\n  state = {...defaults, ...prev, ...state};\n} catch(e) {\n  if (Object.keys(state).length === 0) {\n    state = {—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç: '?', –¥–Ω–µ–π: '?', –¥–∞—Ç–∞: '?', –ø–æ–µ–∑–¥–∫–∏: '?', –æ–ø—ã—Ç: '?', –±–∞–π–∫: '?', –±–∞–π–∫_—Å—Å—ã–ª–∫–∞: '?', —ç—Ç–∞–ø: '–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ'};\n  }\n}\n\n// Smart Extract: ALWAYS parse client message to fill MISSING fields\nlet clientMsg = '';\ntry {\n  const raw = $('–°—É–º–º–∞').first().json.message;\n  clientMsg = (Array.isArray(raw) ? raw.join(' ') : String(raw || '')).toLowerCase();\n} catch(e) {}\n\nif (!clientMsg) {\n  try {\n    const ef = $('Edit Fields4').first().json;\n    clientMsg = (ef.message || ef.text || '').toLowerCase();\n  } catch(e) {}\n}\n\n// Parse transport type (only if still missing)\nif (!state['—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç'] || state['—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç'] === '?') {\n  if (/(?:^|\\s)(–∞–≤—Ç–æ|–º–∞—à–∏–Ω|car|cars|automobile|√¥ t√¥|xe h∆°i)/i.test(clientMsg)) state['—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç'] = '–∞–≤—Ç–æ';\n  else if (/(?:^|\\s)(–±–∞–π–∫|–º–æ—Ç–æ|—Å–∫—É—Ç–µ—Ä|bike|scooter|motorbike|motorcycle|xe m√°y)/i.test(clientMsg)) state['—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç'] = '–±–∞–π–∫';\n  else if (/(?:^|\\s)(–≤–µ–ª–æ—Å–∏–ø–µ–¥|–≤–µ–ª–∏–∫|bicycle|xe ƒë·∫°p)/i.test(clientMsg)) state['—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç'] = '–≤–µ–ª–æ—Å–∏–ø–µ–¥';\n}\n\n// Parse days\nif (!state['–¥–Ω–µ–π'] || state['–¥–Ω–µ–π'] === '?') {\n  const dm = clientMsg.match(/(\\d+)\\s*–¥–Ω|for\\s*(\\d+)\\s*day|(\\d+)\\s*ng√†y/);\n  if (dm) state['–¥–Ω–µ–π'] = dm[1] || dm[2] || dm[3];\n}\n\n// Parse trips\nif (!state['–ø–æ–µ–∑–¥–∫–∏'] || state['–ø–æ–µ–∑–¥–∫–∏'] === '?') {\n  if (/–ø–æ –≥–æ—Ä–æ–¥—É|in the city|around town|trong th√†nh|–≤ –≥–æ—Ä–æ–¥–µ|around the city|city riding|city driving/.test(clientMsg)) state['–ø–æ–µ–∑–¥–∫–∏'] = '–≥–æ—Ä–æ–¥';\n  else if (/–∑–∞ –≥–æ—Ä–æ–¥|–¥–∞–ª—å–Ω–∏–µ|long distance|highway/.test(clientMsg)) state['–ø–æ–µ–∑–¥–∫–∏'] = '–¥–∞–ª—å–Ω–∏–µ';\n}\n\n// Parse experience\nif (!state['–æ–ø—ã—Ç'] || state['–æ–ø—ã—Ç'] === '?') {\n  if (/–ø—Ä–∞–≤–∞ –µ—Å—Ç—å|–∑–∞ —Ä—É–ª–µ–º|have.*license|been driving|c√≥ b·∫±ng|–æ–ø—ã—Ç –µ—Å—Ç—å|have experience|experienced|i ride|i drive/.test(clientMsg)) state['–æ–ø—ã—Ç'] = '–µ—Å—Ç—å';\n  else if (/–Ω–µ—Ç –æ–ø—ã—Ç–∞|–ø–µ—Ä–≤—ã–π —Ä–∞–∑|no experience|never driven|never rode|first time|ch∆∞a bao gi·ªù/.test(clientMsg)) state['–æ–ø—ã—Ç'] = '–Ω–µ—Ç';\n}\n\n// Detect —ç—Ç–∞–ø from AI response (override if detectable)\nconst aiText = aiOutput.toLowerCase();\nif (aiText.includes('–∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–æ') || aiText.includes('–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ') || aiText.includes('booked') || aiText.includes('ƒë√£ ƒë·∫∑t'))\n  state['—ç—Ç–∞–ø'] = '–∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω';\nelse if (aiText.includes('vnd/—Å—É—Ç–∫–∏') || aiText.includes('vnd/day') || aiText.includes('vnd/ng√†y'))\n  state['—ç—Ç–∞–ø'] = '–ø–æ–¥–±–æ—Ä';\nelse if ((aiText.includes('–≤–æ–¥–∏—Ç–µ–ª—å—Å–∫') || aiText.includes('–ø–∞—Å–ø–æ—Ä—Ç') || aiText.includes('passport') || aiText.includes('driver') || aiText.includes('license') || aiText.includes('b·∫±ng l√°i') || aiText.includes('h·ªô chi·∫øu')) &&\n         (aiText.includes('–ø—Ä–∏—à–ª–∏—Ç–µ') || aiText.includes('–æ—Ç–ø—Ä–∞–≤—å—Ç–µ') || aiText.includes('–∑–∞–≥—Ä—É–∑–∏—Ç–µ') || aiText.includes('–∂–¥—É') || aiText.includes('send') || aiText.includes('upload') || aiText.includes('g·ª≠i')))\n  state['—ç—Ç–∞–ø'] = '–ø–∞—Å–ø–æ—Ä—Ç';\n\n// Detect bike/car choice from client message (multilingual)\nconst choiceRu = clientMsg.match(/–±–µ—Ä—É\\s+(.+?)$/m);\nconst choiceEn = clientMsg.match(/(?:i(?:'ll| will)?\\s*)?(?:take|choose|want)\\s+(?:the\\s+)?(.+?)$/m);\nconst choiceVn = clientMsg.match(/(?:t√¥i\\s+)?ch·ªçn\\s+(.+?)$/m);\nconst choiceGeneric = clientMsg.match(/(?:—Ö–æ—á—É|–≤—ã–±–∏—Ä–∞—é|–¥–∞–≤–∞–π)\\s+(.+?)$/m);\nconst choice = choiceRu ? choiceRu[1] : (choiceEn ? choiceEn[1] : (choiceVn ? choiceVn[1] : (choiceGeneric ? choiceGeneric[1] : null)));\nif (choice) {\n  const model = choice.trim();\n  if (model.length > 2 && model.length < 40) {\n    state['–±–∞–π–∫'] = model.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');\n    if (state['—ç—Ç–∞–ø'] === '–ø–æ–¥–±–æ—Ä') state['—ç—Ç–∞–ø'] = '–ø–∞—Å–ø–æ—Ä—Ç';\n  }\n}\n\n// Also detect choice from AI output (GPT says \"–≤—ã –≤—ã–±—Ä–∞–ª–∏ X\" / \"you chose X\")\nif (!state['–±–∞–π–∫'] || state['–±–∞–π–∫'] === '?') {\n  const aiChoiceRu = aiOutput.match(/–≤—ã–±—Ä–∞–ª–∏\\s+(.+?)[\\!\\.\\,]/);\n  const aiChoiceEn = aiOutput.match(/(?:chose|chosen|selected)\\s+(?:the\\s+)?(.+?)[\\!\\.\\,]/i);\n  const aiChoiceVn = aiOutput.match(/(?:ch·ªçn|ƒë√£ ch·ªçn)\\s+(.+?)[\\!\\.\\,]/);\n  const aiChoice = aiChoiceRu ? aiChoiceRu[1] : (aiChoiceEn ? aiChoiceEn[1] : (aiChoiceVn ? aiChoiceVn[1] : null));\n  if (aiChoice && aiChoice.trim().length > 2 && aiChoice.trim().length < 40) {\n    state['–±–∞–π–∫'] = aiChoice.trim();\n  }\n}\n\n// Phase 1: Save catalog links when Merge Transport ran (step 1 = catalog shown)\ntry {\n  const merged = $('Merge Transport').first().json;\n  const catalogLinks = {};\n  const allVehicles = [...(merged.bikes || []), ...(merged.cars || []), ...(merged.bicycles || [])];\n  for (const v of allVehicles) {\n    const name = v['–ë–∞–π–∫'] || v['–ù–∞–∑–≤–∞–Ω–∏–µ'] || '';\n    const link = v['–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ç–∞–ª–æ–≥'] || '';\n    if (name && link.startsWith('https://')) {\n      catalogLinks[name.toLowerCase()] = link;\n    }\n  }\n  if (Object.keys(catalogLinks).length > 0) {\n    state['_catalogLinks'] = JSON.stringify(catalogLinks);\n  }\n} catch(e) {} // Merge Transport not in this execution path ‚Äî that's fine\n\n// Phase 2: Smart link lookup from saved catalog (works on steps 2/3 too)\nif (state['–±–∞–π–∫'] && state['–±–∞–π–∫'] !== '?' && (!state['–±–∞–π–∫_—Å—Å—ã–ª–∫–∞'] || state['–±–∞–π–∫_—Å—Å—ã–ª–∫–∞'] === '?')) {\n  try {\n    const catalogLinks = JSON.parse(state['_catalogLinks'] || '{}');\n    const modelName = state['–±–∞–π–∫'].toLowerCase();\n    // Priority 1: exact match\n    if (catalogLinks[modelName]) {\n      state['–±–∞–π–∫_—Å—Å—ã–ª–∫–∞'] = catalogLinks[modelName];\n    } else {\n      // Priority 2: one contains the other (prefer shorter catName = more specific)\n      let bestMatch = null;\n      let bestLen = Infinity;\n      for (const [catName, link] of Object.entries(catalogLinks)) {\n        if (catName.includes(modelName) || modelName.includes(catName)) {\n          if (catName.length < bestLen) {\n            bestMatch = link;\n            bestLen = catName.length;\n          }\n        }\n      }\n      if (bestMatch) {\n        state['–±–∞–π–∫_—Å—Å—ã–ª–∫–∞'] = bestMatch;\n      } else {\n        // Priority 3: word overlap (at least 2 words match)\n        for (const [catName, link] of Object.entries(catalogLinks)) {\n          const catWords = catName.split(' ').filter(w => w.length > 2);\n          const modelWords = modelName.split(' ').filter(w => w.length > 2);\n          const overlap = modelWords.filter(w => catWords.includes(w));\n          if (overlap.length >= 2 || (overlap.length >= 1 && modelWords.length === 1)) {\n            state['–±–∞–π–∫_—Å—Å—ã–ª–∫–∞'] = link;\n            break;\n          }\n        }\n      }\n    }\n  } catch(e) {}\n}\n\n// ===== TRANSITION GUARD: –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω only from –ø–∞—Å–ø–æ—Ä—Ç =====\n// Prevents AI from skipping document verification step\nconst prev–≠—Ç–∞–ø = (() => {\n  try { return $('Get User State').first().json.state?.['—ç—Ç–∞–ø'] || '–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ'; }\n  catch(e) { return '–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ'; }\n})();\nif (state['—ç—Ç–∞–ø'] === '–∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω' && prev–≠—Ç–∞–ø !== '–ø–∞—Å–ø–æ—Ä—Ç') {\n  // Illegal jump ‚Äî force –ø–∞—Å–ø–æ—Ä—Ç (document required first)\n  state['—ç—Ç–∞–ø'] = '–ø–∞—Å–ø–æ—Ä—Ç';\n}\n// ===== END TRANSITION GUARD =====\n\n// Preserve language + langCounts in state\ntry {\n  const injected = $('Inject State').first().json;\n  if (injected.clientLang) {\n    state['—è–∑—ã–∫'] = injected.clientLang;\n  }\n  if (injected._langCounts) {\n    state['_langCounts'] = injected._langCounts;\n  }\n} catch(e) {}\n\n// Clean response for WhatsApp\nlet cleanOutput = aiOutput.replace(/STATE:\\s*\\{[^}]+\\}\\n?/g, '').trim();\n\nreturn [{\n  json: {\n    output: cleanOutput,\n    sender: sender,\n    state: state,\n    hasState: Object.keys(state).length > 0\n  }\n}];"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          2200,
          256
        ],
        "id": "3555a285-2983-42fb-a95c-ff6edff24a5e",
        "name": "Extract State"
      },
      {
        "parameters": {
          "jsCode": "// Upsert user state to Supabase\nconst sender = $json.sender || '';\nconst state = $json.state || {};\n\nif (!sender) {\n  return [{ json: { success: false, error: 'no sender' } }];\n}\n\nconst key = $env.SUPABASE_SERVICE_ROLE_KEY;\nconst url = 'https://upjyomatlonfgygoniir.supabase.co/rest/v1/user_state';\n\nconst response = await this.helpers.httpRequest({\n  method: 'POST',\n  url: url,\n  headers: {\n    'apikey': key,\n    'Authorization': 'Bearer ' + key,\n    'Content-Type': 'application/json',\n    'Prefer': 'resolution=merge-duplicates'\n  },\n  body: {\n    jid: sender,\n    state: state,\n    updated_at: new Date().toISOString()\n  },\n  returnFullResponse: true\n});\n\nreturn [{ json: { success: true, status: response.statusCode || 201, sender } }];"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          2400,
          256
        ],
        "id": "e16baf7d-8a56-4ea9-8a58-0a97e02dea96",
        "name": "Save User State",
        "credentials": {}
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": false,
              "leftValue": "",
              "typeValidation": "loose",
              "version": 2
            },
            "conditions": [
              {
                "id": "check-booked",
                "leftValue": "={{ $('Inject State').first().json.—ç—Ç–∞–ø || '' }}",
                "rightValue": "–∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω",
                "operator": {
                  "type": "string",
                  "operation": "equals"
                }
              },
              {
                "id": "check-cancelled",
                "leftValue": "={{ $('Inject State').first().json.—ç—Ç–∞–ø || '' }}",
                "rightValue": "–æ—Ç–º–µ–Ω—ë–Ω",
                "operator": {
                  "type": "string",
                  "operation": "equals"
                }
              },
              {
                "id": "check-operator",
                "leftValue": "={{ $('Inject State').first().json.—ç—Ç–∞–ø || '' }}",
                "rightValue": "–æ–ø–µ—Ä–∞—Ç–æ—Ä",
                "operator": {
                  "type": "string",
                  "operation": "equals"
                }
              }
            ],
            "combinator": "or"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.2,
        "position": [
          3200,
          -304
        ],
        "id": "e87cf19d-2206-49f2-80b4-d2cad1a85628",
        "name": "Check Stage"
      },
      {
        "id": "get-bikes-prefetch",
        "name": "Get –ë–∞–π–∫–∏",
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.4,
        "position": [
          3440,
          -304
        ],
        "parameters": {
          "operation": "read",
          "documentId": {
            "__rl": true,
            "value": "1knpg3fWFiPLu2dFUQYTiOsuD-GRmcICnLKFnBf-EgGE",
            "mode": "id"
          },
          "sheetName": {
            "__rl": true,
            "value": 379274933,
            "mode": "id"
          },
          "filtersUI": {},
          "combineFilters": "AND",
          "options": {
            "returnAllMatches": true
          },
          "authentication": "serviceAccount"
        },
        "credentials": {
          "googleApi": {
            "id": "OMzR72oEyu6XISKt",
            "name": "Google Sheets account_KARMA_RENT"
          }
        }
      },
      {
        "id": "agg-bikes",
        "name": "Aggregate –ë–∞–π–∫–∏",
        "type": "n8n-nodes-base.aggregate",
        "typeVersion": 1,
        "position": [
          3680,
          -304
        ],
        "parameters": {
          "aggregate": "aggregateAllItemData",
          "destinationFieldName": "bikes",
          "include": "allFields",
          "options": {}
        },
        "alwaysOutputData": true
      },
      {
        "id": "filter-free-bikes",
        "name": "Filter –°–≤–æ–±–æ–¥–µ–Ω",
        "type": "n8n-nodes-base.filter",
        "typeVersion": 2,
        "position": [
          3560,
          -304
        ],
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": false,
              "leftValue": "",
              "typeValidation": "strict"
            },
            "conditions": [
              {
                "id": "cond-free",
                "leftValue": "={{ $json[\" \"] }}",
                "rightValue": "–°–≤–æ–±–æ–¥–µ–Ω",
                "operator": {
                  "type": "string",
                  "operation": "equals",
                  "rightType": "value"
                }
              }
            ],
            "combinator": "and"
          },
          "looseTypeValidation": true
        },
        "alwaysOutputData": true
      },
      {
        "parameters": {
          "jsCode": "// Check if booking is complete + determine sheet + send booking card\nconst state = $input.first().json.state || {};\nconst stage = String(state['—ç—Ç–∞–ø'] || '');\nconst link = String(state['–±–∞–π–∫_—Å—Å—ã–ª–∫–∞'] || '');\nconst transport = String(state['—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç'] || '');\nconst sender = $input.first().json.sender || '';\n\nconst isBooked = (stage === '–∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω') && link.startsWith('https://');\n\nif (isBooked) {\n  const SHEET_GIDS = {\n    '–±–∞–π–∫': 379274933,\n    '–∞–≤—Ç–æ': 1158744889,\n    '–≤–µ–ª–æ—Å–∏–ø–µ–¥': 1795232281\n  };\n  const sheetGid = SHEET_GIDS[transport] || 379274933;\n\n  // === BOOKING CARD ===\n  const phone = '+' + sender.replace('@s.whatsapp.net', '');\n  const model = (state['–±–∞–π–∫'] && state['–±–∞–π–∫'] !== '?') ? state['–±–∞–π–∫'] : '';\n  const days = (state['–¥–Ω–µ–π'] && state['–¥–Ω–µ–π'] !== '?') ? state['–¥–Ω–µ–π'] : '';\n  const date = (state['–¥–∞—Ç–∞'] && state['–¥–∞—Ç–∞'] !== '?') ? state['–¥–∞—Ç–∞'] : '';\n  const tName = transport === '–±–∞–π–∫' ? '–ë–∞–π–∫' : (transport === '–∞–≤—Ç–æ' ? '–ê–≤—Ç–æ' : '–í–µ–ª–æ—Å–∏–ø–µ–¥');\n\n  // Calculate return date if possible\n  let returnDate = '';\n  if (date && days) {\n    try {\n      let d;\n      const dotMatch = date.match(/(\\d{1,2})\\.(\\d{1,2})\\.(\\d{2,4})/);\n      if (dotMatch) {\n        const y = dotMatch[3].length === 2 ? 2000 + parseInt(dotMatch[3]) : parseInt(dotMatch[3]);\n        d = new Date(y, parseInt(dotMatch[2]) - 1, parseInt(dotMatch[1]));\n      }\n      if (d && !isNaN(d.getTime())) {\n        d.setDate(d.getDate() + parseInt(days));\n        returnDate = d.getDate().toString().padStart(2, '0') + '.' +\n                    (d.getMonth() + 1).toString().padStart(2, '0') + '.' +\n                    (d.getFullYear() % 100).toString().padStart(2, '0');\n      }\n    } catch(e) {}\n  }\n\n  let card = '–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ\\n';\n  card += '\\n' + phone;\n  card += '\\n\\n' + tName + ' - ' + model;\n  card += '\\n\\n–î–Ω–∏: ' + days;\n  card += '\\n\\n–î–∞—Ç–∞: ' + (date ? '—Å ' + date : '');\n  card += '\\n\\n–°–¥–∞—á–∞: ' + returnDate;\n  card += '\\n\\n–í—Ä–µ–º—è: –¥–æ';\n  card += '\\n\\n–§–æ—Ç–æ –ø–∞—Å–ø–æ—Ä—Ç–∞: +';\n  card += '\\n\\n–õ–∏–º–∏—Ç –∫–∏–ª–æ–º–µ—Ç—Ä–∞–∂–∞ –ø–æ –≥–æ—Ä–æ–¥—É:- 100 –∫–º —Å—É—Ç–∫–∏';\n  card += '\\n\\n–î–µ—Ä–∂–∞—Ç–µ–ª—å –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞: ?';\n  card += '\\n\\n–®–ª–µ–º: ?';\n  card += '\\n\\n–ü—Ä–æ–±–µ–≥ ?';\n  card += '\\n\\n–ë–µ–Ω–∑–∏–Ω: ?';\n  card += '\\n\\n–î–µ–ø–æ–∑–∏—Ç: 100–µ–≤—Ä–æ';\n  card += '\\n\\n–°—Ç–æ–∏–º–æ—Å—Ç—å: ?';\n\n  // Send after 5s delay\n  await new Promise(r => setTimeout(r, 5000));\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: 'https://karma-wa.fly.dev/message/sendText/karma',\n      headers: { 'apikey': 'karma-evo-2026-secret', 'Content-Type': 'application/json' },\n      body: { number: sender, text: card }\n    });\n  } catch(e) {}\n\n  return [{ json: { ...$input.first().json, checkin_ready: true, sheetGid: sheetGid } }];\n} else {\n  return [];\n}"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          2500,
          456
        ],
        "id": "check-booked-checkin",
        "name": "Check Booked Logic"
      },
      {
        "id": "checkin-prep",
        "name": "Checkin Prepare",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          2600,
          456
        ],
        "parameters": {
          "jsCode": "// Build checkin data with correct column name per sheet\nconst state = $json.state || {};\nconst transport = String(state['—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç'] || '–±–∞–π–∫');\nconst link = String(state['–±–∞–π–∫_—Å—Å—ã–ª–∫–∞'] || '');\nconst sheetGid = $json.sheetGid;\n\n// Column A header differs: –ë–∞–π–∫–∏=\" \" (space), –ê–≤—Ç–æ/–í–µ–ª–æ=\"–°–æ—Å—Ç–æ—è–Ω–∏–µ\"\nconst statusCol = (transport === '–±–∞–π–∫') ? ' ' : '–°–æ—Å—Ç–æ—è–Ω–∏–µ';\n\nconst result = {\n  '–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ç–∞–ª–æ–≥': link,\n  sheetGid: sheetGid\n};\nresult[statusCol] = '–í –∞—Ä–µ–Ω–¥–µ';\n\nreturn [{ json: result }];"
        }
      },
      {
        "id": "checkin-update",
        "name": "Checkin Update",
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.4,
        "position": [
          2850,
          456
        ],
        "parameters": {
          "operation": "update",
          "documentId": {
            "__rl": true,
            "value": "1knpg3fWFiPLu2dFUQYTiOsuD-GRmcICnLKFnBf-EgGE",
            "mode": "id"
          },
          "sheetName": {
            "__rl": true,
            "value": "={{ $json.sheetGid }}",
            "mode": "id"
          },
          "columns": {
            "mappingMode": "autoMapInputData",
            "value": {},
            "matchingColumns": [
              "–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ç–∞–ª–æ–≥"
            ],
            "schema": [
              {
                "id": " ",
                "displayName": " ",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "–ë–∞–π–∫",
                "displayName": "–ë–∞–π–∫",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "–ù–æ–º–µ—Ä –±–∞–π–∫–∞",
                "displayName": "–ù–æ–º–µ—Ä –±–∞–π–∫–∞",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "–ö–ª–∞—Å—Å",
                "displayName": "–ö–ª–∞—Å—Å",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ç–∞–ª–æ–≥",
                "displayName": "–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ç–∞–ª–æ–≥",
                "required": false,
                "defaultMatch": true,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "–¶–µ–Ω–∞/—Å—É—Ç–∫–∏",
                "displayName": "–¶–µ–Ω–∞/—Å—É—Ç–∫–∏",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              },
              {
                "id": "–°–æ—Å—Ç–æ—è–Ω–∏–µ",
                "displayName": "–°–æ—Å—Ç–æ—è–Ω–∏–µ",
                "required": false,
                "defaultMatch": false,
                "display": true,
                "type": "string",
                "canBeUsedToMatch": true,
                "removed": false
              }
            ]
          },
          "options": {},
          "authentication": "serviceAccount"
        },
        "credentials": {
          "googleApi": {
            "id": "OMzR72oEyu6XISKt",
            "name": "Google Sheets account_KARMA_RENT"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// Evolution API -> ChatFlow format adapter\nconst raw = $input.first().json;\nconst body = raw.body || {};\n\nconst event = body.event || '';\nconst data = body.data || {};\nconst key = data.key || {};\nconst msg = data.message || {};\n\n// Bot messages via API ‚Äî ignore completely\nif (event === 'send.message') return [];\n\n// Manager messages from WhatsApp app ‚Äî mark state as \"–æ–ø–µ—Ä–∞—Ç–æ—Ä\"\nif (key.fromMe === true && event === 'messages.upsert') {\n  const jid = key.remoteJid || '';\n  if (jid) {\n    const supabaseUrl = 'https://upjyomatlonfgygoniir.supabase.co';\n    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVwanlvbWF0bG9uZmd5Z29uaWlyIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc3MTA3MDE1OCwiZXhwIjoyMDg2NjQ2MTU4fQ.oDuT6Bc2mxKHpA1RvZzEa9Wb98qdTghPG4bqgRLvJ3k';\n\n    // First get current state\n    const rows = await this.helpers.httpRequest({\n      method: 'GET',\n      url: supabaseUrl + '/rest/v1/user_state?jid=eq.' + encodeURIComponent(jid) + '&select=state',\n      headers: { 'apikey': supabaseKey, 'Authorization': 'Bearer ' + supabaseKey },\n      json: true\n    });\n    const currentState = (rows.length > 0 && rows[0].state) ? rows[0].state : {};\n    currentState['—ç—Ç–∞–ø'] = '–æ–ø–µ—Ä–∞—Ç–æ—Ä';\n\n    // Upsert state\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: supabaseUrl + '/rest/v1/user_state',\n      headers: {\n        'apikey': supabaseKey,\n        'Authorization': 'Bearer ' + supabaseKey,\n        'Content-Type': 'application/json',\n        'Prefer': 'resolution=merge-duplicates'\n      },\n      body: { jid: jid, state: currentState, updated_at: new Date().toISOString() },\n      json: true\n    });\n  }\n  return [];\n}\n\n// Non-message events ‚Äî skip\nif (event && event !== 'messages.upsert') return [];\n\nlet messageType = 'text';\nlet message = '';\nlet mediaData = { base64: '', url: '' };\n\nif (msg.conversation) {\n  message = msg.conversation;\n} else if (msg.extendedTextMessage) {\n  message = msg.extendedTextMessage.text || '';\n} else if (msg.imageMessage) {\n  messageType = 'image';\n  message = msg.imageMessage.caption || '';\n  mediaData.url = msg.imageMessage.url || '';\n  mediaData.mediaKey = msg.imageMessage.mediaKey || '';\n  mediaData.directPath = msg.imageMessage.directPath || '';\n  mediaData.mimetype = msg.imageMessage.mimetype || '';\n  mediaData.jpegThumbnail = msg.imageMessage.jpegThumbnail || '';\n  mediaData.messageId = key.id || '';\n  mediaData.remoteJid = key.remoteJid || '';\n} else if (msg.audioMessage) {\n  messageType = 'audio';\n  mediaData.url = msg.audioMessage.url || '';\n} else if (msg.documentMessage) {\n  messageType = 'document';\n  message = msg.documentMessage.fileName || '';\n  mediaData.url = msg.documentMessage.url || '';\n}\n\n// Skip empty messages (protocol events)\nif (!message && messageType === 'text') return [];\n\nreturn [{\n  json: {\n    body: {\n      metadata: {\n        remoteJid: key.remoteJid || '',\n        messageId: key.id || '',\n        timestamp: data.messageTimestamp || Math.floor(Date.now()/1000)\n      },\n      messageType: messageType,\n      message: message,\n      mediaData: mediaData\n    }\n  }\n}];"
        },
        "name": "Webhook",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -1000,
          -224
        ],
        "id": "evo-adapter-001"
      },
      {
        "id": "get-cars-prefetch",
        "name": "Get –ê–≤—Ç–æ",
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.4,
        "position": [
          3440,
          -104
        ],
        "parameters": {
          "operation": "read",
          "documentId": {
            "value": "1knpg3fWFiPLu2dFUQYTiOsuD-GRmcICnLKFnBf-EgGE",
            "mode": "id"
          },
          "sheetName": {
            "value": 1158744889,
            "mode": "id"
          },
          "filtersUI": {},
          "combineFilters": "AND",
          "options": {
            "returnAllMatches": true
          },
          "authentication": "serviceAccount"
        },
        "credentials": {
          "googleApi": {
            "id": "OMzR72oEyu6XISKt",
            "name": "Google Sheets account_KARMA_RENT"
          }
        }
      },
      {
        "id": "get-velo-prefetch",
        "name": "Get –í–µ–ª–æ",
        "type": "n8n-nodes-base.googleSheets",
        "typeVersion": 4.4,
        "position": [
          3440,
          96
        ],
        "parameters": {
          "operation": "read",
          "documentId": {
            "value": "1knpg3fWFiPLu2dFUQYTiOsuD-GRmcICnLKFnBf-EgGE",
            "mode": "id"
          },
          "sheetName": {
            "value": 1795232281,
            "mode": "id"
          },
          "filtersUI": {},
          "combineFilters": "AND",
          "options": {
            "returnAllMatches": true
          },
          "authentication": "serviceAccount"
        },
        "credentials": {
          "googleApi": {
            "id": "OMzR72oEyu6XISKt",
            "name": "Google Sheets account_KARMA_RENT"
          }
        }
      },
      {
        "id": "filter-free-cars",
        "name": "Filter –ê–≤—Ç–æ",
        "type": "n8n-nodes-base.filter",
        "typeVersion": 2,
        "position": [
          3560,
          -104
        ],
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": false,
              "leftValue": "",
              "typeValidation": "strict"
            },
            "conditions": [
              {
                "id": "cond-free-car",
                "leftValue": "={{ $json[\"–°–æ—Å—Ç–æ—è–Ω–∏–µ\"] }}",
                "rightValue": "–°–≤–æ–±–æ–¥–µ–Ω",
                "operator": {
                  "type": "string",
                  "operation": "equals",
                  "rightType": "value"
                }
              }
            ],
            "combinator": "and"
          },
          "looseTypeValidation": true
        },
        "alwaysOutputData": true
      },
      {
        "id": "filter-free-velo",
        "name": "Filter –í–µ–ª–æ",
        "type": "n8n-nodes-base.filter",
        "typeVersion": 2,
        "position": [
          3560,
          96
        ],
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": false,
              "leftValue": "",
              "typeValidation": "strict"
            },
            "conditions": [
              {
                "id": "cond-free-velo",
                "leftValue": "={{ $json[\"–°–æ—Å—Ç–æ—è–Ω–∏–µ\"] }}",
                "rightValue": "–°–≤–æ–±–æ–¥–µ–Ω",
                "operator": {
                  "type": "string",
                  "operation": "equals",
                  "rightType": "value"
                }
              }
            ],
            "combinator": "and"
          },
          "looseTypeValidation": true
        },
        "alwaysOutputData": true
      },
      {
        "id": "agg-cars",
        "name": "Aggregate –ê–≤—Ç–æ",
        "type": "n8n-nodes-base.aggregate",
        "typeVersion": 1,
        "position": [
          3680,
          -104
        ],
        "parameters": {
          "aggregate": "aggregateAllItemData",
          "destinationFieldName": "cars",
          "include": "allFields",
          "options": {}
        },
        "alwaysOutputData": true
      },
      {
        "id": "agg-velo",
        "name": "Aggregate –í–µ–ª–æ",
        "type": "n8n-nodes-base.aggregate",
        "typeVersion": 1,
        "position": [
          3680,
          96
        ],
        "parameters": {
          "aggregate": "aggregateAllItemData",
          "destinationFieldName": "bicycles",
          "include": "allFields",
          "options": {}
        },
        "alwaysOutputData": true
      },
      {
        "id": "merge-transport",
        "name": "Merge Transport",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          3800,
          -104
        ],
        "parameters": {
          "jsCode": "// Combine all transport data from 3 parallel branches\nconst bikesData = $('Aggregate –ë–∞–π–∫–∏').all();\nconst carsData = $('Aggregate –ê–≤—Ç–æ').all();\nconst veloData = $('Aggregate –í–µ–ª–æ').all();\n\nconst bikes = (bikesData.length > 0 && bikesData[0].json.bikes) ? bikesData[0].json.bikes : [];\nconst cars = (carsData.length > 0 && carsData[0].json.cars) ? carsData[0].json.cars : [];\nconst bicycles = (veloData.length > 0 && veloData[0].json.bicycles) ? veloData[0].json.bicycles : [];\n\nreturn [{ json: { bikes, cars, bicycles } }];"
        }
      }
    ],
    "connections": {
      "Sort by Message ID": {
        "main": [
          [
            {
              "node": "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "–ë–µ—Ä–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è": {
        "main": [
          [
            {
              "node": "Sort by Message ID",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π": {
        "main": [
          [
            {
              "node": "–ë–µ—Ä–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Wait 10 Seconds": {
        "main": [
          []
        ]
      },
      "Simple Memory": {
        "ai_memory": [
          [
            {
              "node": "AI Agent",
              "type": "ai_memory",
              "index": 0
            }
          ]
        ]
      },
      "AI Agent": {
        "main": [
          [
            {
              "node": "Extract State",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ": {
        "main": [
          [
            {
              "node": "–°–±–æ—Ä–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "No Operation, do nothing",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "–°–±–æ—Ä–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π": {
        "main": [
          [
            {
              "node": "–°—É–º–º–∞",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "–°—É–º–º–∞": {
        "main": [
          [
            {
              "node": "Get User State",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "OpenAI Chat Model": {
        "ai_languageModel": [
          [
            {
              "node": "AI Agent",
              "type": "ai_languageModel",
              "index": 0
            }
          ]
        ]
      },
      "Switch": {
        "main": [
          [
            {
              "node": "Edit Fields5",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Edit Fields6",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "HTTP Request3",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "HTTP Request",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "HTTP Request": {
        "main": [
          [
            {
              "node": "Extract PDF Text",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "HTTP Request3": {
        "main": [
          [
            {
              "node": "Analyze image1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Extract PDF Text": {
        "main": [
          [
            {
              "node": "Set Payment Response2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Analyze image1": {
        "main": [
          [
            {
              "node": "Set Payment Response3",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Edit Fields4": {
        "main": [
          [
            {
              "node": "Switch",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Edit Fields6": {
        "main": [
          [
            {
              "node": "Convert to File1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Convert to File1": {
        "main": [
          [
            {
              "node": "OpenAI1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "OpenAI1": {
        "main": [
          [
            {
              "node": "Edit Fields7",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Edit Fields5": {
        "main": [
          [
            {
              "node": "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Edit Fields7": {
        "main": [
          [
            {
              "node": "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Set Payment Response3": {
        "main": [
          [
            {
              "node": "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Set Payment Response2": {
        "main": [
          [
            {
              "node": "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Phone Filter": {
        "main": [
          [
            {
              "node": "Edit Fields4",
              "type": "main",
              "index": 0
            }
          ],
          []
        ]
      },
      "Get User State": {
        "main": [
          [
            {
              "node": "Inject State",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Inject State": {
        "main": [
          [
            {
              "node": "Check Stage",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Extract State": {
        "main": [
          [
            {
              "node": "Save User State",
              "type": "main",
              "index": 0
            },
            {
              "node": "–°–æ–æ–±—â–µ–Ω–∏–µ –≤ WhatsApp",
              "type": "main",
              "index": 0
            },
            {
              "node": "Check Booked Logic",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Check Stage": {
        "main": [
          [
            {
              "node": "No Operation, do nothing",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Get –ë–∞–π–∫–∏",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Aggregate –ë–∞–π–∫–∏": {
        "main": [
          [
            {
              "node": "Get –ê–≤—Ç–æ",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Filter –°–≤–æ–±–æ–¥–µ–Ω": {
        "main": [
          [
            {
              "node": "Aggregate –ë–∞–π–∫–∏",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get –ë–∞–π–∫–∏": {
        "main": [
          [
            {
              "node": "Filter –°–≤–æ–±–æ–¥–µ–Ω",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Checkin Prepare": {
        "main": [
          [
            {
              "node": "Checkin Update",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Check Booked Logic": {
        "main": [
          [
            {
              "node": "Checkin Prepare",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "WebhookRaw": {
        "main": [
          [
            {
              "node": "Webhook",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Webhook": {
        "main": [
          [
            {
              "node": "Phone Filter",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get –ê–≤—Ç–æ": {
        "main": [
          [
            {
              "node": "Filter –ê–≤—Ç–æ",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Filter –ê–≤—Ç–æ": {
        "main": [
          [
            {
              "node": "Aggregate –ê–≤—Ç–æ",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Get –í–µ–ª–æ": {
        "main": [
          [
            {
              "node": "Filter –í–µ–ª–æ",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Filter –í–µ–ª–æ": {
        "main": [
          [
            {
              "node": "Aggregate –í–µ–ª–æ",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Aggregate –ê–≤—Ç–æ": {
        "main": [
          [
            {
              "node": "Get –í–µ–ª–æ",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Aggregate –í–µ–ª–æ": {
        "main": [
          [
            {
              "node": "Merge Transport",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Merge Transport": {
        "main": [
          [
            {
              "node": "AI Agent",
              "type": "main",
              "index": 0
            }
          ]
        ]
      }
    },
    "authors": "Denis Karmarent",
    "name": null,
    "description": null,
    "autosaved": false,
    "workflowPublishHistory": [
      {
        "createdAt": "2026-02-28T18:59:53.596Z",
        "id": 233,
        "workflowId": "rC30SNQvTZG9Zhza",
        "versionId": "74aa325d-853f-4442-babb-9426ac710fa5",
        "event": "activated",
        "userId": "32ebda6a-f598-4a39-9108-5156d43057e3"
      }
    ]
  }
}