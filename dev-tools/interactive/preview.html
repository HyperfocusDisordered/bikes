<!DOCTYPE html>
<html>
<head>
  <base href="/">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Flutter Component Preview</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #000;
    }
    #preview-container {
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .loading {
      color: #00ffff;
      font-family: monospace;
      text-shadow: 0 0 2px #00cfff, 0 0 3px #00cfff80, 0 0 6px #00cfff;
    }
    iframe {
      border: none;
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <div id="preview-container">
    <div class="loading">Loading Flutter component...</div>
  </div>
  <script>
    // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
    const urlParams = new URLSearchParams(window.location.search);
    const componentName = urlParams.get('component');
    const mockStateParam = urlParams.get('mockState');
    
    // –ü–∞—Ä—Å–∏–º mock state –µ—Å–ª–∏ –µ—Å—Ç—å
    let mockState = {};
    if (mockStateParam) {
      try {
        mockState = JSON.parse(decodeURIComponent(mockStateParam));
      } catch (e) {
        console.error('Error parsing mockState:', e);
      }
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ
    if (componentName) {
      const loadingEl = document.querySelector('.loading');
      if (loadingEl) {
        loadingEl.textContent = `Loading: ${componentName}`;
      }
    }
    
    console.log('Preview page loaded, component:', componentName);
    
    // –í—Å–µ–≥–¥–∞ –ø—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å Flutter (–∏ –¥–ª—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤, –∏ –¥–ª—è —ç–∫—Ä–∞–Ω–æ–≤)
    loadFlutterApp();
    
    // –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å Flutter Web –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    function loadFlutterApp() {
      console.log('loadFlutterApp called for component:', componentName);
      const container = document.getElementById('preview-container');
      const flutterAppPath = '/flutter-app/index.html';
      
      // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Flutter –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      fetch(flutterAppPath, { method: 'HEAD' })
        .then(response => {
          if (response.ok) {
            console.log('Flutter app found, loading in iframe...');
            // Flutter app –Ω–∞–π–¥–µ–Ω, –∑–∞–≥—Ä—É–∂–∞–µ–º —á–µ—Ä–µ–∑ iframe
            const url = flutterAppPath + (componentName ? `?component=${encodeURIComponent(componentName)}` : '');
            const iframe = document.createElement('iframe');
            iframe.src = url;
            iframe.style.width = '100%';
            iframe.style.height = '100%';
            iframe.style.border = 'none';
            iframe.style.background = '#000';
            
            let loaded = false;
            
            iframe.onload = () => {
              loaded = true;
              console.log('Flutter app iframe loaded successfully');
            };
            
            iframe.onerror = () => {
              console.error('Failed to load Flutter app in iframe');
              if (!loaded) {
                const loadingEl = container.querySelector('.loading');
                if (loadingEl) {
                  loadingEl.textContent = 'Failed to load Flutter component';
                  loadingEl.style.color = '#ff0000';
                }
              }
            };
            
            container.innerHTML = '';
            container.appendChild(iframe);
          } else {
            throw new Error('Flutter app not found (404)');
          }
        })
        .catch(error => {
          console.error('Flutter app not found:', error);
          const container = document.getElementById('preview-container');
          if (container) {
            const loadingEl = container.querySelector('.loading');
            if (loadingEl) {
              loadingEl.textContent = 'Flutter app not found. Build it first: flutter build web --release --base-href "/flutter-app/"';
              loadingEl.style.color = '#ff0000';
            }
          }
        });
    }

    // Live Reload —á–µ—Ä–µ–∑ Server-Sent Events
    (function setupLiveReload() {
        const eventSource = new EventSource('/events');

        eventSource.onopen = () => {
            console.log('üîå Live reload connected (preview)');
        };

        eventSource.onmessage = (event) => {
            if (event.data === 'reload') {
                console.log('üîÑ Reloading preview...');

                // –°–æ–∑–¥–∞–µ–º –æ–≤–µ—Ä–ª–µ–π –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100vw;
                    height: 100vh;
                    background: linear-gradient(135deg, rgba(0, 207, 255, 0.95) 0%, rgba(0, 100, 255, 0.95) 100%);
                    z-index: 999999;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    flex-direction: column;
                    gap: 20px;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                `;

                const icon = document.createElement('div');
                icon.style.cssText = `
                    font-size: 64px;
                    animation: spin 1s linear infinite;
                `;
                icon.textContent = 'üîÑ';

                const text = document.createElement('div');
                text.style.cssText = `
                    font-family: monospace;
                    font-size: 24px;
                    color: white;
                    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
                `;
                text.textContent = 'Updating Preview...';

                overlay.appendChild(icon);
                overlay.appendChild(text);
                document.body.appendChild(overlay);

                // –ü–ª–∞–≤–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–≤–µ—Ä–ª–µ–π
                requestAnimationFrame(() => {
                    overlay.style.opacity = '1';
                });

                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            }
        };

        eventSource.onerror = (error) => {
            console.error('EventSource error:', error);
            // –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É
            eventSource.close();
            setTimeout(setupLiveReload, 1000);
        };
    })();
  </script>
</body>
</html>
