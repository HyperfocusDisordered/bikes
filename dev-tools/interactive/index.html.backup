<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bikes - Interactive Logic Map</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000000;
            color: #ffffff;
            overflow: visible;
            height: 100vh;
        }

        .container {
            display: flex;
            height: 100vh;
            background: radial-gradient(ellipse at center, #1a1a1a 0%, #000000 100%);
            overflow: visible;
        }

        .map-canvas {
            flex: 1;
            position: relative;
            overflow: auto;
            cursor: grab;
            user-select: none;
            -webkit-user-select: none;
        }

        .map-canvas:active {
            cursor: grabbing;
        }

        .map-canvas.dragging-node {
            cursor: move;
        }

        .map-svg {
            position: absolute;
            top: 0;
            left: 0;
            min-width: 100%;
            min-height: 100%;
            background: 
                radial-gradient(circle at 20% 30%, rgba(78, 201, 176, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(220, 220, 170, 0.05) 0%, transparent 50%),
                #000000;
        }

        /* JSON-–ø–æ–¥–æ–±–Ω—ã–µ –Ω–æ–¥—ã */
        .node-group {
            cursor: move;
        }

        .node-container {
            filter: drop-shadow(0 0 8px rgba(78, 201, 176, 0.5));
        }

        .node-group:hover .node-container {
            filter: drop-shadow(0 0 15px rgba(78, 201, 176, 0.8));
        }

        .node-rect {
            fill: rgba(20, 20, 20, 0.95);
            stroke-width: 1.5;
            rx: 4;
            transition: all 0.2s;
        }

        .node-group.screen .node-rect {
            stroke: #4ec9b0;
        }

        .node-group.component .node-rect {
            stroke: #dcdcaa;
        }

        .node-group.service .node-rect {
            stroke: #ce9178;
        }

        .node-group.state .node-rect {
            stroke: #c586c0;
        }

        .node-group.util .node-rect {
            stroke: #9cdcfe;
        }

        .node-group.app .node-rect {
            stroke: #569cd6;
        }

        .node-group.entry .node-rect {
            stroke: #d4d4d4;
        }

        .node-group:hover .node-rect {
            stroke-width: 2.5;
        }

        /* JSON —Å—Ç–∏–ª—å —Ç–µ–∫—Å—Ç–∞ */
        .node-json-brace {
            font-size: 14px;
            fill: #d4d4d4;
            font-family: monospace;
            font-weight: bold;
        }

        .node-json-key {
            font-size: 10px;
            fill: #9cdcfe;
            font-family: monospace;
        }

        .node-json-value {
            font-size: 9px;
            fill: #ce9178;
            font-family: monospace;
        }

        .node-json-string {
            font-size: 9px;
            fill: #ce9178;
            font-family: monospace;
        }

        .node-json-number {
            font-size: 9px;
            fill: #b5cea8;
            font-family: monospace;
        }

        .node-json-icon {
            font-size: 12px;
        }

        .node-json-array {
            font-size: 9px;
            fill: #dcdcaa;
            font-family: monospace;
        }

        /* –†–∞–∑–º–µ—Ä—ã —Ç–µ–∫—Å—Ç–∞ –ø–æ —É—Ä–æ–≤–Ω—è–º –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏ */
        .node-level-0 .node-json-key { font-size: 14px; }
        .node-level-0 .node-json-value { font-size: 13px; }
        .node-level-0 .node-json-icon { font-size: 18px; }
        
        .node-level-1 .node-json-key { font-size: 12px; }
        .node-level-1 .node-json-value { font-size: 11px; }
        .node-level-1 .node-json-icon { font-size: 16px; }
        
        .node-level-2 .node-json-key { font-size: 10px; }
        .node-level-2 .node-json-value { font-size: 9px; }
        .node-level-2 .node-json-icon { font-size: 14px; }
        
        .node-level-3 .node-json-key { font-size: 9px; }
        .node-level-3 .node-json-value { font-size: 8px; }
        .node-level-3 .node-json-icon { font-size: 12px; }

        /* –°–æ–µ–¥–∏–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏ - —Ä–∞–∑–Ω—ã–µ —Ç–∏–ø—ã */
        .connection-line {
            stroke-width: 1;
            fill: none;
            marker-end: url(#arrowhead);
            opacity: 0.4;
        }

        .connection-line:hover {
            opacity: 0.8;
            stroke-width: 2;
        }

        .connection-structural {
            stroke: rgba(78, 201, 176, 0.5);
        }

        .connection-call {
            stroke: rgba(220, 220, 170, 0.6);
        }

        .connection-read {
            stroke: rgba(78, 201, 176, 0.4);
            stroke-dasharray: 3,3;
        }

        .connection-write {
            stroke: rgba(197, 134, 192, 0.6);
        }

        .connection-service {
            stroke: rgba(206, 145, 120, 0.6);
        }

        /* –ü—Ä–µ–≤—å—é –ø–∞–Ω–µ–ª—å */
        .preview-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 400px;
            max-height: 80vh;
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid #4ec9b0;
            border-radius: 12px;
            padding: 20px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .preview-panel.visible {
            display: block;
        }

        .preview-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(78, 201, 176, 0.3);
        }

        .preview-icon {
            font-size: 32px;
        }

        .preview-title {
            font-size: 20px;
            font-weight: 600;
            color: #4ec9b0;
        }

        .preview-path {
            font-size: 11px;
            color: #858585;
            font-family: monospace;
            margin-top: 5px;
        }

        .preview-functions {
            margin-top: 15px;
        }

        .preview-function {
            background: rgba(255, 255, 255, 0.05);
            border-left: 3px solid #4ec9b0;
            padding: 10px 12px;
            margin-bottom: 8px;
            border-radius: 4px;
        }

        .preview-function-name {
            font-size: 14px;
            color: #dcdcaa;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .preview-function-desc {
            font-size: 11px;
            color: #858585;
        }

        .preview-calls {
            margin-top: 8px;
            font-size: 10px;
            color: #6a9955;
        }

        .preview-call {
            margin: 2px 0;
            font-family: monospace;
        }

        .controls {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 100;
            display: flex;
            gap: 10px;
        }

        .control-btn {
            padding: 10px 15px;
            background: rgba(78, 201, 176, 0.2);
            border: 1px solid #4ec9b0;
            border-radius: 6px;
            color: #4ec9b0;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .control-btn:hover {
            background: rgba(78, 201, 176, 0.3);
            transform: scale(1.05);
        }
        
        .control-btn.active {
            background: rgba(78, 201, 176, 0.4);
            border-color: #4ec9b0;
        }
        
        .status-indicator {
            position: fixed;
            top: 70px;
            left: 20px;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(78, 201, 176, 0.3);
            border-radius: 6px;
            color: #4ec9b0;
            font-size: 11px;
            z-index: 100;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-indicator.loading {
            border-color: #dcdcaa;
            color: #dcdcaa;
        }
        
        .status-indicator.success {
            border-color: #6a9955;
            color: #6a9955;
        }
        
        .status-indicator.error {
            border-color: #f48771;
            color: #f48771;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .search-box {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 300px;
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(78, 201, 176, 0.3);
            border-radius: 8px;
            color: #ffffff;
            font-size: 14px;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .search-box:focus {
            outline: none;
            border-color: #4ec9b0;
            box-shadow: 0 0 15px rgba(78, 201, 176, 0.3);
        }

        .arrowhead {
            fill: rgba(78, 201, 176, 0.5);
        }

        .arrowhead-call {
            fill: rgba(220, 220, 170, 0.6);
        }

        .arrowhead-read {
            fill: rgba(78, 201, 176, 0.4);
        }

        .arrowhead-write {
            fill: rgba(197, 134, 192, 0.6);
        }

        .arrowhead-service {
            fill: rgba(206, 145, 120, 0.6);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="map-canvas" id="mapCanvas">
            <svg class="map-svg" id="mapSvg">
                <defs>
                    <marker id="arrowhead" markerWidth="8" markerHeight="8" refX="7" refY="2.5" orient="auto">
                        <polygon points="0 0, 8 2.5, 0 5" class="arrowhead" />
                    </marker>
                    <marker id="arrowhead-call" markerWidth="8" markerHeight="8" refX="7" refY="2.5" orient="auto">
                        <polygon points="0 0, 8 2.5, 0 5" class="arrowhead-call" />
                    </marker>
                    <marker id="arrowhead-read" markerWidth="8" markerHeight="8" refX="7" refY="2.5" orient="auto">
                        <polygon points="0 0, 8 2.5, 0 5" class="arrowhead-read" />
                    </marker>
                    <marker id="arrowhead-write" markerWidth="8" markerHeight="8" refX="7" refY="2.5" orient="auto">
                        <polygon points="0 0, 8 2.5, 0 5" class="arrowhead-write" />
                    </marker>
                    <marker id="arrowhead-service" markerWidth="8" markerHeight="8" refX="7" refY="2.5" orient="auto">
                        <polygon points="0 0, 8 2.5, 0 5" class="arrowhead-service" />
                    </marker>
                </defs>
                <g id="transform-group">
                    <g id="connections"></g>
                    <g id="nodes"></g>
                </g>
            </svg>
        </div>
    </div>

    <input type="text" class="search-box" placeholder="üîç –ü–æ–∏—Å–∫..." id="searchBox">

    <div class="controls">
        <button class="control-btn" onclick="reloadData()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
        <button class="control-btn" onclick="resetView()">üéØ –°–±—Ä–æ—Å –≤–∏–¥–∞</button>
        <button class="control-btn" onclick="zoomIn()">‚ûï –£–≤–µ–ª–∏—á–∏—Ç—å</button>
        <button class="control-btn" onclick="zoomOut()">‚ûñ –£–º–µ–Ω—å—à–∏—Ç—å</button>
        <button class="control-btn" onclick="fitToScreen()">üìê –ü–æ —Ä–∞–∑–º–µ—Ä—É</button>
        <button class="control-btn" id="autoReloadBtn" onclick="toggleAutoReload()">‚è∏Ô∏è –ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</button>
    </div>
    
    <div id="statusIndicator" class="status-indicator">
        <span id="statusText">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
    </div>

    <div class="preview-panel" id="previewPanel">
        <div class="preview-header">
            <div class="preview-icon" id="previewIcon">üì±</div>
            <div>
                <div class="preview-title" id="previewTitle">Node Name</div>
                <div class="preview-path" id="previewPath">path/to/file.cljd</div>
            </div>
        </div>
        <div class="preview-functions" id="previewFunctions"></div>
    </div>

    <script src="renderer.js"></script>
    <script>
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞
        let projectData = null;
        let autoReloadEnabled = false;
        let autoReloadInterval = null;
        let lastModified = null;
        
        function updateStatus(text, type = 'success') {
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            statusIndicator.className = `status-indicator ${type}`;
            statusText.textContent = text;
        }
        
        async function loadProjectData(showStatus = true) {
            try {
                if (showStatus) {
                    updateStatus('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...', 'loading');
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º timestamp –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
                const response = await fetch(`project-data.json?t=${Date.now()}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –ª–∏ –¥–∞–Ω–Ω—ã–µ
                const dataHash = JSON.stringify(data);
                if (dataHash === JSON.stringify(projectData)) {
                    if (showStatus) {
                        updateStatus('–î–∞–Ω–Ω—ã–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã', 'success');
                        setTimeout(() => updateStatus('', 'success'), 2000);
                    }
                    return false; // –î–∞–Ω–Ω—ã–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å
                }
                
                projectData = data;
                console.log('‚úÖ Project data loaded:', projectData);
                
                if (showStatus) {
                    updateStatus('–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã', 'success');
                    setTimeout(() => updateStatus('', 'success'), 2000);
                }
                
                // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∫–∞—Ä—Ç—É
                renderNodes();
                updateTransform();
                
                return true; // –î–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å
            } catch (error) {
                console.error('‚ùå Error loading project data:', error);
                updateStatus(`–û—à–∏–±–∫–∞: ${error.message}`, 'error');
                
                // Fallback –Ω–∞ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ
                if (!projectData) {
                    projectData = {
                        tree: {
                            app: { level: 0, parent: null, children: ['home'], subCards: [] }
                        },
                        nodes: {
                            app: { id: 'app', type: 'app', name: 'App', icon: 'üì±', path: 'src/bikes/app.cljd' }
                        }
                    };
                    renderNodes();
                    updateTransform();
                }
                return false;
            }
        }
        
        function reloadData() {
            loadProjectData(true);
        }
        
        function toggleAutoReload() {
            autoReloadEnabled = !autoReloadEnabled;
            const btn = document.getElementById('autoReloadBtn');
            
            if (autoReloadEnabled) {
                btn.textContent = '‚ñ∂Ô∏è –ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ';
                btn.classList.add('active');
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
                autoReloadInterval = setInterval(() => {
                    loadProjectData(false); // –ë–µ–∑ –ø–æ–∫–∞–∑–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–∏ –∞–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
                }, 2000);
                updateStatus('–ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ', 'success');
                setTimeout(() => updateStatus('', 'success'), 2000);
            } else {
                btn.textContent = '‚è∏Ô∏è –ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ';
                btn.classList.remove('active');
                if (autoReloadInterval) {
                    clearInterval(autoReloadInterval);
                    autoReloadInterval = null;
                }
                updateStatus('–ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–∫–ª—é—á–µ–Ω–æ', 'success');
                setTimeout(() => updateStatus('', 'success'), 2000);
            }
        }
        
        // –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–æ–≥–æ JSON –¥–µ—Ä–µ–≤–∞ —Å –¥–æ—á–µ—Ä–Ω–∏–º–∏ –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏
        // –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ JSON —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
        function renderJSONStructure(data, x, y, level = 0) {
            if (!data || typeof data !== 'object') {
                return y;
            }
            
            const indentSize = 30;
            const baseFontSize = 14;
            const maxFontSize = 32;
            
            // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ç–æ–º–∫–æ–≤ –¥–ª—è —Ä–∞–∑–º–µ—Ä–∞ —à—Ä–∏—Ñ—Ç–∞
            const countDescendants = (obj) => {
                if (!obj || typeof obj !== 'object') return 0;
                let count = Object.keys(obj).length;
                for (const key in obj) {
                    count += countDescendants(obj[key]);
                }
                return count;
            };
            
            const descendantsCount = countDescendants(data);
            const fontSize = Math.min(baseFontSize + descendantsCount * 0.8, maxFontSize);
            
            const keys = Object.keys(data);
            
            keys.forEach((key, idx) => {
                const value = data[key];
                const isLast = idx === keys.length - 1;
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–º (–∏–º–µ–µ—Ç –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç—å)
                const hasChildren = value && typeof value === 'object' && Object.keys(value).length > 0;
                
                // –í—ã—á–∏—Å–ª—è–µ–º —à–∏—Ä–∏–Ω—É —Ç–µ–∫—Å—Ç–∞ –¥–ª—è —Ñ–æ–Ω–∞
                const keyTextWidth = fontSize * (key.length + 2) * 0.6;
                const keyTextHeight = fontSize * 1.2;
                const padding = 4;
                
                // –°–æ–∑–¥–∞–µ–º –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω –¥–ª—è –∫–ª—é—á–∞
                const keyBg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                keyBg.setAttribute('x', x - padding);
                keyBg.setAttribute('y', y - fontSize * 0.85);
                keyBg.setAttribute('width', keyTextWidth + padding * 2);
                keyBg.setAttribute('height', keyTextHeight);
                keyBg.setAttribute('rx', '4');
                keyBg.setAttribute('ry', '4');
                keyBg.setAttribute('fill', '#ffffff');
                keyBg.setAttribute('fill-opacity', '0.15');
                nodesGroup.appendChild(keyBg);
                
                // –†–∏—Å—É–µ–º –∫–ª—é—á
                const keyText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                keyText.setAttribute('x', x);
                keyText.setAttribute('y', y);
                keyText.setAttribute('font-size', fontSize);
                keyText.setAttribute('font-weight', 'bold');
                keyText.setAttribute('fill', '#ffffff');
                keyText.setAttribute('font-family', 'monospace');
                keyText.textContent = `"${key}"`;
                nodesGroup.appendChild(keyText);
                
                // –î–≤–æ–µ—Ç–æ—á–∏–µ
                const colon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                colon.setAttribute('x', x + fontSize * (key.length + 2) * 0.6);
                colon.setAttribute('y', y);
                colon.setAttribute('font-size', fontSize);
                colon.setAttribute('fill', '#858585');
                colon.setAttribute('font-family', 'monospace');
                colon.textContent = hasChildren ? ': {' : ': {}';
                nodesGroup.appendChild(colon);
                
                y += fontSize * 1.5;
                
                // –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ —Ä–µ–Ω–¥–µ—Ä–∏–º –¥–æ—á–µ—Ä–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã
                if (hasChildren) {
                    y = renderJSONStructure(value, x + indentSize, y, level + 1);
                    
                    // –ó–∞–∫—Ä—ã–≤–∞—é—â–∞—è —Å–∫–æ–±–∫–∞
                    const closeBrace = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    closeBrace.setAttribute('x', x);
                    closeBrace.setAttribute('y', y);
                    closeBrace.setAttribute('font-size', fontSize);
                    closeBrace.setAttribute('fill', '#858585');
                    closeBrace.setAttribute('font-family', 'monospace');
                    closeBrace.textContent = '}';
                    nodesGroup.appendChild(closeBrace);
                    
                    y += fontSize * 1.2;
                }
                
                // –ó–∞–ø—è—Ç–∞—è (–µ—Å–ª–∏ –Ω–µ –ø–æ—Å–ª–µ–¥–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç)
                if (!isLast) {
                    const comma = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    comma.setAttribute('x', x - 10);
                    comma.setAttribute('y', y - fontSize * 0.3);
                    comma.setAttribute('font-size', fontSize);
                    comma.setAttribute('fill', '#858585');
                    comma.setAttribute('font-family', 'monospace');
                    comma.textContent = ',';
                    nodesGroup.appendChild(comma);
                }
            });
            
            return y;
        }
        
        // –£—Å—Ç–∞—Ä–µ–≤—à–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–æ—Å—Ç–∞–≤–ª—è–µ–º –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º)
        function buildJSONTree() {
            return projectData || {};
        }

        function positionJSONTree() {
            return {};
            
            const logicMap = {};
            const nodesByLevel = {};
            const allNodes = []; // –í—Å–µ –Ω–æ–¥—ã –≤–∫–ª—é—á–∞—è –ø–æ–¥–∫–∞—Ä—Ç–æ—á–∫–∏
            
            // –°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –Ω–æ–¥—ã
            Object.entries(tree).forEach(([id, data]) => {
                if (!nodesByLevel[data.level]) {
                    nodesByLevel[data.level] = [];
                }
                nodesByLevel[data.level].push({ id, ...data, isSubCard: false });
                allNodes.push({ id, ...data, isSubCard: false });
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–∫–∞—Ä—Ç–æ—á–∫–∏ –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –Ω–æ–¥—ã
            Object.entries(tree).forEach(([parentId, parentData]) => {
                if (parentData.subCards && parentData.subCards.length > 0) {
                    parentData.subCards.forEach((subCardId) => {
                        const subCardInfo = getSubCardInfo(subCardId, parentId, parentData);
                        if (subCardInfo) {
                            const subCardLevel = parentData.level + 1;
                            if (!nodesByLevel[subCardLevel]) {
                                nodesByLevel[subCardLevel] = [];
                            }
                            nodesByLevel[subCardLevel].push({ 
                                id: subCardId, 
                                parent: parentId,
                                level: subCardLevel,
                                isSubCard: true,
                                ...subCardInfo
                            });
                            allNodes.push({ 
                                id: subCardId, 
                                parent: parentId,
                                level: subCardLevel,
                                isSubCard: true,
                                ...subCardInfo
                            });
                        }
                    });
                }
            });
            
            // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã –≤—Å–µ—Ö –Ω–æ–¥
            const nodeSizes = {};
            allNodes.forEach((nodeData) => {
                const nodeId = nodeData.id;
                const nodeInfo = nodeData.isSubCard ? nodeData : getNodeInfo(nodeId);
                const levelNum = nodeData.level;
                
                const height = calculateNodeHeight(nodeInfo, levelNum, nodeData.isSubCard);
                const width = calculateNodeWidth(nodeInfo, levelNum, nodeData.isSubCard);
                
                nodeSizes[nodeId] = { width, height };
            });
            
            // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –ø–æ —É—Ä–æ–≤–Ω—è–º —Å–ª–µ–≤–∞ –Ω–∞–ø—Ä–∞–≤–æ
            Object.keys(nodesByLevel).sort((a, b) => parseInt(a) - parseInt(b)).forEach(level => {
                const nodes = nodesByLevel[level];
                const levelNum = parseInt(level);
                
                // –†–∞–∑–¥–µ–ª—è–µ–º –Ω–∞ –æ—Å–Ω–æ–≤–Ω—ã–µ –Ω–æ–¥—ã –∏ –ø–æ–¥–∫–∞—Ä—Ç–æ—á–∫–∏
                const rootNodes = nodes.filter(n => !n.isSubCard);
                const subCardsByParent = {};
                
                nodes.forEach(node => {
                    if (node.isSubCard && node.parent) {
                        if (!subCardsByParent[node.parent]) {
                            subCardsByParent[node.parent] = [];
                        }
                        subCardsByParent[node.parent].push(node);
                    }
                });
                
                // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –Ω–æ–¥—ã
                let currentY = startY;
                rootNodes.forEach((nodeData) => {
                    const nodeId = nodeData.id;
                    const nodeInfo = getNodeInfo(nodeId);
                    const size = nodeSizes[nodeId];
                    const x = startX + (levelNum * levelSpacing);
                    
                    logicMap[nodeId] = {
                        ...nodeInfo,
                        x: x,
                        y: currentY,
                        width: size.width,
                        height: size.height,
                        level: levelNum,
                        isSubCard: false
                    };
                    
                    // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –ø–æ–¥–∫–∞—Ä—Ç–æ—á–∫–∏ —Å–ø—Ä–∞–≤–∞ –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è
                    if (subCardsByParent[nodeId]) {
                        const subCardX = x + size.width + subCardSpacing;
                        let subCardY = currentY;
                        
                        subCardsByParent[nodeId].forEach((subCard) => {
                            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ subCard –Ω–∞–ø—Ä—è–º—É—é (–æ–Ω–∏ —É–∂–µ —Å–æ–¥–µ—Ä–∂–∞—Ç –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é)
                            const subCardSize = nodeSizes[subCard.id];
                            
                            logicMap[subCard.id] = {
                                id: subCard.id,
                                type: subCard.type || 'subcard',
                                name: subCard.name || subCard.id,
                                icon: subCard.icon || 'üìÑ',
                                path: subCard.path || `${parentInfo.path}::${subCard.id}`,
                                structure: subCard.structure,
                                description: subCard.description,
                                calls: subCard.calls,
                                reads: subCard.reads,
                                writes: subCard.writes,
                                uiType: subCard.uiType,
                                content: subCard.content,
                                readBy: subCard.readBy,
                                writtenBy: subCard.writtenBy,
                                x: subCardX,
                                y: subCardY,
                                width: subCardSize.width,
                                height: subCardSize.height,
                                level: levelNum, // –ù–∞ —Ç–æ–º –∂–µ —É—Ä–æ–≤–Ω–µ, –Ω–æ —Å–ø—Ä–∞–≤–∞
                                isSubCard: true,
                                parent: nodeId
                            };
                            
                            console.log('üìç Positioned subcard:', subCard.id, 'at', subCardX, subCardY, 'for parent:', nodeId, 'size:', subCardSize);
                            
                            subCardY += subCardSize.height + nodeSpacing;
                        });
                    }
                    
                    currentY += size.height + nodeSpacing;
                });
            });
            
            const subcards = Object.values(logicMap).filter(n => n.isSubCard);
            console.log('üó∫Ô∏è LogicMap created with', Object.keys(logicMap).length, 'total nodes');
            console.log('üì¶ Subcards:', subcards.length, subcards.map(n => ({id: n.id, parent: n.parent, x: n.x, y: n.y})));
            
            return logicMap;
        }
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–¥–∫–∞—Ä—Ç–æ—á–∫–µ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞–∫ –≤ preview)
        function getSubCardInfo(subCardId, parentId, parentData) {
            const parentInfo = getNodeInfo(parentId);
            
            // Atoms –¥–ª—è appState
            if (subCardId.startsWith('atom-')) {
                const atomName = subCardId.replace('atom-', '');
                console.log('üîç Looking for atom:', atomName, 'in parent:', parentId);
                console.log('üìã Available atoms:', parentInfo.atoms?.map(a => a.name) || 'none');
                const atom = parentInfo.atoms?.find(a => a.name === atomName);
                if (atom) {
                    console.log('‚úÖ Found atom:', atom.name, 'with structure:', atom.structure);
                    return {
                        id: subCardId,
                        type: 'atom',
                        name: atom.name,
                        icon: 'üíæ',
                        path: `${parentInfo.path}::${atom.name}`,
                        structure: atom.structure,
                        readBy: atom.readBy || [],
                        writtenBy: atom.writtenBy || []
                    };
                } else {
                    console.error('‚ùå Atom not found!', atomName, 'Available:', parentInfo.atoms?.map(a => a.name));
                }
            }
            
            // Functions –¥–ª—è services - –∏—â–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
            if (subCardId.startsWith('func-')) {
                const funcNameFromId = subCardId.replace('func-', '');
                // –ò—â–µ–º —Ñ—É–Ω–∫—Ü–∏—é - –ø—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
                let func = null;
                if (parentInfo.functions) {
                    // –ü—Ä—è–º–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
                    func = parentInfo.functions.find(f => f.name === funcNameFromId);
                    // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, –ø—Ä–æ–±—É–µ–º —Å –∑–∞–º–µ–Ω–æ–π –¥–µ—Ñ–∏—Å–æ–≤
                    if (!func) {
                        func = parentInfo.functions.find(f => {
                            const fNameNormalized = f.name.replace(/_/g, '-');
                            return fNameNormalized === funcNameFromId;
                        });
                    }
                }
                if (func) {
                    return {
                        id: subCardId,
                        type: 'function',
                        name: func.name,
                        icon: '‚ö°',
                        path: `${parentInfo.path}::${func.name}`,
                        description: func.description,
                        calls: func.calls || [],
                        reads: func.reads || [],
                        writes: func.writes || []
                    };
                }
            }
            
            // UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–ª—è screens
            if (subCardId.includes('-ui-')) {
                const parts = subCardId.split('-ui-');
                const uiKey = parts[1].replace(/-/g, ' '); // –ó–∞–º–µ–Ω—è–µ–º –¥–µ—Ñ–∏—Å—ã –Ω–∞ –ø—Ä–æ–±–µ–ª—ã
                const uiItem = parentInfo.ui?.structure?.[uiKey];
                if (uiItem) {
                    return {
                        id: subCardId,
                        type: 'ui-component',
                        name: uiKey,
                        icon: 'üé®',
                        path: `${parentInfo.path}::${uiKey}`,
                        uiType: uiItem.type,
                        content: uiItem
                    };
                }
            }
            
            return null;
        }

        function calculateNodeHeight(nodeInfo, level, isSubCard = false) {
            if (isSubCard) {
                // –ü–æ–¥–∫–∞—Ä—Ç–æ—á–∫–∏ –∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ
                let height = 60; // –±–∞–∑–æ–≤–∞—è –≤—ã—Å–æ—Ç–∞
                
                if (nodeInfo.structure) {
                    height += 20 + Object.keys(nodeInfo.structure).length * 14;
                }
                if (nodeInfo.description) {
                    height += 16;
                }
                if (nodeInfo.calls && nodeInfo.calls.length > 0) {
                    height += 16;
                }
                if (nodeInfo.uiType) {
                    height += 20;
                }
                
                return Math.max(80, height);
            }
            
            // –û—Å–Ω–æ–≤–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ - —Ç–æ–ª—å–∫–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –ø—É—Ç—å, –±–µ–∑ –¥–µ—Ç–∞–ª–µ–π (–¥–µ—Ç–∞–ª–∏ –≤ –ø–æ–¥–∫–∞—Ä—Ç–æ—á–∫–∞—Ö)
            let height = 70; // –±–∞–∑–æ–≤–∞—è –≤—ã—Å–æ—Ç–∞ —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∫—Ä–∞—Ç–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–µ
            if (nodeInfo.atoms) {
                height += 20; // –ø—Ä–æ—Å—Ç–æ —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
            }
            if (nodeInfo.functions) {
                height += 20; // –ø—Ä–æ—Å—Ç–æ —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
            }
            if (nodeInfo.ui && nodeInfo.ui.structure) {
                height += 20; // –ø—Ä–æ—Å—Ç–æ —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
            }
            
            height += 20; // –æ—Ç—Å—Ç—É–ø—ã
            return Math.max(100, height);
        }
        
        function calculateNodeWidth(nodeInfo, level, isSubCard = false) {
            if (isSubCard) {
                // –ü–æ–¥–∫–∞—Ä—Ç–æ—á–∫–∏ —É–∂–µ
                let contentWidth = 250;
                const nameWidth = (nodeInfo.name || '').length * (12 - level);
                contentWidth = Math.max(250, nameWidth + 100);
                return contentWidth;
            }
            
            // –û—Å–Ω–æ–≤–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏
            let contentWidth = 280;
            const nameWidth = (nodeInfo.name || '').length * (13 - level);
            const maxContentWidth = Math.max(
                nameWidth + 100,
                nodeInfo.path ? nodeInfo.path.length * 7 : 0
            );
            contentWidth = Math.max(280, maxContentWidth);
            return contentWidth;
        }

        function getNodeInfo(nodeId) {
            if (!projectData || !projectData.nodes) {
                console.warn('Project data not loaded yet');
                return {};
            }
            return projectData.nodes[nodeId] || {};
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã –∫–∞–∫ JSON –¥–µ—Ä–µ–≤–∞
        const logicMap = positionJSONTree();

        let scale = 1;
        let translateX = 0;
        let translateY = 0;
        let draggedNode = null;
        let hoveredNode = null;

        const svg = document.getElementById('mapSvg');
        const nodesGroup = document.getElementById('nodes');
        const connectionsGroup = document.getElementById('connections');
        const previewPanel = document.getElementById('previewPanel');

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π - –∫—Ä–∏–≤—ã–µ –ª–∏–Ω–∏–∏ –¥–ª—è –≤—Å–µ—Ö –≤—ã–∑–æ–≤–æ–≤
        function renderConnections() {
            connectionsGroup.innerHTML = '';
            
            Object.values(logicMap).forEach(node => {
                if (node.functions) {
                    node.functions.forEach(func => {
                        if (func.calls) {
                            func.calls.forEach(call => {
                                const target = logicMap[call.target];
                                if (target) {
                                    const path = createCurvedPath(node, target, call.type);
                                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                                    line.setAttribute('d', path);
                                    line.setAttribute('class', `connection-line connection-${call.type}`);
                                    
                                    // –†–∞–∑–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤
                                    if (call.type === 'call') {
                                        line.setAttribute('marker-end', 'url(#arrowhead-call)');
                                    } else if (call.type === 'read') {
                                        line.setAttribute('marker-end', 'url(#arrowhead-read)');
                                    } else if (call.type === 'write') {
                                        line.setAttribute('marker-end', 'url(#arrowhead-write)');
                                    } else if (call.type === 'service') {
                                        line.setAttribute('marker-end', 'url(#arrowhead-service)');
                                    } else {
                                        line.setAttribute('marker-end', 'url(#arrowhead)');
                                    }
                                    
                                    connectionsGroup.appendChild(line);
                                }
                            });
                        }
                        if (func.reads) {
                            func.reads.forEach(read => {
                                const target = logicMap[read.target];
                                if (target) {
                                    const path = createCurvedPath(node, target, 'read');
                                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                                    line.setAttribute('d', path);
                                    line.setAttribute('class', 'connection-line connection-read');
                                    line.setAttribute('marker-end', 'url(#arrowhead-read)');
                                    connectionsGroup.appendChild(line);
                                }
                            });
                        }
                        if (func.writes) {
                            func.writes.forEach(write => {
                                const target = logicMap[write.target];
                                if (target) {
                                    const path = createCurvedPath(node, target, 'write');
                                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                                    line.setAttribute('d', path);
                                    line.setAttribute('class', 'connection-line connection-write');
                                    line.setAttribute('marker-end', 'url(#arrowhead-write)');
                                    connectionsGroup.appendChild(line);
                                }
                            });
                        }
                    });
                }
            });
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∫—Ä–∏–≤–æ–π –ª–∏–Ω–∏–∏
        function createCurvedPath(from, to, type) {
            const x1 = from.x + from.width / 2;
            const y1 = from.y + from.height;
            const x2 = to.x + to.width / 2;
            const y2 = to.y;
            
            const dx = x2 - x1;
            const dy = y2 - y1;
            const midY = (y1 + y2) / 2;
            
            // –ö—Ä–∏–≤–∞—è –ë–µ–∑—å–µ
            const cp1x = x1 + dx * 0.5;
            const cp1y = y1;
            const cp2x = x2 - dx * 0.5;
            const cp2y = y2;
            
            return `M ${x1} ${y1} C ${cp1x} ${cp1y}, ${cp2x} ${cp2y}, ${x2} ${y2}`;
        }

        // –ü–æ–¥—Å—á–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–æ—á–µ—Ä–Ω–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ —à—Ä–∏—Ñ—Ç–∞
        function countChildren(nodeId, logicMap, tree) {
            let count = 0;
            const node = tree[nodeId];
            if (node) {
                // –°—á–∏—Ç–∞–µ–º children
                if (node.children) count += node.children.length;
                // –°—á–∏—Ç–∞–µ–º subCards
                if (node.subCards) count += node.subCards.length;
            }
            return count;
        }
        
        // –†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –ø–æ–¥—Å—á–µ—Ç –≤—Å–µ—Ö –ø–æ—Ç–æ–º–∫–æ–≤
        function countAllDescendants(nodeId, tree, visited = new Set()) {
            if (visited.has(nodeId)) return 0;
            visited.add(nodeId);
            
            let count = 0;
            const node = tree[nodeId];
            if (node) {
                if (node.children) {
                    count += node.children.length;
                    node.children.forEach(childId => {
                        count += countAllDescendants(childId, tree, visited);
                    });
                }
                if (node.subCards) {
                    count += node.subCards.length;
                }
            }
            return count;
        }
        
        // –û–±—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω–æ–≥–æ —Ñ–æ–Ω–∞ –¥–ª—è –∫–ª—é—á–∞
        function createKeyBackground(x, y, keyText, fontSize, color, iconOffset = 0) {
            const padding = fontSize < 10 ? 2 : 3;
            const keyWidth = fontSize * (keyText.length + 2) * 0.6;
            const keyHeight = fontSize * 1.2;
            
            const bg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            bg.setAttribute('x', x + iconOffset - padding);
            bg.setAttribute('y', y - fontSize * 0.85);
            bg.setAttribute('width', keyWidth + padding * 2);
            bg.setAttribute('height', keyHeight);
            bg.setAttribute('rx', fontSize < 10 ? 3 : 4);
            bg.setAttribute('ry', fontSize < 10 ? 3 : 4);
            bg.setAttribute('fill', color);
            bg.setAttribute('fill-opacity', '0.15');
            
            return bg;
        }
        
        // –û–±—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω–æ–≥–æ —Ñ–æ–Ω–∞ –¥–ª—è –∫–ª—é—á: –∑–Ω–∞—á–µ–Ω–∏–µ
        function createKeyValueBackground(x, y, keyText, valueText, fontSize, color, iconOffset = 0) {
            const padding = fontSize < 10 ? 2 : 3;
            const keyWidth = fontSize * (keyText.length + 2) * 0.6;
            const valueWidth = fontSize * (valueText.length + 2) * 0.6;
            const totalWidth = keyWidth + fontSize * 2 + valueWidth; // –∫–ª—é—á + ": " + –∑–Ω–∞—á–µ–Ω–∏–µ
            const keyHeight = fontSize * 1.2;
            
            const bg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            bg.setAttribute('x', x + iconOffset - padding);
            bg.setAttribute('y', y - fontSize * 0.85);
            bg.setAttribute('width', totalWidth + padding * 2);
            bg.setAttribute('height', keyHeight);
            bg.setAttribute('rx', fontSize < 10 ? 3 : 4);
            bg.setAttribute('ry', fontSize < 10 ? 3 : 4);
            bg.setAttribute('fill', color);
            bg.setAttribute('fill-opacity', '0.15');
            
            return bg;
        }
        
        // –û–±—â–∏–µ —Ü–≤–µ—Ç–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∫–ª—é—á–µ–π
        const keyColors = {
            'main': '#ffffff',
            'nested': '#9cdcfe',
            'ui': '#4ec9b0',
            'value': '#ce9178',
            'state': '#c586c0',
            'action': '#dcdcaa'
        };
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —Å—Ç–µ–π—Ç–æ–≤ –¥–ª—è UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
        function getUsedStatesForUI(uiName, screenId, screenInfo) {
            if (!projectData || !projectData.uiStateMapping) {
                return [];
            }
            
            if (projectData.uiStateMapping[screenId] && projectData.uiStateMapping[screenId][uiName]) {
                return projectData.uiStateMapping[screenId][uiName];
            }
            
            // –ï—Å–ª–∏ –Ω–µ—Ç —è–≤–Ω–æ–≥–æ –º–∞–ø–ø–∏–Ω–≥–∞, –±–µ—Ä–µ–º –∏–∑ reads —Ñ—É–Ω–∫—Ü–∏–π screen
            if (screenInfo.functions) {
                const allReads = [];
                screenInfo.functions.forEach(func => {
                    if (func.reads) {
                        func.reads.forEach(read => {
                            if (read.atom && !allReads.includes(read.atom)) {
                                allReads.push(read.atom);
                            }
                        });
                    }
                });
                return allReads;
            }
            
            return [];
        }
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—ã–∑—ã–≤–∞–µ–º—ã—Ö —ç–∫—à–µ–Ω–æ–≤ –¥–ª—è UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
        function getUsedActionsForUI(uiName, screenId, screenInfo) {
            if (!projectData || !projectData.uiActionMapping) {
                return [];
            }
            
            if (projectData.uiActionMapping[screenId] && projectData.uiActionMapping[screenId][uiName]) {
                return projectData.uiActionMapping[screenId][uiName];
            }
            
            // –ï—Å–ª–∏ –Ω–µ—Ç —è–≤–Ω–æ–≥–æ –º–∞–ø–ø–∏–Ω–≥–∞, –±–µ—Ä–µ–º –∏–∑ calls —Ñ—É–Ω–∫—Ü–∏–π screen
            if (screenInfo.functions) {
                const allActions = [];
                screenInfo.functions.forEach(func => {
                    if (func.calls) {
                        func.calls.forEach(call => {
                            const actionName = call.target === 'bluetooth' || call.target === 'api' 
                                ? `${call.target}.${call.func || 'unknown'}` 
                                : call.target;
                            if (!allActions.includes(actionName)) {
                                allActions.push(actionName);
                            }
                        });
                    }
                });
                return allActions;
            }
            
            return [];
        }
        
        // –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ JSON —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
        function renderJSONStructure(data, x, y, level = 0) {
            if (!data || typeof data !== 'object') {
                return y;
            }
            
            const indentSize = 30;
            const baseFontSize = 14;
            const maxFontSize = 32;
            
            // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ç–æ–º–∫–æ–≤ –¥–ª—è —Ä–∞–∑–º–µ—Ä–∞ —à—Ä–∏—Ñ—Ç–∞
            const countDescendants = (obj) => {
                if (!obj || typeof obj !== 'object') return 0;
                let count = Object.keys(obj).length;
                for (const key in obj) {
                    count += countDescendants(obj[key]);
                }
                return count;
            };
            
            const descendantsCount = countDescendants(data);
            const fontSize = Math.min(baseFontSize + descendantsCount * 0.8, maxFontSize);
            
            const keys = Object.keys(data);
            
            keys.forEach((key, idx) => {
                const value = data[key];
                const isLast = idx === keys.length - 1;
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–º (–∏–º–µ–µ—Ç –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç—å)
                const hasChildren = value && typeof value === 'object' && Object.keys(value).length > 0;
                
                // –í—ã—á–∏—Å–ª—è–µ–º —à–∏—Ä–∏–Ω—É —Ç–µ–∫—Å—Ç–∞ –¥–ª—è —Ñ–æ–Ω–∞
                const keyTextWidth = fontSize * (key.length + 2) * 0.6;
                const keyTextHeight = fontSize * 1.2;
                const padding = 4;
                
                // –°–æ–∑–¥–∞–µ–º –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω –¥–ª—è –∫–ª—é—á–∞
                const keyBg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                keyBg.setAttribute('x', x - padding);
                keyBg.setAttribute('y', y - fontSize * 0.85);
                keyBg.setAttribute('width', keyTextWidth + padding * 2);
                keyBg.setAttribute('height', keyTextHeight);
                keyBg.setAttribute('rx', '4');
                keyBg.setAttribute('ry', '4');
                keyBg.setAttribute('fill', '#ffffff');
                keyBg.setAttribute('fill-opacity', '0.15');
                nodesGroup.appendChild(keyBg);
                
                // –†–∏—Å—É–µ–º –∫–ª—é—á
                const keyText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                keyText.setAttribute('x', x);
                keyText.setAttribute('y', y);
                keyText.setAttribute('font-size', fontSize);
                keyText.setAttribute('font-weight', 'bold');
                keyText.setAttribute('fill', '#ffffff');
                keyText.setAttribute('font-family', 'monospace');
                keyText.textContent = `"${key}"`;
                nodesGroup.appendChild(keyText);
                
                // –î–≤–æ–µ—Ç–æ—á–∏–µ
                const colon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                colon.setAttribute('x', x + fontSize * (key.length + 2) * 0.6);
                colon.setAttribute('y', y);
                colon.setAttribute('font-size', fontSize);
                colon.setAttribute('fill', '#858585');
                colon.setAttribute('font-family', 'monospace');
                colon.textContent = hasChildren ? ': {' : ': {}';
                nodesGroup.appendChild(colon);
                
                y += fontSize * 1.5;
                
                // –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ —Ä–µ–Ω–¥–µ—Ä–∏–º –¥–æ—á–µ—Ä–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã
                if (hasChildren) {
                    y = renderJSONStructure(value, x + indentSize, y, level + 1);
                    
                    // –ó–∞–∫—Ä—ã–≤–∞—é—â–∞—è —Å–∫–æ–±–∫–∞
                    const closeBrace = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    closeBrace.setAttribute('x', x);
                    closeBrace.setAttribute('y', y);
                    closeBrace.setAttribute('font-size', fontSize);
                    closeBrace.setAttribute('fill', '#858585');
                    closeBrace.setAttribute('font-family', 'monospace');
                    closeBrace.textContent = '}';
                    nodesGroup.appendChild(closeBrace);
                    
                    y += fontSize * 1.2;
                }
                
                // –ó–∞–ø—è—Ç–∞—è (–µ—Å–ª–∏ –Ω–µ –ø–æ—Å–ª–µ–¥–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç)
                if (!isLast) {
                    const comma = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    comma.setAttribute('x', x - 10);
                    comma.setAttribute('y', y - fontSize * 0.3);
                    comma.setAttribute('font-size', fontSize);
                    comma.setAttribute('fill', '#858585');
                    comma.setAttribute('font-family', 'monospace');
                    comma.textContent = ',';
                    nodesGroup.appendChild(comma);
                }
            });
            
            return y;
        }
        
        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ JSON –¥–µ—Ä–µ–≤–∞ —Ç–µ–∫—Å—Ç–æ–º
        function renderNodes() {
            if (!nodesGroup) {
                console.warn('nodesGroup not found');
                return;
            }
            
            nodesGroup.innerHTML = '';
            
            if (!projectData) {
                console.warn('Project data not loaded');
                return;
            }
            
            console.log('üå≥ Rendering project data:', projectData);
            
            let yPos = 50;
            const startX = 50;
            
            // –ü—Ä–æ—Å—Ç–æ —Ä–µ–Ω–¥–µ—Ä–∏–º –≤—Å—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ
            const finalY = renderJSONStructure(projectData, startX, yPos, 0);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä SVG
            updateSVGSize(finalY);
        }
        
        // –£—Å—Ç–∞—Ä–µ–≤—à–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–æ—Å—Ç–∞–≤–ª—è–µ–º –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º)
        function renderJSONNode(nodeId, x, y, level, parentData = null) {
                console.log('üé® Rendering node:', nodeId, 'at', x, y);
                const nodeInfo = getNodeInfo(nodeId);
                const treeNode = tree[nodeId];
                if (!treeNode) {
                    console.warn('TreeNode not found:', nodeId);
                    return y;
                }
                
                // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ç–æ–º–∫–æ–≤ –¥–ª—è —Ä–∞–∑–º–µ—Ä–∞ —à—Ä–∏—Ñ—Ç–∞
                const descendantsCount = countAllDescendants(nodeId, tree);
                const fontSize = Math.min(baseFontSize + descendantsCount * 1.2, maxFontSize);
                
                // –ü–æ–ª—É—á–∞–µ–º –∏–º—è –∏ —Ç–∏–ø
                let displayName = nodeInfo.name || nodeId;
                let displayType = nodeInfo.type || 'node';
                
                // –í—ã—á–∏—Å–ª—è–µ–º —à–∏—Ä–∏–Ω—É —Ç–µ–∫—Å—Ç–∞ –¥–ª—è —Ñ–æ–Ω–∞
                const keyTextWidth = fontSize * (displayName.length + 2) * 0.6;
                const keyTextHeight = fontSize * 1.2;
                const padding = 4;
                
                // –°–æ–∑–¥–∞–µ–º –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω –¥–ª—è –∫–ª—é—á–∞
                const keyBg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                keyBg.setAttribute('x', x - padding);
                keyBg.setAttribute('y', y - fontSize * 0.85);
                keyBg.setAttribute('width', keyTextWidth + padding * 2);
                keyBg.setAttribute('height', keyTextHeight);
                keyBg.setAttribute('rx', '4');
                keyBg.setAttribute('ry', '4');
                keyBg.setAttribute('fill', '#ffffff');
                keyBg.setAttribute('fill-opacity', '0.15');
                nodesGroup.appendChild(keyBg);
                
                // –†–∏—Å—É–µ–º –∫–ª—é—á (–∏–º—è –Ω–æ–¥—ã) - —Ä–∞–∑–º–µ—Ä –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ—Ç–æ–º–∫–æ–≤
                const keyText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                keyText.setAttribute('x', x);
                keyText.setAttribute('y', y);
                keyText.setAttribute('font-size', fontSize);
                keyText.setAttribute('font-weight', 'bold');
                keyText.setAttribute('fill', '#ffffff');
                keyText.setAttribute('font-family', 'monospace');
                keyText.textContent = `"${displayName}"`;
                nodesGroup.appendChild(keyText);
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å –¥–æ—á–µ—Ä–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã, —Ä–∏—Å—É–µ–º –¥–≤–æ–µ—Ç–æ—á–∏–µ –∏ –æ—Ç–∫—Ä—ã–≤–∞—é—â—É—é —Å–∫–æ–±–∫—É
                // –î–ª—è –Ω–æ–¥ —Å ui.structure –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ–º UI subCards (–æ–Ω–∏ —É–∂–µ –≤ ui.structure)
                const hasUIStructure = nodeInfo.ui && nodeInfo.ui.structure;
                const uiSubCardPrefix = nodeId + '-ui-';
                const nonUISubCards = hasUIStructure 
                    ? (treeNode.subCards || []).filter(subCardId => !subCardId.startsWith(uiSubCardPrefix))
                    : (treeNode.subCards || []);
                const hasChildren = (treeNode.children && treeNode.children.length > 0) || 
                                   (nonUISubCards && nonUISubCards.length > 0) ||
                                   (hasUIStructure && Object.keys(nodeInfo.ui.structure).length > 0);
                
                if (hasChildren) {
                    const colon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    colon.setAttribute('x', x + fontSize * (displayName.length + 2) * 0.6);
                    colon.setAttribute('y', y);
                    colon.setAttribute('font-size', fontSize);
                    colon.setAttribute('fill', '#858585');
                    colon.setAttribute('font-family', 'monospace');
                    colon.textContent = ': {';
                    nodesGroup.appendChild(colon);
                    
                    y += fontSize * 1.5;
                    
                    // –†–∏—Å—É–µ–º children —Å –¥–µ—Ç–∞–ª—è–º–∏
                    if (treeNode.children && treeNode.children.length > 0) {
                        treeNode.children.forEach((childId, idx) => {
                            y = renderJSONNode(childId, x + indentSize, y, level + 1, nodeInfo);
                            
                            // –î–æ–±–∞–≤–ª—è–µ–º –¥–µ—Ç–∞–ª–∏ –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö –Ω–æ–¥ (UI, functions, atoms)
                            const childInfo = getNodeInfo(childId);
                            
                            // –î–ª—è screens - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º UI —Å—Ç—Ä—É–∫—Ç—É—Ä—É (–Ω–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∞ –µ—â–µ –Ω–µ –±—ã–ª–∞ –ø–æ–∫–∞–∑–∞–Ω–∞ –≤—ã—à–µ –¥–ª—è —Å–∞–º–æ–π –Ω–æ–¥—ã)
                            // UI —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —É–∂–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ renderJSONNode –¥–ª—è —Å–∞–º–æ–π –Ω–æ–¥—ã, –ø–æ—ç—Ç–æ–º—É –∑–¥–µ—Å—å –Ω–µ –¥—É–±–ª–∏—Ä—É–µ–º
                            if (false && childInfo.ui && childInfo.ui.structure) {
                                // –ò–∫–æ–Ω–∫–∞ –¥–ª—è ui
                                const uiIcon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                                uiIcon.setAttribute('x', x + indentSize * 2);
                                uiIcon.setAttribute('y', y);
                                uiIcon.setAttribute('font-size', fontSize * 0.7);
                                uiIcon.setAttribute('font-family', 'monospace');
                                uiIcon.textContent = 'üé®';
                                nodesGroup.appendChild(uiIcon);
                                
                                // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã –¥–ª—è —Ñ–æ–Ω–∞ ui
                                const uiKeyWidth = fontSize * 0.7 * 4 * 0.5;
                                const uiKeyHeight = fontSize * 0.7 * 1.2;
                                const uiKeyPadding = 2;
                                
                                // –°–æ–∑–¥–∞–µ–º –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω –¥–ª—è ui
                                const uiKeyBg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                                uiKeyBg.setAttribute('x', x + indentSize * 2 + fontSize * 1.0 - uiKeyPadding);
                                uiKeyBg.setAttribute('y', y - fontSize * 0.7 * 0.85);
                                uiKeyBg.setAttribute('width', uiKeyWidth + uiKeyPadding * 2);
                                uiKeyBg.setAttribute('height', uiKeyHeight);
                                uiKeyBg.setAttribute('rx', '3');
                                uiKeyBg.setAttribute('ry', '3');
                                uiKeyBg.setAttribute('fill', '#9cdcfe');
                                uiKeyBg.setAttribute('fill-opacity', '0.15');
                                nodesGroup.appendChild(uiKeyBg);
                                
                                const uiKey = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                                uiKey.setAttribute('x', x + indentSize * 2 + fontSize * 1.0);
                                uiKey.setAttribute('y', y);
                                uiKey.setAttribute('font-size', fontSize * 0.7);
                                uiKey.setAttribute('fill', '#9cdcfe');
                                uiKey.setAttribute('font-family', 'monospace');
                                uiKey.textContent = '"ui"';
                                nodesGroup.appendChild(uiKey);
                                
                                const uiColon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                                uiColon.setAttribute('x', x + indentSize * 2 + fontSize * 1.0 + uiKeyWidth);
                                uiColon.setAttribute('y', y);
                                uiColon.setAttribute('font-size', fontSize * 0.7);
                                uiColon.setAttribute('fill', '#858585');
                                uiColon.setAttribute('font-family', 'monospace');
                                uiColon.textContent = ': {';
                                nodesGroup.appendChild(uiColon);
                                
                                y += fontSize * 1.0;
                                
                                Object.entries(childInfo.ui.structure).forEach(([uiName, uiData], uiIdx) => {
                                    // –ö–ª—é—á UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
                                    const uiItemKey = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                                    uiItemKey.setAttribute('x', x + indentSize * 3);
                                    uiItemKey.setAttribute('y', y);
                                    uiItemKey.setAttribute('font-size', fontSize * 0.65);
                                    uiItemKey.setAttribute('font-weight', 'bold');
                                    uiItemKey.setAttribute('fill', '#4ec9b0');
                                    uiItemKey.setAttribute('font-family', 'monospace');
                                    uiItemKey.textContent = `"${uiName}"`;
                                    nodesGroup.appendChild(uiItemKey);
                                    
                                    const uiItemColon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                                    uiItemColon.setAttribute('x', x + indentSize * 3 + fontSize * (uiName.length + 2) * 0.4);
                                    uiItemColon.setAttribute('y', y);
                                    uiItemColon.setAttribute('font-size', fontSize * 0.65);
                                    uiItemColon.setAttribute('fill', '#858585');
                                    uiItemColon.setAttribute('font-family', 'monospace');
                                    uiItemColon.textContent = ': {';
                                    nodesGroup.appendChild(uiItemColon);
                                    
                                    y += fontSize * 0.9;
                                    
                                    // –¢–∏–ø –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
                                    const uiType = typeof uiData === 'object' ? (uiData.type || 'object') : uiData;
                                    // –ò–∫–æ–Ω–∫–∞ –¥–ª—è type
                                    const typeIcon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                                    typeIcon.setAttribute('x', x + indentSize * 4);
                                    typeIcon.setAttribute('y', y);
                                    typeIcon.setAttribute('font-size', fontSize * 0.6);
                                    typeIcon.setAttribute('font-family', 'monospace');
                                    typeIcon.textContent = 'üè∑Ô∏è';
                                    nodesGroup.appendChild(typeIcon);
                                    
                                    const typeKey = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                                    typeKey.setAttribute('x', x + indentSize * 4 + fontSize * 1.0);
                                    typeKey.setAttribute('y', y);
                                    typeKey.setAttribute('font-size', fontSize * 0.6);
                                    typeKey.setAttribute('fill', '#9cdcfe');
                                    typeKey.setAttribute('font-family', 'monospace');
                                    typeKey.textContent = '"type"';
                                    nodesGroup.appendChild(typeKey);
                                    
                                    const typeColon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                                    typeColon.setAttribute('x', x + indentSize * 4 + fontSize * 6 * 0.35);
                                    typeColon.setAttribute('y', y);
                                    typeColon.setAttribute('font-size', fontSize * 0.6);
                                    typeColon.setAttribute('fill', '#858585');
                                    typeColon.setAttribute('font-family', 'monospace');
                                    typeColon.textContent = ': ';
                                    nodesGroup.appendChild(typeColon);
                                    
                                    const typeVal = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                                    typeVal.setAttribute('x', x + indentSize * 4 + fontSize * 8 * 0.35);
                                    typeVal.setAttribute('y', y);
                                    typeVal.setAttribute('font-size', fontSize * 0.6);
                                    typeVal.setAttribute('fill', '#ce9178');
                                    typeVal.setAttribute('font-family', 'monospace');
                                    typeVal.textContent = `"${uiType}"`;
                                    nodesGroup.appendChild(typeVal);
                                    y += fontSize * 0.8;
                                    
                                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Å—Ç–µ–π—Ç—ã –¥–ª—è —ç—Ç–æ–≥–æ UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
                                    const usedStates = getUsedStatesForUI(uiName, childId, childInfo);
                                    if (usedStates && usedStates.length > 0) {
                                        // –ò–∫–æ–Ω–∫–∞ –¥–ª—è states
                                        const statesIcon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                                        statesIcon.setAttribute('x', x + indentSize * 4);
                                        statesIcon.setAttribute('y', y);
                                        statesIcon.setAttribute('font-size', fontSize * 0.6);
                                        statesIcon.setAttribute('font-family', 'monospace');
                                        statesIcon.textContent = 'üíæ';
                                        nodesGroup.appendChild(statesIcon);
                                        
                                        const statesKey = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                                        statesKey.setAttribute('x', x + indentSize * 4 + fontSize * 1.0);
                                        statesKey.setAttribute('y', y);
                                        statesKey.setAttribute('font-size', fontSize * 0.6);
                                        statesKey.setAttribute('fill', '#9cdcfe');
                                        statesKey.setAttribute('font-family', 'monospace');
                                        statesKey.textContent = '"states"';
                                        nodesGroup.appendChild(statesKey);
                                        
                                        const statesColon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                                        statesColon.setAttribute('x', x + indentSize * 4 + fontSize * 8 * 0.35);
                                        statesColon.setAttribute('y', y);
                                        statesColon.setAttribute('font-size', fontSize * 0.6);
                                        statesColon.setAttribute('fill', '#858585');
                                        statesColon.setAttribute('font-family', 'monospace');
                                        statesColon.textContent = ': [';
                                        nodesGroup.appendChild(statesColon);
                                        
                                        y += fontSize * 0.8;
                                        
                                        usedStates.forEach((state, stateIdx) => {
                                            const stateText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                                            stateText.setAttribute('x', x + indentSize * 5);
                                            stateText.setAttribute('y', y);
                                            stateText.setAttribute('font-size', fontSize * 0.55);
                                            stateText.setAttribute('fill', '#c586c0');
                                            stateText.setAttribute('font-family', 'monospace');
                                            stateText.textContent = `"${state}"`;
                                            nodesGroup.appendChild(stateText);
                                            
                                            if (stateIdx < usedStates.length - 1) {
                                                const stateComma = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                                                stateComma.setAttribute('x', x + indentSize * 5 - 8);
                                                stateComma.setAttribute('y', y);
                                                stateComma.setAttribute('font-size', fontSize * 0.55);
                                                stateComma.setAttribute('fill', '#858585');
                                                stateComma.setAttribute('font-family', 'monospace');
                                                stateComma.textContent = ',';
                                                nodesGroup.appendChild(stateComma);
                                            }
                                            
                                            y += fontSize * 0.7;
                                        });
                                        
                                        const statesClose = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                                        statesClose.setAttribute('x', x + indentSize * 4);
                                        statesClose.setAttribute('y', y);
                                        statesClose.setAttribute('font-size', fontSize * 0.6);
                                        statesClose.setAttribute('fill', '#858585');
                                        statesClose.setAttribute('font-family', 'monospace');
                                        statesClose.textContent = ']';
                                        nodesGroup.appendChild(statesClose);
                                        y += fontSize * 0.8;
                                    }
                                    
                                    // –í—ã–∑—ã–≤–∞–µ–º—ã–µ —ç–∫—à–µ–Ω—ã (API –∏ Bluetooth)
                                    const usedActions = getUsedActionsForUI(uiName, childId, childInfo);
                                    if (usedActions && usedActions.length > 0) {
                                        // –ò–∫–æ–Ω–∫–∞ –¥–ª—è actions
                                        const actionsIcon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                                        actionsIcon.setAttribute('x', x + indentSize * 4);
                                        actionsIcon.setAttribute('y', y);
                                        actionsIcon.setAttribute('font-size', fontSize * 0.6);
                                        actionsIcon.setAttribute('font-family', 'monospace');
                                        actionsIcon.textContent = '‚ö°';
                                        nodesGroup.appendChild(actionsIcon);
                                        
                                        // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã –¥–ª—è —Ñ–æ–Ω–∞ actions
                                        const actionsKeyWidth = fontSize * 0.6 * 9 * 0.35;
                                        const actionsKeyHeight = fontSize * 0.6 * 1.2;
                                        const actionsKeyPadding = 2;
                                        
                                        // –°–æ–∑–¥–∞–µ–º –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω –¥–ª—è actions
                                        const actionsKeyBg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                                        actionsKeyBg.setAttribute('x', x + indentSize * 4 + fontSize * 1.0 - actionsKeyPadding);
                                        actionsKeyBg.setAttribute('y', y - fontSize * 0.6 * 0.85);
                                        actionsKeyBg.setAttribute('width', actionsKeyWidth + actionsKeyPadding * 2);
                                        actionsKeyBg.setAttribute('height', actionsKeyHeight);
                                        actionsKeyBg.setAttribute('rx', '3');
                                        actionsKeyBg.setAttribute('ry', '3');
                                        actionsKeyBg.setAttribute('fill', '#9cdcfe');
                                        actionsKeyBg.setAttribute('fill-opacity', '0.15');
                                        nodesGroup.appendChild(actionsKeyBg);
                                        
                                        const actionsKey = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                                        actionsKey.setAttribute('x', x + indentSize * 4 + fontSize * 1.0);
                                        actionsKey.setAttribute('y', y);
                                        actionsKey.setAttribute('font-size', fontSize * 0.6);
                                        actionsKey.setAttribute('fill', '#9cdcfe');
                                        actionsKey.setAttribute('font-family', 'monospace');
                                        actionsKey.textContent = '"actions"';
                                        nodesGroup.appendChild(actionsKey);
                                        
                                        const actionsColon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                                        actionsColon.setAttribute('x', x + indentSize * 4 + fontSize * 1.0 + actionsKeyWidth);
                                        actionsColon.setAttribute('y', y);
                                        actionsColon.setAttribute('font-size', fontSize * 0.6);
                                        actionsColon.setAttribute('fill', '#858585');
                                        actionsColon.setAttribute('font-family', 'monospace');
                                        actionsColon.textContent = ': [';
                                        nodesGroup.appendChild(actionsColon);
                                        
                                        y += fontSize * 0.8;
                                        
                                        usedActions.forEach((action, actionIdx) => {
                                            const actionText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                                            actionText.setAttribute('x', x + indentSize * 5);
                                            actionText.setAttribute('y', y);
                                            actionText.setAttribute('font-size', fontSize * 0.55);
                                            actionText.setAttribute('fill', '#dcdcaa');
                                            actionText.setAttribute('font-family', 'monospace');
                                            actionText.textContent = `"${action}"`;
                                            nodesGroup.appendChild(actionText);
                                            
                                            if (actionIdx < usedActions.length - 1) {
                                                const actionComma = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                                                actionComma.setAttribute('x', x + indentSize * 5 - 8);
                                                actionComma.setAttribute('y', y);
                                                actionComma.setAttribute('font-size', fontSize * 0.55);
                                                actionComma.setAttribute('fill', '#858585');
                                                actionComma.setAttribute('font-family', 'monospace');
                                                actionComma.textContent = ',';
                                                nodesGroup.appendChild(actionComma);
                                            }
                                            
                                            y += fontSize * 0.7;
                                        });
                                        
                                        const actionsClose = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                                        actionsClose.setAttribute('x', x + indentSize * 4);
                                        actionsClose.setAttribute('y', y);
                                        actionsClose.setAttribute('font-size', fontSize * 0.6);
                                        actionsClose.setAttribute('fill', '#858585');
                                        actionsClose.setAttribute('font-family', 'monospace');
                                        actionsClose.textContent = ']';
                                        nodesGroup.appendChild(actionsClose);
                                        y += fontSize * 0.8;
                                    }
                                    
                                    // –ó–∞–∫—Ä—ã–≤–∞—é—â–∞—è —Å–∫–æ–±–∫–∞ –¥–ª—è UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
                                    const uiItemClose = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                                    uiItemClose.setAttribute('x', x + indentSize * 3);
                                    uiItemClose.setAttribute('y', y);
                                    uiItemClose.setAttribute('font-size', fontSize * 0.65);
                                    uiItemClose.setAttribute('fill', '#858585');
                                    uiItemClose.setAttribute('font-family', 'monospace');
                                    uiItemClose.textContent = '}';
                                    nodesGroup.appendChild(uiItemClose);
                                    
                                    if (uiIdx < Object.keys(childInfo.ui.structure).length - 1) {
                                        const uiComma = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                                        uiComma.setAttribute('x', x + indentSize * 3 - 10);
                                        uiComma.setAttribute('y', y);
                                        uiComma.setAttribute('font-size', fontSize * 0.65);
                                        uiComma.setAttribute('fill', '#858585');
                                        uiComma.setAttribute('font-family', 'monospace');
                                        uiComma.textContent = ',';
                                        nodesGroup.appendChild(uiComma);
                                    }
                                    
                                    y += fontSize * 0.9;
                                });
                                
                                const uiClose = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                                uiClose.setAttribute('x', x + indentSize * 2);
                                uiClose.setAttribute('y', y);
                                uiClose.setAttribute('font-size', fontSize * 0.7);
                                uiClose.setAttribute('fill', '#858585');
                                uiClose.setAttribute('font-family', 'monospace');
                                uiClose.textContent = '}';
                                nodesGroup.appendChild(uiClose);
                                y += fontSize * 1.0;
                            }
                            
                            // Functions —É–∂–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –≤ subCards, –ø–æ—ç—Ç–æ–º—É –∑–¥–µ—Å—å –Ω–µ –¥—É–±–ª–∏—Ä—É–µ–º
                            
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –µ—â–µ children –∏–ª–∏ nonUISubCards –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ child
                            const hasMoreChildren = idx < treeNode.children.length - 1;
                            const hasNonUISubCards = nonUISubCards && nonUISubCards.length > 0;
                            const hasUIStructure = childInfo.ui && childInfo.ui.structure;
                            
                            if (hasMoreChildren || hasNonUISubCards || hasUIStructure) {
                                const comma = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                                comma.setAttribute('x', x + indentSize - 15);
                                comma.setAttribute('y', y - fontSize * 0.3);
                                comma.setAttribute('font-size', fontSize * 0.7);
                                comma.setAttribute('fill', '#858585');
                                comma.setAttribute('font-family', 'monospace');
                                comma.textContent = ',';
                                nodesGroup.appendChild(comma);
                            }
                        });
                    }
                    
                    // –†–∏—Å—É–µ–º subCards —Å –¥–µ—Ç–∞–ª—è–º–∏
                    // –ù–û: –µ—Å–ª–∏ —É –Ω–æ–¥—ã –µ—Å—Ç—å ui.structure, —Ç–æ –Ω–µ —Ä–∏—Å—É–µ–º UI subCards (–æ–Ω–∏ —É–∂–µ –Ω–∞—Ä–∏—Å–æ–≤–∞–Ω—ã –≤ ui.structure)
                    const hasUIStructure = nodeInfo.ui && nodeInfo.ui.structure;
                    const uiSubCardPrefix = nodeId + '-ui-';
                    const nonUISubCards = hasUIStructure 
                        ? treeNode.subCards.filter(subCardId => !subCardId.startsWith(uiSubCardPrefix))
                        : (treeNode.subCards || []);
                    
                if (nonUISubCards && nonUISubCards.length > 0) {
                    nonUISubCards.forEach((subCardId, idx) => {
                        const subCardInfo = getSubCardInfo(subCardId, nodeId, treeNode);
                        if (subCardInfo) {
                            // –†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ –¥–ª—è –ø–æ–¥–∫–∞—Ä—Ç–æ—á–∫–∏ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è
                            const subFontSize = Math.max(baseFontSize * 0.7, fontSize * 0.65);
                            
                            // –ò–∫–æ–Ω–∫–∞ –¥–ª—è –ø–æ–¥–∫–∞—Ä—Ç–æ—á–∫–∏
                            const iconMap = {
                                'atom': 'üíæ',
                                'function': '‚ö°',
                                'ui-component': 'üé®'
                            };
                            const icon = iconMap[subCardInfo.type] || '';
                            
                            const iconOffset = icon ? subFontSize * 1.2 : 0;
                            
                            if (icon) {
                                const iconText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                                iconText.setAttribute('x', x + indentSize);
                                iconText.setAttribute('y', y);
                                iconText.setAttribute('font-size', subFontSize);
                                iconText.setAttribute('font-family', 'monospace');
                                iconText.textContent = icon;
                                nodesGroup.appendChild(iconText);
                            }
                            
                            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–æ–Ω–∞
                            const subKeyBg = createKeyBackground(
                                x + indentSize, 
                                y, 
                                subCardInfo.name, 
                                subFontSize, 
                                keyColors.main, 
                                iconOffset
                            );
                            nodesGroup.appendChild(subKeyBg);
                            
                            // –ö–ª—é—á –ø–æ–¥–∫–∞—Ä—Ç–æ—á–∫–∏ (—Å—Ç–∏–ª—å –∫–∞–∫ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º JSON)
                            const subCardKey = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                            subCardKey.setAttribute('x', x + indentSize + iconOffset);
                            subCardKey.setAttribute('y', y);
                            subCardKey.setAttribute('font-size', subFontSize);
                            subCardKey.setAttribute('font-weight', 'bold');
                            subCardKey.setAttribute('fill', keyColors.main);
                            subCardKey.setAttribute('font-family', 'monospace');
                            subCardKey.textContent = `"${subCardInfo.name}"`;
                            nodesGroup.appendChild(subCardKey);
                            
                            // –î–≤–æ–µ—Ç–æ—á–∏–µ
                            const subColon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                            subColon.setAttribute('x', x + indentSize + subFontSize * (subCardInfo.name.length + 2) * 0.6);
                            subColon.setAttribute('y', y);
                            subColon.setAttribute('font-size', subFontSize);
                            subColon.setAttribute('fill', '#858585');
                            subColon.setAttribute('font-family', 'monospace');
                            subColon.textContent = ': {';
                            nodesGroup.appendChild(subColon);
                            
                            y += subFontSize * 1.3;
                            
                            // –î–µ—Ç–∞–ª–∏ –¥–ª—è atom
                            if (subCardInfo.type === 'atom' && subCardInfo.structure) {
                                const structFontSize = subFontSize * 0.85; // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
                                
                                Object.entries(subCardInfo.structure).forEach(([key, val], structIdx) => {
                                    // –ò–∫–æ–Ω–∫–∞ –¥–ª—è –ø–æ–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
                                    const fieldIcon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                                    fieldIcon.setAttribute('x', x + indentSize * 2);
                                    fieldIcon.setAttribute('y', y);
                                    fieldIcon.setAttribute('font-size', structFontSize);
                                    fieldIcon.setAttribute('font-family', 'monospace');
                                    fieldIcon.textContent = 'üìã';
                                    nodesGroup.appendChild(fieldIcon);
                                    
                                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–æ–Ω–∞ –∫–ª—é—á: –∑–Ω–∞—á–µ–Ω–∏–µ
                                    const structBg = createKeyValueBackground(
                                        x + indentSize * 2 + subFontSize * 1.2,
                                        y,
                                        key,
                                        String(val),
                                        structFontSize,
                                        keyColors.nested,
                                        0
                                    );
                                    nodesGroup.appendChild(structBg);
                                    
                                    const structKey = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                                    structKey.setAttribute('x', x + indentSize * 2 + subFontSize * 1.2);
                                    structKey.setAttribute('y', y);
                                    structKey.setAttribute('font-size', structFontSize);
                                    structKey.setAttribute('fill', keyColors.nested);
                                    structKey.setAttribute('font-family', 'monospace');
                                    structKey.textContent = `"${key}"`;
                                    nodesGroup.appendChild(structKey);
                                    
                                    const structKeyWidth = structFontSize * (key.length + 2) * 0.6;
                                    const structColon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                                    structColon.setAttribute('x', x + indentSize * 2 + subFontSize * 1.2 + structKeyWidth);
                                    structColon.setAttribute('y', y);
                                    structColon.setAttribute('font-size', structFontSize);
                                    structColon.setAttribute('fill', '#858585');
                                    structColon.setAttribute('font-family', 'monospace');
                                    structColon.textContent = ': ';
                                    nodesGroup.appendChild(structColon);
                                    
                                    const structVal = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                                    structVal.setAttribute('x', x + indentSize * 2 + subFontSize * 1.2 + structKeyWidth + structFontSize * 2);
                                    structVal.setAttribute('y', y);
                                    structVal.setAttribute('font-size', structFontSize);
                                    structVal.setAttribute('fill', keyColors.value);
                                    structVal.setAttribute('font-family', 'monospace');
                                    structVal.textContent = `"${val}"`;
                                    nodesGroup.appendChild(structVal);
                                    
                                    if (structIdx < Object.keys(subCardInfo.structure).length - 1) {
                                        const structComma = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                                        structComma.setAttribute('x', x + indentSize * 2 - 10);
                                        structComma.setAttribute('y', y);
                                        structComma.setAttribute('font-size', structFontSize);
                                        structComma.setAttribute('fill', '#858585');
                                        structComma.setAttribute('font-family', 'monospace');
                                        structComma.textContent = ',';
                                        nodesGroup.appendChild(structComma);
                                    }
                                    
                                    y += structFontSize * 1.2;
                                });
                            }
                            
                            // –î–µ—Ç–∞–ª–∏ –¥–ª—è function
                            if (subCardInfo.type === 'function') {
                                if (subCardInfo.description) {
                                    // –ò–∫–æ–Ω–∫–∞ –¥–ª—è description
                                    const descIcon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                                    descIcon.setAttribute('x', x + indentSize * 2);
                                    descIcon.setAttribute('y', y);
                                    descIcon.setAttribute('font-size', subFontSize * 0.8);
                                    descIcon.setAttribute('font-family', 'monospace');
                                    descIcon.textContent = 'üìù';
                                    nodesGroup.appendChild(descIcon);
                                    
                                    const descFontSize = subFontSize * 0.85;
                                    const shortDesc = subCardInfo.description.length > 30 ? subCardInfo.description.substring(0, 27) + '...' : subCardInfo.description;
                                    
                                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–æ–Ω–∞
                                    const descBg = createKeyValueBackground(
                                        x + indentSize * 2 + subFontSize * 1.2,
                                        y,
                                        'description',
                                        shortDesc,
                                        descFontSize,
                                        keyColors.nested,
                                        0
                                    );
                                    nodesGroup.appendChild(descBg);
                                    
                                    const descKey = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                                    descKey.setAttribute('x', x + indentSize * 2 + subFontSize * 1.2);
                                    descKey.setAttribute('y', y);
                                    descKey.setAttribute('font-size', descFontSize);
                                    descKey.setAttribute('fill', keyColors.nested);
                                    descKey.setAttribute('font-family', 'monospace');
                                    descKey.textContent = '"description"';
                                    nodesGroup.appendChild(descKey);
                                    
                                    const descKeyWidth = descFontSize * 13 * 0.6;
                                    const descColon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                                    descColon.setAttribute('x', x + indentSize * 2 + subFontSize * 1.2 + descKeyWidth);
                                    descColon.setAttribute('y', y);
                                    descColon.setAttribute('font-size', descFontSize);
                                    descColon.setAttribute('fill', '#858585');
                                    descColon.setAttribute('font-family', 'monospace');
                                    descColon.textContent = ': ';
                                    nodesGroup.appendChild(descColon);
                                    
                                    const descVal = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                                    descVal.setAttribute('x', x + indentSize * 2 + subFontSize * 1.2 + descKeyWidth + descFontSize * 2);
                                    descVal.setAttribute('y', y);
                                    descVal.setAttribute('font-size', descFontSize);
                                    descVal.setAttribute('fill', keyColors.value);
                                    descVal.setAttribute('font-family', 'monospace');
                                    descVal.textContent = `"${shortDesc}"`;
                                    nodesGroup.appendChild(descVal);
                                    y += descFontSize * 1.2;
                                }
                                
                                if (subCardInfo.calls && subCardInfo.calls.length > 0) {
                                    // –ò–∫–æ–Ω–∫–∞ –¥–ª—è calls
                                    const callsIcon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                                    callsIcon.setAttribute('x', x + indentSize * 2);
                                    callsIcon.setAttribute('y', y);
                                    callsIcon.setAttribute('font-size', subFontSize * 0.8);
                                    callsIcon.setAttribute('font-family', 'monospace');
                                    callsIcon.textContent = 'üîó';
                                    nodesGroup.appendChild(callsIcon);
                                    
                                    const callsFontSize = subFontSize * 0.85;
                                    
                                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–æ–Ω–∞
                                    const callsKeyBg = createKeyBackground(
                                        x + indentSize * 2 + subFontSize * 1.2,
                                        y,
                                        'calls',
                                        callsFontSize,
                                        keyColors.nested,
                                        0
                                    );
                                    nodesGroup.appendChild(callsKeyBg);
                                    
                                    const callsKey = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                                    callsKey.setAttribute('x', x + indentSize * 2 + subFontSize * 1.2);
                                    callsKey.setAttribute('y', y);
                                    callsKey.setAttribute('font-size', callsFontSize);
                                    callsKey.setAttribute('fill', keyColors.nested);
                                    callsKey.setAttribute('font-family', 'monospace');
                                    callsKey.textContent = '"calls"';
                                    nodesGroup.appendChild(callsKey);
                                    
                                    const callsKeyWidth = callsFontSize * 7 * 0.6;
                                    const callsColon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                                    callsColon.setAttribute('x', x + indentSize * 2 + subFontSize * 1.2 + callsKeyWidth);
                                    callsColon.setAttribute('y', y);
                                    callsColon.setAttribute('font-size', callsFontSize);
                                    callsColon.setAttribute('fill', '#858585');
                                    callsColon.setAttribute('font-family', 'monospace');
                                    callsColon.textContent = ': [';
                                    nodesGroup.appendChild(callsColon);
                                    
                                    y += subFontSize * 1.1;
                                    
                                    subCardInfo.calls.forEach((call, callIdx) => {
                                        const callText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                                        callText.setAttribute('x', x + indentSize * 3);
                                        callText.setAttribute('y', y);
                                        callText.setAttribute('font-size', subFontSize * 0.7);
                                        callText.setAttribute('fill', '#dcdcaa');
                                        callText.setAttribute('font-family', 'monospace');
                                        callText.textContent = `"${call.target}"`;
                                        nodesGroup.appendChild(callText);
                                        
                                        if (callIdx < subCardInfo.calls.length - 1) {
                                            const callComma = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                                            callComma.setAttribute('x', x + indentSize * 3 - 10);
                                            callComma.setAttribute('y', y);
                                            callComma.setAttribute('font-size', subFontSize * 0.7);
                                            callComma.setAttribute('fill', '#858585');
                                            callComma.setAttribute('font-family', 'monospace');
                                            callComma.textContent = ',';
                                            nodesGroup.appendChild(callComma);
                                        }
                                        
                                        y += subFontSize * 1.0;
                                    });
                                    
                                    const callsClose = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                                    callsClose.setAttribute('x', x + indentSize * 2);
                                    callsClose.setAttribute('y', y);
                                    callsClose.setAttribute('font-size', subFontSize * 0.8);
                                    callsClose.setAttribute('fill', '#858585');
                                    callsClose.setAttribute('font-family', 'monospace');
                                    callsClose.textContent = ']';
                                    nodesGroup.appendChild(callsClose);
                                    y += subFontSize * 1.1;
                                }
                            }
                            
                            // –î–µ—Ç–∞–ª–∏ –¥–ª—è ui-component
                            if (subCardInfo.type === 'ui-component' && subCardInfo.uiType) {
                                // –ò–∫–æ–Ω–∫–∞ –¥–ª—è type
                                const typeIcon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                                typeIcon.setAttribute('x', x + indentSize * 2);
                                typeIcon.setAttribute('y', y);
                                typeIcon.setAttribute('font-size', subFontSize * 0.8);
                                typeIcon.setAttribute('font-family', 'monospace');
                                typeIcon.textContent = 'üè∑Ô∏è';
                                nodesGroup.appendChild(typeIcon);
                                
                                const uiTypeFontSize = subFontSize * 0.85;
                                
                                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–æ–Ω–∞
                                const uiTypeBg = createKeyValueBackground(
                                    x + indentSize * 2,
                                    y,
                                    'type',
                                    subCardInfo.uiType,
                                    uiTypeFontSize,
                                    keyColors.nested,
                                    0
                                );
                                nodesGroup.appendChild(uiTypeBg);
                                
                                const uiTypeKey = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                                uiTypeKey.setAttribute('x', x + indentSize * 2);
                                uiTypeKey.setAttribute('y', y);
                                uiTypeKey.setAttribute('font-size', uiTypeFontSize);
                                uiTypeKey.setAttribute('fill', keyColors.nested);
                                uiTypeKey.setAttribute('font-family', 'monospace');
                                uiTypeKey.textContent = '"type"';
                                nodesGroup.appendChild(uiTypeKey);
                                
                                const uiTypeKeyWidth = uiTypeFontSize * 6 * 0.6;
                                const uiTypeColon = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                                uiTypeColon.setAttribute('x', x + indentSize * 2 + uiTypeKeyWidth);
                                uiTypeColon.setAttribute('y', y);
                                uiTypeColon.setAttribute('font-size', uiTypeFontSize);
                                uiTypeColon.setAttribute('fill', '#858585');
                                uiTypeColon.setAttribute('font-family', 'monospace');
                                uiTypeColon.textContent = ': ';
                                nodesGroup.appendChild(uiTypeColon);
                                
                                const uiTypeVal = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                                uiTypeVal.setAttribute('x', x + indentSize * 2 + uiTypeKeyWidth + uiTypeFontSize * 2);
                                uiTypeVal.setAttribute('y', y);
                                uiTypeVal.setAttribute('font-size', uiTypeFontSize);
                                uiTypeVal.setAttribute('fill', keyColors.value);
                                uiTypeVal.setAttribute('font-family', 'monospace');
                                uiTypeVal.textContent = `"${subCardInfo.uiType}"`;
                                nodesGroup.appendChild(uiTypeVal);
                                y += uiTypeFontSize * 1.2;
                            }
                            
                            // –ó–∞–∫—Ä—ã–≤–∞—é—â–∞—è —Å–∫–æ–±–∫–∞ –¥–ª—è –ø–æ–¥–∫–∞—Ä—Ç–æ—á–∫–∏
                            const subCloseBrace = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                            subCloseBrace.setAttribute('x', x + indentSize);
                            subCloseBrace.setAttribute('y', y);
                            subCloseBrace.setAttribute('font-size', subFontSize);
                            subCloseBrace.setAttribute('fill', '#858585');
                            subCloseBrace.setAttribute('font-family', 'monospace');
                            subCloseBrace.textContent = '}';
                            nodesGroup.appendChild(subCloseBrace);
                            y += subFontSize * 1.3;
                            
                            if (idx < nonUISubCards.length - 1) {
                                const comma = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                                comma.setAttribute('x', x + indentSize - 15);
                                comma.setAttribute('y', y - subFontSize * 0.3);
                                comma.setAttribute('font-size', subFontSize);
                                comma.setAttribute('fill', '#858585');
                                comma.setAttribute('font-family', 'monospace');
                                comma.textContent = ',';
                                nodesGroup.appendChild(comma);
                            }
                        }
                    });
                }
                    
                    // –ó–∞–∫—Ä—ã–≤–∞—é—â–∞—è —Å–∫–æ–±–∫–∞
                    const closeBrace = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    closeBrace.setAttribute('x', x);
                    closeBrace.setAttribute('y', y);
                    closeBrace.setAttribute('font-size', fontSize);
                    closeBrace.setAttribute('fill', '#858585');
                    closeBrace.setAttribute('font-family', 'monospace');
                    closeBrace.textContent = '}';
                    nodesGroup.appendChild(closeBrace);
                } else {
                    // –õ–∏—Å—Ç - –ø—Ä–æ—Å—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ
                    const value = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    value.setAttribute('x', x + fontSize * (displayName.length + 2) * 0.6 + 10);
                    value.setAttribute('y', y);
                    value.setAttribute('font-size', fontSize * 0.7);
                    value.setAttribute('fill', '#6a9955');
                    value.setAttribute('font-family', 'monospace');
                    value.textContent = `"${displayType}"`;
                    nodesGroup.appendChild(value);
                }
                
                return y + fontSize * 1.3;
            }
            
            // –ü—Ä–æ—Å—Ç–æ —Ä–µ–Ω–¥–µ—Ä–∏–º –≤—Å—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ
            console.log('üöÄ Starting render');
            const finalY = renderJSONStructure(projectData, startX, yPos, 0);
            console.log('‚úÖ Render complete, final Y:', finalY);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä SVG —á—Ç–æ–±—ã –≤–º–µ—Å—Ç–∏—Ç—å –≤–µ—Å—å –∫–æ–Ω—Ç–µ–Ω—Ç
            updateSVGSize(finalY);
        }
        
        function updateSVGSize(maxY) {
            const svg = document.getElementById('mapSvg');
            if (!svg) return;
            
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –≥—Ä–∞–Ω–∏—Ü—ã –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            const nodesGroup = document.getElementById('nodes');
            if (!nodesGroup) {
                // –ï—Å–ª–∏ –Ω–µ—Ç nodesGroup, –∏—Å–ø–æ–ª—å–∑—É–µ–º maxY
                const padding = 150;
                const svgWidth = Math.max(window.innerWidth || 2000, 2000);
                const svgHeight = Math.max(window.innerHeight || 2000, maxY + padding);
                svg.setAttribute('width', svgWidth);
                svg.setAttribute('height', svgHeight);
                svg.setAttribute('viewBox', `0 0 ${svgWidth} ${svgHeight}`);
                return;
            }
            
            // –ù–∞—Ö–æ–¥–∏–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            let maxX = 0;
            let maxYCoord = 0;
            
            // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º —ç–ª–µ–º–µ–Ω—Ç–∞–º –≤ nodesGroup (text, rect)
            const allElements = nodesGroup.querySelectorAll('text, rect');
            allElements.forEach(el => {
                const x = parseFloat(el.getAttribute('x')) || 0;
                const y = parseFloat(el.getAttribute('y')) || 0;
                const fontSize = parseFloat(el.getAttribute('font-size')) || 14;
                const width = parseFloat(el.getAttribute('width')) || 0;
                const height = parseFloat(el.getAttribute('height')) || 0;
                const textLength = (el.textContent || '').length;
                
                // –î–ª—è —Ç–µ–∫—Å—Ç–∞ —É—á–∏—Ç—ã–≤–∞–µ–º –¥–ª–∏–Ω—É —Ç–µ–∫—Å—Ç–∞
                if (el.tagName === 'text') {
                    maxX = Math.max(maxX, x + textLength * fontSize * 0.6);
                    maxYCoord = Math.max(maxYCoord, y + fontSize);
                } else if (el.tagName === 'rect') {
                    // –î–ª—è –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤ —É—á–∏—Ç—ã–≤–∞–µ–º —à–∏—Ä–∏–Ω—É –∏ –≤—ã—Å–æ—Ç—É
                    maxX = Math.max(maxX, x + width);
                    maxYCoord = Math.max(maxYCoord, y + height);
                }
            });
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ maxY (–≤–æ–∑–≤—Ä–∞—â–µ–Ω–Ω–æ–µ –∏–∑ renderJSONNode) –∏ –≤—ã—á–∏—Å–ª–µ–Ω–Ω–æ–≥–æ maxYCoord
            const finalMaxY = Math.max(maxY || 0, maxYCoord);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø—ã
            const padding = 150;
            const svgWidth = Math.max(window.innerWidth || 2000, maxX + padding, 2000);
            const svgHeight = Math.max(window.innerHeight || 2000, finalMaxY + padding);
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã SVG
            svg.setAttribute('width', svgWidth);
            svg.setAttribute('height', svgHeight);
            svg.setAttribute('viewBox', `0 0 ${svgWidth} ${svgHeight}`);
            
            console.log('üìê SVG size updated:', svgWidth, 'x', svgHeight, 'maxY:', finalMaxY, 'maxX:', maxX);
        }

        function showPreview(node) {
            hoveredNode = node;
            previewPanel.classList.add('visible');
            
            document.getElementById('previewIcon').textContent = node.icon;
            document.getElementById('previewTitle').textContent = node.name;
            document.getElementById('previewPath').textContent = node.path;
            
            const functionsDiv = document.getElementById('previewFunctions');
            functionsDiv.innerHTML = '';
            
            if (node.ui && node.ui.structure) {
                const uiDiv = document.createElement('div');
                uiDiv.className = 'preview-function';
                uiDiv.innerHTML = '<div class="preview-function-name">üé® UI Structure</div>';
                Object.entries(node.ui.structure).forEach(([key, value]) => {
                    const item = document.createElement('div');
                    item.className = 'preview-function-desc';
                    item.textContent = `${key}: ${value.type}`;
                    uiDiv.appendChild(item);
                });
                functionsDiv.appendChild(uiDiv);
            }
            
            if (node.atoms) {
                node.atoms.forEach(atom => {
                    const atomDiv = document.createElement('div');
                    atomDiv.className = 'preview-function';
                    atomDiv.style.borderLeftColor = '#c586c0';
                    atomDiv.innerHTML = `
                        <div class="preview-function-name">üíæ ${atom.name}</div>
                        <div class="preview-function-desc">${JSON.stringify(atom.structure, null, 2)}</div>
                    `;
                    functionsDiv.appendChild(atomDiv);
                });
            }
            
            if (node.functions) {
                node.functions.forEach(func => {
                    const funcDiv = document.createElement('div');
                    funcDiv.className = 'preview-function';
                    funcDiv.innerHTML = `
                        <div class="preview-function-name">‚ö° ${func.name}()</div>
                        <div class="preview-function-desc">${func.description || ''}</div>
                    `;
                    functionsDiv.appendChild(funcDiv);
                });
            }
        }

        function hidePreview() {
            if (!draggedNode) {
                previewPanel.classList.remove('visible');
                hoveredNode = null;
            }
        }

        // –ü—Ä–æ—Å—Ç–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ–π
        const canvas = document.getElementById('mapCanvas');
        let isPanning = false;
        let isDraggingNode = false;
        let panStart = { x: 0, y: 0 };
        let mouseStart = { x: 0, y: 0 };

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤ —Å–∏—Å—Ç–µ–º–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –∫–∞—Ä—Ç—ã
        function getSVGPoint(clientX, clientY) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: (clientX - rect.left - translateX) / scale,
                y: (clientY - rect.top - translateY) / scale
            };
        }

        // –ó—É–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ç–æ—á–∫–∏ –∫—É—Ä—Å–æ—Ä–∞ (–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç)
        function zoomToPoint(clientX, clientY, zoomFactor) {
            const rect = canvas.getBoundingClientRect();
            
            // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫—É—Ä—Å–æ—Ä–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ canvas (viewport)
            const viewportX = clientX - rect.left;
            const viewportY = clientY - rect.top;
            
            // –¢–æ—á–∫–∞ –≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö –∫–∞—Ä—Ç—ã (world coordinates) –î–û –∑—É–º–∞
            const worldX = (viewportX - translateX) / scale;
            const worldY = (viewportY - translateY) / scale;
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –∑—É–º (–º–µ–Ω—å—à–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)
            const newScale = Math.max(0.1, Math.min(5, scale * zoomFactor));
            
            // –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—ã–π translate —Ç–∞–∫, —á—Ç–æ–±—ã —Ç–æ—á–∫–∞ –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º –æ—Å—Ç–∞–ª–∞—Å—å –Ω–∞ –º–µ—Å—Ç–µ
            // viewportX = translateX + worldX * newScale
            // translateX = viewportX - worldX * newScale
            translateX = viewportX - worldX * newScale;
            translateY = viewportY - worldY * newScale;
            scale = newScale;
            
            updateTransform();
        }

        // Drag –Ω–æ–¥—ã –æ—Ç–∫–ª—é—á–µ–Ω - –¥–µ—Ä–µ–≤–æ —Å—Ç–∞—Ç–∏—á–Ω–æ –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ
        function startDragNode(e, node) {
            e.stopPropagation();
            // –ù–æ–¥—ã –Ω–µ –¥–≤–∏–≥–∞—é—Ç—Å—è - –¥–µ—Ä–µ–≤–æ —Å—Ç–∞—Ç–∏—á–Ω–æ
            // –ú–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ –∑—É–º–∏—Ç—å –∏ –ø–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞—Ç—å –≤—Å—é –∫–∞—Ä—Ç—É
        }

        function dragNode(e) {
            // –ù–æ–¥—ã –Ω–µ –¥–≤–∏–≥–∞—é—Ç—Å—è - –¥–µ—Ä–µ–≤–æ —Å—Ç–∞—Ç–∏—á–Ω–æ
        }

        function stopDragNode() {
            isDraggingNode = false;
            draggedNode = null;
        }

        // –ü–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏–µ
        canvas.addEventListener('mousedown', (e) => {
            const target = e.target;
            const isNode = target.closest('.node-group') || 
                         target.classList.contains('node-rect') ||
                         target.classList.contains('node-container');
            
            if (!isNode) {
                isPanning = true;
                mouseStart = { x: e.clientX, y: e.clientY };
                panStart = { x: translateX, y: translateY };
                canvas.style.cursor = 'grabbing';
            }
        });

        canvas.addEventListener('mousemove', (e) => {
            if (isPanning && !isDraggingNode) {
                translateX = panStart.x + (e.clientX - mouseStart.x);
                translateY = panStart.y + (e.clientY - mouseStart.y);
                updateTransform();
            } else if (isDraggingNode && draggedNode) {
                dragNode(e);
            }
        });

        canvas.addEventListener('mouseup', () => {
            isPanning = false;
            canvas.style.cursor = 'grab';
            if (isDraggingNode) {
                stopDragNode();
            }
        });

        canvas.addEventListener('mouseleave', () => {
            isPanning = false;
            canvas.style.cursor = 'grab';
            if (isDraggingNode) {
                stopDragNode();
            }
        });

        // –ó—É–º –∫–æ–ª–µ—Å–∏–∫–æ–º (–º–µ–Ω—å—à–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)
        canvas.addEventListener('wheel', (e) => {
            e.preventDefault();
            // –ú–µ–Ω—å—à–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å - –±–æ–ª–µ–µ –ø–ª–∞–≤–Ω—ã–π –∑—É–º
            const zoomFactor = e.deltaY > 0 ? 0.97 : 1.03;
            zoomToPoint(e.clientX, e.clientY, zoomFactor);
        }, { passive: false });

        // Touch —Å–æ–±—ã—Ç–∏—è
        let touchState = {
            lastDistance: 0,
            lastCenter: { x: 0, y: 0 },
            panStart: { x: 0, y: 0 }
        };

        canvas.addEventListener('touchstart', (e) => {
            if (e.touches.length === 1) {
                const touch = e.touches[0];
                touchState.panStart = { x: translateX, y: translateY };
                touchState.lastCenter = { x: touch.clientX, y: touch.clientY };
            } else if (e.touches.length === 2) {
                const t1 = e.touches[0];
                const t2 = e.touches[1];
                touchState.lastDistance = Math.hypot(t2.clientX - t1.clientX, t2.clientY - t1.clientY);
                touchState.lastCenter = {
                    x: (t1.clientX + t2.clientX) / 2,
                    y: (t1.clientY + t2.clientY) / 2
                };
            }
        }, { passive: false });

        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            
            if (e.touches.length === 1) {
                const touch = e.touches[0];
                translateX = touchState.panStart.x + (touch.clientX - touchState.lastCenter.x);
                translateY = touchState.panStart.y + (touch.clientY - touchState.lastCenter.y);
                updateTransform();
            } else if (e.touches.length === 2) {
                const t1 = e.touches[0];
                const t2 = e.touches[1];
                const distance = Math.hypot(t2.clientX - t1.clientX, t2.clientY - t1.clientY);
                const centerX = (t1.clientX + t2.clientX) / 2;
                const centerY = (t1.clientY + t2.clientY) / 2;
                
                if (touchState.lastDistance > 0 && Math.abs(distance - touchState.lastDistance) > 3) {
                    // –ú–µ–Ω—å—à–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–ª—è touch (–≤ 2 —Ä–∞–∑–∞ —Å–ª–∞–±–µ–µ)
                    const rawZoomFactor = distance / touchState.lastDistance;
                    const zoomFactor = 1 + (rawZoomFactor - 1) * 0.5;
                    zoomToPoint(centerX, centerY, zoomFactor);
                }
                
                // Pan –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏ —Ü–µ–Ω—Ç—Ä–∞
                translateX += centerX - touchState.lastCenter.x;
                translateY += centerY - touchState.lastCenter.y;
                
                touchState.lastDistance = distance;
                touchState.lastCenter = { x: centerX, y: centerY };
                updateTransform();
            }
        }, { passive: false });

        canvas.addEventListener('touchend', () => {
            touchState.lastDistance = 0;
        });

        function updateTransform() {
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—é –∫ –≥—Ä—É–ø–ø–µ —Å –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º (–∑—É–º –∏ –ø–∞–Ω —Ä–∞–±–æ—Ç–∞—é—Ç)
            const transformGroup = document.getElementById('transform-group');
            if (transformGroup) {
                transformGroup.setAttribute('transform', `translate(${translateX}, ${translateY}) scale(${scale})`);
            }
        }

        function resetView() {
            scale = 1;
            // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –Ω–∞ —Å–µ—Ä–µ–¥–∏–Ω–µ –∫–∞—Ä—Ç—ã
            const centerX = Object.values(logicMap).reduce((sum, n) => sum + n.x + n.width/2, 0) / Object.keys(logicMap).length;
            const centerY = Object.values(logicMap).reduce((sum, n) => sum + n.y + n.height/2, 0) / Object.keys(logicMap).length;
            translateX = canvas.clientWidth / 2 - centerX;
            translateY = canvas.clientHeight / 2 - centerY;
            updateTransform();
        }

        function zoomIn() {
            const centerX = canvas.clientWidth / 2;
            const centerY = canvas.clientHeight / 2;
            zoomToPoint(centerX, centerY, 1.1);
        }

        function zoomOut() {
            const centerX = canvas.clientWidth / 2;
            const centerY = canvas.clientHeight / 2;
            zoomToPoint(centerX, centerY, 0.9);
        }

        function fitToScreen() {
            // –í—ã—á–∏—Å–ª—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –≤—Å–µ—Ö –Ω–æ–¥
            let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
            Object.values(logicMap).forEach(node => {
                minX = Math.min(minX, node.x);
                minY = Math.min(minY, node.y);
                maxX = Math.max(maxX, node.x + node.width);
                maxY = Math.max(maxY, node.y + node.height);
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø—ã
            const padding = 50;
            minX -= padding;
            minY -= padding;
            maxX += padding;
            maxY += padding;
            
            const width = maxX - minX;
            const height = maxY - minY;
            const centerX = (minX + maxX) / 2;
            const centerY = (minY + maxY) / 2;
            
            const scaleX = (canvas.clientWidth * 0.9) / width;
            const scaleY = (canvas.clientHeight * 0.9) / height;
            scale = Math.min(scaleX, scaleY, 2);
            
            translateX = canvas.clientWidth / 2 - centerX * scale;
            translateY = canvas.clientHeight / 2 - centerY * scale;
            
            updateTransform();
        }

        document.getElementById('searchBox').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            Object.values(logicMap).forEach(node => {
                const group = document.querySelector(`[data-node-id="${node.id}"]`);
                if (group) {
                    const text = node.name.toLowerCase() + ' ' + (node.path || '').toLowerCase();
                    group.style.opacity = text.includes(query) ? '1' : '0.3';
                }
            });
        });

        function initMap() {
            if (!projectData) {
                console.warn('Project data not loaded, waiting...');
                return;
            }
            renderNodes();
            // renderConnections(); // –£–±—Ä–∞–ª–∏ —Å–≤—è–∑–∏ –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ JSON
            updateTransform();
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        loadProjectData().then(() => {
            initMap();
        });
    </script>
</body>
</html>
